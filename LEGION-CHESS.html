<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LEGION CHESS</title>
</head>
<body>
<script>
/*-- üéÆ‚ôüÔ∏è-(1A)-(S)-(SHELL-ROOT-BOOTSTRAP)-(LEGION-CHESS)-(S)-(1A)-‚ôüÔ∏èüéÆ --*/
(()=>{let LC=window.LEGION_CHESS||{};window.LEGION_CHESS=LC;

LC.VERSION="1A";
LC._cells=LC._cells||{};
LC._order=LC._order||[];
LC._mounted=LC._mounted||[];
LC._ready=false;

LC.now=()=>performance.now();
LC.log=(...a)=>console.log("[LEGION_CHESS]",...a);

LC.bus=LC.bus||(()=>{let m={};return{
on:(k,f)=>{(m[k]=m[k]||[]).push(f);return()=>{let a=m[k]||[];m[k]=a.filter(x=>x!==f);};},
emit:(k,p)=>{let a=m[k]||[];for(let i=0;i<a.length;i++)try{a[i](p);}catch(e){console.error(e);}},
clear:()=>{m={};}
};})();

LC.registerCell=(id,cell)=>{if(!id||!cell)throw Error("registerCell missing");LC._cells[id]=cell;};
LC.setOrder=(arr)=>{LC._order=Array.isArray(arr)?arr.slice():[];};
LC.getCell=(id)=>LC._cells[id]||null;

LC.ctx=LC.ctx||{bus:LC.bus,log:LC.log,now:LC.now,root:null,theme:null,settings:null};

LC.mount=(root)=>{LC.ctx.root=root||document.body;LC._mounted=[];for(let i=0;i<LC._order.length;i++){let id=LC._order[i];let c=LC._cells[id];if(!c||!c.mount)continue;try{c.mount(LC.ctx);}catch(e){console.error(e);}LC._mounted.push(id);}LC._ready=true;LC.bus.emit("shell:ready",{version:LC.VERSION});};
LC.unmount=()=>{for(let i=LC._mounted.length-1;i>=0;i--){let id=LC._mounted[i];let c=LC._cells[id];if(!c||!c.unmount)continue;try{c.unmount();}catch(e){console.error(e);}}LC._mounted=[];LC._ready=false;LC.bus.emit("shell:down",{});};

LC.boot=()=>{let root=document.getElementById("LEGION_CHESS_ROOT")||document.body;LC.mount(root);};

LC.log("Shell 1A loaded");

})();
/*-- üéÆ‚ôüÔ∏è-(1A)-(E)-(SHELL-ROOT-BOOTSTRAP)-(LEGION-CHESS)-(E)-(1A)-‚ôüÔ∏èüéÆ --*/

/*-- üëëüî•-(1A)-(S)-(COMMAND-CORE-ENGINE)-(KING-OF-GODS)-(S)-(1A)-üî•üëë --*/
/* (1A) COMMAND-CORE-ENGINE (KING-OF-GODS) */
const Engine_KING_OF_GODS={
id:"KING_OF_GODS",
_ctx:null,
_registry:new Map(),
_inited:false,
_bus:{on:null,emit:null},

init:function(ctx){
if(!ctx)return;
this._ctx=ctx;
if(this._inited)return;
this._inited=true;

const bus=(ctx.bus||ctx);
const on=bus&&((bus.on&&bus.on.bind(bus))||(bus.subscribe&&bus.subscribe.bind(bus))||(bus.addEventListener&&((evt,fn)=>bus.addEventListener(evt,fn))));
const emit=bus&&((bus.emit&&bus.emit.bind(bus))||(bus.publish&&bus.publish.bind(bus))||(bus.dispatchEvent&&((evt,payload)=>bus.dispatchEvent(new CustomEvent(evt,{detail:payload})))));

this._bus.on=on||function(){};
this._bus.emit=emit||function(){};

this._bus.on("REQ:KING_OF_GODS:REGISTER",(payload)=>{
if(payload&&payload.cmd&&typeof payload.fn==="function")this.api.register(payload.cmd,payload.fn);
});

this._bus.on("REQ:KING_OF_GODS:EXECUTE",(payload)=>{
if(!payload)return null;
const cmd=payload.cmd||payload.command;
if(!cmd)return null;
return this.api.execute(cmd,payload.args);
});

this._log("info","Command Core Online");
this._bus.emit("EVT:KING_OF_GODS:READY",{id:this.id,status:"stable",ts:Date.now()});
},

api:{
register:(command,fn)=>{
const self=Engine_KING_OF_GODS;
const ctx=self._ctx||{};
if(!command||typeof fn!=="function")return false;

if(self._registry.has(command))self._log("warn","Overwriting command: "+command);
self._registry.set(command,fn);

self._bus.emit("EVT:KING_OF_GODS:REGISTERED",{id:self.id,cmd:command,ts:Date.now()});
return true;
},

execute:(command,args)=>{
const self=Engine_KING_OF_GODS;
const fn=self._registry.get(command);

if(!fn){
self._log("error","Command not found: "+command);
self._bus.emit("EVT:KING_OF_GODS:ERROR",{id:self.id,cmd:command,error:"NOT_FOUND",ts:Date.now()});
return null;
}

try{
const safeArgs=Array.isArray(args)?args:(args===undefined?[]:[args]);
const result=fn(...safeArgs);

self._log("info","Executed: "+command);
self._bus.emit("EVT:KING_OF_GODS:EXECUTED",{id:self.id,cmd:command,result,ts:Date.now()});
return result;
}catch(error){
const errMsg=(error&&error.message)?error.message:String(error);
self._log("error","Execution failed: "+command+" :: "+errMsg);
self._bus.emit("EVT:KING_OF_GODS:ERROR",{id:self.id,cmd:command,error:errMsg,ts:Date.now()});
return null;
}
},

has:(command)=>Engine_KING_OF_GODS._registry.has(command),
list:()=>Array.from(Engine_KING_OF_GODS._registry.keys())
},

_log:function(level,msg){
const ctx=this._ctx;
const log=ctx&&ctx.log;
if(log&&typeof log[level]==="function")log[level]("KING_OF_GODS",msg);
else if(log&&typeof log==="function")log("KING_OF_GODS",msg);
}
};

window.KOG=window.KOG||{};
window.KOG[Engine_KING_OF_GODS.id]=Engine_KING_OF_GODS;
/*-- üëëüî•-(1A)-(E)-(COMMAND-CORE-ENGINE)-(KING-OF-GODS)-(E)-(1A)-üî•üëë --*/
/*-- üÉèüé≤-(2A)-(S)-(THEME-ROUTER-ENGINE)-(WILD-CARD)-(S)-(2A)-üé≤üÉè --*/
const Engine_WILD_CARD={
id:"WILD_CARD",
_ctx:null,
_bus:null,
_log:null,
_state:{themeName:"toxic",vars:{}},
_presets:{
toxic:{themeName:"toxic",vars:{"--primary":"#39ff14","--glow":"#00ff00","--bg":"#0a0a0a","--text":"#ccffcc","--accent":"#b3ff00"}},
lava:{themeName:"lava",vars:{"--primary":"#ff4500","--glow":"#ff8c00","--bg":"#1a0500","--text":"#ffeebb","--accent":"#ff2200"}},
cyber:{themeName:"cyber",vars:{"--primary":"#00ffff","--glow":"#ff00ff","--bg":"#000022","--text":"#e0ffff","--accent":"#ff0099"}},
ice:{themeName:"ice",vars:{"--primary":"#00bfff","--glow":"#87cefa","--bg":"#001133","--text":"#ffffff","--accent":"#0099ff"}},
void:{themeName:"void",vars:{"--primary":"#9400d3","--glow":"#4b0082","--bg":"#000000","--text":"#dcdcdc","--accent":"#8a2be2"}},
gold:{themeName:"gold",vars:{"--primary":"#ffd700","--glow":"#daa520","--bg":"#1a1a00","--text":"#ffffe0","--accent":"#ffb700"}}
},
init:function(ctx){
this._ctx=ctx||{};
this._bus=(this._ctx.bus&&typeof this._ctx.bus==="object")?this._ctx.bus:{};
if(typeof this._bus.on!=="function") this._bus.on=function(){};
if(typeof this._bus.emit!=="function") this._bus.emit=function(){};
this._log=(this._ctx.log&&typeof this._ctx.log==="object")?this._ctx.log:{};
if(typeof this._log.info!=="function") this._log.info=function(){};
if(typeof this._log.warn!=="function") this._log.warn=function(){};

this._state.themeName="toxic";
this._state.vars=Object.assign({},this._presets.toxic.vars);

const updateAndEmit=(name,vars)=>{
this._state.themeName=name;
this._state.vars=vars;
const payload={themeName:this._state.themeName,vars:Object.assign({},this._state.vars),ts:Date.now()};
this._bus.emit("EVT:WILD_CARD:THEME_CHANGED",payload);
this._bus.emit("EVT:WILD_CARD:THEME_STATE",payload);
this._log.info("WILD_CARD","Theme state updated: "+name);
};

this.api={
setTheme:(payload)=>{
try{
let targetName="";
let targetVars={};
if(payload&&payload.preset){
if(!this._presets[payload.preset]) throw new Error("Preset not found: "+payload.preset);
targetName=payload.preset;
targetVars=this._presets[payload.preset].vars;
}else if(payload&&payload.themeName&&payload.vars){
targetName=payload.themeName;
targetVars=payload.vars;
}else{
throw new Error("Invalid theme payload structure");
}
updateAndEmit(targetName,Object.assign({},targetVars));
}catch(e){
const msg=(e&&e.message)?e.message:String(e);
this._log.warn("WILD_CARD","Theme Error: "+msg);
this._bus.emit("EVT:WILD_CARD:ERROR",{code:"INVALID_THEME",msg,ts:Date.now()});
if(!this._state.vars||Object.keys(this._state.vars).length===0) updateAndEmit("toxic",Object.assign({},this._presets.toxic.vars));
}
},
apply:()=>{
this._bus.emit("EVT:WILD_CARD:THEME_APPLY",{themeName:this._state.themeName,vars:Object.assign({},this._state.vars),ts:Date.now()});
this._log.info("WILD_CARD","Broadcasting theme application request.");
},
getTheme:()=>({themeName:this._state.themeName,vars:Object.assign({},this._state.vars)}),
listPresets:()=>Object.keys(this._presets)
};

this._bus.on("REQ:WILD_CARD:SET_THEME",(p)=>this.api.setTheme(p));
this._bus.on("REQ:WILD_CARD:APPLY",()=>this.api.apply());
this._bus.on("REQ:WILD_CARD:GET_THEME",()=>{this._bus.emit("EVT:WILD_CARD:THEME_STATE",{themeName:this._state.themeName,vars:Object.assign({},this._state.vars),ts:Date.now()});});

this._log.info("WILD_CARD","Engine Initialized.");
this._bus.emit("EVT:WILD_CARD:READY",{id:this.id,presets:this.api.listPresets(),ts:Date.now()});
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_WILD_CARD.id]=Engine_WILD_CARD;
/*-- üÉèüé≤-(2A)-(E)-(THEME-ROUTER-ENGINE)-(WILD-CARD)-(E)-(2A)-üé≤üÉè --*/
/*-- üõ°Ô∏è‚öôÔ∏è-(3A)-(S)-(UI-SKIN-ENGINE)-(IRON-CORE)-(S)-(3A)-‚öôÔ∏èüõ°Ô∏è --*/
const Engine_IRON_CORE={
id:"IRON_CORE",
_ctx:null,
_state:{
enabled:true,
mounted:false,
activePreset:"steel",
lastError:null,
presets:{
steel:{bg:"#1e1e1e",fg:"#e5e5e5",accent:"#9aa0a6",border:"#3a3a3a"},
obsidian:{bg:"#0b0b0b",fg:"#f5f5f5",accent:"#7f39fb",border:"#222"},
titanium:{bg:"#f4f6f8",fg:"#1b1f23",accent:"#0969da",border:"#d0d7de"}
}
},
init(ctx){
this._ctx=ctx||null;
if(!this._ctx||!this._ctx.bus)return this._error("init","missing_ctx_bus");
this._wire();
this._emit("EVT:IRON_CORE:READY",{id:this.id,ts:Date.now()});
return this;
},
_wire(){
var b=this._ctx.bus,me=this;
b.on("REQ:IRON_CORE:MOUNT",function(p){me.mount(p);});
b.on("REQ:IRON_CORE:ENABLE",function(){me.enable();});
b.on("REQ:IRON_CORE:DISABLE",function(){me.disable();});
b.on("REQ:IRON_CORE:SET",function(p){me.setPreset(p);});
b.on("REQ:IRON_CORE:STATUS",function(){me._emitState();});
},
_emit(ev,p){
try{this._ctx&&this._ctx.bus&&this._ctx.bus.emit(ev,p);}catch(e){this._error("_emit",e);}
},
_log(){
try{this._ctx&&this._ctx.log&&this._ctx.log.apply(this._ctx,arguments);}catch(e){}
},
_error(where,err){
var msg=(err&&err.message)?err.message:String(err||"error");
this._state.lastError=msg;
this._emit("EVT:IRON_CORE:ERROR",{id:this.id,where:String(where||"unknown"),error:msg,ts:Date.now()});
return null;
},
mount(payload){
try{
payload=payload||{};
if(payload.preset)this.setPreset({name:payload.preset});
this._state.mounted=true;
this._emit("EVT:IRON_CORE:MOUNTED",{id:this.id,ts:Date.now()});
this._emitState();
}catch(e){this._error("mount",e);}
},
enable(){
this._state.enabled=true;
this._emitState();
},
disable(){
this._state.enabled=false;
this._emitState();
},
setPreset(payload){
try{
payload=payload||{};
var name=payload.name;
if(!name||!this._state.presets[name])return;
this._state.activePreset=name;
this._emit("EVT:IRON_CORE:UPDATED",{id:this.id,preset:name,ts:Date.now()});
this._emitState();
}catch(e){this._error("setPreset",e);}
},
_snapshot(){
return{
enabled:this._state.enabled,
mounted:this._state.mounted,
activePreset:this._state.activePreset,
presets:this._state.presets,
lastError:this._state.lastError
};
},
_emitState(){
this._emit("EVT:IRON_CORE:STATE",{id:this.id,state:this._snapshot(),ts:Date.now()});
},
status(){
return{id:this.id,state:this._snapshot(),ts:Date.now()};
},
api:{
mount:function(p){return Engine_IRON_CORE.mount(p);},
enable:function(){return Engine_IRON_CORE.enable();},
disable:function(){return Engine_IRON_CORE.disable();},
setPreset:function(p){return Engine_IRON_CORE.setPreset(p);},
status:function(){return Engine_IRON_CORE.status();}
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_IRON_CORE.id]=Engine_IRON_CORE;
/*-- üõ°Ô∏è‚öôÔ∏è-(3A)-(E)-(UI-SKIN-ENGINE)-(IRON-CORE)-(E)-(3A)-‚öôÔ∏èüõ°Ô∏è --*/
/*-- üï∂Ô∏èüíª-(4A)-(S)-(BACKGROUND-ENGINE)-(NET-RUNNER)-(S)-(4A)-üíªüï∂Ô∏è --*/
const Engine_NET_RUNNER={
id:'NET_RUNNER',
version:'1.0.1',
_ctx:null,
_state:{
enabled:true,
mounted:false,
started:false,
lastError:null,
mode:'css',
layerId:'KOG_NET_RUNNER_LAYER',
zIndex:-1,
opacity:1,
theme:'grid',
themes:{},
config:{
autoMount:true,
respectReducedMotion:true,
pauseWhenHidden:true,
defaultTheme:'grid',
defaultOpacity:1,
defaultZIndex:-1
}
},
_timers:{tick:0},
_wireOnce:false,
init:function(ctx){
this._ctx=ctx||null;
try{
this._buildThemes();
this._wire();
if(this._state.config.autoMount) this.api.mount();
this._emit('EVT:NET_RUNNER:READY',{id:this.id,state:this.api.status(),ts:Date.now()});
this._log('info','NET_RUNNER Online');
}catch(e){
this._error('init',e);
}
},
api:{
mount:function(){
try{
const self=Engine_NET_RUNNER;
if(self._state.mounted){self._emit('EVT:NET_RUNNER:MOUNTED',{id:self.id,state:self.api.status(),ts:Date.now()});return true;}
const layer=self._ensureLayer();
if(!layer) return false;
self._state.mounted=true;
self._applyTheme(self._state.theme,true);
self._applyOpacity(self._state.opacity,true);
self._applyZ(self._state.zIndex,true);
self._emit('EVT:NET_RUNNER:MOUNTED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:NET_RUNNER:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_NET_RUNNER._error('mount',e);
return false;
}
},
unmount:function(){
try{
const self=Engine_NET_RUNNER;
self.api.stop();
const el=document.getElementById(self._state.layerId);
if(el&&el.parentNode) el.parentNode.removeChild(el);
self._state.mounted=false;
self._emit('EVT:NET_RUNNER:UNMOUNTED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:NET_RUNNER:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_NET_RUNNER._error('unmount',e);
return false;
}
},
start:function(){
try{
const self=Engine_NET_RUNNER;
if(self._state.started) return true;
if(!self._state.mounted) self.api.mount();
self._state.started=true;
self._tickStart();
self._emit('EVT:NET_RUNNER:STARTED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:NET_RUNNER:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_NET_RUNNER._error('start',e);
return false;
}
},
stop:function(){
try{
const self=Engine_NET_RUNNER;
if(!self._state.started) return true;
self._state.started=false;
self._tickStop();
self._emit('EVT:NET_RUNNER:STOPPED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:NET_RUNNER:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_NET_RUNNER._error('stop',e);
return false;
}
},
enable:function(){
try{
const self=Engine_NET_RUNNER;
self._state.enabled=true;
self._layerShow(true);
if(self._state.started) self._tickStart();
self._emit('EVT:NET_RUNNER:ENABLED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:NET_RUNNER:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_NET_RUNNER._error('enable',e);
return false;
}
},
disable:function(){
try{
const self=Engine_NET_RUNNER;
self._state.enabled=false;
self._layerShow(false);
self._tickStop();
self._emit('EVT:NET_RUNNER:DISABLED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:NET_RUNNER:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_NET_RUNNER._error('disable',e);
return false;
}
},
setTheme:function(name){
try{
const self=Engine_NET_RUNNER;
const nm=(name&&typeof name==='string')?name:self._state.config.defaultTheme;
self._state.theme=self._state.themes[nm]?nm:self._state.config.defaultTheme;
if(self._state.mounted) self._applyTheme(self._state.theme,false);
self._emit('EVT:NET_RUNNER:THEME',{id:self.id,theme:self._state.theme,ts:Date.now()});
self._emit('EVT:NET_RUNNER:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_NET_RUNNER._error('setTheme',e);
return false;
}
},
setOpacity:function(v){
try{
const self=Engine_NET_RUNNER;
let x=Number(v);
if(!isFinite(x)) x=self._state.config.defaultOpacity;
if(x<0) x=0;
if(x>1) x=1;
self._state.opacity=x;
if(self._state.mounted) self._applyOpacity(x,false);
self._emit('EVT:NET_RUNNER:OPACITY',{id:self.id,opacity:self._state.opacity,ts:Date.now()});
self._emit('EVT:NET_RUNNER:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_NET_RUNNER._error('setOpacity',e);
return false;
}
},
setZIndex:function(v){
try{
const self=Engine_NET_RUNNER;
let z=parseInt(v,10);
if(!isFinite(z)) z=self._state.config.defaultZIndex;
self._state.zIndex=z;
if(self._state.mounted) self._applyZ(z,false);
self._emit('EVT:NET_RUNNER:ZINDEX',{id:self.id,zIndex:self._state.zIndex,ts:Date.now()});
self._emit('EVT:NET_RUNNER:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_NET_RUNNER._error('setZIndex',e);
return false;
}
},
snapshot:function(){
const self=Engine_NET_RUNNER;
return {id:self.id,state:self.api.status(),ts:Date.now()};
},
status:function(){
const s=Engine_NET_RUNNER._state;
return {id:Engine_NET_RUNNER.id,version:Engine_NET_RUNNER.version,enabled:s.enabled,mounted:s.mounted,started:s.started,theme:s.theme,opacity:s.opacity,zIndex:s.zIndex,layerId:s.layerId,ts:Date.now()};
},
listThemes:function(){
return Object.keys(Engine_NET_RUNNER._state.themes||{});
}
},
_buildThemes:function(){
const t={};
t.grid={name:'grid',css:"radial-gradient(circle at 1px 1px, rgba(255,255,255,0.08) 1px, rgba(0,0,0,0) 0) 0 0/24px 24px, linear-gradient(rgba(255,255,255,0.05) 1px, rgba(0,0,0,0) 1px) 0 0/24px 24px, linear-gradient(90deg, rgba(255,255,255,0.05) 1px, rgba(0,0,0,0) 1px) 0 0/24px 24px"};
t.scanlines={name:'scanlines',css:"linear-gradient(rgba(0,0,0,0.0) 50%, rgba(0,0,0,0.18) 50%) 0 0/100% 4px"};
t.nebula={name:'nebula',css:"radial-gradient(circle at 20% 30%, rgba(0,255,255,0.10), rgba(0,0,0,0) 55%), radial-gradient(circle at 80% 40%, rgba(255,0,255,0.10), rgba(0,0,0,0) 60%), radial-gradient(circle at 50% 80%, rgba(255,255,0,0.06), rgba(0,0,0,0) 55%), linear-gradient(180deg, rgba(0,0,0,0.75), rgba(0,0,0,0.92))"};
t.matrix={name:'matrix',css:"linear-gradient(180deg, rgba(0,255,128,0.08), rgba(0,0,0,0) 60%), radial-gradient(circle at 50% 50%, rgba(0,255,128,0.06), rgba(0,0,0,0) 65%)"};
t.static={name:'static',css:"repeating-linear-gradient(0deg, rgba(255,255,255,0.03), rgba(255,255,255,0.03) 1px, rgba(0,0,0,0) 2px, rgba(0,0,0,0) 4px), repeating-linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.02) 1px, rgba(0,0,0,0) 2px, rgba(0,0,0,0) 6px)"};
this._state.themes=t;
if(!this._state.theme) this._state.theme=this._state.config.defaultTheme;
},
_wire:function(){
if(this._wireOnce) return;
this._wireOnce=true;
const ctx=this._ctx;
const bus=ctx&&ctx.bus?ctx.bus:null;
if(!bus||typeof bus.on!=='function') return;
bus.on('REQ:NET_RUNNER:MOUNT',()=>{try{this.api.mount();}catch(e){this._error('listener:MOUNT',e);}});
bus.on('REQ:NET_RUNNER:UNMOUNT',()=>{try{this.api.unmount();}catch(e){this._error('listener:UNMOUNT',e);}});
bus.on('REQ:NET_RUNNER:START',()=>{try{this.api.start();}catch(e){this._error('listener:START',e);}});
bus.on('REQ:NET_RUNNER:STOP',()=>{try{this.api.stop();}catch(e){this._error('listener:STOP',e);}});
bus.on('REQ:NET_RUNNER:ENABLE',()=>{try{this.api.enable();}catch(e){this._error('listener:ENABLE',e);}});
bus.on('REQ:NET_RUNNER:DISABLE',()=>{try{this.api.disable();}catch(e){this._error('listener:DISABLE',e);}});
bus.on('REQ:NET_RUNNER:THEME',(p)=>{try{p=p||{};this.api.setTheme(p.name);}catch(e){this._error('listener:THEME',e);}});
bus.on('REQ:NET_RUNNER:OPACITY',(p)=>{try{p=p||{};this.api.setOpacity(p.value);}catch(e){this._error('listener:OPACITY',e);}});
bus.on('REQ:NET_RUNNER:ZINDEX',(p)=>{try{p=p||{};this.api.setZIndex(p.value);}catch(e){this._error('listener:ZINDEX',e);}});
bus.on('REQ:NET_RUNNER:SNAPSHOT',()=>{try{this._emit('EVT:NET_RUNNER:STATE',{id:this.id,state:this.api.status(),ts:Date.now()});}catch(e){this._error('listener:SNAPSHOT',e);}});
bus.on('REQ:NET_RUNNER:STATUS',()=>{try{this._emit('EVT:NET_RUNNER:STATUS',{id:this.id,state:this.api.status(),ts:Date.now()});}catch(e){this._error('listener:STATUS',e);}});
if(typeof document!=='undefined'&&document&&document.addEventListener){
document.addEventListener('visibilitychange',()=>{try{this._onVisibility();}catch(e){this._error('visibility',e);}},false);
}
},
_onVisibility:function(){
const cfg=this._state.config;
if(!cfg.pauseWhenHidden) return;
const hidden=(typeof document!=='undefined'&&document&&document.visibilityState==='hidden');
if(hidden) this._tickStop();
else if(this._state.started&&this._state.enabled) this._tickStart();
},
_ensureLayer:function(){
try{
if(typeof document==='undefined') return null;
let el=document.getElementById(this._state.layerId);
if(el) return el;
el=document.createElement('div');
el.id=this._state.layerId;
el.setAttribute('data-kog-engine',this.id);
el.style.position='fixed';
el.style.left='0';
el.style.top='0';
el.style.width='100%';
el.style.height='100%';
el.style.pointerEvents='none';
el.style.zIndex=String(this._state.zIndex);
el.style.opacity=String(this._state.opacity);
el.style.backgroundRepeat='repeat';
el.style.backgroundPosition='0 0';
el.style.willChange='transform,opacity,filter,background-position';
el.style.transform='translateZ(0)';
el.style.filter='none';
document.body.appendChild(el);
return el;
}catch(e){
this._error('ensureLayer',e);
return null;
}
},
_applyTheme:function(name,first){
const theme=this._state.themes[name]||this._state.themes[this._state.config.defaultTheme];
const el=this._ensureLayer();
if(!el||!theme) return;
el.style.backgroundImage=theme.css;
if(first) return;
},
_applyOpacity:function(v,first){
const el=this._ensureLayer();
if(!el) return;
el.style.opacity=String(v);
if(first) return;
},
_applyZ:function(z,first){
const el=this._ensureLayer();
if(!el) return;
el.style.zIndex=String(z);
if(first) return;
},
_layerShow:function(show){
const el=this._ensureLayer();
if(!el) return;
el.style.display=show?'block':'none';
},
_tickStart:function(){
try{
const cfg=this._state.config;
if(cfg.respectReducedMotion&&typeof window!=='undefined'&&window.matchMedia){
const mm=window.matchMedia('(prefers-reduced-motion: reduce)');
if(mm&&mm.matches) return;
}
this._tickStop();
const el=this._ensureLayer();
if(!el) return;
let t0=0;
const step=()=>{
if(!this._state.started||!this._state.enabled) return;
const hidden=(this._state.config.pauseWhenHidden&&(typeof document!=='undefined'&&document&&document.visibilityState==='hidden'));
if(hidden) return;
t0=(t0||performance.now());
const t1=performance.now();
const dt=t1-t0;
t0=t1;
const x=(Math.sin(t1/1200)*24);
const y=(Math.cos(t1/1400)*24);
el.style.backgroundPosition=`${x}px ${y}px`;
this._timers.tick=window.requestAnimationFrame(step);
};
if(typeof window!=='undefined'&&window.requestAnimationFrame) this._timers.tick=window.requestAnimationFrame(step);
}catch(e){
this._error('tick',e);
}
},
_tickStop:function(){
try{
if(typeof window==='undefined') return;
if(this._timers.tick&&window.cancelAnimationFrame) window.cancelAnimationFrame(this._timers.tick);
this._timers.tick=0;
}catch(e){
this._error('tickStop',e);
}
},
_emit:function(evt,payload){
try{
const ctx=this._ctx;
const bus=ctx&&ctx.bus?ctx.bus:null;
if(!bus||typeof bus.emit!=='function') return;
bus.emit(evt,payload||{id:this.id,ts:Date.now()});
}catch(e){
this._error('emit',e);
}
},
_log:function(level,msg){
const ctx=this._ctx;
if(!ctx||!ctx.log) return;
try{
if(typeof ctx.log[level]==='function') ctx.log[level]('NET_RUNNER',msg);
else if(typeof ctx.log==='function') ctx.log('NET_RUNNER',msg);
}catch(_e){}
},
_error:function(where,e){
const msg=(e&&e.message)?e.message:String(e);
this._state.lastError=msg;
this._emit('EVT:NET_RUNNER:ERROR',{id:this.id,where,error:msg,ts:Date.now()});
this._log('warn',`${where}: ${msg}`);
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_NET_RUNNER.id]=Engine_NET_RUNNER;
/*-- üï∂Ô∏èüíª-(4A)-(E)-(BACKGROUND-ENGINE)-(NET-RUNNER)-(E)-(4A)-üíªüï∂Ô∏è --*/
/*-- üß†‚ö°-(5A)-(S)-(FULLSCREEN-ENGINE)-(VOID-WALKER)-(S)-(5A)-‚ö°üß† --*/
const Engine_VOID_WALKER={
id:'VOID_WALKER',
version:'1.0.1',
_ctx:null,
_state:{
enabled:true,
mounted:false,
started:false,
lastError:null,
isFullscreen:false,
hasFS:false,
el:null,
config:{
target:'documentElement',
autoMount:true,
listenKeys:true,
keyToggle:'KeyF',
keyExit:'Escape',
dblClickToggle:true,
touchToggle:false,
minIntervalMs:400
},
lastToggleAt:0
},
_wireOnce:false,
init:function(ctx){
this._ctx=ctx||null;
try{
this._state.hasFS=this._detectFS();
this._wire();
if(this._state.config.autoMount) this.api.mount();
this._emit('EVT:VOID_WALKER:READY',{id:this.id,state:this.api.status(),ts:Date.now()});
this._log('info','VOID_WALKER Online');
}catch(e){
this._error('init',e);
}
},
api:{
mount:function(){
try{
const self=Engine_VOID_WALKER;
if(self._state.mounted){self._emit('EVT:VOID_WALKER:MOUNTED',{id:self.id,state:self.api.status(),ts:Date.now()});return true;}
self._state.el=self._resolveTarget(self._state.config.target);
self._state.mounted=true;
self._syncState(true);
self._emit('EVT:VOID_WALKER:MOUNTED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:VOID_WALKER:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_VOID_WALKER._error('mount',e);
return false;
}
},
start:function(){
try{
const self=Engine_VOID_WALKER;
if(self._state.started) return true;
if(!self._state.mounted) self.api.mount();
self._state.started=true;
self._bindInputs(true);
self._emit('EVT:VOID_WALKER:STARTED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:VOID_WALKER:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_VOID_WALKER._error('start',e);
return false;
}
},
stop:function(){
try{
const self=Engine_VOID_WALKER;
if(!self._state.started) return true;
self._state.started=false;
self._bindInputs(false);
self._emit('EVT:VOID_WALKER:STOPPED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:VOID_WALKER:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_VOID_WALKER._error('stop',e);
return false;
}
},
enable:function(){
try{
const self=Engine_VOID_WALKER;
self._state.enabled=true;
if(self._state.started) self._bindInputs(true);
self._emit('EVT:VOID_WALKER:ENABLED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:VOID_WALKER:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_VOID_WALKER._error('enable',e);
return false;
}
},
disable:function(){
try{
const self=Engine_VOID_WALKER;
self._state.enabled=false;
self._bindInputs(false);
self._emit('EVT:VOID_WALKER:DISABLED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:VOID_WALKER:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_VOID_WALKER._error('disable',e);
return false;
}
},
toggle:function(){
try{
const self=Engine_VOID_WALKER;
if(!self._state.enabled) return false;
if(!self._state.hasFS){self._emit('EVT:VOID_WALKER:ERROR',{id:self.id,where:'toggle',error:'fullscreen_not_supported',ts:Date.now()});return false;}
if(!self._cooldown()) return false;
if(self._state.isFullscreen) return self.api.exit();
return self.api.enter();
}catch(e){
Engine_VOID_WALKER._error('toggle',e);
return false;
}
},
enter:function(){
try{
const self=Engine_VOID_WALKER;
if(!self._state.enabled) return false;
if(!self._state.hasFS) return false;
if(!self._cooldown()) return false;
const el=self._state.el||self._resolveTarget(self._state.config.target)||document.documentElement;
const req=el.requestFullscreen||el.webkitRequestFullscreen||el.mozRequestFullScreen||el.msRequestFullscreen;
if(!req){self._emit('EVT:VOID_WALKER:ERROR',{id:self.id,where:'enter',error:'requestFullscreen_missing',ts:Date.now()});return false;}
req.call(el);
self._state.lastToggleAt=Date.now();
self._emit('EVT:VOID_WALKER:REQUESTED',{id:self.id,action:'enter',ts:Date.now()});
return true;
}catch(e){
Engine_VOID_WALKER._error('enter',e);
return false;
}
},
exit:function(){
try{
const self=Engine_VOID_WALKER;
if(!self._state.enabled) return false;
if(!self._state.hasFS) return false;
if(!self._cooldown()) return false;
const doc=document;
const ex=doc.exitFullscreen||doc.webkitExitFullscreen||doc.mozCancelFullScreen||doc.msExitFullscreen;
if(!ex){self._emit('EVT:VOID_WALKER:ERROR',{id:self.id,where:'exit',error:'exitFullscreen_missing',ts:Date.now()});return false;}
ex.call(doc);
self._state.lastToggleAt=Date.now();
self._emit('EVT:VOID_WALKER:REQUESTED',{id:self.id,action:'exit',ts:Date.now()});
return true;
}catch(e){
Engine_VOID_WALKER._error('exit',e);
return false;
}
},
setConfig:function(p){
try{
const self=Engine_VOID_WALKER;
p=p||{};
const c=self._state.config;
if(typeof p.target==='string') c.target=p.target;
if(typeof p.autoMount==='boolean') c.autoMount=p.autoMount;
if(typeof p.listenKeys==='boolean') c.listenKeys=p.listenKeys;
if(typeof p.keyToggle==='string') c.keyToggle=p.keyToggle;
if(typeof p.keyExit==='string') c.keyExit=p.keyExit;
if(typeof p.dblClickToggle==='boolean') c.dblClickToggle=p.dblClickToggle;
if(typeof p.touchToggle==='boolean') c.touchToggle=p.touchToggle;
if(isFinite(p.minIntervalMs)){c.minIntervalMs=parseInt(p.minIntervalMs,10);if(c.minIntervalMs<100) c.minIntervalMs=100;if(c.minIntervalMs>4000) c.minIntervalMs=4000;}
self._state.el=self._resolveTarget(c.target);
if(self._state.started) self._bindInputs(true);
self._emit('EVT:VOID_WALKER:CONFIG',{id:self.id,config:Object.assign({},c),ts:Date.now()});
self._emit('EVT:VOID_WALKER:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_VOID_WALKER._error('setConfig',e);
return false;
}
},
snapshot:function(){
const self=Engine_VOID_WALKER;
return {id:self.id,state:self.api.status(),ts:Date.now()};
},
status:function(){
const s=Engine_VOID_WALKER._state;
return {id:Engine_VOID_WALKER.id,version:Engine_VOID_WALKER.version,enabled:s.enabled,mounted:s.mounted,started:s.started,isFullscreen:s.isFullscreen,hasFS:s.hasFS,target:s.config.target,ts:Date.now()};
}
},
_wire:function(){
if(this._wireOnce) return;
this._wireOnce=true;
const ctx=this._ctx;
const bus=ctx&&ctx.bus?ctx.bus:null;
if(bus&&typeof bus.on==='function'){
bus.on('REQ:VOID_WALKER:MOUNT',()=>{try{this.api.mount();}catch(e){this._error('listener:MOUNT',e);}});
bus.on('REQ:VOID_WALKER:START',()=>{try{this.api.start();}catch(e){this._error('listener:START',e);}});
bus.on('REQ:VOID_WALKER:STOP',()=>{try{this.api.stop();}catch(e){this._error('listener:STOP',e);}});
bus.on('REQ:VOID_WALKER:ENABLE',()=>{try{this.api.enable();}catch(e){this._error('listener:ENABLE',e);}});
bus.on('REQ:VOID_WALKER:DISABLE',()=>{try{this.api.disable();}catch(e){this._error('listener:DISABLE',e);}});
bus.on('REQ:VOID_WALKER:TOGGLE',()=>{try{this.api.toggle();}catch(e){this._error('listener:TOGGLE',e);}});
bus.on('REQ:VOID_WALKER:ENTER',()=>{try{this.api.enter();}catch(e){this._error('listener:ENTER',e);}});
bus.on('REQ:VOID_WALKER:EXIT',()=>{try{this.api.exit();}catch(e){this._error('listener:EXIT',e);}});
bus.on('REQ:VOID_WALKER:CONFIG',(p)=>{try{this.api.setConfig(p);}catch(e){this._error('listener:CONFIG',e);}});
bus.on('REQ:VOID_WALKER:SNAPSHOT',()=>{try{this._emit('EVT:VOID_WALKER:STATE',{id:this.id,state:this.api.status(),ts:Date.now()});}catch(e){this._error('listener:SNAPSHOT',e);}});
bus.on('REQ:VOID_WALKER:STATUS',()=>{try{this._emit('EVT:VOID_WALKER:STATUS',{id:this.id,state:this.api.status(),ts:Date.now()});}catch(e){this._error('listener:STATUS',e);}});
}
this._bindFSChange(true);
},
_bindInputs:function(on){
try{
const c=this._state.config;
const active=!!(on&&this._state.enabled&&this._state.started);
this._unbindInputs();
if(!active) return;
if(typeof document==='undefined') return;
if(c.listenKeys) document.addEventListener('keydown',this._onKeyDown,true);
if(c.dblClickToggle) document.addEventListener('dblclick',this._onDblClick,true);
if(c.touchToggle) document.addEventListener('touchstart',this._onTouch,true);
}catch(e){
this._error('bindInputs',e);
}
},
_unbindInputs:function(){
try{
if(typeof document==='undefined') return;
document.removeEventListener('keydown',this._onKeyDown,true);
document.removeEventListener('dblclick',this._onDblClick,true);
document.removeEventListener('touchstart',this._onTouch,true);
}catch(e){
this._error('unbindInputs',e);
}
},
_bindFSChange:function(on){
try{
if(typeof document==='undefined') return;
const fn=this._onFSChange;
const events=['fullscreenchange','webkitfullscreenchange','mozfullscreenchange','MSFullscreenChange'];
events.forEach((ev)=>{if(on) document.addEventListener(ev,fn,true); else document.removeEventListener(ev,fn,true);});
}catch(e){
this._error('bindFSChange',e);
}
},
_onFSChange:function(){
try{
Engine_VOID_WALKER._syncState(false);
}catch(e){
Engine_VOID_WALKER._error('fschange',e);
}
},
_syncState:function(first){
try{
const doc=document;
const fsEl=doc.fullscreenElement||doc.webkitFullscreenElement||doc.mozFullScreenElement||doc.msFullscreenElement;
const isFS=!!fsEl;
const prev=this._state.isFullscreen;
this._state.isFullscreen=isFS;
if(first) return;
if(prev!==isFS){
this._emit('EVT:VOID_WALKER:CHANGED',{id:this.id,isFullscreen:isFS,ts:Date.now()});
this._emit('EVT:VOID_WALKER:STATE',{id:this.id,state:this.api.status(),ts:Date.now()});
}
}catch(e){
this._error('syncState',e);
}
},
_onKeyDown:function(e){
try{
const self=Engine_VOID_WALKER;
if(!self._state.enabled||!self._state.started) return;
e=e||{};
const code=e.code||e.key||'';
if(code===self._state.config.keyExit&&self._state.isFullscreen){self.api.exit();return;}
if(code===self._state.config.keyToggle){self.api.toggle();return;}
}catch(err){
Engine_VOID_WALKER._error('keydown',err);
}
},
_onDblClick:function(_e){
try{
const self=Engine_VOID_WALKER;
if(!self._state.enabled||!self._state.started) return;
self.api.toggle();
}catch(err){
Engine_VOID_WALKER._error('dblclick',err);
}
},
_onTouch:function(e){
try{
const self=Engine_VOID_WALKER;
if(!self._state.enabled||!self._state.started) return;
e=e||{};
const t=e.touches?e.touches.length:0;
if(t===3) self.api.toggle();
}catch(err){
Engine_VOID_WALKER._error('touch',err);
}
},
_cooldown:function(){
const now=Date.now();
const ms=this._state.config.minIntervalMs||400;
if(now-(this._state.lastToggleAt||0)<ms) return false;
return true;
},
_resolveTarget:function(sel){
try{
if(typeof document==='undefined') return null;
if(sel==='documentElement') return document.documentElement;
if(sel==='body') return document.body;
if(sel&&sel[0]==='#') return document.getElementById(sel.slice(1));
if(sel&&sel[0]==='.') return document.querySelector(sel);
if(sel&&sel.indexOf('[')===0) return document.querySelector(sel);
return document.documentElement;
}catch(e){
this._error('resolveTarget',e);
return document.documentElement;
}
},
_detectFS:function(){
try{
if(typeof document==='undefined') return false;
const el=document.documentElement;
return !!(el.requestFullscreen||el.webkitRequestFullscreen||el.mozRequestFullScreen||el.msRequestFullscreen);
}catch(_e){
return false;
}
},
_emit:function(evt,payload){
try{
const ctx=this._ctx;
const bus=ctx&&ctx.bus?ctx.bus:null;
if(!bus||typeof bus.emit!=='function') return;
bus.emit(evt,payload||{id:this.id,ts:Date.now()});
}catch(e){
this._error('emit',e);
}
},
_log:function(level,msg){
const ctx=this._ctx;
if(!ctx||!ctx.log) return;
try{
if(typeof ctx.log[level]==='function') ctx.log[level]('VOID_WALKER',msg);
else if(typeof ctx.log==='function') ctx.log('VOID_WALKER',msg);
}catch(_e){}
},
_error:function(where,e){
const msg=(e&&e.message)?e.message:String(e);
this._state.lastError=msg;
this._emit('EVT:VOID_WALKER:ERROR',{id:this.id,where,error:msg,ts:Date.now()});
this._log('warn',`${where}: ${msg}`);
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_VOID_WALKER.id]=Engine_VOID_WALKER;
/*-- üß†‚ö°-(5A)-(E)-(FULLSCREEN-ENGINE)-(VOID-WALKER)-(E)-(5A)-‚ö°üß† --*/
/*-- üó°Ô∏èüèØ-(6A)-(S)-(PARTICLE-FLUX-ENGINE)-(NEON-BLADE)-(S)-(6A)-üèØüó°Ô∏è --*/
const Engine_NEON_BLADE={
id:'NEON_BLADE',
version:'1.0.1',
_ctx:null,
_state:{
enabled:true,
mounted:false,
started:false,
lastError:null,
config:{
maxParticles:180,
spawnRate:18,
lifeMs:900,
lifeJitter:450,
speed:0.65,
speedJitter:0.55,
size:2.1,
sizeJitter:1.6,
gravity:0.02,
drag:0.985,
fade:0.985,
burstOnEvent:true,
burstCount:24,
canvasSelector:null,
zIndex:9999,
pointerFollow:true,
pointerDownBoost:true,
pointerBoost:2.2,
qualityScale:1.0,
minDt:8,
maxDt:48
},
metrics:{
count:0,
spawns:0,
bursts:0,
lastBurstAt:0,
fps:0
},
canvas:null,
g:null,
w:0,
h:0,
dpr:1,
raf:0,
lastT:0,
accum:0,
mouse:{x:0,y:0,down:false,has:false},
parts:[],
pool:[]
},
_wireOnce:false,
init:function(ctx){
this._ctx=ctx||null;
try{
this._wire();
this.api.mount();
this._emit('EVT:NEON_BLADE:READY',{id:this.id,state:this.api.status(),ts:Date.now()});
this._log('info','NEON_BLADE Online');
}catch(e){
this._error('init',e);
}
},
api:{
mount:function(){
try{
const self=Engine_NEON_BLADE;
if(self._state.mounted){self._emit('EVT:NEON_BLADE:MOUNTED',{id:self.id,state:self.api.status(),ts:Date.now()});return true;}
self._ensureCanvas();
self._bindResize(true);
self._bindPointer(true);
self._state.mounted=true;
self._resize();
self._emit('EVT:NEON_BLADE:MOUNTED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:NEON_BLADE:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_NEON_BLADE._error('mount',e);
return false;
}
},
start:function(){
try{
const self=Engine_NEON_BLADE;
if(self._state.started) return true;
if(!self._state.mounted) self.api.mount();
self._state.started=true;
self._state.lastT=self._now();
self._loop();
self._emit('EVT:NEON_BLADE:STARTED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:NEON_BLADE:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_NEON_BLADE._error('start',e);
return false;
}
},
stop:function(){
try{
const self=Engine_NEON_BLADE;
if(!self._state.started) return true;
self._state.started=false;
if(self._state.raf) cancelAnimationFrame(self._state.raf);
self._state.raf=0;
self._emit('EVT:NEON_BLADE:STOPPED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:NEON_BLADE:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_NEON_BLADE._error('stop',e);
return false;
}
},
enable:function(){
try{
const self=Engine_NEON_BLADE;
self._state.enabled=true;
self._emit('EVT:NEON_BLADE:ENABLED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:NEON_BLADE:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_NEON_BLADE._error('enable',e);
return false;
}
},
disable:function(){
try{
const self=Engine_NEON_BLADE;
self._state.enabled=false;
self.api.stop();
self._emit('EVT:NEON_BLADE:DISABLED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:NEON_BLADE:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_NEON_BLADE._error('disable',e);
return false;
}
},
burst:function(x,y,count){
try{
const self=Engine_NEON_BLADE;
if(!self._state.enabled) return false;
count=isFinite(count)?parseInt(count,10):(self._state.config.burstCount||24);
if(count<1) count=1;
if(count>400) count=400;
self._burstAt(x,y,count);
return true;
}catch(e){
Engine_NEON_BLADE._error('burst',e);
return false;
}
},
setConfig:function(p){
try{
const self=Engine_NEON_BLADE;
p=p||{};
const c=self._state.config;
if(isFinite(p.maxParticles)) c.maxParticles=self._clampInt(p.maxParticles,20,2000);
if(isFinite(p.spawnRate)) c.spawnRate=self._clampInt(p.spawnRate,0,400);
if(isFinite(p.lifeMs)) c.lifeMs=self._clampInt(p.lifeMs,120,12000);
if(isFinite(p.lifeJitter)) c.lifeJitter=self._clampInt(p.lifeJitter,0,12000);
if(isFinite(p.speed)) c.speed=self._clamp(p.speed,0,10);
if(isFinite(p.speedJitter)) c.speedJitter=self._clamp(p.speedJitter,0,10);
if(isFinite(p.size)) c.size=self._clamp(p.size,0.5,40);
if(isFinite(p.sizeJitter)) c.sizeJitter=self._clamp(p.sizeJitter,0,40);
if(isFinite(p.gravity)) c.gravity=self._clamp(p.gravity,-2,2);
if(isFinite(p.drag)) c.drag=self._clamp(p.drag,0.85,1.0);
if(isFinite(p.fade)) c.fade=self._clamp(p.fade,0.85,0.9999);
if(typeof p.burstOnEvent==='boolean') c.burstOnEvent=p.burstOnEvent;
if(isFinite(p.burstCount)) c.burstCount=self._clampInt(p.burstCount,0,400);
if(typeof p.canvasSelector==='string') c.canvasSelector=p.canvasSelector;
if(isFinite(p.zIndex)) c.zIndex=self._clampInt(p.zIndex,-9999,99999);
if(typeof p.pointerFollow==='boolean') c.pointerFollow=p.pointerFollow;
if(typeof p.pointerDownBoost==='boolean') c.pointerDownBoost=p.pointerDownBoost;
if(isFinite(p.pointerBoost)) c.pointerBoost=self._clamp(p.pointerBoost,1,8);
if(isFinite(p.qualityScale)) c.qualityScale=self._clamp(p.qualityScale,0.25,2.0);
if(isFinite(p.minDt)) c.minDt=self._clampInt(p.minDt,1,33);
if(isFinite(p.maxDt)) c.maxDt=self._clampInt(p.maxDt,16,120);
if(c.maxDt<c.minDt) c.maxDt=c.minDt;
self._ensureCanvas();
self._resize();
self._emit('EVT:NEON_BLADE:CONFIG',{id:self.id,config:Object.assign({},c),ts:Date.now()});
self._emit('EVT:NEON_BLADE:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_NEON_BLADE._error('setConfig',e);
return false;
}
},
clear:function(){
try{
const self=Engine_NEON_BLADE;
self._state.parts.length=0;
self._state.pool.length=0;
self._state.metrics.count=0;
self._draw(true);
self._emit('EVT:NEON_BLADE:CLEARED',{id:self.id,ts:Date.now()});
self._emit('EVT:NEON_BLADE:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_NEON_BLADE._error('clear',e);
return false;
}
},
snapshot:function(){
const self=Engine_NEON_BLADE;
return {id:self.id,state:self.api.status(),ts:Date.now()};
},
status:function(){
const s=Engine_NEON_BLADE._state;
const c=s.config;
return {id:Engine_NEON_BLADE.id,version:Engine_NEON_BLADE.version,enabled:s.enabled,mounted:s.mounted,started:s.started,count:s.metrics.count,spawns:s.metrics.spawns,bursts:s.metrics.bursts,fps:s.metrics.fps,canvas:!!s.canvas,w:s.w,h:s.h,dpr:s.dpr,config:Object.assign({},c),lastError:s.lastError,ts:Date.now()};
}
},
_wire:function(){
if(this._wireOnce) return;
this._wireOnce=true;
const ctx=this._ctx;
const bus=ctx&&ctx.bus?ctx.bus:null;
if(bus&&typeof bus.on==='function'){
bus.on('REQ:NEON_BLADE:MOUNT',()=>{try{this.api.mount();}catch(e){this._error('listener:MOUNT',e);}});
bus.on('REQ:NEON_BLADE:START',()=>{try{this.api.start();}catch(e){this._error('listener:START',e);}});
bus.on('REQ:NEON_BLADE:STOP',()=>{try{this.api.stop();}catch(e){this._error('listener:STOP',e);}});
bus.on('REQ:NEON_BLADE:ENABLE',()=>{try{this.api.enable();}catch(e){this._error('listener:ENABLE',e);}});
bus.on('REQ:NEON_BLADE:DISABLE',()=>{try{this.api.disable();}catch(e){this._error('listener:DISABLE',e);}});
bus.on('REQ:NEON_BLADE:CONFIG',(p)=>{try{this.api.setConfig(p);}catch(e){this._error('listener:CONFIG',e);}});
bus.on('REQ:NEON_BLADE:BURST',(p)=>{try{p=p||{};this.api.burst(p.x,p.y,p.count);}catch(e){this._error('listener:BURST',e);}});
bus.on('REQ:NEON_BLADE:CLEAR',()=>{try{this.api.clear();}catch(e){this._error('listener:CLEAR',e);}});
bus.on('REQ:NEON_BLADE:SNAPSHOT',()=>{try{this._emit('EVT:NEON_BLADE:STATE',{id:this.id,state:this.api.status(),ts:Date.now()});}catch(e){this._error('listener:SNAPSHOT',e);}});
bus.on('REQ:NEON_BLADE:STATUS',()=>{try{this._emit('EVT:NEON_BLADE:STATUS',{id:this.id,state:this.api.status(),ts:Date.now()});}catch(e){this._error('listener:STATUS',e);}});
}
},
_ensureCanvas:function(){
try{
const s=this._state;
const c=s.config;
let cv=null;
if(c.canvasSelector&&typeof document!=='undefined') cv=document.querySelector(c.canvasSelector);
if(!cv&&typeof document!=='undefined') cv=document.getElementById('kog-neonblade-canvas');
if(!cv&&typeof document!=='undefined'){
cv=document.createElement('canvas');
cv.id='kog-neonblade-canvas';
document.body.appendChild(cv);
}
if(!cv) return;
cv.style.position='fixed';
cv.style.left='0';
cv.style.top='0';
cv.style.width='100%';
cv.style.height='100%';
cv.style.pointerEvents='none';
cv.style.zIndex=String(c.zIndex);
s.canvas=cv;
s.g=cv.getContext&&cv.getContext('2d');
s.dpr=(window&&window.devicePixelRatio)?window.devicePixelRatio:1;
}catch(e){
this._error('ensureCanvas',e);
}
},
_bindResize:function(on){
try{
if(typeof window==='undefined') return;
const fn=this._onResize;
if(on) window.addEventListener('resize',fn,true);
else window.removeEventListener('resize',fn,true);
}catch(e){
this._error('bindResize',e);
}
},
_onResize:function(){
try{
Engine_NEON_BLADE._resize();
}catch(e){
Engine_NEON_BLADE._error('resize',e);
}
},
_resize:function(){
try{
const s=this._state;
if(!s.canvas) return;
const dpr=(window&&window.devicePixelRatio)?window.devicePixelRatio:1;
s.dpr=dpr;
const qs=s.config.qualityScale||1.0;
const w=Math.max(1,(window&&window.innerWidth)?window.innerWidth:1);
const h=Math.max(1,(window&&window.innerHeight)?window.innerHeight:1);
s.w=w;
s.h=h;
s.canvas.width=Math.max(1,Math.floor(w*dpr*qs));
s.canvas.height=Math.max(1,Math.floor(h*dpr*qs));
if(s.g&&s.g.setTransform) s.g.setTransform(1,0,0,1,0,0);
this._draw(true);
this._emit('EVT:NEON_BLADE:RESIZED',{id:this.id,w:s.w,h:s.h,dpr:s.dpr,ts:Date.now()});
}catch(e){
this._error('resize',e);
}
},
_bindPointer:function(on){
try{
if(typeof window==='undefined') return;
const s=this._state;
const mv=this._onMove;
const dn=this._onDown;
const up=this._onUp;
if(on){
window.addEventListener('pointermove',mv,true);
window.addEventListener('pointerdown',dn,true);
window.addEventListener('pointerup',up,true);
window.addEventListener('pointercancel',up,true);
}else{
window.removeEventListener('pointermove',mv,true);
window.removeEventListener('pointerdown',dn,true);
window.removeEventListener('pointerup',up,true);
window.removeEventListener('pointercancel',up,true);
}
}catch(e){
this._error('bindPointer',e);
}
},
_onMove:function(e){
try{
const self=Engine_NEON_BLADE;
const m=self._state.mouse;
m.x=isFinite(e.clientX)?e.clientX:0;
m.y=isFinite(e.clientY)?e.clientY:0;
m.has=true;
}catch(err){
Engine_NEON_BLADE._error('pointermove',err);
}
},
_onDown:function(e){
try{
const self=Engine_NEON_BLADE;
self._state.mouse.down=true;
if(self._state.config.burstOnEvent) self._burstAt(e.clientX,e.clientY,self._state.config.burstCount||24);
}catch(err){
Engine_NEON_BLADE._error('pointerdown',err);
}
},
_onUp:function(_e){
try{
Engine_NEON_BLADE._state.mouse.down=false;
}catch(err){
Engine_NEON_BLADE._error('pointerup',err);
}
},
_loop:function(){
try{
const s=this._state;
if(!s.started) return;
s.raf=requestAnimationFrame(()=>{Engine_NEON_BLADE._loop();});
if(!s.enabled) return;
const now=this._now();
let dt=now-(s.lastT||now);
s.lastT=now;
dt=this._clamp(dt,s.config.minDt||8,s.config.maxDt||48);
this._step(dt);
this._draw(false);
}catch(e){
this._error('loop',e);
}
},
_step:function(dt){
try{
const s=this._state;
const c=s.config;
const parts=s.parts;
const pool=s.pool;
const maxP=c.maxParticles||180;
let rate=c.spawnRate||0;
if(c.pointerDownBoost&&s.mouse.down) rate=Math.floor(rate*(c.pointerBoost||2.2));
if(!c.pointerFollow||!s.mouse.has) rate=Math.floor(rate*0.35);
s.accum+=dt;
const stepMs=1000/60;
let spawnN=0;
while(s.accum>=stepMs){
s.accum-=stepMs;
spawnN+=rate/60;
}
const toSpawn=Math.min(maxP-parts.length,Math.floor(spawnN));
if(toSpawn>0) this._spawnAt(s.mouse.x,s.mouse.y,toSpawn);
let i=parts.length;
const g=c.gravity||0;
const drag=c.drag||0.985;
const fade=c.fade||0.985;
while(i--){
const p=parts[i];
p.vy+=g*dt;
p.vx*=Math.pow(drag,dt/16.67);
p.vy*=Math.pow(drag,dt/16.67);
p.x+=p.vx*dt;
p.y+=p.vy*dt;
p.a*=Math.pow(fade,dt/16.67);
p.life-=dt;
if(p.life<=0||p.a<=0.02||p.x<-100||p.y<-100||p.x>s.w+100||p.y>s.h+100){
parts.splice(i,1);
pool.push(p);
}
}
s.metrics.count=parts.length;
}catch(e){
this._error('step',e);
}
},
_spawnAt:function(x,y,n){
try{
const s=this._state;
const c=s.config;
const parts=s.parts;
const pool=s.pool;
x=isFinite(x)?x:(s.w*0.5);
y=isFinite(y)?y:(s.h*0.5);
let i=0;
while(i<n){
const p=pool.length?pool.pop():{x:0,y:0,vx:0,vy:0,r:2,a:1,life:500};
const ang=Math.random()*Math.PI*2;
const sp=(c.speed||0.65)+(Math.random()*(c.speedJitter||0.55));
p.x=x;
p.y=y;
p.vx=Math.cos(ang)*sp;
p.vy=Math.sin(ang)*sp;
p.r=(c.size||2.1)+(Math.random()*(c.sizeJitter||1.6));
if(p.r<0.5) p.r=0.5;
if(p.r>60) p.r=60;
p.a=1;
p.life=(c.lifeMs||900)+(Math.random()*(c.lifeJitter||450));
if(p.life<80) p.life=80;
if(p.life>20000) p.life=20000;
parts.push(p);
i++;
}
s.metrics.spawns+=n;
}catch(e){
this._error('spawnAt',e);
}
},
_burstAt:function(x,y,n){
try{
const s=this._state;
const now=Date.now();
s.metrics.bursts+=1;
s.metrics.lastBurstAt=now;
this._spawnAt(x,y,n);
this._emit('EVT:NEON_BLADE:BURST',{id:this.id,x:isFinite(x)?x:null,y:isFinite(y)?y:null,count:n,ts:now});
}catch(e){
this._error('burstAt',e);
}
},
_draw:function(clear){
try{
const s=this._state;
const g=s.g;
if(!g||!s.canvas) return;
if(clear) g.clearRect(0,0,s.canvas.width,s.canvas.height);
else{
g.clearRect(0,0,s.canvas.width,s.canvas.height);
}
const dpr=s.dpr*(s.config.qualityScale||1.0);
g.save();
g.scale(dpr,dpr);
const parts=s.parts;
let i=0;
while(i<parts.length){
const p=parts[i];
g.globalAlpha=p.a;
g.beginPath();
g.arc(p.x,p.y,p.r,0,Math.PI*2);
g.fill();
i++;
}
g.restore();
const t=this._now();
if(!s._fpsT0){s._fpsT0=t;s._fpsN=0;}
s._fpsN++;
if(t-s._fpsT0>=1000){
s.metrics.fps=Math.round((s._fpsN*1000)/(t-s._fpsT0));
s._fpsT0=t;
s._fpsN=0;
}
}catch(e){
this._error('draw',e);
}
},
_now:function(){
try{
return (window&&window.performance&&performance.now)?performance.now():Date.now();
}catch(_e){
return Date.now();
}
},
_clamp:function(v,a,b){
v=+v;
if(v<a) return a;
if(v>b) return b;
return v;
},
_clampInt:function(v,a,b){
v=parseInt(v,10);
if(!isFinite(v)) v=a;
if(v<a) v=a;
if(v>b) v=b;
return v;
},
_emit:function(evt,payload){
try{
const ctx=this._ctx;
const bus=ctx&&ctx.bus?ctx.bus:null;
if(!bus||typeof bus.emit!=='function') return;
bus.emit(evt,payload||{id:this.id,ts:Date.now()});
}catch(e){
this._error('emit',e);
}
},
_log:function(level,msg){
const ctx=this._ctx;
if(!ctx||!ctx.log) return;
try{
if(typeof ctx.log[level]==='function') ctx.log[level]('NEON_BLADE',msg);
else if(typeof ctx.log==='function') ctx.log('NEON_BLADE',msg);
}catch(_e){}
},
_error:function(where,e){
const msg=(e&&e.message)?e.message:String(e);
this._state.lastError=msg;
this._emit('EVT:NEON_BLADE:ERROR',{id:this.id,where,error:msg,ts:Date.now()});
this._log('warn',`${where}: ${msg}`);
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_NEON_BLADE.id]=Engine_NEON_BLADE;
/*-- üó°Ô∏èüèØ-(6A)-(E)-(PARTICLE-FLUX-ENGINE)-(NEON-BLADE)-(E)-(6A)-üèØüó°Ô∏è --*/
/*-- ü¶Åüëë-(7A)-(S)-(COMPONENT-ARMOR-ENGINE)-(TITAN-VANCE)-(S)-(7A)-üëëü¶Å --*/
const Engine_TITAN_VANCE={
id:'TITAN_VANCE',
version:'1.0.1',
_ctx:null,
_state:{
enabled:true,
mounted:false,
started:false,
lastError:null,
config:{
strict:true,
freeze:false,
requiredIds:[
'KING_OF_GODS',
'WILD_CARD',
'IRON_CORE',
'NET_RUNNER',
'VOID_WALKER',
'NEON_BLADE'
],
optionalIds:[
'SHADOW_OPS',
'STORM_BREAKER',
'PRIME_ARCHITECT',
'HYPER_FLUX',
'PIXEL_RONIN',
'DATA_WITCH',
'MECH_WARLORD',
'NIGHT_SHADE',
'BIO_HACKER',
'SOLAR_FLARE',
'CRYPT_KEEPER',
'DOOM_SLAYER',
'ZEN_MONK',
'LORE_MASTER',
'AUDIO_MANCER',
'ZERO_POINT',
'CHRONO_LORD',
'PHOENIX',
'SPACE_ACE',
'DEAL_CLOSER',
'RETRO_WAVE',
'STREET_RAT',
'GOD_MODE'
],
heartbeatMs:3000,
auditMs:6000,
maxMissingBeforePanic:2
},
registry:{
present:{},
missing:[],
optionalMissing:[]
},
heartbeat:{
last:0,
timer:0
},
audit:{
last:0,
timer:0
}
},
_wireOnce:false,
init:function(ctx){
this._ctx=ctx||null;
try{
this._wire();
this.api.mount();
this._emit('EVT:TITAN_VANCE:READY',{id:this.id,state:this.api.status(),ts:Date.now()});
this._log('info','TITAN_VANCE Online');
}catch(e){
this._error('init',e);
}
},
api:{
mount:function(){
try{
const self=Engine_TITAN_VANCE;
if(self._state.mounted){self._emit('EVT:TITAN_VANCE:MOUNTED',{id:self.id,state:self.api.status(),ts:Date.now()});return true;}
self._state.mounted=true;
self._auditNow('mount');
self._emit('EVT:TITAN_VANCE:MOUNTED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:TITAN_VANCE:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_TITAN_VANCE._error('mount',e);
return false;
}
},
start:function(){
try{
const self=Engine_TITAN_VANCE;
if(self._state.started) return true;
self._state.started=true;
self._startTimers();
self._emit('EVT:TITAN_VANCE:STARTED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:TITAN_VANCE:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_TITAN_VANCE._error('start',e);
return false;
}
},
stop:function(){
try{
const self=Engine_TITAN_VANCE;
if(!self._state.started) return true;
self._state.started=false;
self._stopTimers();
self._emit('EVT:TITAN_VANCE:STOPPED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:TITAN_VANCE:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_TITAN_VANCE._error('stop',e);
return false;
}
},
enable:function(){
try{
const self=Engine_TITAN_VANCE;
self._state.enabled=true;
self._emit('EVT:TITAN_VANCE:ENABLED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:TITAN_VANCE:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_TITAN_VANCE._error('enable',e);
return false;
}
},
disable:function(){
try{
const self=Engine_TITAN_VANCE;
self._state.enabled=false;
self._emit('EVT:TITAN_VANCE:DISABLED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:TITAN_VANCE:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_TITAN_VANCE._error('disable',e);
return false;
}
},
audit:function(){
try{
Engine_TITAN_VANCE._auditNow('manual');
return Engine_TITAN_VANCE.api.snapshot();
}catch(e){
Engine_TITAN_VANCE._error('audit',e);
return null;
}
},
snapshot:function(){
const self=Engine_TITAN_VANCE;
return {id:self.id,state:self.api.status(),ts:Date.now()};
},
status:function(){
const s=Engine_TITAN_VANCE._state;
const c=s.config;
const r=s.registry;
return {id:Engine_TITAN_VANCE.id,version:Engine_TITAN_VANCE.version,enabled:s.enabled,mounted:s.mounted,started:s.started,strict:c.strict,freeze:c.freeze,requiredIds:c.requiredIds.slice(0),optionalIds:c.optionalIds.slice(0),present:Object.assign({},r.present),missing:r.missing.slice(0),optionalMissing:r.optionalMissing.slice(0),heartbeatLast:s.heartbeat.last,auditLast:s.audit.last,lastError:s.lastError,ts:Date.now()};
}
},
_wire:function(){
if(this._wireOnce) return;
this._wireOnce=true;
const ctx=this._ctx;
const bus=ctx&&ctx.bus?ctx.bus:null;
if(bus&&typeof bus.on==='function'){
bus.on('REQ:TITAN_VANCE:MOUNT',()=>{try{this.api.mount();}catch(e){this._error('listener:MOUNT',e);}});
bus.on('REQ:TITAN_VANCE:START',()=>{try{this.api.start();}catch(e){this._error('listener:START',e);}});
bus.on('REQ:TITAN_VANCE:STOP',()=>{try{this.api.stop();}catch(e){this._error('listener:STOP',e);}});
bus.on('REQ:TITAN_VANCE:ENABLE',()=>{try{this.api.enable();}catch(e){this._error('listener:ENABLE',e);}});
bus.on('REQ:TITAN_VANCE:DISABLE',()=>{try{this.api.disable();}catch(e){this._error('listener:DISABLE',e);}});
bus.on('REQ:TITAN_VANCE:CONFIG',(p)=>{try{this._setConfig(p);}catch(e){this._error('listener:CONFIG',e);}});
bus.on('REQ:TITAN_VANCE:AUDIT',()=>{try{this._auditNow('req');this._emit('EVT:TITAN_VANCE:AUDIT',{id:this.id,state:this.api.status(),ts:Date.now()});}catch(e){this._error('listener:AUDIT',e);}});
bus.on('REQ:TITAN_VANCE:STATUS',()=>{try{this._emit('EVT:TITAN_VANCE:STATUS',{id:this.id,state:this.api.status(),ts:Date.now()});}catch(e){this._error('listener:STATUS',e);}});
bus.on('REQ:TITAN_VANCE:SNAPSHOT',()=>{try{this._emit('EVT:TITAN_VANCE:STATE',{id:this.id,state:this.api.status(),ts:Date.now()});}catch(e){this._error('listener:SNAPSHOT',e);}});
}
},
_setConfig:function(p){
p=p||{};
const s=this._state;
const c=s.config;
if(typeof p.strict==='boolean') c.strict=p.strict;
if(typeof p.freeze==='boolean') c.freeze=p.freeze;
if(Array.isArray(p.requiredIds)) c.requiredIds=p.requiredIds.filter(x=>typeof x==='string'&&x).slice(0,64);
if(Array.isArray(p.optionalIds)) c.optionalIds=p.optionalIds.filter(x=>typeof x==='string'&&x).slice(0,256);
if(isFinite(p.heartbeatMs)) c.heartbeatMs=this._clampInt(p.heartbeatMs,500,30000);
if(isFinite(p.auditMs)) c.auditMs=this._clampInt(p.auditMs,800,60000);
if(isFinite(p.maxMissingBeforePanic)) c.maxMissingBeforePanic=this._clampInt(p.maxMissingBeforePanic,0,50);
this._startTimers();
this._emit('EVT:TITAN_VANCE:CONFIG',{id:this.id,config:Object.assign({},c),ts:Date.now()});
this._emit('EVT:TITAN_VANCE:STATE',{id:this.id,state:this.api.status(),ts:Date.now()});
},
_startTimers:function(){
const s=this._state;
const c=s.config;
this._stopTimers();
if(!s.started) return;
if(!s.enabled) return;
s.heartbeat.timer=setInterval(()=>{try{Engine_TITAN_VANCE._heartbeat();}catch(e){Engine_TITAN_VANCE._error('heartbeat',e);}},c.heartbeatMs||3000);
s.audit.timer=setInterval(()=>{try{Engine_TITAN_VANCE._auditNow('interval');}catch(e){Engine_TITAN_VANCE._error('auditTimer',e);}},c.auditMs||6000);
},
_stopTimers:function(){
const s=this._state;
if(s.heartbeat.timer){clearInterval(s.heartbeat.timer);s.heartbeat.timer=0;}
if(s.audit.timer){clearInterval(s.audit.timer);s.audit.timer=0;}
},
_heartbeat:function(){
const s=this._state;
s.heartbeat.last=Date.now();
this._emit('EVT:TITAN_VANCE:HEARTBEAT',{id:this.id,ts:s.heartbeat.last});
},
_auditNow:function(where){
try{
const s=this._state;
const c=s.config;
const K=(typeof window!=='undefined'&&window.KOG)?window.KOG:{};
const present={};
const missing=[];
const optionalMissing=[];
let i=0;
for(i=0;i<c.requiredIds.length;i++){
const id=c.requiredIds[i];
present[id]=!!(K&&K[id]);
if(!present[id]) missing.push(id);
}
for(i=0;i<c.optionalIds.length;i++){
const id=c.optionalIds[i];
if(!(K&&K[id])) optionalMissing.push(id);
}
s.registry.present=present;
s.registry.missing=missing;
s.registry.optionalMissing=optionalMissing;
s.audit.last=Date.now();
const payload={id:this.id,where,requiredMissing:missing.slice(0),optionalMissing:optionalMissing.slice(0),present:Object.assign({},present),score:this._score(missing.length),ts:s.audit.last};
this._emit('EVT:TITAN_VANCE:AUDIT',payload);
this._emit('EVT:TITAN_VANCE:STATE',{id:this.id,state:this.api.status(),ts:Date.now()});
if(c.freeze&&missing.length){
this._emit('EVT:TITAN_VANCE:FREEZE',{id:this.id,missing:missing.slice(0),ts:Date.now()});
}
if(c.strict&&missing.length){
const mode=(missing.length>=(c.maxMissingBeforePanic||2))?'PANIC':'WARN';
this._emit('EVT:TITAN_VANCE:ALERT',{id:this.id,mode,missing:missing.slice(0),ts:Date.now()});
}
}catch(e){
this._error('auditNow',e);
}
},
_score:function(missingCount){
const c=this._state.config;
let score=0;
if(missingCount<=0) score=0;
else score=Math.min(100,missingCount*25);
if(missingCount>=(c.maxMissingBeforePanic||2)) score=Math.min(100,score+25);
return score;
},
_clampInt:function(v,a,b){
v=parseInt(v,10);
if(!isFinite(v)) v=a;
if(v<a) v=a;
if(v>b) v=b;
return v;
},
_emit:function(evt,payload){
try{
const ctx=this._ctx;
const bus=ctx&&ctx.bus?ctx.bus:null;
if(!bus||typeof bus.emit!=='function') return;
bus.emit(evt,payload||{id:this.id,ts:Date.now()});
}catch(e){
this._error('emit',e);
}
},
_log:function(level,msg){
const ctx=this._ctx;
if(!ctx||!ctx.log) return;
try{
if(typeof ctx.log[level]==='function') ctx.log[level]('TITAN_VANCE',msg);
else if(typeof ctx.log==='function') ctx.log('TITAN_VANCE',msg);
}catch(_e){}
},
_error:function(where,e){
const msg=(e&&e.message)?e.message:String(e);
this._state.lastError=msg;
this._emit('EVT:TITAN_VANCE:ERROR',{id:this.id,where,error:msg,ts:Date.now()});
this._log('warn',`${where}: ${msg}`);
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_TITAN_VANCE.id]=Engine_TITAN_VANCE;
/*-- ü¶Åüëë-(7A)-(E)-(COMPONENT-ARMOR-ENGINE)-(TITAN-VANCE)-(E)-(7A)-üëëü¶Å --*/
/*-- ü•∑üí®-(8A)-(S)-(HEADER-CONTROL-ENGINE)-(SHADOW-OPS)-(S)-(8A)-üí®ü•∑ --*/
const Engine_SHADOW_OPS={
id:'SHADOW_OPS',
version:'1.0.1',
_ctx:null,
_state:{
enabled:true,
mounted:false,
started:false,
lastError:null,
config:{
autoMount:true,
autoStart:true,
targetId:'kog-header',
injectIfMissing:true,
zIndex:9999,
heightPx:52,
gapPx:10,
padX:14,
padY:10,
fadeMs:150,
collapseOnScroll:true,
collapseAfterPx:60,
showOnHover:true,
hotkeys:true,
keys:{toggle:'h',collapse:'c',expand:'e'}
},
ui:{
root:null,wrap:null,left:null,center:null,right:null,
btnToggle:null,btnFS:null,btnHome:null,
statusDot:null,title:null,
collapsed:false,visible:true,
lastScrollY:0,lastMove:0
},
timers:{raf:0}
},
_wireOnce:false,
init:function(ctx){
this._ctx=ctx||null;
try{
this._wire();
if(this._state.config.autoMount) this.api.mount();
if(this._state.config.autoStart) this.api.start();
this._emit('EVT:SHADOW_OPS:READY',{id:this.id,state:this.api.status(),ts:Date.now()});
}catch(e){this._error('init',e);}
},
api:{
mount:function(){
try{
const self=Engine_SHADOW_OPS;
if(self._state.mounted){self._emit('EVT:SHADOW_OPS:MOUNTED',{id:self.id,state:self.api.status(),ts:Date.now()});return true;}
self._state.mounted=true;
self._ensureUI();
self._bindUI();
self._emit('EVT:SHADOW_OPS:MOUNTED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:SHADOW_OPS:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){Engine_SHADOW_OPS._error('mount',e);return false;}
},
start:function(){
try{
const self=Engine_SHADOW_OPS;
if(self._state.started) return true;
self._state.started=true;
self._startLoop();
self._emit('EVT:SHADOW_OPS:STARTED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:SHADOW_OPS:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){Engine_SHADOW_OPS._error('start',e);return false;}
},
stop:function(){
try{
const self=Engine_SHADOW_OPS;
if(!self._state.started) return true;
self._state.started=false;
self._stopLoop();
self._emit('EVT:SHADOW_OPS:STOPPED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:SHADOW_OPS:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){Engine_SHADOW_OPS._error('stop',e);return false;}
},
enable:function(){
try{
const self=Engine_SHADOW_OPS;
self._state.enabled=true;
self._setVisible(true);
self._emit('EVT:SHADOW_OPS:ENABLED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:SHADOW_OPS:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){Engine_SHADOW_OPS._error('enable',e);return false;}
},
disable:function(){
try{
const self=Engine_SHADOW_OPS;
self._state.enabled=false;
self._setVisible(false);
self._emit('EVT:SHADOW_OPS:DISABLED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:SHADOW_OPS:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){Engine_SHADOW_OPS._error('disable',e);return false;}
},
toggle:function(){
try{
const self=Engine_SHADOW_OPS;
self._setVisible(!self._state.ui.visible);
self._emit('EVT:SHADOW_OPS:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return self._state.ui.visible;
}catch(e){Engine_SHADOW_OPS._error('toggle',e);return false;}
},
collapse:function(){
try{
Engine_SHADOW_OPS._setCollapsed(true);
Engine_SHADOW_OPS._emit('EVT:SHADOW_OPS:STATE',{id:Engine_SHADOW_OPS.id,state:Engine_SHADOW_OPS.api.status(),ts:Date.now()});
return true;
}catch(e){Engine_SHADOW_OPS._error('collapse',e);return false;}
},
expand:function(){
try{
Engine_SHADOW_OPS._setCollapsed(false);
Engine_SHADOW_OPS._emit('EVT:SHADOW_OPS:STATE',{id:Engine_SHADOW_OPS.id,state:Engine_SHADOW_OPS.api.status(),ts:Date.now()});
return true;
}catch(e){Engine_SHADOW_OPS._error('expand',e);return false;}
},
setTitle:function(t){
try{
Engine_SHADOW_OPS._setTitle(t);
Engine_SHADOW_OPS._emit('EVT:SHADOW_OPS:STATE',{id:Engine_SHADOW_OPS.id,state:Engine_SHADOW_OPS.api.status(),ts:Date.now()});
return true;
}catch(e){Engine_SHADOW_OPS._error('setTitle',e);return false;}
},
setConfig:function(p){
try{
Engine_SHADOW_OPS._setConfig(p);
Engine_SHADOW_OPS._emit('EVT:SHADOW_OPS:STATE',{id:Engine_SHADOW_OPS.id,state:Engine_SHADOW_OPS.api.status(),ts:Date.now()});
return true;
}catch(e){Engine_SHADOW_OPS._error('setConfig',e);return false;}
},
status:function(){
const s=Engine_SHADOW_OPS._state;
const c=s.config;
const u=s.ui;
return {id:Engine_SHADOW_OPS.id,version:Engine_SHADOW_OPS.version,enabled:s.enabled,mounted:s.mounted,started:s.started,visible:u.visible,collapsed:u.collapsed,targetId:c.targetId,heightPx:c.heightPx,lastError:s.lastError,ts:Date.now()};
}
},
_wire:function(){
if(this._wireOnce) return;
this._wireOnce=true;
const ctx=this._ctx;
const bus=ctx&&ctx.bus?ctx.bus:null;
if(bus&&typeof bus.on==='function'){
bus.on('REQ:SHADOW_OPS:MOUNT',()=>{try{this.api.mount();}catch(e){this._error('listener:MOUNT',e);}});
bus.on('REQ:SHADOW_OPS:START',()=>{try{this.api.start();}catch(e){this._error('listener:START',e);}});
bus.on('REQ:SHADOW_OPS:STOP',()=>{try{this.api.stop();}catch(e){this._error('listener:STOP',e);}});
bus.on('REQ:SHADOW_OPS:ENABLE',()=>{try{this.api.enable();}catch(e){this._error('listener:ENABLE',e);}});
bus.on('REQ:SHADOW_OPS:DISABLE',()=>{try{this.api.disable();}catch(e){this._error('listener:DISABLE',e);}});
bus.on('REQ:SHADOW_OPS:TOGGLE',()=>{try{this.api.toggle();}catch(e){this._error('listener:TOGGLE',e);}});
bus.on('REQ:SHADOW_OPS:COLLAPSE',()=>{try{this.api.collapse();}catch(e){this._error('listener:COLLAPSE',e);}});
bus.on('REQ:SHADOW_OPS:EXPAND',()=>{try{this.api.expand();}catch(e){this._error('listener:EXPAND',e);}});
bus.on('REQ:SHADOW_OPS:TITLE',(p)=>{try{this._setTitle(p&&p.title!=null?p.title:p);this._emit('EVT:SHADOW_OPS:STATE',{id:this.id,state:this.api.status(),ts:Date.now()});}catch(e){this._error('listener:TITLE',e);}});
bus.on('REQ:SHADOW_OPS:CONFIG',(p)=>{try{this._setConfig(p||{});this._emit('EVT:SHADOW_OPS:STATE',{id:this.id,state:this.api.status(),ts:Date.now()});}catch(e){this._error('listener:CONFIG',e);}});
bus.on('REQ:SHADOW_OPS:STATUS',()=>{try{this._emit('EVT:SHADOW_OPS:STATUS',{id:this.id,state:this.api.status(),ts:Date.now()});}catch(e){this._error('listener:STATUS',e);}});
bus.on('REQ:SHADOW_OPS:SNAPSHOT',()=>{try{this._emit('EVT:SHADOW_OPS:STATE',{id:this.id,state:this.api.status(),ts:Date.now()});}catch(e){this._error('listener:SNAPSHOT',e);}});
}
},
_setConfig:function(p){
p=p||{};
const s=this._state;
const c=s.config;
if(typeof p.targetId==='string'&&p.targetId) c.targetId=p.targetId;
if(typeof p.injectIfMissing==='boolean') c.injectIfMissing=p.injectIfMissing;
if(isFinite(p.zIndex)) c.zIndex=this._clampInt(p.zIndex,1,2147483647);
if(isFinite(p.heightPx)) c.heightPx=this._clampInt(p.heightPx,28,120);
if(isFinite(p.gapPx)) c.gapPx=this._clampInt(p.gapPx,0,40);
if(isFinite(p.padX)) c.padX=this._clampInt(p.padX,0,40);
if(isFinite(p.padY)) c.padY=this._clampInt(p.padY,0,40);
if(isFinite(p.fadeMs)) c.fadeMs=this._clampInt(p.fadeMs,0,600);
if(typeof p.collapseOnScroll==='boolean') c.collapseOnScroll=p.collapseOnScroll;
if(isFinite(p.collapseAfterPx)) c.collapseAfterPx=this._clampInt(p.collapseAfterPx,0,600);
if(typeof p.showOnHover==='boolean') c.showOnHover=p.showOnHover;
if(typeof p.hotkeys==='boolean') c.hotkeys=p.hotkeys;
if(p.keys&&typeof p.keys==='object'){
if(typeof p.keys.toggle==='string'&&p.keys.toggle) c.keys.toggle=p.keys.toggle;
if(typeof p.keys.collapse==='string'&&p.keys.collapse) c.keys.collapse=p.keys.collapse;
if(typeof p.keys.expand==='string'&&p.keys.expand) c.keys.expand=p.keys.expand;
}
this._applyLayout();
},
_ensureUI:function(){
const s=this._state;
const c=s.config;
if(typeof document==='undefined') return;
let root=document.getElementById(c.targetId);
if(!root&&c.injectIfMissing){root=document.createElement('div');root.id=c.targetId;document.body.appendChild(root);}
if(!root) return;
s.ui.root=root;
root.style.position='fixed';
root.style.left='0';
root.style.top='0';
root.style.right='0';
root.style.zIndex=String(c.zIndex);
root.style.pointerEvents='none';
root.style.fontFamily='system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif';
root.style.transition=`opacity ${c.fadeMs}ms ease, transform ${c.fadeMs}ms ease`;
let wrap=root.querySelector('[data-kog="shadow-ops-wrap"]');
if(!wrap){wrap=document.createElement('div');wrap.setAttribute('data-kog','shadow-ops-wrap');root.appendChild(wrap);}
s.ui.wrap=wrap;
wrap.style.pointerEvents='auto';
wrap.style.display='flex';
wrap.style.alignItems='center';
wrap.style.justifyContent='space-between';
wrap.style.backdropFilter='blur(10px)';
wrap.style.webkitBackdropFilter='blur(10px)';
wrap.style.background='rgba(0,0,0,0.55)';
wrap.style.borderBottom='1px solid rgba(255,255,255,0.12)';
wrap.style.boxShadow='0 8px 22px rgba(0,0,0,0.35)';
wrap.style.borderRadius='0 0 14px 14px';
wrap.style.margin='0 auto';
wrap.style.maxWidth='1200px';
wrap.style.transform='translateY(0px)';
wrap.style.opacity='1';
let left=wrap.querySelector('[data-kog="left"]');
let center=wrap.querySelector('[data-kog="center"]');
let right=wrap.querySelector('[data-kog="right"]');
if(!left){left=document.createElement('div');left.setAttribute('data-kog','left');wrap.appendChild(left);}
if(!center){center=document.createElement('div');center.setAttribute('data-kog','center');wrap.appendChild(center);}
if(!right){right=document.createElement('div');right.setAttribute('data-kog','right');wrap.appendChild(right);}
s.ui.left=left;s.ui.center=center;s.ui.right=right;
left.style.display='flex';left.style.alignItems='center';left.style.gap='10px';
center.style.display='flex';center.style.alignItems='center';center.style.gap='10px';
right.style.display='flex';right.style.alignItems='center';right.style.gap='10px';
const mkBtn=(txt)=>{const b=document.createElement('button');b.type='button';b.textContent=txt;b.style.cursor='pointer';b.style.border='1px solid rgba(255,255,255,0.18)';b.style.background='rgba(255,255,255,0.08)';b.style.color='rgba(255,255,255,0.92)';b.style.borderRadius='10px';b.style.padding='8px 10px';b.style.fontSize='12px';b.style.lineHeight='12px';b.style.userSelect='none';b.style.transition='transform 120ms ease, background 120ms ease';b.onmouseenter=()=>{b.style.background='rgba(255,255,255,0.14)';};b.onmouseleave=()=>{b.style.background='rgba(255,255,255,0.08)';};b.onmousedown=()=>{b.style.transform='scale(0.98)';};b.onmouseup=()=>{b.style.transform='scale(1)';};return b;};
let btnToggle=left.querySelector('[data-kog="btn-toggle"]');
if(!btnToggle){btnToggle=mkBtn('HEADER');btnToggle.setAttribute('data-kog','btn-toggle');left.appendChild(btnToggle);}
s.ui.btnToggle=btnToggle;
let btnFS=right.querySelector('[data-kog="btn-fs"]');
if(!btnFS){btnFS=mkBtn('FULL');btnFS.setAttribute('data-kog','btn-fs');right.appendChild(btnFS);}
s.ui.btnFS=btnFS;
let btnHome=right.querySelector('[data-kog="btn-home"]');
if(!btnHome){btnHome=mkBtn('HOME');btnHome.setAttribute('data-kog','btn-home');right.appendChild(btnHome);}
s.ui.btnHome=btnHome;
let dot=center.querySelector('[data-kog="dot"]');
if(!dot){dot=document.createElement('span');dot.setAttribute('data-kog','dot');center.appendChild(dot);}
s.ui.statusDot=dot;
dot.style.width='10px';dot.style.height='10px';dot.style.borderRadius='999px';
dot.style.background='rgba(0,255,140,0.9)';
dot.style.boxShadow='0 0 12px rgba(0,255,140,0.35)';
let title=center.querySelector('[data-kog="title"]');
if(!title){title=document.createElement('div');title.setAttribute('data-kog','title');center.appendChild(title);}
s.ui.title=title;
title.textContent=title.textContent||'KOG LEGION';
title.style.color='rgba(255,255,255,0.92)';
title.style.fontSize='12px';
title.style.letterSpacing='0.8px';
title.style.textTransform='uppercase';
this._applyLayout();
this._setVisible(true);
},
_bindUI:function(){
const s=this._state;
const u=s.ui;
if(!u.wrap||u.wrap._kog_bound) return;
u.wrap._kog_bound=true;
if(u.btnToggle) u.btnToggle.onclick=()=>{try{Engine_SHADOW_OPS.api.toggle();}catch(e){Engine_SHADOW_OPS._error('ui:toggle',e);}};
if(u.btnFS) u.btnFS.onclick=()=>{try{Engine_SHADOW_OPS._emit('REQ:VOID_WALKER:TOGGLE',{id:'SHADOW_OPS',ts:Date.now()});}catch(e){Engine_SHADOW_OPS._error('ui:fs',e);}};
if(u.btnHome) u.btnHome.onclick=()=>{try{Engine_SHADOW_OPS._emit('EVT:SHADOW_OPS:HOME',{id:'SHADOW_OPS',ts:Date.now()});}catch(e){Engine_SHADOW_OPS._error('ui:home',e);}};
if(typeof window!=='undefined'){
window.addEventListener('scroll',()=>{try{Engine_SHADOW_OPS._onScroll();}catch(e){Engine_SHADOW_OPS._error('scroll',e);}}, {passive:true});
window.addEventListener('mousemove',()=>{try{Engine_SHADOW_OPS._state.ui.lastMove=Date.now();}catch(e){Engine_SHADOW_OPS._error('mousemove',e);}}, {passive:true});
window.addEventListener('keydown',(ev)=>{try{Engine_SHADOW_OPS._onKey(ev);}catch(e){Engine_SHADOW_OPS._error('keydown',e);}});
window.addEventListener('resize',()=>{try{Engine_SHADOW_OPS._applyLayout();}catch(e){Engine_SHADOW_OPS._error('resize',e);}});
}
if(typeof document!=='undefined'){
document.addEventListener('visibilitychange',()=>{try{Engine_SHADOW_OPS._emit('EVT:SHADOW_OPS:VIS',{id:'SHADOW_OPS',vis:document.visibilityState||'unknown',ts:Date.now()});}catch(e){Engine_SHADOW_OPS._error('visibility',e);}});
}
},
_applyLayout:function(){
const s=this._state;
const c=s.config;
const u=s.ui;
if(!u.wrap) return;
u.wrap.style.height=String(c.heightPx)+'px';
u.wrap.style.padding=`${c.padY}px ${c.padX}px`;
u.wrap.style.gap=String(c.gapPx)+'px';
},
_setVisible:function(v){
const s=this._state;
const u=s.ui;
if(!u.root||!u.wrap) return;
u.visible=!!v;
if(!s.enabled) u.visible=false;
u.root.style.opacity=u.visible?'1':'0';
u.root.style.transform=u.visible?'translateY(0px)':'translateY(-10px)';
u.root.style.pointerEvents=u.visible?'auto':'none';
},
_setCollapsed:function(v){
const s=this._state;
const u=s.ui;
if(!u.wrap) return;
u.collapsed=!!v;
if(u.collapsed){
u.wrap.style.height='32px';
u.wrap.style.padding='6px 10px';
u.wrap.style.borderRadius='0 0 12px 12px';
if(u.title) u.title.style.display='none';
}else{
this._applyLayout();
if(u.title) u.title.style.display='block';
}
},
_setTitle:function(t){
const u=this._state.ui;
if(!u.title) return;
u.title.textContent=(t==null)?'':String(t);
},
_onScroll:function(){
const s=this._state;
const c=s.config;
const u=s.ui;
if(!c.collapseOnScroll) return;
if(typeof window==='undefined') return;
const y=window.scrollY||0;
if(y>c.collapseAfterPx) this._setCollapsed(true);
else this._setCollapsed(false);
u.lastScrollY=y;
},
_onKey:function(ev){
const s=this._state;
const c=s.config;
if(!c.hotkeys) return;
if(!ev||ev.defaultPrevented) return;
if(ev.ctrlKey||ev.metaKey||ev.altKey) return;
const k=(ev.key||'').toLowerCase();
if(k===String(c.keys.toggle||'h').toLowerCase()){this.api.toggle();ev.preventDefault();return;}
if(k===String(c.keys.collapse||'c').toLowerCase()){this.api.collapse();ev.preventDefault();return;}
if(k===String(c.keys.expand||'e').toLowerCase()){this.api.expand();ev.preventDefault();return;}
},
_startLoop:function(){
const s=this._state;
this._stopLoop();
const step=()=>{
try{
if(!Engine_SHADOW_OPS._state.started) return;
Engine_SHADOW_OPS._loop();
Engine_SHADOW_OPS._state.timers.raf=requestAnimationFrame(step);
}catch(e){
Engine_SHADOW_OPS._error('raf',e);
try{Engine_SHADOW_OPS._state.timers.raf=requestAnimationFrame(step);}catch(_e){}
}
};
try{this._state.timers.raf=requestAnimationFrame(step);}catch(e){this._error('startLoop',e);}
},
_stopLoop:function(){
const t=this._state.timers;
if(t.raf){try{cancelAnimationFrame(t.raf);}catch(_e){}t.raf=0;}
},
_loop:function(){
const s=this._state;
const c=s.config;
const u=s.ui;
if(!u.root) return;
if(!s.enabled){this._setVisible(false);return;}
if(c.showOnHover&&u.collapsed){
const now=Date.now();
const hot=(now-u.lastMove)<900;
if(hot) this._setVisible(true);
else this._setVisible(true);
}
},
_emit:function(evt,payload){
try{
const ctx=this._ctx;
const bus=ctx&&ctx.bus?ctx.bus:null;
if(!bus||typeof bus.emit!=='function') return;
bus.emit(evt,payload||{id:this.id,ts:Date.now()});
}catch(e){this._error('emit',e);}
},
_log:function(level,msg){
const ctx=this._ctx;
if(!ctx||!ctx.log) return;
try{
if(typeof ctx.log[level]==='function') ctx.log[level]('SHADOW_OPS',msg);
else if(typeof ctx.log==='function') ctx.log('SHADOW_OPS',msg);
}catch(_e){}
},
_error:function(where,e){
const msg=(e&&e.message)?e.message:String(e);
this._state.lastError=msg;
this._emit('EVT:SHADOW_OPS:ERROR',{id:this.id,where,error:msg,ts:Date.now()});
this._log('warn',`${where}: ${msg}`);
},
_clampInt:function(v,a,b){
v=parseInt(v,10);
if(!isFinite(v)) v=a;
if(v<a) v=a;
if(v>b) v=b;
return v;
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_SHADOW_OPS.id]=Engine_SHADOW_OPS;
/*-- ü•∑üí®-(8A)-(E)-(HEADER-CONTROL-ENGINE)-(SHADOW-OPS)-(E)-(8A)-üí®ü•∑ --*/
/*-- ‚ö°‚õàÔ∏è-(9A)-(S)-(TITLE-BAR-ENGINE)-(STORM-BREAKER)-(S)-(9A)-‚õàÔ∏è‚ö° --*/
const Engine_STORM_BREAKER={
id:'STORM_BREAKER',
version:'1.0.1',
_ctx:null,
_state:{
enabled:true,
mounted:false,
started:false,
lastError:null,
config:{
autoMount:true,
autoStart:true,
targetId:'kog-titlebar',
injectIfMissing:true,
zIndex:10000,
heightPx:34,
padX:12,
fadeMs:160,
showBuild:true,
buildLabel:'ALPHA',
showClock:true,
clock12h:true,
clockHz:1,
leftText:'KOG LEGION',
centerText:'',
rightText:'',
pulseOnEvent:true,
pulseMs:240
},
ui:{
root:null,
bar:null,
left:null,
center:null,
right:null,
build:null,
clock:null,
pulseT:0
},
timers:{
clock:0
}
},
_wireOnce:false,
init:function(ctx){
this._ctx=ctx||null;
try{
this._wire();
if(this._state.config.autoMount) this.api.mount();
if(this._state.config.autoStart) this.api.start();
this._emit('EVT:STORM_BREAKER:READY',{id:this.id,state:this.api.status(),ts:Date.now()});
}catch(e){
this._error('init',e);
}
},
api:{
mount:function(){
try{
const self=Engine_STORM_BREAKER;
if(self._state.mounted){self._emit('EVT:STORM_BREAKER:MOUNTED',{id:self.id,state:self.api.status(),ts:Date.now()});return true;}
self._state.mounted=true;
self._ensureUI();
self._bindUI();
self._apply();
self._emit('EVT:STORM_BREAKER:MOUNTED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:STORM_BREAKER:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_STORM_BREAKER._error('mount',e);
return false;
}
},
start:function(){
try{
const self=Engine_STORM_BREAKER;
if(self._state.started) return true;
self._state.started=true;
self._startClock();
self._emit('EVT:STORM_BREAKER:STARTED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:STORM_BREAKER:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_STORM_BREAKER._error('start',e);
return false;
}
},
stop:function(){
try{
const self=Engine_STORM_BREAKER;
if(!self._state.started) return true;
self._state.started=false;
self._stopClock();
self._emit('EVT:STORM_BREAKER:STOPPED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:STORM_BREAKER:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_STORM_BREAKER._error('stop',e);
return false;
}
},
enable:function(){
try{
const self=Engine_STORM_BREAKER;
self._state.enabled=true;
self._setVisible(true);
self._emit('EVT:STORM_BREAKER:ENABLED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:STORM_BREAKER:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_STORM_BREAKER._error('enable',e);
return false;
}
},
disable:function(){
try{
const self=Engine_STORM_BREAKER;
self._state.enabled=false;
self._setVisible(false);
self._emit('EVT:STORM_BREAKER:DISABLED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:STORM_BREAKER:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_STORM_BREAKER._error('disable',e);
return false;
}
},
setText:function(p){
try{
const self=Engine_STORM_BREAKER;
p=p||{};
if(p.left!=null) self._state.config.leftText=String(p.left);
if(p.center!=null) self._state.config.centerText=String(p.center);
if(p.right!=null) self._state.config.rightText=String(p.right);
self._applyText();
self._pulse();
self._emit('EVT:STORM_BREAKER:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_STORM_BREAKER._error('setText',e);
return false;
}
},
setConfig:function(p){
try{
Engine_STORM_BREAKER._setConfig(p||{});
Engine_STORM_BREAKER._apply();
Engine_STORM_BREAKER._emit('EVT:STORM_BREAKER:STATE',{id:Engine_STORM_BREAKER.id,state:Engine_STORM_BREAKER.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_STORM_BREAKER._error('setConfig',e);
return false;
}
},
status:function(){
const s=Engine_STORM_BREAKER._state;
const c=s.config;
return {id:Engine_STORM_BREAKER.id,version:Engine_STORM_BREAKER.version,enabled:s.enabled,mounted:s.mounted,started:s.started,targetId:c.targetId,heightPx:c.heightPx,leftText:c.leftText,centerText:c.centerText,rightText:c.rightText,showClock:c.showClock,clock12h:c.clock12h,lastError:s.lastError,ts:Date.now()};
}
},
_wire:function(){
if(this._wireOnce) return;
this._wireOnce=true;
const ctx=this._ctx;
const bus=ctx&&ctx.bus?ctx.bus:null;
if(bus&&typeof bus.on==='function'){
bus.on('REQ:STORM_BREAKER:MOUNT',()=>{try{this.api.mount();}catch(e){this._error('listener:MOUNT',e);}});
bus.on('REQ:STORM_BREAKER:START',()=>{try{this.api.start();}catch(e){this._error('listener:START',e);}});
bus.on('REQ:STORM_BREAKER:STOP',()=>{try{this.api.stop();}catch(e){this._error('listener:STOP',e);}});
bus.on('REQ:STORM_BREAKER:ENABLE',()=>{try{this.api.enable();}catch(e){this._error('listener:ENABLE',e);}});
bus.on('REQ:STORM_BREAKER:DISABLE',()=>{try{this.api.disable();}catch(e){this._error('listener:DISABLE',e);}});
bus.on('REQ:STORM_BREAKER:TEXT',(p)=>{try{this.api.setText(p||{});}catch(e){this._error('listener:TEXT',e);}});
bus.on('REQ:STORM_BREAKER:CONFIG',(p)=>{try{this.api.setConfig(p||{});}catch(e){this._error('listener:CONFIG',e);}});
bus.on('REQ:STORM_BREAKER:STATUS',()=>{try{this._emit('EVT:STORM_BREAKER:STATUS',{id:this.id,state:this.api.status(),ts:Date.now()});}catch(e){this._error('listener:STATUS',e);}});
bus.on('REQ:STORM_BREAKER:SNAPSHOT',()=>{try{this._emit('EVT:STORM_BREAKER:STATE',{id:this.id,state:this.api.status(),ts:Date.now()});}catch(e){this._error('listener:SNAPSHOT',e);}});
}
},
_setConfig:function(p){
p=p||{};
const c=this._state.config;
if(typeof p.targetId==='string'&&p.targetId) c.targetId=p.targetId;
if(typeof p.injectIfMissing==='boolean') c.injectIfMissing=p.injectIfMissing;
if(isFinite(p.zIndex)) c.zIndex=this._clampInt(p.zIndex,1,2147483647);
if(isFinite(p.heightPx)) c.heightPx=this._clampInt(p.heightPx,24,64);
if(isFinite(p.padX)) c.padX=this._clampInt(p.padX,0,30);
if(isFinite(p.fadeMs)) c.fadeMs=this._clampInt(p.fadeMs,0,600);
if(typeof p.showBuild==='boolean') c.showBuild=p.showBuild;
if(typeof p.buildLabel==='string') c.buildLabel=String(p.buildLabel||'');
if(typeof p.showClock==='boolean') c.showClock=p.showClock;
if(typeof p.clock12h==='boolean') c.clock12h=p.clock12h;
if(isFinite(p.clockHz)) c.clockHz=this._clampNum(p.clockHz,0.2,10);
if(typeof p.leftText==='string') c.leftText=p.leftText;
if(typeof p.centerText==='string') c.centerText=p.centerText;
if(typeof p.rightText==='string') c.rightText=p.rightText;
if(typeof p.pulseOnEvent==='boolean') c.pulseOnEvent=p.pulseOnEvent;
if(isFinite(p.pulseMs)) c.pulseMs=this._clampInt(p.pulseMs,60,1200);
},
_ensureUI:function(){
const s=this._state;
const c=s.config;
if(typeof document==='undefined') return;
let root=document.getElementById(c.targetId);
if(!root&&c.injectIfMissing){
root=document.createElement('div');
root.id=c.targetId;
document.body.appendChild(root);
}
if(!root) return;
s.ui.root=root;
root.style.position='fixed';
root.style.left='0';
root.style.top='0';
root.style.right='0';
root.style.zIndex=String(c.zIndex);
root.style.pointerEvents='none';
root.style.fontFamily='system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif';
root.style.transition=`opacity ${c.fadeMs}ms ease, transform ${c.fadeMs}ms ease`;
let bar=root.querySelector('[data-kog="storm-bar"]');
if(!bar){
bar=document.createElement('div');
bar.setAttribute('data-kog','storm-bar');
root.appendChild(bar);
}
s.ui.bar=bar;
bar.style.pointerEvents='auto';
bar.style.display='grid';
bar.style.gridTemplateColumns='1fr auto 1fr';
bar.style.alignItems='center';
bar.style.background='rgba(10,10,14,0.72)';
bar.style.borderBottom='1px solid rgba(255,255,255,0.10)';
bar.style.backdropFilter='blur(10px)';
bar.style.webkitBackdropFilter='blur(10px)';
bar.style.boxShadow='0 10px 26px rgba(0,0,0,0.35)';
bar.style.borderRadius='0 0 14px 14px';
bar.style.margin='0 auto';
bar.style.maxWidth='1200px';
bar.style.transform='translateY(0px)';
bar.style.opacity='1';
const mkSlot=(k,justify)=>{let el=bar.querySelector(`[data-kog="${k}"]`);if(!el){el=document.createElement('div');el.setAttribute('data-kog',k);bar.appendChild(el);}el.style.display='flex';el.style.alignItems='center';el.style.justifyContent=justify;el.style.gap='10px';el.style.minWidth='0';return el;};
s.ui.left=mkSlot('left','flex-start');
s.ui.center=mkSlot('center','center');
s.ui.right=mkSlot('right','flex-end');
const mkText=(parent,k)=>{let el=parent.querySelector(`[data-kog="${k}"]`);if(!el){el=document.createElement('div');el.setAttribute('data-kog',k);parent.appendChild(el);}el.style.color='rgba(255,255,255,0.92)';el.style.fontSize='12px';el.style.letterSpacing='0.8px';el.style.textTransform='uppercase';el.style.whiteSpace='nowrap';el.style.overflow='hidden';el.style.textOverflow='ellipsis';return el;};
s.ui.leftText=mkText(s.ui.left,'leftText');
s.ui.centerText=mkText(s.ui.center,'centerText');
s.ui.rightText=mkText(s.ui.right,'rightText');
let build=s.ui.center.querySelector('[data-kog="build"]');
if(!build){
build=document.createElement('span');
build.setAttribute('data-kog','build');
s.ui.center.appendChild(build);
}
s.ui.build=build;
build.style.fontSize='11px';
build.style.padding='3px 8px';
build.style.borderRadius='999px';
build.style.border='1px solid rgba(255,255,255,0.16)';
build.style.background='rgba(255,255,255,0.08)';
build.style.color='rgba(255,255,255,0.90)';
build.style.letterSpacing='0.9px';
build.style.textTransform='uppercase';
let clock=s.ui.right.querySelector('[data-kog="clock"]');
if(!clock){
clock=document.createElement('span');
clock.setAttribute('data-kog','clock');
s.ui.right.appendChild(clock);
}
s.ui.clock=clock;
clock.style.fontSize='12px';
clock.style.padding='3px 8px';
clock.style.borderRadius='10px';
clock.style.border='1px solid rgba(255,255,255,0.14)';
clock.style.background='rgba(255,255,255,0.06)';
clock.style.color='rgba(255,255,255,0.92)';
clock.style.letterSpacing='0.8px';
clock.style.fontVariantNumeric='tabular-nums';
this._apply();
this._setVisible(true);
},
_bindUI:function(){
const u=this._state.ui;
if(!u.bar||u.bar._kog_bound) return;
u.bar._kog_bound=true;
if(typeof window!=='undefined'){
window.addEventListener('resize',()=>{try{Engine_STORM_BREAKER._apply();}catch(e){Engine_STORM_BREAKER._error('resize',e);}});
}
},
_apply:function(){
const s=this._state;
const c=s.config;
const u=s.ui;
if(!u.bar) return;
u.bar.style.height=String(c.heightPx)+'px';
u.bar.style.padding=`0 ${c.padX}px`;
if(u.build){
u.build.style.display=c.showBuild?'inline-flex':'none';
u.build.textContent=c.buildLabel||'';
}
if(u.clock) u.clock.style.display=c.showClock?'inline-flex':'none';
this._applyText();
this._setVisible(this._state.enabled);
},
_applyText:function(){
const c=this._state.config;
const u=this._state.ui;
if(u.leftText) u.leftText.textContent=c.leftText||'';
if(u.centerText) u.centerText.textContent=c.centerText||'';
if(u.rightText) u.rightText.textContent=c.rightText||'';
},
_setVisible:function(v){
const s=this._state;
const u=s.ui;
if(!u.root||!u.bar) return;
const on=!!v&&s.enabled;
u.root.style.opacity=on?'1':'0';
u.root.style.transform=on?'translateY(0px)':'translateY(-10px)';
u.root.style.pointerEvents=on?'auto':'none';
},
_startClock:function(){
const s=this._state;
const c=s.config;
this._stopClock();
if(!c.showClock) return;
const iv=Math.max(100,Math.floor(1000/Math.max(0.2,Math.min(10,c.clockHz||1))));
s.timers.clock=setInterval(()=>{try{Engine_STORM_BREAKER._updateClock();}catch(e){Engine_STORM_BREAKER._error('clock',e);}},iv);
this._updateClock();
},
_stopClock:function(){
const t=this._state.timers;
if(t.clock){try{clearInterval(t.clock);}catch(_e){}t.clock=0;}
},
_updateClock:function(){
const s=this._state;
const c=s.config;
const u=s.ui;
if(!u.clock||!c.showClock) return;
const d=new Date();
let h=d.getHours(),m=d.getMinutes(),sec=d.getSeconds();
let ap='';
if(c.clock12h){
ap=h>=12?'PM':'AM';
h=h%12;if(h===0) h=12;
}
const hh=String(h).padStart(2,'0');
const mm=String(m).padStart(2,'0');
const ss=String(sec).padStart(2,'0');
u.clock.textContent=c.clock12h?`${hh}:${mm}:${ss} ${ap}`:`${hh}:${mm}:${ss}`;
},
_pulse:function(){
const c=this._state.config;
const u=this._state.ui;
if(!c.pulseOnEvent) return;
if(!u.bar) return;
const now=Date.now();
u.pulseT=now;
u.bar.style.transition=`transform ${c.pulseMs}ms ease`;
u.bar.style.transform='scale(1.01)';
setTimeout(()=>{try{if(Engine_STORM_BREAKER._state.ui.pulseT!==now) return;Engine_STORM_BREAKER._state.ui.bar.style.transform='scale(1)';}catch(_e){}},c.pulseMs);
},
_emit:function(evt,payload){
try{
const ctx=this._ctx;
const bus=ctx&&ctx.bus?ctx.bus:null;
if(!bus||typeof bus.emit!=='function') return;
bus.emit(evt,payload||{id:this.id,ts:Date.now()});
}catch(e){
this._error('emit',e);
}
},
_log:function(level,msg){
const ctx=this._ctx;
if(!ctx||!ctx.log) return;
try{
if(typeof ctx.log[level]==='function') ctx.log[level]('STORM_BREAKER',msg);
else if(typeof ctx.log==='function') ctx.log('STORM_BREAKER',msg);
}catch(_e){}
},
_error:function(where,e){
const msg=(e&&e.message)?e.message:String(e);
this._state.lastError=msg;
this._emit('EVT:STORM_BREAKER:ERROR',{id:this.id,where,error:msg,ts:Date.now()});
this._log('warn',`${where}: ${msg}`);
},
_clampInt:function(v,a,b){
v=parseInt(v,10);
if(!isFinite(v)) v=a;
if(v<a) v=a;
if(v>b) v=b;
return v;
},
_clampNum:function(v,a,b){
v=Number(v);
if(!isFinite(v)) v=a;
if(v<a) v=a;
if(v>b) v=b;
return v;
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_STORM_BREAKER.id]=Engine_STORM_BREAKER;
/*-- ‚ö°‚õàÔ∏è-(9A)-(E)-(TITLE-BAR-ENGINE)-(STORM-BREAKER)-(E)-(9A)-‚õàÔ∏è‚ö° --*/
/*-- üèóÔ∏èüñäÔ∏è-(10A)-(S)-(LAYOUT-GRID-ENGINE)-(PRIME-ARCHITECT)-(S)-(10A)-üñäÔ∏èüèóÔ∏è --*/
const Engine_PRIME_ARCHITECT={
id:'PRIME_ARCHITECT',
version:'1.0.1',
_ctx:null,
_state:{
enabled:true,
mounted:false,
started:false,
lastError:null,
ts0:0,
lastUpdate:0,
config:{
autoMount:true,
autoStart:true,
gridBase:975,
mobileBase:320,
cellCount:17,
snap:true,
snapUnit:5,
emitOnResize:true,
emitHz:8,
listenViewport:true
},
viewport:{
w:0,
h:0,
dpr:1,
mode:'desktop',
base:975,
unit:195,
size:975,
x:0,
y:0
},
cells:{},
order:[],
timers:{resize:0,emit:0,emitGate:0}
},
_wireOnce:false,
init:function(ctx){
this._ctx=ctx||null;
try{
this._state.ts0=Date.now();
this._wire();
if(this._state.config.autoMount) this.api.mount();
if(this._state.config.autoStart) this.api.start();
this._emit('EVT:PRIME_ARCHITECT:READY',{id:this.id,state:this.api.status(),ts:Date.now()});
}catch(e){
this._error('init',e);
}
},
api:{
mount:function(){
try{
const self=Engine_PRIME_ARCHITECT;
if(self._state.mounted){self._emit('EVT:PRIME_ARCHITECT:MOUNTED',{id:self.id,state:self.api.status(),ts:Date.now()});return true;}
self._state.mounted=true;
self._calcViewport();
self._emit('EVT:PRIME_ARCHITECT:MOUNTED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:PRIME_ARCHITECT:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_PRIME_ARCHITECT._error('mount',e);
return false;
}
},
start:function(){
try{
const self=Engine_PRIME_ARCHITECT;
if(self._state.started) return true;
self._state.started=true;
self._bindResize();
self._tick();
self._emit('EVT:PRIME_ARCHITECT:STARTED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:PRIME_ARCHITECT:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_PRIME_ARCHITECT._error('start',e);
return false;
}
},
stop:function(){
try{
const self=Engine_PRIME_ARCHITECT;
if(!self._state.started) return true;
self._state.started=false;
self._unbindResize();
self._stopEmit();
self._emit('EVT:PRIME_ARCHITECT:STOPPED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:PRIME_ARCHITECT:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_PRIME_ARCHITECT._error('stop',e);
return false;
}
},
enable:function(){
try{
const self=Engine_PRIME_ARCHITECT;
self._state.enabled=true;
self._emit('EVT:PRIME_ARCHITECT:ENABLED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:PRIME_ARCHITECT:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_PRIME_ARCHITECT._error('enable',e);
return false;
}
},
disable:function(){
try{
const self=Engine_PRIME_ARCHITECT;
self._state.enabled=false;
self._emit('EVT:PRIME_ARCHITECT:DISABLED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:PRIME_ARCHITECT:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_PRIME_ARCHITECT._error('disable',e);
return false;
}
},
setConfig:function(p){
try{
Engine_PRIME_ARCHITECT._setConfig(p||{});
Engine_PRIME_ARCHITECT._calcViewport();
Engine_PRIME_ARCHITECT._emit('EVT:PRIME_ARCHITECT:STATE',{id:Engine_PRIME_ARCHITECT.id,state:Engine_PRIME_ARCHITECT.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_PRIME_ARCHITECT._error('setConfig',e);
return false;
}
},
registerCell:function(id,meta){
try{
const self=Engine_PRIME_ARCHITECT;
if(!id) return false;
id=String(id);
if(!self._state.cells[id]){
self._state.cells[id]={id:id,meta:null,rect:{x:0,y:0,w:0,h:0},ts:0};
self._state.order.push(id);
}
self._state.cells[id].meta=meta||null;
self._state.cells[id].ts=Date.now();
self._layoutCell(id);
self._emit('EVT:PRIME_ARCHITECT:CELL',{id:self.id,cell:self._state.cells[id],ts:Date.now()});
return true;
}catch(e){
Engine_PRIME_ARCHITECT._error('registerCell',e);
return false;
}
},
unregisterCell:function(id){
try{
const self=Engine_PRIME_ARCHITECT;
id=String(id||'');
if(!self._state.cells[id]) return true;
delete self._state.cells[id];
self._state.order=self._state.order.filter(x=>x!==id);
self._emit('EVT:PRIME_ARCHITECT:CELL_REMOVED',{id:self.id,cellId:id,ts:Date.now()});
return true;
}catch(e){
Engine_PRIME_ARCHITECT._error('unregisterCell',e);
return false;
}
},
getViewport:function(){
return Engine_PRIME_ARCHITECT._clone(Engine_PRIME_ARCHITECT._state.viewport);
},
getCell:function(id){
id=String(id||'');
return Engine_PRIME_ARCHITECT._clone(Engine_PRIME_ARCHITECT._state.cells[id]||null);
},
layoutAll:function(){
try{
Engine_PRIME_ARCHITECT._calcViewport();
Engine_PRIME_ARCHITECT._layoutAllCells();
Engine_PRIME_ARCHITECT._emitUpdate(true);
return true;
}catch(e){
Engine_PRIME_ARCHITECT._error('layoutAll',e);
return false;
}
},
status:function(){
const s=Engine_PRIME_ARCHITECT._state;
return {id:Engine_PRIME_ARCHITECT.id,version:Engine_PRIME_ARCHITECT.version,enabled:s.enabled,mounted:s.mounted,started:s.started,lastError:s.lastError,ts0:s.ts0,lastUpdate:s.lastUpdate,viewport:Engine_PRIME_ARCHITECT._clone(s.viewport),cellCount:Object.keys(s.cells).length,config:Engine_PRIME_ARCHITECT._clone(s.config),ts:Date.now()};
}
},
_wire:function(){
if(this._wireOnce) return;
this._wireOnce=true;
const ctx=this._ctx;
const bus=ctx&&ctx.bus?ctx.bus:null;
if(bus&&typeof bus.on==='function'){
bus.on('REQ:PRIME_ARCHITECT:MOUNT',()=>{try{this.api.mount();}catch(e){this._error('listener:MOUNT',e);}});
bus.on('REQ:PRIME_ARCHITECT:START',()=>{try{this.api.start();}catch(e){this._error('listener:START',e);}});
bus.on('REQ:PRIME_ARCHITECT:STOP',()=>{try{this.api.stop();}catch(e){this._error('listener:STOP',e);}});
bus.on('REQ:PRIME_ARCHITECT:ENABLE',()=>{try{this.api.enable();}catch(e){this._error('listener:ENABLE',e);}});
bus.on('REQ:PRIME_ARCHITECT:DISABLE',()=>{try{this.api.disable();}catch(e){this._error('listener:DISABLE',e);}});
bus.on('REQ:PRIME_ARCHITECT:CONFIG',(p)=>{try{this.api.setConfig(p||{});}catch(e){this._error('listener:CONFIG',e);}});
bus.on('REQ:PRIME_ARCHITECT:CELL_REGISTER',(p)=>{try{if(!p) return;this.api.registerCell(p.id,p.meta);}catch(e){this._error('listener:CELL_REGISTER',e);}});
bus.on('REQ:PRIME_ARCHITECT:CELL_REMOVE',(p)=>{try{if(!p) return;this.api.unregisterCell(p.id);}catch(e){this._error('listener:CELL_REMOVE',e);}});
bus.on('REQ:PRIME_ARCHITECT:LAYOUT',()=>{try{this.api.layoutAll();}catch(e){this._error('listener:LAYOUT',e);}});
bus.on('REQ:PRIME_ARCHITECT:STATUS',()=>{try{this._emit('EVT:PRIME_ARCHITECT:STATUS',{id:this.id,state:this.api.status(),ts:Date.now()});}catch(e){this._error('listener:STATUS',e);}});
bus.on('REQ:PRIME_ARCHITECT:SNAPSHOT',()=>{try{this._emit('EVT:PRIME_ARCHITECT:STATE',{id:this.id,state:this.api.status(),ts:Date.now()});}catch(e){this._error('listener:SNAPSHOT',e);}});
}
},
_setConfig:function(p){
const c=this._state.config;
p=p||{};
if(isFinite(p.gridBase)) c.gridBase=this._clampInt(p.gridBase,200,4096);
if(isFinite(p.mobileBase)) c.mobileBase=this._clampInt(p.mobileBase,160,1024);
if(isFinite(p.cellCount)) c.cellCount=this._clampInt(p.cellCount,1,64);
if(typeof p.snap==='boolean') c.snap=p.snap;
if(isFinite(p.snapUnit)) c.snapUnit=this._clampInt(p.snapUnit,1,20);
if(typeof p.emitOnResize==='boolean') c.emitOnResize=p.emitOnResize;
if(isFinite(p.emitHz)) c.emitHz=this._clampNum(p.emitHz,1,60);
if(typeof p.listenViewport==='boolean') c.listenViewport=p.listenViewport;
},
_bindResize:function(){
const s=this._state;
if(!s.config.listenViewport) return;
if(typeof window==='undefined') return;
if(s.timers.resize) return;
const onR=()=>{try{Engine_PRIME_ARCHITECT._tick();}catch(e){Engine_PRIME_ARCHITECT._error('resize',e);}};
window.addEventListener('resize',onR);
window.addEventListener('orientationchange',onR);
s.timers.resize=1;
this._startEmit();
},
_unbindResize:function(){
const s=this._state;
if(!s.timers.resize) return;
if(typeof window!=='undefined'){
try{
window.removeEventListener('resize',Engine_PRIME_ARCHITECT._tick);
window.removeEventListener('orientationchange',Engine_PRIME_ARCHITECT._tick);
}catch(_e){}
}
s.timers.resize=0;
},
_startEmit:function(){
const s=this._state;
const c=s.config;
if(s.timers.emit) return;
const iv=Math.max(16,Math.floor(1000/Math.max(1,Math.min(60,c.emitHz||8))));
s.timers.emit=setInterval(()=>{try{Engine_PRIME_ARCHITECT._emitUpdate(false);}catch(e){Engine_PRIME_ARCHITECT._error('emit',e);}},iv);
},
_stopEmit:function(){
const t=this._state.timers;
if(t.emit){try{clearInterval(t.emit);}catch(_e){}t.emit=0;}
t.emitGate=0;
},
_tick:function(){
if(!this._state.enabled||!this._state.started) return;
this._calcViewport();
this._layoutAllCells();
if(this._state.config.emitOnResize) this._emitUpdate(true);
},
_calcViewport:function(){
const s=this._state;
const c=s.config;
const vp=s.viewport;
let w=0,h=0,dpr=1;
if(typeof window!=='undefined'){
w=Math.max(0,window.innerWidth||0);
h=Math.max(0,window.innerHeight||0);
dpr=Number(window.devicePixelRatio||1)||1;
}
vp.w=w;vp.h=h;vp.dpr=dpr;
vp.mode=w&&w<700?'mobile':'desktop';
vp.base=vp.mode==='mobile'?c.mobileBase:c.gridBase;
vp.size=vp.base;
vp.unit=vp.base/5;
vp.x=Math.max(0,Math.floor((w-vp.size)/2));
vp.y=Math.max(0,Math.floor((h-vp.size)/2));
},
_layoutAllCells:function(){
const s=this._state;
const ids=s.order.slice(0);
for(let i=0;i<ids.length;i++) this._layoutCell(ids[i]);
},
_layoutCell:function(id){
const s=this._state;
const vp=s.viewport;
const cell=s.cells[id];
if(!cell) return;
const meta=cell.meta||{};
let gx=meta.gx!=null?Number(meta.gx):0;
let gy=meta.gy!=null?Number(meta.gy):0;
let gw=meta.gw!=null?Number(meta.gw):1;
let gh=meta.gh!=null?Number(meta.gh):1;
gx=isFinite(gx)?gx:0;gy=isFinite(gy)?gy:0;gw=isFinite(gw)?gw:1;gh=isFinite(gh)?gh:1;
if(gw<0.2) gw=0.2;if(gh<0.2) gh=0.2;
let x=vp.x+gx*vp.unit;
let y=vp.y+gy*vp.unit;
let w=gw*vp.unit;
let h=gh*vp.unit;
if(this._state.config.snap){
const su=Math.max(1,this._state.config.snapUnit||5);
x=Math.round(x/su)*su;
y=Math.round(y/su)*su;
w=Math.round(w/su)*su;
h=Math.round(h/su)*su;
}
cell.rect.x=this._clampInt(x,0,999999);
cell.rect.y=this._clampInt(y,0,999999);
cell.rect.w=this._clampInt(w,0,999999);
cell.rect.h=this._clampInt(h,0,999999);
cell.ts=Date.now();
},
_emitUpdate:function(force){
const s=this._state;
const now=Date.now();
if(!force){
const gate=s.timers.emitGate||0;
if(now-gate<120) return;
s.timers.emitGate=now;
}
s.lastUpdate=now;
this._emit('EVT:PRIME_ARCHITECT:UPDATED',{id:this.id,state:this.api.status(),ts:now});
},
_emit:function(evt,payload){
try{
const ctx=this._ctx;
const bus=ctx&&ctx.bus?ctx.bus:null;
if(!bus||typeof bus.emit!=='function') return;
bus.emit(evt,payload||{id:this.id,ts:Date.now()});
}catch(e){
this._error('emit',e);
}
},
_log:function(level,msg){
const ctx=this._ctx;
if(!ctx||!ctx.log) return;
try{
if(typeof ctx.log[level]==='function') ctx.log[level]('PRIME_ARCHITECT',msg);
else if(typeof ctx.log==='function') ctx.log('PRIME_ARCHITECT',msg);
}catch(_e){}
},
_error:function(where,e){
const msg=(e&&e.message)?e.message:String(e);
this._state.lastError=msg;
this._emit('EVT:PRIME_ARCHITECT:ERROR',{id:this.id,where,error:msg,ts:Date.now()});
this._log('warn',`${where}: ${msg}`);
},
_clone:function(o){
try{return JSON.parse(JSON.stringify(o));}catch(_e){return o;}
},
_clampInt:function(v,a,b){
v=parseInt(v,10);
if(!isFinite(v)) v=a;
if(v<a) v=a;
if(v>b) v=b;
return v;
},
_clampNum:function(v,a,b){
v=Number(v);
if(!isFinite(v)) v=a;
if(v<a) v=a;
if(v>b) v=b;
return v;
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_PRIME_ARCHITECT.id]=Engine_PRIME_ARCHITECT;
/*-- üèóÔ∏èüñäÔ∏è-(10A)-(E)-(LAYOUT-GRID-ENGINE)-(PRIME-ARCHITECT)-(E)-(10A)-üñäÔ∏èüèóÔ∏è --*/
/*-- üèéÔ∏è‚è∞-(11A)-(S)-(MENU-NAV-ENGINE)-(HYPER-FLUX)-(S)-(11A)-‚è∞üèéÔ∏è --*/
const Engine_HYPER_FLUX={
id:'HYPER_FLUX',
version:'1.0.1',
_ctx:null,
_state:{
enabled:true,
mounted:false,
started:false,
lastError:null,
ts0:0,
lastUpdate:0,
config:{
autoMount:true,
autoStart:true,
items:[
{id:'home',label:'HOME',key:'1',path:'#home'},
{id:'game',label:'GAME',key:'2',path:'#game'},
{id:'shop',label:'SHOP',key:'3',path:'#shop'},
{id:'settings',label:'SETTINGS',key:'4',path:'#settings'}
],
activeId:'home',
wrap:true,
hotkeys:true,
cooldownMs:120,
emitStateOnSelect:true
},
ui:{
container:null,
buttons:{},
lastPressTs:0
}
},
_wireOnce:false,
init:function(ctx){
this._ctx=ctx||null;
try{
this._state.ts0=Date.now();
this._wire();
if(this._state.config.autoMount) this.api.mount();
if(this._state.config.autoStart) this.api.start();
this._emit('EVT:HYPER_FLUX:READY',{id:this.id,state:this.api.status(),ts:Date.now()});
}catch(e){
this._error('init',e);
}
},
api:{
mount:function(){
try{
const self=Engine_HYPER_FLUX;
if(self._state.mounted){self._emit('EVT:HYPER_FLUX:MOUNTED',{id:self.id,state:self.api.status(),ts:Date.now()});return true;}
self._state.mounted=true;
self._buildUI();
self._emit('EVT:HYPER_FLUX:MOUNTED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:HYPER_FLUX:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_HYPER_FLUX._error('mount',e);
return false;
}
},
start:function(){
try{
const self=Engine_HYPER_FLUX;
if(self._state.started) return true;
self._state.started=true;
self._bind();
self._syncActiveUI();
self._emit('EVT:HYPER_FLUX:STARTED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:HYPER_FLUX:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_HYPER_FLUX._error('start',e);
return false;
}
},
stop:function(){
try{
const self=Engine_HYPER_FLUX;
if(!self._state.started) return true;
self._state.started=false;
self._unbind();
self._emit('EVT:HYPER_FLUX:STOPPED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:HYPER_FLUX:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_HYPER_FLUX._error('stop',e);
return false;
}
},
enable:function(){
try{
const self=Engine_HYPER_FLUX;
self._state.enabled=true;
self._emit('EVT:HYPER_FLUX:ENABLED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:HYPER_FLUX:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_HYPER_FLUX._error('enable',e);
return false;
}
},
disable:function(){
try{
const self=Engine_HYPER_FLUX;
self._state.enabled=false;
self._emit('EVT:HYPER_FLUX:DISABLED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:HYPER_FLUX:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_HYPER_FLUX._error('disable',e);
return false;
}
},
setConfig:function(p){
try{
Engine_HYPER_FLUX._setConfig(p||{});
Engine_HYPER_FLUX._rebuild();
Engine_HYPER_FLUX._emit('EVT:HYPER_FLUX:STATE',{id:Engine_HYPER_FLUX.id,state:Engine_HYPER_FLUX.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_HYPER_FLUX._error('setConfig',e);
return false;
}
},
setItems:function(items){
try{
Engine_HYPER_FLUX._state.config.items=Engine_HYPER_FLUX._sanitizeItems(items);
Engine_HYPER_FLUX._rebuild();
Engine_HYPER_FLUX._emit('EVT:HYPER_FLUX:STATE',{id:Engine_HYPER_FLUX.id,state:Engine_HYPER_FLUX.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_HYPER_FLUX._error('setItems',e);
return false;
}
},
select:function(id,meta){
try{
const self=Engine_HYPER_FLUX;
if(!self._state.enabled) return false;
id=String(id||'');
if(!self._findItem(id)) return false;
if(!self._cooldown()) return false;
self._state.config.activeId=id;
self._syncActiveUI();
const it=self._findItem(id);
self._emit('EVT:HYPER_FLUX:SELECT',{id:self.id,activeId:id,item:it,meta:meta||null,ts:Date.now()});
if(self._state.config.emitStateOnSelect) self._emit('EVT:HYPER_FLUX:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_HYPER_FLUX._error('select',e);
return false;
}
},
next:function(){
try{
const self=Engine_HYPER_FLUX;
const items=self._state.config.items||[];
if(!items.length) return false;
const idx=self._indexOf(self._state.config.activeId);
const ni=idx<0?0:idx+1;
if(ni>=items.length) return self._state.config.wrap?self.api.select(items[0].id,{via:'next'}):false;
return self.api.select(items[ni].id,{via:'next'});
}catch(e){
Engine_HYPER_FLUX._error('next',e);
return false;
}
},
prev:function(){
try{
const self=Engine_HYPER_FLUX;
const items=self._state.config.items||[];
if(!items.length) return false;
const idx=self._indexOf(self._state.config.activeId);
const pi=idx<0?0:idx-1;
if(pi<0) return self._state.config.wrap?self.api.select(items[items.length-1].id,{via:'prev'}):false;
return self.api.select(items[pi].id,{via:'prev'});
}catch(e){
Engine_HYPER_FLUX._error('prev',e);
return false;
}
},
snapshot:function(){
return {id:'HYPER_FLUX',state:Engine_HYPER_FLUX.api.status(),ts:Date.now()};
},
status:function(){
const s=Engine_HYPER_FLUX._state;
return {id:Engine_HYPER_FLUX.id,version:Engine_HYPER_FLUX.version,enabled:s.enabled,mounted:s.mounted,started:s.started,lastError:s.lastError,ts0:s.ts0,lastUpdate:s.lastUpdate,activeId:s.config.activeId,items:(s.config.items||[]).map(x=>({id:x.id,label:x.label,key:x.key,path:x.path})),config:Engine_HYPER_FLUX._clone(s.config),ts:Date.now()};
}
},
_wire:function(){
if(this._wireOnce) return;
this._wireOnce=true;
const ctx=this._ctx;
const bus=ctx&&ctx.bus?ctx.bus:null;
if(bus&&typeof bus.on==='function'){
bus.on('REQ:HYPER_FLUX:MOUNT',()=>{try{this.api.mount();}catch(e){this._error('listener:MOUNT',e);}});
bus.on('REQ:HYPER_FLUX:START',()=>{try{this.api.start();}catch(e){this._error('listener:START',e);}});
bus.on('REQ:HYPER_FLUX:STOP',()=>{try{this.api.stop();}catch(e){this._error('listener:STOP',e);}});
bus.on('REQ:HYPER_FLUX:ENABLE',()=>{try{this.api.enable();}catch(e){this._error('listener:ENABLE',e);}});
bus.on('REQ:HYPER_FLUX:DISABLE',()=>{try{this.api.disable();}catch(e){this._error('listener:DISABLE',e);}});
bus.on('REQ:HYPER_FLUX:CONFIG',(p)=>{try{this.api.setConfig(p||{});}catch(e){this._error('listener:CONFIG',e);}});
bus.on('REQ:HYPER_FLUX:ITEMS',(p)=>{try{this.api.setItems(p&&p.items?p.items:[]);}catch(e){this._error('listener:ITEMS',e);}});
bus.on('REQ:HYPER_FLUX:SELECT',(p)=>{try{if(!p) return;this.api.select(p.id,p.meta);}catch(e){this._error('listener:SELECT',e);}});
bus.on('REQ:HYPER_FLUX:NEXT',()=>{try{this.api.next();}catch(e){this._error('listener:NEXT',e);}});
bus.on('REQ:HYPER_FLUX:PREV',()=>{try{this.api.prev();}catch(e){this._error('listener:PREV',e);}});
bus.on('REQ:HYPER_FLUX:STATUS',()=>{try{this._emit('EVT:HYPER_FLUX:STATUS',{id:this.id,state:this.api.status(),ts:Date.now()});}catch(e){this._error('listener:STATUS',e);}});
bus.on('REQ:HYPER_FLUX:SNAPSHOT',()=>{try{this._emit('EVT:HYPER_FLUX:STATE',{id:this.id,state:this.api.status(),ts:Date.now()});}catch(e){this._error('listener:SNAPSHOT',e);}});
}
},
_setConfig:function(p){
const c=this._state.config;
p=p||{};
if(typeof p.autoMount==='boolean') c.autoMount=p.autoMount;
if(typeof p.autoStart==='boolean') c.autoStart=p.autoStart;
if(typeof p.wrap==='boolean') c.wrap=p.wrap;
if(typeof p.hotkeys==='boolean') c.hotkeys=p.hotkeys;
if(isFinite(p.cooldownMs)) c.cooldownMs=this._clampInt(p.cooldownMs,0,1000);
if(typeof p.emitStateOnSelect==='boolean') c.emitStateOnSelect=p.emitStateOnSelect;
if(typeof p.activeId==='string') c.activeId=p.activeId;
if(p.items) c.items=this._sanitizeItems(p.items);
},
_sanitizeItems:function(items){
items=Array.isArray(items)?items:[];
const out=[];
for(let i=0;i<items.length&&i<32;i++){
const it=items[i]||{};
const id=String(it.id||'item_'+i);
const label=String(it.label||id).slice(0,32);
const key=it.key!=null?String(it.key).slice(0,3):null;
const path=it.path!=null?String(it.path).slice(0,128):null;
out.push({id,label,key,path});
}
return out;
},
_rebuild:function(){
try{
const s=this._state;
if(!s.mounted) return;
this._destroyUI();
this._buildUI();
this._syncActiveUI();
}catch(e){
this._error('rebuild',e);
}
},
_buildUI:function(){
const s=this._state;
const items=s.config.items||[];
const el=this._qs('[data-kog="menu-nav"]')||this._qs('#kog-menu')||null;
s.ui.container=el;
s.ui.buttons={};
if(!el) return;
while(el.firstChild) el.removeChild(el.firstChild);
for(let i=0;i<items.length;i++){
const it=items[i];
const b=document.createElement('button');
b.type='button';
b.setAttribute('data-kog-nav',it.id);
b.textContent=it.label;
b.style.cursor='pointer';
b.style.userSelect='none';
b.style.touchAction='manipulation';
b.addEventListener('click',()=>{try{Engine_HYPER_FLUX.api.select(it.id,{via:'click'});}catch(e){Engine_HYPER_FLUX._error('click',e);}});
el.appendChild(b);
s.ui.buttons[it.id]=b;
}
},
_destroyUI:function(){
const s=this._state;
const el=s.ui.container;
if(!el) return;
try{while(el.firstChild) el.removeChild(el.firstChild);}catch(_e){}
s.ui.buttons={};
},
_bind:function(){
try{
const s=this._state;
if(typeof window==='undefined') return;
if(s.ui._keyBound) return;
const onKey=(ev)=>{try{Engine_HYPER_FLUX._onKey(ev);}catch(e){Engine_HYPER_FLUX._error('hotkeys',e);}};
window.addEventListener('keydown',onKey);
s.ui._keyBound=onKey;
}catch(e){
this._error('bind',e);
}
},
_unbind:function(){
const s=this._state;
if(typeof window==='undefined') return;
if(!s.ui._keyBound) return;
try{window.removeEventListener('keydown',s.ui._keyBound);}catch(_e){}
s.ui._keyBound=0;
},
_onKey:function(ev){
const s=this._state;
if(!s.enabled||!s.started) return;
if(!s.config.hotkeys) return;
if(!ev) return;
const k=String(ev.key||'').toLowerCase();
if(!k) return;
if(k==='arrowright'){this.api.next();return;}
if(k==='arrowleft'){this.api.prev();return;}
const items=s.config.items||[];
for(let i=0;i<items.length;i++){
const it=items[i];
if(!it.key) continue;
if(String(it.key).toLowerCase()===k){this.api.select(it.id,{via:'key',key:k});return;}
}
},
_indexOf:function(id){
const items=this._state.config.items||[];
for(let i=0;i<items.length;i++) if(items[i].id===id) return i;
return -1;
},
_findItem:function(id){
const items=this._state.config.items||[];
for(let i=0;i<items.length;i++) if(items[i].id===id) return items[i];
return null;
},
_syncActiveUI:function(){
const s=this._state;
const items=s.config.items||[];
const active=s.config.activeId;
for(let i=0;i<items.length;i++){
const it=items[i];
const b=s.ui.buttons[it.id];
if(!b) continue;
if(it.id===active){b.setAttribute('aria-current','page');b.classList.add('kog-active');}
else{b.removeAttribute('aria-current');b.classList.remove('kog-active');}
}
},
_cooldown:function(){
const s=this._state;
const now=Date.now();
const cd=Math.max(0,Number(s.config.cooldownMs||0)||0);
if(!cd){s.ui.lastPressTs=now;return true;}
if(now-(s.ui.lastPressTs||0)<cd) return false;
s.ui.lastPressTs=now;
return true;
},
_qs:function(sel){
try{if(typeof document==='undefined') return null;return document.querySelector(sel);}catch(_e){return null;}
},
_emit:function(evt,payload){
try{
const ctx=this._ctx;
const bus=ctx&&ctx.bus?ctx.bus:null;
if(!bus||typeof bus.emit!=='function') return;
bus.emit(evt,payload||{id:this.id,ts:Date.now()});
}catch(e){
this._error('emit',e);
}
},
_log:function(level,msg){
const ctx=this._ctx;
if(!ctx||!ctx.log) return;
try{
if(typeof ctx.log[level]==='function') ctx.log[level]('HYPER_FLUX',msg);
else if(typeof ctx.log==='function') ctx.log('HYPER_FLUX',msg);
}catch(_e){}
},
_error:function(where,e){
const msg=(e&&e.message)?e.message:String(e);
this._state.lastError=msg;
this._emit('EVT:HYPER_FLUX:ERROR',{id:this.id,where,error:msg,ts:Date.now()});
this._log('warn',`${where}: ${msg}`);
},
_clone:function(o){
try{return JSON.parse(JSON.stringify(o));}catch(_e){return o;}
},
_clampInt:function(v,a,b){
v=parseInt(v,10);
if(!isFinite(v)) v=a;
if(v<a) v=a;
if(v>b) v=b;
return v;
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_HYPER_FLUX.id]=Engine_HYPER_FLUX;
/*-- üèéÔ∏è‚è∞-(11A)-(E)-(MENU-NAV-ENGINE)-(HYPER-FLUX)-(E)-(11A)-‚è∞üèéÔ∏è --*/
/*-- üìüüñäÔ∏è-(12A)-(S)-(HUD-FOOTER-ENGINE)-(PIXEL-RONIN)-(S)-(12A)-üñäÔ∏èüìü --*/
const Engine_PIXEL_RONIN={
id:'PIXEL_RONIN',
version:'1.0.2',
_ctx:null,
_state:{
enabled:true,
mounted:false,
started:false,
lastError:null,
ts0:0,
lastUpdate:0,
config:{
autoMount:true,
autoStart:true,
hostId:'KOG_SHELL',
mountId:'KOG_HUD_FOOTER',
className:'kog-hud-footer',
textClassName:'kog-hud-footer-text',
heightPx:44,
padPx:10,
minFontPx:10,
maxFontPx:22,
defaultText:'READY',
ariaLabel:'HUD Footer',
debug:false
},
ui:{host:null,wrap:null,text:null}
},
_emit:function(t,p){
try{
if(this._ctx&&this._ctx.bus&&typeof this._ctx.bus.emit==='function') this._ctx.bus.emit(t,p);
window.dispatchEvent(new CustomEvent(t,{detail:p}));
}catch(e){}
},
_error:function(where,e){
this._state.lastError={where:where,msg:(e&&e.message)||String(e),ts:Date.now()};
if(this._state.config.debug) console.warn('[PIXEL_RONIN]',where,e);
this._emit('EVT:PIXEL_RONIN:ERROR',{id:this.id,where:where,error:this._state.lastError,ts:Date.now()});
},
_setConfig:function(p){
const c=this._state.config;
if(!p||typeof p!=='object') return;
Object.keys(p).forEach(k=>{c[k]=p[k];});
},
_host:function(){
const c=this._state.config;
let h=null;
if(c.hostId) h=document.getElementById(c.hostId);
if(!h) h=document.body;
return h;
},
_css:function(){
if(document.getElementById('css-pixel-ronin')) return;
const c=this._state.config;
const s=document.createElement('style');
s.id='css-pixel-ronin';
s.textContent=
`#${c.mountId}{position:relative;width:100%;box-sizing:border-box;}
.${c.className}{display:flex;align-items:center;justify-content:center;width:100%;box-sizing:border-box;overflow:hidden;}
.${c.textClassName}{display:block;max-width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;user-select:none;}`;
document.head.appendChild(s);
},
_fitText:function(){
try{
const st=this._state;
const c=st.config;
const el=st.ui.text;
const wrap=st.ui.wrap;
if(!el||!wrap) return;
const pad=Math.max(0,Number(c.padPx)||0);
wrap.style.paddingLeft=pad+'px';
wrap.style.paddingRight=pad+'px';
wrap.style.height=(Number(c.heightPx)||44)+'px';
let lo=Math.max(6,Number(c.minFontPx)||10);
let hi=Math.max(lo,Number(c.maxFontPx)||22);
const fits=(px)=>{
el.style.fontSize=px+'px';
return (el.scrollWidth<=wrap.clientWidth)&&(el.scrollHeight<=wrap.clientHeight);
};
let best=lo;
let a=lo,b=hi;
while(a<=b){
const mid=(a+b)>>1;
if(fits(mid)){best=mid;a=mid+1;}else b=mid-1;
}
el.style.fontSize=best+'px';
}catch(e){this._error('_fitText',e);}
},
_rebuild:function(){
try{
const st=this._state;
const c=st.config;
if(!st.mounted) return;
if(st.ui.wrap){
st.ui.wrap.className=c.className;
st.ui.wrap.style.height=(Number(c.heightPx)||44)+'px';
}
if(st.ui.text){
st.ui.text.className=c.textClassName;
st.ui.text.setAttribute('aria-label',c.ariaLabel||'HUD Footer');
}
this._fitText();
}catch(e){this._error('_rebuild',e);}
},
_mount:function(){
try{
if(this._state.mounted) return true;
this._css();
const st=this._state;
const c=st.config;
st.ui.host=this._host();
let wrap=document.getElementById(c.mountId);
if(!wrap){
wrap=document.createElement('div');
wrap.id=c.mountId;
st.ui.host.appendChild(wrap);
}
wrap.className=c.className;
wrap.style.height=(Number(c.heightPx)||44)+'px';
wrap.style.boxSizing='border-box';
wrap.style.overflow='hidden';
wrap.style.display='flex';
wrap.style.alignItems='center';
wrap.style.justifyContent='center';

let txt=wrap.querySelector('.'+c.textClassName);
if(!txt){
txt=document.createElement('div');
txt.className=c.textClassName;
wrap.appendChild(txt);
}
txt.textContent=c.defaultText||'';
txt.setAttribute('role','status');
txt.setAttribute('aria-label',c.ariaLabel||'HUD Footer');

st.ui.wrap=wrap;
st.ui.text=txt;
st.mounted=true;

this._fitText();

const onResize=()=>{Engine_PIXEL_RONIN._fitText();};
window.addEventListener('resize',onResize);
st._onResize=onResize;

this._emit('EVT:PIXEL_RONIN:MOUNTED',{id:this.id,state:this.api.status(),ts:Date.now()});
return true;
}catch(e){this._error('_mount',e);return false;}
},
_start:function(){
try{
if(this._state.started) return true;
this._state.started=true;
this._state.ts0=Date.now();
this._emit('EVT:PIXEL_RONIN:STARTED',{id:this.id,state:this.api.status(),ts:Date.now()});
return true;
}catch(e){this._error('_start',e);return false;}
},
_stop:function(){
try{
if(!this._state.started) return true;
this._state.started=false;
this._emit('EVT:PIXEL_RONIN:STOPPED',{id:this.id,state:this.api.status(),ts:Date.now()});
return true;
}catch(e){this._error('_stop',e);return false;}
},
_unmount:function(){
try{
const st=this._state;
const c=st.config;
if(!st.mounted) return true;
if(st._onResize) window.removeEventListener('resize',st._onResize);
st._onResize=null;
const wrap=document.getElementById(c.mountId);
if(wrap&&wrap.parentNode) wrap.parentNode.removeChild(wrap);
st.ui={host:null,wrap:null,text:null};
st.mounted=false;
st.started=false;
this._emit('EVT:PIXEL_RONIN:UNMOUNTED',{id:this.id,ts:Date.now()});
return true;
}catch(e){this._error('_unmount',e);return false;}
},
api:{
init:function(ctx,config){
try{
Engine_PIXEL_RONIN._ctx=ctx||null;
Engine_PIXEL_RONIN._setConfig(config||{});
Engine_PIXEL_RONIN._emit('EVT:PIXEL_RONIN:INIT',{id:Engine_PIXEL_RONIN.id,state:Engine_PIXEL_RONIN.api.status(),ts:Date.now()});
if(Engine_PIXEL_RONIN._state.config.autoMount) Engine_PIXEL_RONIN._mount();
if(Engine_PIXEL_RONIN._state.config.autoStart) Engine_PIXEL_RONIN._start();
return true;
}catch(e){Engine_PIXEL_RONIN._error('api.init',e);return false;}
},
setText:function(t){
try{
const st=Engine_PIXEL_RONIN._state;
if(!st.mounted) Engine_PIXEL_RONIN._mount();
if(st.ui.text) st.ui.text.textContent=(t==null?'':String(t));
Engine_PIXEL_RONIN._fitText();
Engine_PIXEL_RONIN._emit('EVT:PIXEL_RONIN:TEXT',{id:Engine_PIXEL_RONIN.id,text:(t==null?'':String(t)),ts:Date.now()});
return true;
}catch(e){Engine_PIXEL_RONIN._error('api.setText',e);return false;}
},
setConfig:function(p){
try{
Engine_PIXEL_RONIN._setConfig(p||{});
Engine_PIXEL_RONIN._rebuild();
Engine_PIXEL_RONIN._emit('EVT:PIXEL_RONIN:STATE',{id:Engine_PIXEL_RONIN.id,state:Engine_PIXEL_RONIN.api.status(),ts:Date.now()});
return true;
}catch(e){Engine_PIXEL_RONIN._error('api.setConfig',e);return false;}
},
enable:function(){
try{
Engine_PIXEL_RONIN._state.enabled=true;
Engine_PIXEL_RONIN._emit('EVT:PIXEL_RONIN:ENABLED',{id:Engine_PIXEL_RONIN.id,state:Engine_PIXEL_RONIN.api.status(),ts:Date.now()});
return true;
}catch(e){Engine_PIXEL_RONIN._error('api.enable',e);return false;}
},
disable:function(){
try{
Engine_PIXEL_RONIN._state.enabled=false;
Engine_PIXEL_RONIN._emit('EVT:PIXEL_RONIN:DISABLED',{id:Engine_PIXEL_RONIN.id,state:Engine_PIXEL_RONIN.api.status(),ts:Date.now()});
return true;
}catch(e){Engine_PIXEL_RONIN._error('api.disable',e);return false;}
},
mount:function(){return Engine_PIXEL_RONIN._mount();},
unmount:function(){return Engine_PIXEL_RONIN._unmount();},
start:function(){return Engine_PIXEL_RONIN._start();},
stop:function(){return Engine_PIXEL_RONIN._stop();},
status:function(){
const st=Engine_PIXEL_RONIN._state;
return{
id:Engine_PIXEL_RONIN.id,
version:Engine_PIXEL_RONIN.version,
enabled:!!st.enabled,
mounted:!!st.mounted,
started:!!st.started,
lastError:st.lastError,
config:Object.assign({},st.config),
hasUI:!!st.ui.wrap
};
}
}
};
window.Engine_PIXEL_RONIN=Engine_PIXEL_RONIN;
/*-- üìüüñäÔ∏è-(12A)-(E)-(HUD-FOOTER-ENGINE)-(PIXEL-RONIN)-(E)-(12A)-üñäÔ∏èüìü --*/
/*-- üîÆüïØÔ∏è-(13A)-(S)-(PHANTOM-RATIO-ENGINE)-(DATA-WITCH)-(S)-(13A)-üïØÔ∏èüîÆ --*/
const Engine_DATA_WITCH={
id:'DATA_WITCH',
version:'1.0.1',
_ctx:null,
_state:{
enabled:true,
mounted:false,
started:false,
lastError:null,
ts0:0,
lastUpdate:0,
config:{
autoStart:true,
sampleHz:4,
baseW:975,
baseH:975,
minW:320,
minH:320,
mode:'contain',                  // 'contain'|'cover'|'fit-width'|'fit-height'|'stretch'
snap:0,                          // 0 disables; else snap scale to nearest (e.g. 0.01)
emitOnResize:true,
emitOnVisibility:true,
targetSelector:'[data-kog="stage"]',
useVisualViewport:true
},
ratio:{
w:0,h:0,
targetW:0,targetH:0,
scale:1,
scaleX:1,scaleY:1,
offsetX:0,offsetY:0,
dpr:1,
orientation:'unknown',           // 'portrait'|'landscape'|'square'|'unknown'
viewportW:0,viewportH:0,
visible:true,
ts:0
},
metrics:{
updates:0,
resizes:0,
lastResizeTs:0,
samples:0
},
timers:{
interval:0,
raf:0
}
},
_wireOnce:false,
init:function(ctx){
this._ctx=ctx||null;
try{
this._state.ts0=Date.now();
this._wire();
if(this._state.config.autoStart) this.api.start();
this._emit('EVT:DATA_WITCH:READY',{id:this.id,state:this.api.status(),ts:Date.now()});
}catch(e){
this._error('init',e);
}
},
api:{
mount:function(){
try{
const self=Engine_DATA_WITCH;
if(self._state.mounted){self._emit('EVT:DATA_WITCH:MOUNTED',{id:self.id,state:self.api.status(),ts:Date.now()});return true;}
self._state.mounted=true;
self._emit('EVT:DATA_WITCH:MOUNTED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:DATA_WITCH:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_DATA_WITCH._error('mount',e);
return false;
}
},
start:function(){
try{
const self=Engine_DATA_WITCH;
if(self._state.started) return true;
self._state.started=true;
self.api.mount();
self._bindDOM();
self._startLoop();
self._recalc('start');
self._emit('EVT:DATA_WITCH:STARTED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:DATA_WITCH:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_DATA_WITCH._error('start',e);
return false;
}
},
stop:function(){
try{
const self=Engine_DATA_WITCH;
if(!self._state.started) return true;
self._state.started=false;
self._stopLoop();
self._unbindDOM();
self._emit('EVT:DATA_WITCH:STOPPED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:DATA_WITCH:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_DATA_WITCH._error('stop',e);
return false;
}
},
enable:function(){
try{
const self=Engine_DATA_WITCH;
self._state.enabled=true;
self._emit('EVT:DATA_WITCH:ENABLED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:DATA_WITCH:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_DATA_WITCH._error('enable',e);
return false;
}
},
disable:function(){
try{
const self=Engine_DATA_WITCH;
self._state.enabled=false;
self._emit('EVT:DATA_WITCH:DISABLED',{id:self.id,state:self.api.status(),ts:Date.now()});
self._emit('EVT:DATA_WITCH:STATE',{id:self.id,state:self.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_DATA_WITCH._error('disable',e);
return false;
}
},
setConfig:function(p){
try{
Engine_DATA_WITCH._setConfig(p||{});
Engine_DATA_WITCH._restartLoop();
Engine_DATA_WITCH._recalc('config');
Engine_DATA_WITCH._emit('EVT:DATA_WITCH:STATE',{id:Engine_DATA_WITCH.id,state:Engine_DATA_WITCH.api.status(),ts:Date.now()});
return true;
}catch(e){
Engine_DATA_WITCH._error('setConfig',e);
return false;
}
},
getRatio:function(){
return Engine_DATA_WITCH._clone(Engine_DATA_WITCH._state.ratio);
},
applyTo:function(el){
try{
const self=Engine_DATA_WITCH;
if(!el) return false;
const r=self._state.ratio;
el.style.transformOrigin='0 0';
el.style.transform='translate('+r.offsetX+'px,'+r.offsetY+'px) scale('+r.scaleX+','+r.scaleY+')';
return true;
}catch(e){
Engine_DATA_WITCH._error('applyTo',e);
return false;
}
},
snapshot:function(){
return {id:'DATA_WITCH',state:Engine_DATA_WITCH.api.status(),ts:Date.now()};
},
status:function(){
const s=Engine_DATA_WITCH._state;
return {
id:Engine_DATA_WITCH.id,
version:Engine_DATA_WITCH.version,
enabled:s.enabled,
mounted:s.mounted,
started:s.started,
lastError:s.lastError,
ts0:s.ts0,
lastUpdate:s.lastUpdate,
config:Engine_DATA_WITCH._clone(s.config),
ratio:Engine_DATA_WITCH._clone(s.ratio),
metrics:Engine_DATA_WITCH._clone(s.metrics),
ts:Date.now()
};
}
},
_wire:function(){
if(this._wireOnce) return;
this._wireOnce=true;
const ctx=this._ctx;
const bus=ctx&&ctx.bus?ctx.bus:null;
if(bus&&typeof bus.on==='function'){
bus.on('REQ:DATA_WITCH:MOUNT',()=>{try{this.api.mount();}catch(e){this._error('listener:MOUNT',e);}});
bus.on('REQ:DATA_WITCH:START',()=>{try{this.api.start();}catch(e){this._error('listener:START',e);}});
bus.on('REQ:DATA_WITCH:STOP',()=>{try{this.api.stop();}catch(e){this._error('listener:STOP',e);}});
bus.on('REQ:DATA_WITCH:ENABLE',()=>{try{this.api.enable();}catch(e){this._error('listener:ENABLE',e);}});
bus.on('REQ:DATA_WITCH:DISABLE',()=>{try{this.api.disable();}catch(e){this._error('listener:DISABLE',e);}});
bus.on('REQ:DATA_WITCH:CONFIG',(p)=>{try{this.api.setConfig(p||{});}catch(e){this._error('listener:CONFIG',e);}});
bus.on('REQ:DATA_WITCH:RECALC',()=>{try{this._recalc('bus');}catch(e){this._error('listener:RECALC',e);}});
bus.on('REQ:DATA_WITCH:STATUS',()=>{try{this._emit('EVT:DATA_WITCH:STATUS',{id:this.id,state:this.api.status(),ts:Date.now()});}catch(e){this._error('listener:STATUS',e);}});
bus.on('REQ:DATA_WITCH:SNAPSHOT',()=>{try{this._emit('EVT:DATA_WITCH:STATE',{id:this.id,state:this.api.status(),ts:Date.now()});}catch(e){this._error('listener:SNAPSHOT',e);}});
}
},
_bindDOM:function(){
try{
if(typeof window==='undefined') return;
this._onResize=this._onResize||(()=>{try{Engine_DATA_WITCH._recalc('resize');}catch(e){Engine_DATA_WITCH._error('onResize',e);}});
this._onVis=this._onVis||(()=>{try{Engine_DATA_WITCH._onVisibility();}catch(e){Engine_DATA_WITCH._error('onVis',e);}});
window.addEventListener('resize',this._onResize,{passive:true});
window.addEventListener('orientationchange',this._onResize,{passive:true});
if(this._state.config.useVisualViewport&&window.visualViewport){
window.visualViewport.addEventListener('resize',this._onResize,{passive:true});
window.visualViewport.addEventListener('scroll',this._onResize,{passive:true});
}
if(this._state.config.emitOnVisibility&&typeof document!=='undefined') document.addEventListener('visibilitychange',this._onVis,{passive:true});
}catch(e){
this._error('bindDOM',e);
}
},
_unbindDOM:function(){
try{
if(typeof window==='undefined') return;
if(this._onResize) window.removeEventListener('resize',this._onResize);
if(this._onResize) window.removeEventListener('orientationchange',this._onResize);
if(this._state.config.useVisualViewport&&window.visualViewport&&this._onResize){
window.visualViewport.removeEventListener('resize',this._onResize);
window.visualViewport.removeEventListener('scroll',this._onResize);
}
if(this._onVis&&typeof document!=='undefined') document.removeEventListener('visibilitychange',this._onVis);
}catch(e){
this._error('unbindDOM',e);
}
},
_onVisibility:function(){
const s=this._state;
let vis='unknown';
try{vis=(typeof document!=='undefined'&&document.visibilityState)?String(document.visibilityState):'unknown';}catch(_e){vis='unknown';}
s.ratio.visible=(vis!=='hidden');
this._recalc('visibility');
},
_startLoop:function(){
this._stopLoop();
const s=this._state;
const hz=this._clampNum(s.config.sampleHz,0.2,20);
const ms=Math.max(50,Math.floor(1000/hz));
s.timers.interval=setInterval(()=>{try{Engine_DATA_WITCH._recalc('tick');}catch(e){Engine_DATA_WITCH._error('loop',e);}},ms);
},
_restartLoop:function(){
if(!this._state.started) return;
this._startLoop();
},
_stopLoop:function(){
const s=this._state;
if(s.timers.interval){try{clearInterval(s.timers.interval);}catch(_e){}}
s.timers.interval=0;
},
_recalc:function(where){
try{
const s=this._state;
s.lastUpdate=Date.now();
s.metrics.samples++;
const vp=this._viewport();
const w=vp.w,h=vp.h;
const baseW=this._clampNum(s.config.baseW,1,99999);
const baseH=this._clampNum(s.config.baseH,1,99999);
const minW=this._clampNum(s.config.minW,1,99999);
const minH=this._clampNum(s.config.minH,1,99999);
const targetW=this._clampNum(w,minW,99999);
const targetH=this._clampNum(h,minH,99999);
const mode=String(s.config.mode||'contain');
let sx=1,sy=1,sc=1,ox=0,oy=0;
const rW=targetW/baseW;
const rH=targetH/baseH;
if(mode==='stretch'){sx=rW;sy=rH;sc=(rW+rH)/2;}
else if(mode==='fit-width'){sc=rW;sx=sc;sy=sc;}
else if(mode==='fit-height'){sc=rH;sx=sc;sy=sc;}
else if(mode==='cover'){sc=Math.max(rW,rH);sx=sc;sy=sc;}
else{sc=Math.min(rW,rH);sx=sc;sy=sc;}
if(s.config.snap&&isFinite(s.config.snap)&&s.config.snap>0){
const step=Math.max(0.0001,Number(s.config.snap));
sx=Math.round(sx/step)*step;
sy=Math.round(sy/step)*step;
sc=(sx+sy)/2;
}
const outW=baseW*sx;
const outH=baseH*sy;
ox=Math.floor((targetW-outW)/2);
oy=Math.floor((targetH-outH)/2);
const dpr=this._dpr();
const ori=this._orientation(targetW,targetH);
let vis='unknown';
try{vis=(typeof document!=='undefined'&&document.visibilityState)?String(document.visibilityState):'unknown';}catch(_e){vis='unknown';}
s.ratio={
w:baseW,h:baseH,
targetW:targetW,targetH:targetH,
scale:sc,scaleX:sx,scaleY:sy,
offsetX:ox,offsetY:oy,
dpr:dpr,
orientation:ori,
viewportW:w,viewportH:h,
visible:(vis!=='hidden'),
ts:Date.now()
};
if(where==='resize'){s.metrics.resizes++;s.metrics.lastResizeTs=Date.now();this._emit('EVT:DATA_WITCH:RESIZE',{id:this.id,ratio:this._clone(s.ratio),ts:Date.now()});}
if(s.config.emitOnResize&&where==='resize') this._emit('EVT:DATA_WITCH:STATE',{id:this.id,state:this.api.status(),ts:Date.now()});
if(where==='start'||where==='config'||where==='visibility') this._emit('EVT:DATA_WITCH:STATE',{id:this.id,state:this.api.status(),ts:Date.now()});
this._emit('EVT:DATA_WITCH:UPDATED',{id:this.id,ratio:this._clone(s.ratio),where:String(where||'tick'),ts:Date.now()});
}catch(e){
this._error('recalc:'+String(where||'unknown'),e);
}
},
_viewport:function(){
let w=0,h=0;
try{
if(this._state.config.useVisualViewport&&typeof window!=='undefined'&&window.visualViewport){
w=Math.floor(window.visualViewport.width||0);
h=Math.floor(window.visualViewport.height||0);
}else if(typeof window!=='undefined'){
w=Math.floor(window.innerWidth||0);
h=Math.floor(window.innerHeight||0);
}
}catch(_e){}
if(!w||!h){
try{
if(typeof document!=='undefined'&&document.documentElement){
w=Math.floor(document.documentElement.clientWidth||0);
h=Math.floor(document.documentElement.clientHeight||0);
}
}catch(_e){}
}
return {w:w||0,h:h||0};
},
_orientation:function(w,h){
w=Math.floor(w||0);h=Math.floor(h||0);
if(!w||!h) return 'unknown';
if(w===h) return 'square';
return (h>w)?'portrait':'landscape';
},
_dpr:function(){
try{
if(typeof window!=='undefined'&&window.devicePixelRatio) return Math.max(1,Number(window.devicePixelRatio)||1);
}catch(_e){}
return 1;
},
_setConfig:function(p){
const c=this._state.config;
p=p||{};
if(typeof p.autoStart==='boolean') c.autoStart=p.autoStart;
if(isFinite(p.sampleHz)) c.sampleHz=this._clampNum(p.sampleHz,0.2,20);
if(isFinite(p.baseW)) c.baseW=this._clampNum(p.baseW,1,99999);
if(isFinite(p.baseH)) c.baseH=this._clampNum(p.baseH,1,99999);
if(isFinite(p.minW)) c.minW=this._clampNum(p.minW,1,99999);
if(isFinite(p.minH)) c.minH=this._clampNum(p.minH,1,99999);
if(typeof p.mode==='string') c.mode=p.mode;
if(isFinite(p.snap)) c.snap=this._clampNum(p.snap,0,1);
if(typeof p.emitOnResize==='boolean') c.emitOnResize=p.emitOnResize;
if(typeof p.emitOnVisibility==='boolean') c.emitOnVisibility=p.emitOnVisibility;
if(typeof p.targetSelector==='string') c.targetSelector=p.targetSelector;
if(typeof p.useVisualViewport==='boolean') c.useVisualViewport=p.useVisualViewport;
},
_emit:function(evt,payload){
try{
const ctx=this._ctx;
const bus=ctx&&ctx.bus?ctx.bus:null;
if(!bus||typeof bus.emit!=='function') return;
bus.emit(evt,payload||{id:this.id,ts:Date.now()});
}catch(e){
this._error('emit',e);
}
},
_log:function(level,msg){
const ctx=this._ctx;
if(!ctx||!ctx.log) return;
try{
if(typeof ctx.log[level]==='function') ctx.log[level]('DATA_WITCH',msg);
else if(typeof ctx.log==='function') ctx.log('DATA_WITCH',msg);
}catch(_e){}
},
_error:function(where,e){
const msg=(e&&e.message)?e.message:String(e);
this._state.lastError=msg;
this._emit('EVT:DATA_WITCH:ERROR',{id:this.id,where,error:msg,ts:Date.now()});
this._log('warn',`${where}: ${msg}`);
},
_clone:function(o){
try{return JSON.parse(JSON.stringify(o));}catch(_e){return o;}
},
_clampNum:function(v,a,b){
v=Number(v);
if(!isFinite(v)) v=a;
if(v<a) v=a;
if(v>b) v=b;
return v;
},
_qs:function(sel){
try{if(typeof document==='undefined') return null;return document.querySelector(sel);}catch(_e){return null;}
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_DATA_WITCH.id]=Engine_DATA_WITCH;
/*-- üîÆüïØÔ∏è-(13A)-(E)-(PHANTOM-RATIO-ENGINE)-(DATA-WITCH)-(E)-(13A)-üïØÔ∏èüîÆ --*/
/*-- üïπÔ∏èüëÅÔ∏è-(14A)-(S)-(INPUT-MAP-ENGINE)-(GHOST-HAND)-(S)-(14A)-üëÅÔ∏èüïπÔ∏è --*/
const Engine_GHOST_HAND={
id:'GHOST_HAND',
_ctx:null,
_raf:0,
_state:{
enabled:true,
mounted:false,
mode:'DEFAULT',
keys:{},
pointer:{x:0,y:0,down:false,btn:0,dx:0,dy:0,wheel:0,ts:0},
touch:{active:false,x:0,y:0,ts:0},
gamepad:{enabled:true,index:0,connected:false,buttons:[],axes:[],ts:0},
actions:{},
bindings:{keys:{},mouse:{},touch:{},pad:{},},
lastError:null,
lastUpdate:0
},
_handlers:{},
init(ctx){
this._ctx=ctx;
this._wireBus();
this._emit('READY',{status:'IDLE'});
},
api:{
mount:(target)=>Engine_GHOST_HAND._mount(target),
enable:()=>Engine_GHOST_HAND._setEnabled(true),
disable:()=>Engine_GHOST_HAND._setEnabled(false),
toggle:()=>Engine_GHOST_HAND._setEnabled(!Engine_GHOST_HAND._state.enabled),
setMode:(mode)=>Engine_GHOST_HAND._setMode(mode),
bindKey:(key,action,meta)=>Engine_GHOST_HAND._bindKey(key,action,meta),
unbindKey:(key)=>Engine_GHOST_HAND._unbindKey(key),
bindMouse:(type,action,meta)=>Engine_GHOST_HAND._bindMouse(type,action,meta),
bindPad:(btnOrAxis,action,meta)=>Engine_GHOST_HAND._bindPad(btnOrAxis,action,meta),
registerAction:(name,fn)=>Engine_GHOST_HAND._registerAction(name,fn),
unregisterAction:(name)=>Engine_GHOST_HAND._unregisterAction(name),
setGamepad:(cfg)=>Engine_GHOST_HAND._setGamepad(cfg),
clear:()=>Engine_GHOST_HAND._clear(),
status:()=>Engine_GHOST_HAND.status()
},
_wireBus(){
const b=this._ctx&&this._ctx.bus?this._ctx.bus:null;
if(!b)return;
const on=(evt,fn)=>{
if(typeof b.on==='function')b.on(evt,fn);
else if(typeof b.subscribe==='function')b.subscribe(evt,fn);
else if(typeof b.addEventListener==='function')b.addEventListener(evt,fn);
};
on('REQ:GHOST_HAND:MOUNT',(p)=>this.api.mount(p));
on('REQ:GHOST_HAND:ENABLE',()=>this.api.enable());
on('REQ:GHOST_HAND:DISABLE',()=>this.api.disable());
on('REQ:GHOST_HAND:TOGGLE',()=>this.api.toggle());
on('REQ:GHOST_HAND:MODE',(p)=>this.api.setMode(p&&p.mode?p.mode:p));
on('REQ:GHOST_HAND:BIND_KEY',(p)=>this.api.bindKey(p&&p.key,p&&p.action,p&&p.meta));
on('REQ:GHOST_HAND:UNBIND_KEY',(p)=>this.api.unbindKey(p&&p.key?p.key:p));
on('REQ:GHOST_HAND:BIND_MOUSE',(p)=>this.api.bindMouse(p&&p.type,p&&p.action,p&&p.meta));
on('REQ:GHOST_HAND:BIND_PAD',(p)=>this.api.bindPad(p&&p.control,p&&p.action,p&&p.meta));
on('REQ:GHOST_HAND:REGISTER_ACTION',(p)=>this.api.registerAction(p&&p.name,p&&p.fn));
on('REQ:GHOST_HAND:UNREGISTER_ACTION',(p)=>this.api.unregisterAction(p&&p.name?p.name:p));
on('REQ:GHOST_HAND:GAMEPAD',(p)=>this.api.setGamepad(p));
on('REQ:GHOST_HAND:CLEAR',()=>this.api.clear());
on('REQ:GHOST_HAND:STATUS',()=>this._emit('STATE',{state:this.status()}));
},
_mount(){
if(this._state.mounted)return true;
try{
this._state.mounted=true;
this._bindDom();
this._startPadLoop();
this._emit('MOUNTED',{mounted:true});
this._emit('STATE',{state:this.status()});
return true;
}catch(e){
this._err('mount',e);
return false;
}
},
_bindDom(){
const s=this._state;
const H=this._handlers;
H.keydown=(e)=>this._onKey(e,true);
H.keyup=(e)=>this._onKey(e,false);
H.mousedown=(e)=>this._onMouseDown(e);
H.mouseup=(e)=>this._onMouseUp(e);
H.mousemove=(e)=>this._onMouseMove(e);
H.wheel=(e)=>this._onWheel(e);
H.touchstart=(e)=>this._onTouch(e,'start');
H.touchmove=(e)=>this._onTouch(e,'move');
H.touchend=(e)=>this._onTouch(e,'end');
H.gpconnect=(e)=>this._onGamepadConnect(e,true);
H.gpdisconnect=(e)=>this._onGamepadConnect(e,false);
window.addEventListener('keydown',H.keydown,{passive:true});
window.addEventListener('keyup',H.keyup,{passive:true});
window.addEventListener('mousedown',H.mousedown,{passive:true});
window.addEventListener('mouseup',H.mouseup,{passive:true});
window.addEventListener('mousemove',H.mousemove,{passive:true});
window.addEventListener('wheel',H.wheel,{passive:true});
window.addEventListener('touchstart',H.touchstart,{passive:true});
window.addEventListener('touchmove',H.touchmove,{passive:true});
window.addEventListener('touchend',H.touchend,{passive:true});
window.addEventListener('gamepadconnected',H.gpconnect,{passive:true});
window.addEventListener('gamepaddisconnected',H.gpdisconnect,{passive:true});
},
_setEnabled(v){
this._state.enabled=!!v;
this._touchUpdate();
this._emit('TOGGLE',{enabled:this._state.enabled});
this._emit('STATE',{state:this.status()});
},
_setMode(mode){
this._state.mode=mode||'DEFAULT';
this._emit('MODE',{mode:this._state.mode});
this._emit('STATE',{state:this.status()});
},
_bindKey(key,action,meta){
if(!key||!action)return false;
this._state.bindings.keys[String(key).toLowerCase()]={action,meta:meta||{}};
this._emit('BIND',{type:'key',key,action});
return true;
},
_unbindKey(key){
if(!key)return false;
delete this._state.bindings.keys[String(key).toLowerCase()];
this._emit('UNBIND',{type:'key',key});
return true;
},
_bindMouse(type,action,meta){
if(!type||!action)return false;
this._state.bindings.mouse[type]={action,meta:meta||{}};
this._emit('BIND',{type:'mouse',control:type,action});
return true;
},
_bindPad(control,action,meta){
if(!control||!action)return false;
this._state.bindings.pad[String(control)]={action,meta:meta||{}};
this._emit('BIND',{type:'pad',control,action});
return true;
},
_registerAction(name,fn){
if(!name||typeof fn!=='function')return false;
this._state.actions[name]=fn;
this._emit('ACTION_REGISTERED',{name});
return true;
},
_unregisterAction(name){
if(!name)return false;
delete this._state.actions[name];
this._emit('ACTION_UNREGISTERED',{name});
return true;
},
_setGamepad(cfg){
if(cfg&&typeof cfg==='object'){
if(cfg.index!==undefined)this._state.gamepad.index=parseInt(cfg.index,10)||0;
if(cfg.enabled!==undefined)this._state.gamepad.enabled=!!cfg.enabled;
}
this._emit('GAMEPAD',{gamepad:{...this._state.gamepad}});
this._emit('STATE',{state:this.status()});
},
_clear(){
this._state.keys={};
this._state.pointer={x:0,y:0,down:false,btn:0,dx:0,dy:0,wheel:0,ts:0};
this._state.touch={active:false,x:0,y:0,ts:0};
this._state.lastError=null;
this._emit('CLEARED',{});
this._emit('STATE',{state:this.status()});
},
_onKey(e,isDown){
if(!this._state.enabled)return;
const k=(e&&e.key?e.key:'').toLowerCase();
if(!k)return;
this._state.keys[k]=!!isDown;
this._state.lastUpdate=Date.now();
this._emit('KEY',{key:k,down:!!isDown,keys:this._state.keys,ts:this._state.lastUpdate});
if(isDown)this._triggerBinding('keys',k,{type:'key',key:k,down:true,raw:e});
},
_onMouseDown(e){
if(!this._state.enabled)return;
this._state.pointer.down=true;
this._state.pointer.btn=e&&e.button!==undefined?e.button:0;
this._state.pointer.ts=Date.now();
this._emit('POINTER',{...this._state.pointer,type:'down'});
this._triggerBinding('mouse','down',{type:'mouse',event:'down',raw:e});
},
_onMouseUp(e){
if(!this._state.enabled)return;
this._state.pointer.down=false;
this._state.pointer.btn=e&&e.button!==undefined?e.button:0;
this._state.pointer.ts=Date.now();
this._emit('POINTER',{...this._state.pointer,type:'up'});
this._triggerBinding('mouse','up',{type:'mouse',event:'up',raw:e});
},
_onMouseMove(e){
if(!this._state.enabled)return;
const p=this._state.pointer;
const nx=e&&e.clientX!==undefined?e.clientX:p.x;
const ny=e&&e.clientY!==undefined?e.clientY:p.y;
p.dx=nx-p.x;
p.dy=ny-p.y;
p.x=nx;
p.y=ny;
p.ts=Date.now();
this._emit('POINTER',{...p,type:'move'});
this._triggerBinding('mouse','move',{type:'mouse',event:'move',x:p.x,y:p.y,dx:p.dx,dy:p.dy,raw:e});
},
_onWheel(e){
if(!this._state.enabled)return;
const p=this._state.pointer;
p.wheel=(e&&e.deltaY!==undefined?e.deltaY:0);
p.ts=Date.now();
this._emit('POINTER',{...p,type:'wheel'});
this._triggerBinding('mouse','wheel',{type:'mouse',event:'wheel',wheel:p.wheel,raw:e});
},
_onTouch(e,phase){
if(!this._state.enabled)return;
const t=(e&&e.touches&&e.touches[0])||(e&&e.changedTouches&&e.changedTouches[0])||null;
if(!t&&phase!=='end')return;
if(phase==='end'){
this._state.touch.active=false;
this._state.touch.ts=Date.now();
this._emit('TOUCH',{...this._state.touch,phase:'end'});
this._triggerBinding('touch','end',{type:'touch',phase:'end',raw:e});
return;
}
this._state.touch.active=true;
this._state.touch.x=t.clientX;
this._state.touch.y=t.clientY;
this._state.touch.ts=Date.now();
this._emit('TOUCH',{...this._state.touch,phase});
this._triggerBinding('touch',phase,{type:'touch',phase,x:this._state.touch.x,y:this._state.touch.y,raw:e});
},
_onGamepadConnect(e,isOn){
this._state.gamepad.connected=!!isOn;
this._state.gamepad.ts=Date.now();
this._emit('GAMEPAD',{connected:this._state.gamepad.connected,ts:this._state.gamepad.ts});
this._emit('STATE',{state:this.status()});
},
_startPadLoop(){
if(this._raf)cancelAnimationFrame(this._raf);
const tick=()=>{
this._raf=requestAnimationFrame(tick);
if(!this._state.enabled)return;
if(!this._state.gamepad.enabled)return;
const gps=navigator.getGamepads?navigator.getGamepads():null;
const gp=gps?gps[this._state.gamepad.index]:null;
if(!gp){if(this._state.gamepad.connected){this._state.gamepad.connected=false;this._emit('GAMEPAD',{connected:false});}return;}
this._state.gamepad.connected=true;
this._state.gamepad.buttons=gp.buttons?gp.buttons.map(b=>!!b.pressed):[];
this._state.gamepad.axes=gp.axes?gp.axes.slice(0):[];
this._state.gamepad.ts=Date.now();
this._emit('PAD_STATE',{gamepad:{...this._state.gamepad}});
this._padBindings();
};
tick();
},
_padBindings(){
const b=this._state.bindings.pad;
if(!b)return;
const gp=this._state.gamepad;
if(!gp.connected)return;
const btns=gp.buttons||[];
const axes=gp.axes||[];
Object.keys(b).forEach(key=>{
const spec=b[key];
if(!spec||!spec.action)return;
if(key.startsWith('B')){
const idx=parseInt(key.slice(1),10);
if(isNaN(idx))return;
if(btns[idx])this._triggerAction(spec.action,{type:'pad',control:key,pressed:true,meta:spec.meta,ts:Date.now()});
return;
}
if(key.startsWith('A')){
const idx=parseInt(key.slice(1),10);
if(isNaN(idx))return;
const v=axes[idx]!==undefined?axes[idx]:0;
const dead=(spec.meta&&spec.meta.dead!==undefined)?spec.meta.dead:0.2;
if(Math.abs(v)>=dead)this._triggerAction(spec.action,{type:'pad',control:key,value:v,meta:spec.meta,ts:Date.now()});
return;
}
});
},
_triggerBinding(bucket,key,payload){
const map=this._state.bindings[bucket];
if(!map)return;
const spec=map[key];
if(!spec||!spec.action)return;
this._triggerAction(spec.action,{...payload,meta:spec.meta||{},ts:Date.now()});
},
_triggerAction(name,payload){
const fn=this._state.actions[name];
this._emit('ACTION',{name,payload});
if(typeof fn==='function'){
try{fn(payload);}catch(e){this._err('action:'+name,e);}
}
},
_touchUpdate(){
this._state.pointer.dx=0;
this._state.pointer.dy=0;
this._state.pointer.wheel=0;
},
_emit(suffix,payload={}){
if(!this._ctx||!this._ctx.bus)return;
this._state.lastUpdate=Date.now();
const msg={id:'GHOST_HAND',state:this.status(),...payload,ts:Date.now()};
this._ctx.bus.emit(`EVT:GHOST_HAND:${suffix}`,msg);
},
_err(where,e){
const msg=e&&e.message?e.message:String(e);
this._state.lastError=msg;
if(this._ctx&&this._ctx.bus)this._ctx.bus.emit('EVT:GHOST_HAND:ERROR',{id:'GHOST_HAND',where,error:msg,ts:Date.now()});
},
status(){
return JSON.parse(JSON.stringify(this._state));
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_GHOST_HAND.id]=Engine_GHOST_HAND;
/*-- üïπÔ∏èüëÅÔ∏è-(14A)-(E)-(INPUT-MAP-ENGINE)-(GHOST-HAND)-(E)-(14A)-üëÅÔ∏èüïπÔ∏è --*/
/*-- ü¶áüßõ-(15A)-(S)-(SECURITY-GATE-ENGINE)-(NIGHT-SHADE)-(S)-(15A)-üßõü¶á --*/
const Engine_NIGHT_SHADE={
id:"NIGHT_SHADE",
_ctx:null,
_key:"KOG_NS_DATA",
_state:{
enabled:true,
mounted:false,
mode:"OPEN",
policyVersion:"1A",
allowList:new Set(),
denyList:new Set(),
tokens:new Map(),
lastError:null,
lastUpdate:0
},

init(ctx){
this._ctx=ctx;
this._safe(()=>this._load(),"init_load");
this._safe(()=>this._bindEvents(),"init_bind");
this._emit("READY");
},

api:{
mount:()=>Engine_NIGHT_SHADE._mount(),
enable:()=>Engine_NIGHT_SHADE._setEnabled(true),
disable:()=>Engine_NIGHT_SHADE._setEnabled(false),
setMode:(m)=>Engine_NIGHT_SHADE._setMode(m),
allow:(cap)=>Engine_NIGHT_SHADE._modList(cap,"allow",true),
deny:(cap)=>Engine_NIGHT_SHADE._modList(cap,"deny",true),
clearAllow:(cap)=>Engine_NIGHT_SHADE._modList(cap,"allow",false),
clearDeny:(cap)=>Engine_NIGHT_SHADE._modList(cap,"deny",false),
check:(cap,meta)=>Engine_NIGHT_SHADE._check(cap,meta),
guard:(cap,fn,meta)=>Engine_NIGHT_SHADE._guard(cap,fn,meta),
issueToken:(label,ttlMs,meta)=>Engine_NIGHT_SHADE._issueToken(label,ttlMs,meta),
revokeToken:(tokenId)=>Engine_NIGHT_SHADE._revokeToken(tokenId),
validateToken:(tokenId)=>Engine_NIGHT_SHADE._validateToken(tokenId),
status:()=>Engine_NIGHT_SHADE._status()
},

_mount(){
if(this._state.mounted) return;
this._state.mounted=true;
this._update();
this._emit("MOUNTED");
},

_setEnabled(v){
this._state.enabled=!!v;
this._update();
},

_setMode(mode){
const m=String(mode||"").toUpperCase();
if(m!=="OPEN"&&m!=="SOFT_LOCK"&&m!=="HARD_LOCK"){this._err("setMode","Invalid mode: "+mode);return;}
this._state.mode=m;
this._save();
this._update();
this._emit("MODE",{mode:m});
},

_modList(caps,listName,add){
try{
const s=this._state;
const set=listName==="allow"?s.allowList:s.denyList;
if(!caps&&!add){set.clear();this._save();this._update();return;}
const arr=Array.isArray(caps)?caps:[caps];
arr.forEach(c=>{
if(typeof c!=="string") return;
if(add) set.add(c);
else set.delete(c);
});
this._save();
this._update();
}catch(e){this._err("_modList",e.message||String(e));}
},

_check(cap,meta){
try{
const s=this._state;
const c=typeof cap==="string"?cap:"";
const internal=c.indexOf("NIGHT_SHADE:")===0;
const safeRead=c.endsWith(":STATUS")||c.endsWith(":CHECK");
const res=(ok,reason)=>({ok,mode:s.mode,capability:c,reason,meta:meta||null,ts:Date.now()});

if(!s.enabled) return res(false,"DISABLED");
if(!c) return res(false,"NO_CAPABILITY");
if(s.denyList.has(c)) return res(false,"DENIED_EXPLICIT");

const allowed=s.allowList.has(c);

if(s.mode==="OPEN") return res(true,allowed?"ALLOWED_EXPLICIT":"ALLOWED_OPEN");

if(s.mode==="HARD_LOCK"){
if(internal||allowed) return res(true,internal?"ALLOWED_INTERNAL":"ALLOWED_HARD");
return res(false,"HARD_LOCK_BLOCK");
}

if(s.mode==="SOFT_LOCK"){
if(internal||safeRead||allowed) return res(true,internal?"ALLOWED_INTERNAL":(safeRead?"ALLOWED_SAFE_READ":"ALLOWED_SOFT"));
return res(false,"SOFT_LOCK_BLOCK");
}

return res(false,"UNKNOWN_MODE");
}catch(e){this._err("check",e.message||String(e));return {ok:false,mode:this._state.mode,capability:cap,reason:"ERROR",ts:Date.now()};}
},

_guard(cap,fn,meta){
const r=this._check(cap,meta);
if(!r.ok) return null;
if(typeof fn!=="function") return null;
try{return fn();}catch(e){this._err("guard_exec",e.message||String(e));return null;}
},

_issueToken(label,ttlMs,meta){
try{
this._pruneTokens();
const now=Date.now();
const ttl=typeof ttlMs==="number"&&ttlMs>0?ttlMs:0;
const id=now+"_"+Math.random().toString(36).slice(2,11);
const tok={
tokenId:id,
label:typeof label==="string"?label:"token",
created:now,
ttl:ttl,
expires:ttl?now+ttl:null,
meta:meta||null
};
this._state.tokens.set(id,tok);
this._update();
this._emit("TOKEN_ISSUED",{token:tok});
return tok;
}catch(e){this._err("issueToken",e.message||String(e));return null;}
},

_revokeToken(id){
try{
this._pruneTokens();
if(!id) return false;
const ok=this._state.tokens.delete(String(id));
this._update();
this._emit("TOKEN_REVOKED",{tokenId:String(id),ok:!!ok});
return !!ok;
}catch(e){this._err("revokeToken",e.message||String(e));return false;}
},

_validateToken(id){
try{
this._pruneTokens();
if(!id) return false;
return this._state.tokens.has(String(id));
}catch(e){this._err("validateToken",e.message||String(e));return false;}
},

_pruneTokens(){
try{
const now=Date.now();
for(const [id,t] of this._state.tokens){
if(t&&t.expires&&now>t.expires) this._state.tokens.delete(id);
}
}catch(e){}
},

_status(){
this._pruneTokens();
const s=this._state;
const out={
enabled:s.enabled,
mounted:s.mounted,
mode:s.mode,
policyVersion:s.policyVersion,
allowList:Array.from(s.allowList),
denyList:Array.from(s.denyList),
tokens:Array.from(s.tokens.values()),
lastError:s.lastError,
lastUpdate:s.lastUpdate
};
this._emit("STATE",out);
return out;
},

_update(){
this._state.lastUpdate=Date.now();
this._emit("UPDATED");
this._status();
},

_emit(evt,data){
try{
if(!this._ctx||!this._ctx.bus) return;
const payload={id:this.id,state:this._statusLite(),ts:Date.now()};
if(data&&typeof data==="object") Object.assign(payload,data);
this._ctx.bus.emit("EVT:NIGHT_SHADE:"+evt,payload);
}catch(e){this._err("_emit",e.message||String(e));}
},

_statusLite(){
const s=this._state;
return{
enabled:s.enabled,
mounted:s.mounted,
mode:s.mode,
policyVersion:s.policyVersion,
allowList:Array.from(s.allowList),
denyList:Array.from(s.denyList),
tokens:Array.from(s.tokens.keys()),
lastError:s.lastError,
lastUpdate:s.lastUpdate
};
},

_err(where,msg){
this._state.lastError=String(msg||"error");
try{
if(this._ctx&&this._ctx.bus){
this._ctx.bus.emit("EVT:NIGHT_SHADE:ERROR",{id:this.id,where:String(where||"unknown"),error:String(msg||"error"),ts:Date.now()});
}
}catch(e){}
return false;
},

_safe(fn,where){
try{fn();}catch(e){this._err(where||"safe",e.message||String(e));}
},

_save(){
try{
const s=this._state;
const payload=JSON.stringify({
policyVersion:s.policyVersion,
mode:s.mode,
allowList:Array.from(s.allowList),
denyList:Array.from(s.denyList)
});
window.localStorage&&window.localStorage.setItem(this._key,payload);
}catch(e){}
},

_load(){
try{
const raw=window.localStorage&&window.localStorage.getItem(this._key);
if(!raw) return;
const d=JSON.parse(raw);
if(d&&typeof d==="object"){
if(typeof d.policyVersion==="string") this._state.policyVersion=d.policyVersion;
if(typeof d.mode==="string") this._state.mode=d.mode;
if(Array.isArray(d.allowList)) d.allowList.forEach(x=>{if(typeof x==="string") this._state.allowList.add(x);});
if(Array.isArray(d.denyList)) d.denyList.forEach(x=>{if(typeof x==="string") this._state.denyList.add(x);});
}
}catch(e){}
},

_bindEvents(){
const bus=this._ctx&&this._ctx.bus;
if(!bus) return;
const on=(t,fn)=>{
try{
if(typeof bus.on==="function") bus.on(t,fn);
else if(typeof bus.subscribe==="function") bus.subscribe(t,fn);
}catch(e){this._err("bind:"+t,e.message||String(e));}
};
on("REQ:NIGHT_SHADE:MOUNT",()=>this.api.mount());
on("REQ:NIGHT_SHADE:ENABLE",()=>this.api.enable());
on("REQ:NIGHT_SHADE:DISABLE",()=>this.api.disable());
on("REQ:NIGHT_SHADE:MODE",(d)=>this.api.setMode(d&&d.mode));
on("REQ:NIGHT_SHADE:ALLOW",(d)=>this.api.allow(d&&d.cap));
on("REQ:NIGHT_SHADE:DENY",(d)=>this.api.deny(d&&d.cap));
on("REQ:NIGHT_SHADE:CLEAR_ALLOW",(d)=>this.api.clearAllow(d&&d.cap));
on("REQ:NIGHT_SHADE:CLEAR_DENY",(d)=>this.api.clearDeny(d&&d.cap));
on("REQ:NIGHT_SHADE:CHECK",(d)=>this.api.check(d&&d.capability,d&&d.meta));
on("REQ:NIGHT_SHADE:GUARD",(d)=>this.api.guard(d&&d.capability,d&&d.fn,d&&d.meta));
on("REQ:NIGHT_SHADE:ISSUE_TOKEN",(d)=>this.api.issueToken(d&&d.label,d&&d.ttlMs,d&&d.meta));
on("REQ:NIGHT_SHADE:REVOKE_TOKEN",(d)=>this.api.revokeToken(d&&d.tokenId));
on("REQ:NIGHT_SHADE:VALIDATE_TOKEN",(d)=>{const ok=this.api.validateToken(d&&d.tokenId);this._emit("TOKEN_VALID",{tokenId:String(d&&d.tokenId||""),ok:!!ok});});
on("REQ:NIGHT_SHADE:STATUS",()=>this.api.status());
}
};

window.KOG=window.KOG||{};
window.KOG[Engine_NIGHT_SHADE.id]=Engine_NIGHT_SHADE;
/*-- ü¶áüßõ-(15A)-(E)-(SECURITY-GATE-ENGINE)-(NIGHT-SHADE)-(E)-(15A)-üßõü¶á --*/
/*-- üß¨üß†-(16A)-(S)-(STORAGE-PROFILE-ENGINE)-(BIO-HACKER)-(S)-(16A)-üß†üß¨ --*/
const Engine_BIO_HACKER={
id:"BIO_HACKER",
_ctx:null,
_key:"KOG_BIO_HACKER_PROFILE",
_state:{
enabled:true,
mounted:false,
loaded:false,
lastError:null,
lastUpdate:0,
profile:{
id:"default",
created:0,
updated:0,
name:"Player",
flags:{},
prefs:{},
stats:{},
progress:{},
meta:{}
}
},

init(ctx){
this._ctx=ctx;
this._safe(()=>this._load(),"init_load");
this._safe(()=>this._bindEvents(),"init_bind");
this._emit("READY");
},

api:{
mount:()=>Engine_BIO_HACKER._mount(),
enable:()=>Engine_BIO_HACKER._setEnabled(true),
disable:()=>Engine_BIO_HACKER._setEnabled(false),
getProfile:()=>Engine_BIO_HACKER._getProfile(),
setProfile:(p)=>Engine_BIO_HACKER._setProfile(p),
patch:(path,val)=>Engine_BIO_HACKER._patch(path,val),
merge:(obj)=>Engine_BIO_HACKER._merge(obj),
reset:(keepId)=>Engine_BIO_HACKER._reset(keepId),
save:()=>Engine_BIO_HACKER._save(),
load:()=>Engine_BIO_HACKER._load(true),
export:()=>Engine_BIO_HACKER._export(),
import:(data,mode)=>Engine_BIO_HACKER._import(data,mode),
status:()=>Engine_BIO_HACKER._status()
},

_mount(){
if(this._state.mounted) return;
this._state.mounted=true;
this._update();
this._emit("MOUNTED");
},

_setEnabled(v){
this._state.enabled=!!v;
this._update();
},

_getProfile(){
return this._clone(this._state.profile);
},

_setProfile(p){
try{
if(!p||typeof p!=="object"){this._err("setProfile","Invalid profile");return null;}
const now=Date.now();
const next=this._normalize(p,now);
this._state.profile=next;
this._save();
this._update();
this._emit("PROFILE_SET",{profile:this._clone(next)});
return this._clone(next);
}catch(e){this._err("setProfile",e.message||String(e));return null;}
},

_patch(path,val){
try{
const s=this._state.profile;
const p=this._normPath(path);
if(!p){this._err("patch","Invalid path");return null;}
this._setDeep(s,p,val);
s.updated=Date.now();
this._save();
this._update();
this._emit("PATCHED",{path:p.join("."),value:this._clone(val)});
return this._clone(this._state.profile);
}catch(e){this._err("patch",e.message||String(e));return null;}
},

_merge(obj){
try{
if(!obj||typeof obj!=="object"){this._err("merge","Invalid merge object");return null;}
this._mergeDeep(this._state.profile,obj);
this._state.profile.updated=Date.now();
this._save();
this._update();
this._emit("MERGED",{delta:this._clone(obj)});
return this._clone(this._state.profile);
}catch(e){this._err("merge",e.message||String(e));return null;}
},

_reset(keepId){
try{
const old=this._state.profile;
const now=Date.now();
const id=keepId?String(old.id||"default"):"default";
this._state.profile=this._normalize({id,name:"Player"},now);
this._state.profile.id=id;
this._save();
this._update();
this._emit("RESET",{keepId:!!keepId});
return this._clone(this._state.profile);
}catch(e){this._err("reset",e.message||String(e));return null;}
},

_export(){
try{
const payload={id:this.id,ts:Date.now(),profile:this._clone(this._state.profile)};
this._emit("EXPORTED",{bytes:JSON.stringify(payload).length});
return payload;
}catch(e){this._err("export",e.message||String(e));return null;}
},

_import(data,mode){
try{
if(!data){this._err("import","No data");return null;}
const m=String(mode||"REPLACE").toUpperCase();
const incoming=(typeof data==="string")?JSON.parse(data):data;
const p=incoming&&incoming.profile?incoming.profile:incoming;
if(!p||typeof p!=="object"){this._err("import","Invalid import payload");return null;}
if(m==="MERGE"){return this._setProfile(this._normalize(this._mergeReturn(this._state.profile,p),Date.now()));}
return this._setProfile(p);
}catch(e){this._err("import",e.message||String(e));return null;}
},

_save(){
try{
if(!this._hasLS()) return false;
const out={v:1,ts:Date.now(),profile:this._state.profile};
window.localStorage.setItem(this._key,JSON.stringify(out));
return true;
}catch(e){this._err("save",e.message||String(e));return false;}
},

_load(emit){
try{
const now=Date.now();
if(!this._hasLS()){
this._state.loaded=true;
this._state.profile=this._normalize(this._state.profile,now);
this._update();
if(emit) this._emit("LOADED",{from:"memory"});
return this._clone(this._state.profile);
}
const raw=window.localStorage.getItem(this._key);
if(!raw){
this._state.loaded=true;
this._state.profile=this._normalize(this._state.profile,now);
this._save();
this._update();
if(emit) this._emit("LOADED",{from:"default"});
return this._clone(this._state.profile);
}
const d=JSON.parse(raw);
const p=d&&d.profile?d.profile:null;
this._state.loaded=true;
this._state.profile=this._normalize(p||this._state.profile,now);
this._update();
if(emit) this._emit("LOADED",{from:"localStorage"});
return this._clone(this._state.profile);
}catch(e){
this._err("load",e.message||String(e));
this._state.loaded=true;
this._state.profile=this._normalize(this._state.profile,Date.now());
this._update();
if(emit) this._emit("LOADED",{from:"recovered"});
return this._clone(this._state.profile);
}
},

_status(){
const st=this._statusObj();
this._emit("STATE",st);
return st;
},

_statusObj(){
const s=this._state;
return{
enabled:s.enabled,
mounted:s.mounted,
loaded:s.loaded,
lastError:s.lastError,
lastUpdate:s.lastUpdate,
profile:this._clone(s.profile)
};
},

_update(){
this._state.lastUpdate=Date.now();
this._emit("UPDATED");
},

_emit(evt,data){
try{
if(!this._ctx||!this._ctx.bus) return;
const payload={id:this.id,state:this._lite(),ts:Date.now()};
if(data&&typeof data==="object") Object.assign(payload,data);
this._ctx.bus.emit("EVT:BIO_HACKER:"+evt,payload);
}catch(e){this._err("_emit",e.message||String(e));}
},

_lite(){
const s=this._state;
return{
enabled:s.enabled,
mounted:s.mounted,
loaded:s.loaded,
lastError:s.lastError,
lastUpdate:s.lastUpdate,
profile:{id:s.profile.id,updated:s.profile.updated,name:s.profile.name}
};
},

_err(where,msg){
this._state.lastError=String(msg||"error");
try{
this._ctx&&this._ctx.bus&&this._ctx.bus.emit("EVT:BIO_HACKER:ERROR",{id:this.id,where:String(where||"unknown"),error:String(msg||"error"),ts:Date.now()});
}catch(e){}
return false;
},

_safe(fn,where){
try{fn();}catch(e){this._err(where||"safe",e.message||String(e));}
},

_hasLS(){
try{return !!(window.localStorage&&typeof window.localStorage.getItem==="function");}catch(e){return false;}
},

_normalize(p,now){
const base={
id:"default",
created:now,
updated:now,
name:"Player",
flags:{},
prefs:{},
stats:{},
progress:{},
meta:{}
};
if(!p||typeof p!=="object") return base;
const out=this._mergeReturn(base,p);
out.id=String(out.id||"default");
out.name=String(out.name||"Player");
out.created=typeof out.created==="number"&&out.created>0?out.created:now;
out.updated=typeof out.updated==="number"&&out.updated>0?out.updated:now;
out.flags=this._obj(out.flags);
out.prefs=this._obj(out.prefs);
out.stats=this._obj(out.stats);
out.progress=this._obj(out.progress);
out.meta=this._obj(out.meta);
return out;
},

_obj(x){
return (x&&typeof x==="object"&&!Array.isArray(x))?x:{};
},

_clone(x){
try{return JSON.parse(JSON.stringify(x));}catch(e){return x;}
},

_normPath(path){
if(!path) return null;
if(Array.isArray(path)) return path.map(s=>String(s)).filter(Boolean);
if(typeof path==="string"){
const p=path.replace(/\[(\d+)\]/g,".$1").split(".").map(s=>s.trim()).filter(Boolean);
return p.length?p:null;
}
return null;
},

_setDeep(obj,path,val){
let cur=obj;
for(let i=0;i<path.length;i++){
const k=path[i];
if(i===path.length-1){cur[k]=val;return;}
if(!cur[k]||typeof cur[k]!=="object") cur[k]={};
cur=cur[k];
}
},

_mergeReturn(a,b){
const out=this._clone(a);
this._mergeDeep(out,b);
return out;
},

_mergeDeep(dst,src){
if(!src||typeof src!=="object") return;
Object.keys(src).forEach(k=>{
const v=src[k];
if(v&&typeof v==="object"&&!Array.isArray(v)){
if(!dst[k]||typeof dst[k]!=="object"||Array.isArray(dst[k])) dst[k]={};
this._mergeDeep(dst[k],v);
}else dst[k]=v;
});
},

_bindEvents(){
const bus=this._ctx&&this._ctx.bus;
if(!bus) return;
const on=(t,fn)=>{
try{
if(typeof bus.on==="function") bus.on(t,fn);
else if(typeof bus.subscribe==="function") bus.subscribe(t,fn);
}catch(e){this._err("bind:"+t,e.message||String(e));}
};
on("REQ:BIO_HACKER:MOUNT",()=>this.api.mount());
on("REQ:BIO_HACKER:ENABLE",()=>this.api.enable());
on("REQ:BIO_HACKER:DISABLE",()=>this.api.disable());
on("REQ:BIO_HACKER:GET",()=>this.api.getProfile());
on("REQ:BIO_HACKER:SET",(d)=>this.api.setProfile(d&&d.profile));
on("REQ:BIO_HACKER:PATCH",(d)=>this.api.patch(d&&d.path,d&&d.value));
on("REQ:BIO_HACKER:MERGE",(d)=>this.api.merge(d&&d.delta));
on("REQ:BIO_HACKER:RESET",(d)=>this.api.reset(d&&d.keepId));
on("REQ:BIO_HACKER:SAVE",()=>this.api.save());
on("REQ:BIO_HACKER:LOAD",()=>this.api.load());
on("REQ:BIO_HACKER:EXPORT",()=>this.api.export());
on("REQ:BIO_HACKER:IMPORT",(d)=>this.api.import(d&&d.data,d&&d.mode));
on("REQ:BIO_HACKER:STATUS",()=>this.api.status());
}
};

window.KOG=window.KOG||{};
window.KOG[Engine_BIO_HACKER.id]=Engine_BIO_HACKER;
/*-- üß¨üß†-(16A)-(E)-(STORAGE-PROFILE-ENGINE)-(BIO-HACKER)-(E)-(16A)-üß†üß¨ --*/
/*-- ‚òÄÔ∏èüòé-(17A)-(S)-(INPUT-HOTKEY-ENGINE)-(SOLAR-FLARE)-(S)-(17A)-üòé‚òÄÔ∏è --*/
const Engine_SOLAR_FLARE={
id:"SOLAR_FLARE",
_ctx:null,
_state:{
enabled:true,
mounted:false,
started:false,
lastError:null,
lastUpdate:0,
config:{
capture:true,
preventDefault:true,
allowInInputs:false,
allowRepeat:false,
comboTimeoutMs:350,
maxBindings:64
},
mods:{alt:false,ctrl:false,shift:false,meta:false},
down:{},
bindings:{},
recent:{ts:0,combo:""}
},

init(ctx){
this._ctx=ctx;
this._safe(()=>this._bindEvents(),"init_bind");
this._emit("READY");
},

api:{
mount:()=>Engine_SOLAR_FLARE._mount(),
enable:()=>Engine_SOLAR_FLARE._setEnabled(true),
disable:()=>Engine_SOLAR_FLARE._setEnabled(false),
start:()=>Engine_SOLAR_FLARE._start(),
stop:()=>Engine_SOLAR_FLARE._stop(),
setConfig:(c)=>Engine_SOLAR_FLARE._setConfig(c),
bind:(b)=>Engine_SOLAR_FLARE._bind(b),
unbind:(combo)=>Engine_SOLAR_FLARE._unbind(combo),
clear:()=>Engine_SOLAR_FLARE._clear(),
snapshot:()=>Engine_SOLAR_FLARE._snapshot(),
status:()=>Engine_SOLAR_FLARE._status()
},

_mount(){
if(this._state.mounted) return;
this._state.mounted=true;
this._touch();
this._emit("MOUNTED");
},

_setEnabled(v){
this._state.enabled=!!v;
if(!this._state.enabled) this._stop();
this._touch();
this._emit("STATE");
},

_start(){
if(!this._state.enabled) return;
if(this._state.started) return;
this._state.started=true;
this._safe(()=>this._attach(),"start_attach");
this._touch();
this._emit("STARTED");
},

_stop(){
if(!this._state.started) return;
this._state.started=false;
this._safe(()=>this._detach(),"stop_detach");
this._state.mods={alt:false,ctrl:false,shift:false,meta:false};
this._state.down={};
this._touch();
this._emit("STOPPED");
},

_setConfig(c){
try{
if(!c||typeof c!=="object"){this._touch();return this._snapshot();}
const cfg=this._state.config;
if(typeof c.capture==="boolean") cfg.capture=c.capture;
if(typeof c.preventDefault==="boolean") cfg.preventDefault=c.preventDefault;
if(typeof c.allowInInputs==="boolean") cfg.allowInInputs=c.allowInInputs;
if(typeof c.allowRepeat==="boolean") cfg.allowRepeat=c.allowRepeat;
if(typeof c.comboTimeoutMs==="number") cfg.comboTimeoutMs=this._clamp(c.comboTimeoutMs,50,1500);
if(typeof c.maxBindings==="number") cfg.maxBindings=this._clamp(Math.floor(c.maxBindings),1,256);
this._prune();
this._touch();
this._emit("UPDATED",{config:this._clone(cfg)});
return this._snapshot();
}catch(e){this._err("setConfig",e.message||String(e));return this._snapshot();}
},

_bind(b){
try{
if(!b||typeof b!=="object"){this._err("bind","Invalid binding");return false;}
const combo=this._normCombo(b.combo);
if(!combo){this._err("bind","Missing combo");return false;}
const emit=String(b.emit||"EVT:SOLAR_FLARE:FIRED");
const payload=(b.payload&&typeof b.payload==="object")?b.payload:{};
const desc=b.desc?String(b.desc):"";
this._state.bindings[combo]={combo,emit,payload,desc,ts:Date.now(),count:0};
this._prune();
this._touch();
this._emit("BIND",{combo,emit,desc});
return true;
}catch(e){this._err("bind",e.message||String(e));return false;}
},

_unbind(combo){
try{
const c=this._normCombo(combo);
if(!c) return false;
if(this._state.bindings[c]) delete this._state.bindings[c];
this._touch();
this._emit("UNBIND",{combo:c});
return true;
}catch(e){this._err("unbind",e.message||String(e));return false;}
},

_clear(){
try{
this._state.bindings={};
this._touch();
this._emit("CLEARED");
return true;
}catch(e){this._err("clear",e.message||String(e));return false;}
},

_snapshot(){
return{ id:this.id,state:this._statusObj(),ts:Date.now() };
},

_status(){
const out=this._snapshot();
this._emit("STATE",out);
return out;
},

_statusObj(){
const s=this._state;
return{
enabled:s.enabled,
mounted:s.mounted,
started:s.started,
lastError:s.lastError,
lastUpdate:s.lastUpdate,
config:this._clone(s.config),
bindings:this._listBindings(),
mods:this._clone(s.mods)
};
},

_listBindings(){
const b=this._state.bindings;
const keys=Object.keys(b);
keys.sort();
return keys.map(k=>({combo:b[k].combo,emit:b[k].emit,desc:b[k].desc,count:b[k].count||0,ts:b[k].ts||0}));
},

_attach(){
if(this._onKeyDown||this._onKeyUp||this._onBlur) return;
this._onKeyDown=(e)=>this._safe(()=>this._handleDown(e),"keydown");
this._onKeyUp=(e)=>this._safe(()=>this._handleUp(e),"keyup");
this._onBlur=()=>this._safe(()=>this._handleBlur(),"blur");
try{
window.addEventListener("keydown",this._onKeyDown,{capture:this._state.config.capture});
window.addEventListener("keyup",this._onKeyUp,{capture:this._state.config.capture});
window.addEventListener("blur",this._onBlur,{capture:true});
}catch(e){this._err("attach",e.message||String(e));}
},

_detach(){
try{
if(this._onKeyDown) window.removeEventListener("keydown",this._onKeyDown,{capture:this._state.config.capture});
if(this._onKeyUp) window.removeEventListener("keyup",this._onKeyUp,{capture:this._state.config.capture});
if(this._onBlur) window.removeEventListener("blur",this._onBlur,{capture:true});
}catch(e){this._err("detach",e.message||String(e));}
this._onKeyDown=null;
this._onKeyUp=null;
this._onBlur=null;
},

_handleBlur(){
this._state.mods={alt:false,ctrl:false,shift:false,meta:false};
this._state.down={};
this._touch();
this._emit("UPDATED",{where:"blur"});
},

_handleDown(e){
if(!this._state.enabled||!this._state.started) return;
if(!e) return;
if(!this._state.config.allowRepeat&&e.repeat) return;
if(!this._state.config.allowInInputs&&this._isTypingTarget(e.target)) return;
this._syncMods(e);
const key=this._normKey(e);
if(!key) return;
this._state.down[key]=1;
const combo=this._composeCombo(key);
if(!combo) return;
const hit=this._fire(combo,e,"down");
if(hit&&this._state.config.preventDefault){try{e.preventDefault();}catch(_e){}}
},

_handleUp(e){
if(!this._state.enabled||!this._state.started) return;
if(!e) return;
this._syncMods(e);
const key=this._normKey(e);
if(key&&this._state.down[key]) delete this._state.down[key];
},

_fire(combo,e,phase){
const b=this._state.bindings[combo];
const now=Date.now();
const recent=this._state.recent;
if(recent.combo===combo&&(now-recent.ts)<this._state.config.comboTimeoutMs) return false;
if(!b){
this._emit("KEY",{combo,phase:phase||"down",key:this._normKey(e)||"",mods:this._clone(this._state.mods)});
return false;
}
recent.ts=now;
recent.combo=combo;
b.count=(b.count||0)+1;
const payload=this._clone(b.payload||{});
payload.id=this.id;
payload.combo=combo;
payload.phase=phase||"down";
payload.key=this._normKey(e)||"";
payload.mods=this._clone(this._state.mods);
payload.ts=Date.now();
this._emitRaw(b.emit,payload);
this._emit("FIRED",{combo,emit:b.emit,desc:b.desc||"",count:b.count});
this._touch();
return true;
},

_emit(evt,data){
try{
if(!this._ctx||!this._ctx.bus) return;
const payload={id:this.id,state:this._lite(),ts:Date.now()};
if(data&&typeof data==="object") Object.assign(payload,data);
this._ctx.bus.emit("EVT:SOLAR_FLARE:"+evt,payload);
}catch(e){this._err("_emit",e.message||String(e));}
},

_emitRaw(topic,payload){
try{
if(!this._ctx||!this._ctx.bus) return;
this._ctx.bus.emit(String(topic||"EVT:SOLAR_FLARE:FIRED"),payload||{id:this.id,ts:Date.now()});
}catch(e){this._err("emitRaw",e.message||String(e));}
},

_lite(){
const s=this._state;
return{enabled:s.enabled,mounted:s.mounted,started:s.started,lastError:s.lastError,lastUpdate:s.lastUpdate};
},

_touch(){
this._state.lastUpdate=Date.now();
},

_err(where,msg){
this._state.lastError=String(msg||"error");
try{
this._ctx&&this._ctx.bus&&this._ctx.bus.emit("EVT:SOLAR_FLARE:ERROR",{id:this.id,where:String(where||"unknown"),error:String(msg||"error"),ts:Date.now()});
}catch(e){}
return false;
},

_safe(fn,where){
try{fn();}catch(e){this._err(where||"safe",e.message||String(e));}
},

_syncMods(e){
this._state.mods.alt=!!e.altKey;
this._state.mods.ctrl=!!e.ctrlKey;
this._state.mods.shift=!!e.shiftKey;
this._state.mods.meta=!!e.metaKey;
},

_normKey(e){
try{
let k=e&&e.key!=null?String(e.key):"";
if(!k) return "";
k=k.length===1?k.toUpperCase():k;
if(k===" ") k="SPACE";
if(k==="Esc") k="ESCAPE";
if(k==="ArrowUp") k="ARROWUP";
if(k==="ArrowDown") k="ARROWDOWN";
if(k==="ArrowLeft") k="ARROWLEFT";
if(k==="ArrowRight") k="ARROWRIGHT";
if(k==="OS") k="META";
return k.toUpperCase();
}catch(_e){return "";}
},

_composeCombo(key){
const m=this._state.mods;
let parts=[];
if(m.ctrl) parts.push("CTRL");
if(m.alt) parts.push("ALT");
if(m.shift) parts.push("SHIFT");
if(m.meta) parts.push("META");
parts.push(String(key||"").toUpperCase());
return parts.join("+");
},

_normCombo(combo){
if(!combo) return "";
if(Array.isArray(combo)) combo=combo.join("+");
if(typeof combo!=="string") return "";
let c=combo.toUpperCase().replace(/\s+/g,"").replace(/CMD/g,"META");
c=c.replace(/CONTROL/g,"CTRL").replace(/OPTION/g,"ALT");
c=c.replace(/ARROW_UP/g,"ARROWUP").replace(/ARROW_DOWN/g,"ARROWDOWN").replace(/ARROW_LEFT/g,"ARROWLEFT").replace(/ARROW_RIGHT/g,"ARROWRIGHT");
c=c.replace(/ESC/g,"ESCAPE").replace(/DEL/g,"DELETE");
c=c.replace(/^\+|\+$/g,"");
if(!c) return "";
const parts=c.split("+").filter(Boolean);
const mods={CTRL:0,ALT:0,SHIFT:0,META:0};
let key="";
parts.forEach(p=>{
if(p==="CTRL"||p==="ALT"||p==="SHIFT"||p==="META") mods[p]=1;
else if(!key) key=p;
});
if(!key) return "";
let out=[];
if(mods.CTRL) out.push("CTRL");
if(mods.ALT) out.push("ALT");
if(mods.SHIFT) out.push("SHIFT");
if(mods.META) out.push("META");
out.push(key);
return out.join("+");
},

_isTypingTarget(t){
try{
if(!t) return false;
const tag=(t.tagName||"").toUpperCase();
if(tag==="INPUT"||tag==="TEXTAREA"||tag==="SELECT") return true;
if(t.isContentEditable) return true;
return false;
}catch(_e){return false;}
},

_prune(){
try{
const max=this._state.config.maxBindings;
const b=this._state.bindings;
const keys=Object.keys(b);
if(keys.length<=max) return;
keys.sort((a,c)=>(b[a].ts||0)-(b[c].ts||0));
while(Object.keys(b).length>max){
const k=keys.shift();
if(!k) break;
if(b[k]) delete b[k];
}
}catch(e){this._err("prune",e.message||String(e));}
},

_clamp(n,a,b){
n=Number(n);
if(!isFinite(n)) return a;
if(n<a) return a;
if(n>b) return b;
return n;
},

_clone(x){
try{return JSON.parse(JSON.stringify(x));}catch(e){return x;}
},

_bindEvents(){
const bus=this._ctx&&this._ctx.bus;
if(!bus) return;
const on=(t,fn)=>{
try{
if(typeof bus.on==="function") bus.on(t,fn);
else if(typeof bus.subscribe==="function") bus.subscribe(t,fn);
}catch(e){this._err("bind:"+t,e.message||String(e));}
};
on("REQ:SOLAR_FLARE:MOUNT",()=>this.api.mount());
on("REQ:SOLAR_FLARE:ENABLE",()=>this.api.enable());
on("REQ:SOLAR_FLARE:DISABLE",()=>this.api.disable());
on("REQ:SOLAR_FLARE:START",()=>this.api.start());
on("REQ:SOLAR_FLARE:STOP",()=>this.api.stop());
on("REQ:SOLAR_FLARE:CONFIG",(d)=>this.api.setConfig(d&&d.config?d.config:d));
on("REQ:SOLAR_FLARE:BIND",(d)=>this.api.bind(d&&d.binding?d.binding:d));
on("REQ:SOLAR_FLARE:UNBIND",(d)=>this.api.unbind(d&&d.combo));
on("REQ:SOLAR_FLARE:CLEAR",()=>this.api.clear());
on("REQ:SOLAR_FLARE:SNAPSHOT",()=>this.api.snapshot());
on("REQ:SOLAR_FLARE:STATUS",()=>this.api.status());
}
};

window.KOG=window.KOG||{};
window.KOG[Engine_SOLAR_FLARE.id]=Engine_SOLAR_FLARE;
/*-- ‚òÄÔ∏èüòé-(17A)-(E)-(INPUT-HOTKEY-ENGINE)-(SOLAR-FLARE)-(E)-(17A)-üòé‚òÄÔ∏è --*/
/*-- üóùÔ∏èüë¥-(18A)-(S)-(SOUND-SFX-ENGINE)-(CRYPT-KEEPER)-(S)-(18A)-üë¥üóùÔ∏è --*/
const Engine_CRYPT_KEEPER={
id:"CRYPT_KEEPER",
_ctx:null,
_state:{
enabled:true,
mounted:false,
started:false,
lastError:null,
lastUpdate:0,
config:{
master:1,
mute:false,
maxChannels:16,
fadeMs:120,
allowOverlap:true,
preload:true
},
channels:[],
sounds:{},
stats:{plays:0,stops:0,errors:0}
},

init(ctx){
this._ctx=ctx;
this._safe(()=>this._bindEvents(),"init_bind");
this._emit("READY");
},

api:{
mount:()=>Engine_CRYPT_KEEPER._mount(),
enable:()=>Engine_CRYPT_KEEPER._setEnabled(true),
disable:()=>Engine_CRYPT_KEEPER._setEnabled(false),
start:()=>Engine_CRYPT_KEEPER._start(),
stop:()=>Engine_CRYPT_KEEPER._stop(),
setConfig:(c)=>Engine_CRYPT_KEEPER._setConfig(c),
load:(d)=>Engine_CRYPT_KEEPER._load(d),
play:(d)=>Engine_CRYPT_KEEPER._play(d),
stopSound:(d)=>Engine_CRYPT_KEEPER._stopSound(d),
stopAll:()=>Engine_CRYPT_KEEPER._stopAll(),
snapshot:()=>Engine_CRYPT_KEEPER._snapshot(),
status:()=>Engine_CRYPT_KEEPER._status()
},

_mount(){
if(this._state.mounted) return;
this._state.mounted=true;
this._touch();
this._emit("MOUNTED");
},

_setEnabled(v){
this._state.enabled=!!v;
if(!this._state.enabled) this._stopAll();
this._touch();
this._emit("STATE");
},

_start(){
if(!this._state.enabled||this._state.started) return;
this._state.started=true;
this._touch();
this._emit("STARTED");
},

_stop(){
if(!this._state.started) return;
this._state.started=false;
this._stopAll();
this._touch();
this._emit("STOPPED");
},

_setConfig(c){
try{
if(!c||typeof c!=="object") return this._snapshot();
const cfg=this._state.config;
if(typeof c.master==="number") cfg.master=this._clamp(c.master,0,1);
if(typeof c.mute==="boolean") cfg.mute=c.mute;
if(typeof c.maxChannels==="number") cfg.maxChannels=this._clamp(Math.floor(c.maxChannels),1,64);
if(typeof c.fadeMs==="number") cfg.fadeMs=this._clamp(c.fadeMs,0,2000);
if(typeof c.allowOverlap==="boolean") cfg.allowOverlap=c.allowOverlap;
if(typeof c.preload==="boolean") cfg.preload=c.preload;
this._touch();
this._emit("UPDATED",{config:this._clone(cfg)});
return this._snapshot();
}catch(e){this._err("setConfig",e.message||String(e));return this._snapshot();}
},

_load(d){
try{
if(!d||!d.id||!d.src) return false;
const id=String(d.id);
if(this._state.sounds[id]) return true;
const a=new Audio();
a.src=String(d.src);
a.preload=this._state.config.preload?"auto":"none";
this._state.sounds[id]={id,src:a.src,base:a};
this._touch();
this._emit("LOADED",{id});
return true;
}catch(e){this._state.stats.errors++;this._err("load",e.message||String(e));return false;}
},

_play(d){
try{
if(!this._state.enabled||!this._state.started) return false;
if(!d||!d.id) return false;
const s=this._state.sounds[String(d.id)];
if(!s) return false;
if(this._state.config.mute) return false;
if(!this._state.config.allowOverlap) this._stopSound({id:d.id});
let a=s.base.cloneNode();
a.volume=this._clamp((typeof d.volume==="number"?d.volume:1)*this._state.config.master,0,1);
if(typeof d.loop==="boolean") a.loop=d.loop;
this._pruneChannels();
this._state.channels.push(a);
a.play().catch(()=>{});
this._state.stats.plays++;
this._touch();
this._emit("PLAY",{id:d.id});
return true;
}catch(e){this._state.stats.errors++;this._err("play",e.message||String(e));return false;}
},

_stopSound(d){
try{
if(!d||!d.id) return false;
this._state.channels=this._state.channels.filter(a=>{
try{
if(a.src&&a.src.indexOf(String(d.id))!==-1){a.pause();this._state.stats.stops++;return false;}
}catch(_e){}
return true;
});
this._touch();
this._emit("STOP",{id:d.id});
return true;
}catch(e){this._err("stopSound",e.message||String(e));return false;}
},

_stopAll(){
try{
this._state.channels.forEach(a=>{try{a.pause();}catch(_e){}});
this._state.channels=[];
this._touch();
this._emit("STOP_ALL");
}catch(e){this._err("stopAll",e.message||String(e));}
},

_pruneChannels(){
while(this._state.channels.length>=this._state.config.maxChannels){
const a=this._state.channels.shift();
try{a.pause();}catch(_e){}
}
},

_snapshot(){
return{ id:this.id,state:this._statusObj(),ts:Date.now() };
},

_status(){
const o=this._snapshot();
this._emit("STATE",o);
return o;
},

_statusObj(){
const s=this._state;
return{
enabled:s.enabled,
mounted:s.mounted,
started:s.started,
lastError:s.lastError,
lastUpdate:s.lastUpdate,
config:this._clone(s.config),
sounds:Object.keys(s.sounds),
stats:this._clone(s.stats)
};
},

_emit(evt,data){
try{
if(!this._ctx||!this._ctx.bus) return;
const p={id:this.id,state:this._lite(),ts:Date.now()};
if(data) Object.assign(p,data);
this._ctx.bus.emit("EVT:CRYPT_KEEPER:"+evt,p);
}catch(e){this._err("_emit",e.message||String(e));}
},

_lite(){
const s=this._state;
return{enabled:s.enabled,mounted:s.mounted,started:s.started,lastError:s.lastError,lastUpdate:s.lastUpdate};
},

_touch(){
this._state.lastUpdate=Date.now();
},

_err(where,msg){
this._state.lastError=String(msg||"error");
try{
this._ctx&&this._ctx.bus&&this._ctx.bus.emit("EVT:CRYPT_KEEPER:ERROR",{id:this.id,where:String(where),error:String(msg),ts:Date.now()});
}catch(e){}
return false;
},

_safe(fn,where){
try{fn();}catch(e){this._err(where,e.message||String(e));}
},

_clamp(n,a,b){
n=Number(n);
if(!isFinite(n)) return a;
if(n<a) return a;
if(n>b) return b;
return n;
},

_clone(x){
try{return JSON.parse(JSON.stringify(x));}catch(e){return x;}
},

_bindEvents(){
const bus=this._ctx&&this._ctx.bus;
if(!bus) return;
const on=(t,fn)=>{
try{
if(typeof bus.on==="function") bus.on(t,fn);
else if(typeof bus.subscribe==="function") bus.subscribe(t,fn);
}catch(e){this._err("bind:"+t,e.message||String(e));}
};
on("REQ:CRYPT_KEEPER:MOUNT",()=>this.api.mount());
on("REQ:CRYPT_KEEPER:ENABLE",()=>this.api.enable());
on("REQ:CRYPT_KEEPER:DISABLE",()=>this.api.disable());
on("REQ:CRYPT_KEEPER:START",()=>this.api.start());
on("REQ:CRYPT_KEEPER:STOP",()=>this.api.stop());
on("REQ:CRYPT_KEEPER:CONFIG",(d)=>this.api.setConfig(d&&d.config?d.config:d));
on("REQ:CRYPT_KEEPER:LOAD",(d)=>this.api.load(d));
on("REQ:CRYPT_KEEPER:PLAY",(d)=>this.api.play(d));
on("REQ:CRYPT_KEEPER:STOP_SOUND",(d)=>this.api.stopSound(d));
on("REQ:CRYPT_KEEPER:STOP_ALL",()=>this.api.stopAll());
on("REQ:CRYPT_KEEPER:SNAPSHOT",()=>this.api.snapshot());
on("REQ:CRYPT_KEEPER:STATUS",()=>this.api.status());
}
};

window.KOG=window.KOG||{};
window.KOG[Engine_CRYPT_KEEPER.id]=Engine_CRYPT_KEEPER;
/*-- üóùÔ∏èüë¥-(18A)-(E)-(SOUND-SFX-ENGINE)-(CRYPT-KEEPER)-(E)-(18A)-üë¥üóùÔ∏è --*/
/*-- ü§¨üé∏-(19A)-(S)-(ERROR-HARDENING-ENGINE)-(DOOM-SLAYER)-(S)-(19A)-üé∏ü§¨ --*/
const Engine_DOOM_SLAYERR={
id:"DOOM_SLAYERR",
_ctx:null,
_state:{
enabled:true,
mounted:false,
started:false,
lastError:null,
lastUpdate:0,
config:{
catchWindowErrors:true,
catchPromiseRejections:true,
wrapBusHandlers:true,
maxLog:80,
dedupeMs:1500,
emitConsole:false
},
stats:{
errors:0,
warnings:0,
infos:0,
caughtWindow:0,
caughtPromise:0,
caughtWrapped:0,
deduped:0,
lastTs:0
},
log:[]
},

init(ctx){
this._ctx=ctx;
this._safe(()=>this._bindEvents(),"init_bind");
this._safe(()=>this._installGlobalHooks(),"init_hooks");
this._emit("READY");
},

api:{
mount:()=>Engine_DOOM_SLAYERR._mount(),
enable:()=>Engine_DOOM_SLAYERR._setEnabled(true),
disable:()=>Engine_DOOM_SLAYERR._setEnabled(false),
start:()=>Engine_DOOM_SLAYERR._start(),
stop:()=>Engine_DOOM_SLAYERR._stop(),
setConfig:(c)=>Engine_DOOM_SLAYERR._setConfig(c),
guard:(fn,where)=>Engine_DOOM_SLAYERR._guard(fn,where),
wrap:(fn,where)=>Engine_DOOM_SLAYERR._wrap(fn,where),
report:(lvl,where,msg,meta)=>Engine_DOOM_SLAYERR._report(lvl,where,msg,meta),
snapshot:()=>Engine_DOOM_SLAYERR._snapshot(),
status:()=>Engine_DOOM_SLAYERR._status()
},

_mount(){
if(this._state.mounted) return;
this._state.mounted=true;
this._touch();
this._emit("MOUNTED");
},

_setEnabled(v){
this._state.enabled=!!v;
this._touch();
this._emit("STATE");
},

_start(){
if(!this._state.enabled||this._state.started) return;
this._state.started=true;
this._touch();
this._emit("STARTED");
},

_stop(){
if(!this._state.started) return;
this._state.started=false;
this._touch();
this._emit("STOPPED");
},

_setConfig(c){
try{
if(!c||typeof c!=="object") return this._snapshot();
const cfg=this._state.config;
if(typeof c.catchWindowErrors==="boolean") cfg.catchWindowErrors=c.catchWindowErrors;
if(typeof c.catchPromiseRejections==="boolean") cfg.catchPromiseRejections=c.catchPromiseRejections;
if(typeof c.wrapBusHandlers==="boolean") cfg.wrapBusHandlers=c.wrapBusHandlers;
if(typeof c.maxLog==="number") cfg.maxLog=this._clampInt(c.maxLog,10,500);
if(typeof c.dedupeMs==="number") cfg.dedupeMs=this._clampInt(c.dedupeMs,0,10000);
if(typeof c.emitConsole==="boolean") cfg.emitConsole=c.emitConsole;
this._touch();
this._emit("UPDATED",{config:this._clone(cfg)});
return this._snapshot();
}catch(e){this._err("setConfig",e.message||String(e));return this._snapshot();}
},

_guard(fn,where){
try{fn();}catch(e){this._state.stats.caughtWrapped++;this._err(where||"guard",e.message||String(e),{stack:e&&e.stack?String(e.stack):null});}
},

_wrap(fn,where){
if(typeof fn!=="function") return ()=>{};
const self=this;
return function(){
try{return fn.apply(this,arguments);}catch(e){self._state.stats.caughtWrapped++;self._err(where||"wrap",e.message||String(e),{stack:e&&e.stack?String(e.stack):null});}
};
},

_report(lvl,where,msg,meta){
try{
lvl=String(lvl||"error").toLowerCase();
if(lvl!=="error"&&lvl!=="warn"&&lvl!=="info") lvl="error";
if(lvl==="error") this._state.stats.errors++;
if(lvl==="warn") this._state.stats.warnings++;
if(lvl==="info") this._state.stats.infos++;
this._pushLog({lvl,where:String(where||"manual"),msg:String(msg||""),meta:meta||null,ts:Date.now()});
this._touch();
this._emit(lvl==="error"?"ERROR":(lvl==="warn"?"WARN":"INFO"),{lvl,where:String(where||"manual"),error:String(msg||""),meta:meta||null});
if(this._state.config.emitConsole){
try{
if(lvl==="error"&&console&&console.error) console.error("[DOOM_SLAYERR]",where,msg,meta||"");
if(lvl==="warn"&&console&&console.warn) console.warn("[DOOM_SLAYERR]",where,msg,meta||"");
if(lvl==="info"&&console&&console.log) console.log("[DOOM_SLAYERR]",where,msg,meta||"");
}catch(_e){}
}
return true;
}catch(e){this._err("_report",e.message||String(e));return false;}
},

_installGlobalHooks(){
try{
if(typeof window==="undefined") return;
if(this._state._hooksInstalled) return;
this._state._hooksInstalled=true;

if(this._state.config.catchWindowErrors){
window.addEventListener("error",(ev)=>{
try{
if(!this._state.enabled) return;
this._state.stats.caughtWindow++;
const m=(ev&&ev.message)?String(ev.message):"window_error";
const meta={file:ev&&ev.filename?String(ev.filename):null,line:ev&&typeof ev.lineno==="number"?ev.lineno:null,col:ev&&typeof ev.colno==="number"?ev.colno:null,stack:ev&&ev.error&&ev.error.stack?String(ev.error.stack):null};
this._err("window:error",m,meta);
}catch(e){this._err("window:error_handler",e.message||String(e));}
},{capture:true});
}

if(this._state.config.catchPromiseRejections){
window.addEventListener("unhandledrejection",(ev)=>{
try{
if(!this._state.enabled) return;
this._state.stats.caughtPromise++;
let m="unhandled_rejection";
let stack=null;
const r=ev?ev.reason:null;
if(r&&typeof r==="object"){
if(r.message) m=String(r.message);
if(r.stack) stack=String(r.stack);
}else if(typeof r==="string") m=r;
this._err("window:unhandledrejection",m,{stack});
}catch(e){this._err("window:unhandledrejection_handler",e.message||String(e));}
});
}
}catch(e){this._err("_installGlobalHooks",e.message||String(e));}
},

_snapshot(){
return{ id:this.id,state:this._statusObj(),ts:Date.now() };
},

_status(){
const o=this._snapshot();
this._emit("STATE",o);
return o;
},

_statusObj(){
const s=this._state;
return{
enabled:s.enabled,
mounted:s.mounted,
started:s.started,
lastError:s.lastError,
lastUpdate:s.lastUpdate,
config:this._clone(s.config),
stats:this._clone(s.stats),
log:this._clone(s.log)
};
},

_pushLog(entry){
const s=this._state;
const now=Date.now();
const key=entry.lvl+"|"+entry.where+"|"+entry.msg;
if(s._dedupe&&s._dedupe[key]&&now-s._dedupe[key]<s.config.dedupeMs){
s.stats.deduped++;
return;
}
s._dedupe=s._dedupe||{};
s._dedupe[key]=now;
s.log.push(entry);
while(s.log.length>s.config.maxLog) s.log.shift();
},

_emit(evt,data){
try{
if(!this._ctx||!this._ctx.bus) return;
const p={id:this.id,state:this._lite(),ts:Date.now()};
if(data) Object.assign(p,data);
this._ctx.bus.emit("EVT:DOOM_SLAYERR:"+evt,p);
}catch(e){this._err("_emit",e.message||String(e));}
},

_lite(){
const s=this._state;
return{enabled:s.enabled,mounted:s.mounted,started:s.started,lastError:s.lastError,lastUpdate:s.lastUpdate};
},

_touch(){
this._state.lastUpdate=Date.now();
},

_err(where,msg,meta){
this._state.lastError=String(msg||"error");
this._state.stats.errors++;
this._pushLog({lvl:"error",where:String(where||"error"),msg:String(msg||"error"),meta:meta||null,ts:Date.now()});
try{
this._ctx&&this._ctx.bus&&this._ctx.bus.emit("EVT:DOOM_SLAYERR:ERROR",{id:this.id,where:String(where||"error"),error:String(msg||"error"),meta:meta||null,ts:Date.now()});
}catch(e){}
return false;
},

_safe(fn,where){
try{fn();}catch(e){this._err(where||"safe",e.message||String(e),{stack:e&&e.stack?String(e.stack):null});}
},

_clampInt(n,a,b){
n=Math.floor(Number(n));
if(!isFinite(n)) return a;
if(n<a) return a;
if(n>b) return b;
return n;
},

_clone(x){
try{return JSON.parse(JSON.stringify(x));}catch(e){return x;}
},

_bindEvents(){
const bus=this._ctx&&this._ctx.bus;
if(!bus) return;
const on=(t,fn)=>{
try{
if(typeof bus.on==="function") bus.on(t,fn);
else if(typeof bus.subscribe==="function") bus.subscribe(t,fn);
}catch(e){this._err("bind:"+t,e.message||String(e));}
};

on("REQ:DOOM_SLAYERR:MOUNT",()=>this.api.mount());
on("REQ:DOOM_SLAYERR:ENABLE",()=>this.api.enable());
on("REQ:DOOM_SLAYERR:DISABLE",()=>this.api.disable());
on("REQ:DOOM_SLAYERR:START",()=>this.api.start());
on("REQ:DOOM_SLAYERR:STOP",()=>this.api.stop());
on("REQ:DOOM_SLAYERR:CONFIG",(d)=>this.api.setConfig(d&&d.config?d.config:d));
on("REQ:DOOM_SLAYERR:REPORT",(d)=>this.api.report(d&&d.lvl?d.lvl:"error",d&&d.where?d.where:"manual",d&&d.msg?d.msg:"",d&&d.meta?d.meta:null));
on("REQ:DOOM_SLAYERR:GUARD",(d)=>this.api.guard(()=>{try{d&&typeof d.fn==="function"&&d.fn();}catch(e){throw e;}},d&&d.where?d.where:"guard"));
on("REQ:DOOM_SLAYERR:SNAPSHOT",()=>this.api.snapshot());
on("REQ:DOOM_SLAYERR:STATUS",()=>this.api.status());

if(this._state.config.wrapBusHandlers){
try{
if(typeof bus.wrap!=="function"){
bus.wrap=(fn,where)=>this.api.wrap(fn,where);
}
}catch(e){this._err("bus_wrap",e.message||String(e));}
}
}
};

window.KOG=window.KOG||{};
window.KOG[Engine_DOOM_SLAYERR.id]=Engine_DOOM_SLAYERR;
/*-- ü§¨üé∏-(19A)-(E)-(ERROR-HARDENING-ENGINE)-(DOOM-SLAYER)-(E)-(19A)-üé∏ü§¨ --*/
/*-- üåäüßò-(20A)-(S)-(LIFECYCLE-ENGINE)-(ZEN-MONK)-(S)-(20A)-üßòüåä --*/
const Engine_ZEN_MONK={
id:"ZEN_MONK",
_ctx:null,
_state:{
enabled:true,
mounted:false,
started:false,
lastError:null,
ts0:0,
lastUpdate:0,
config:{
autoStart:true,
emitStateHz:2,
visibilityTrack:true,
onlineTrack:true,
beforeUnload:true,
freezeTrack:true
},
stats:{
starts:0,
stops:0,
visChanges:0,
onlineChanges:0,
focusChanges:0,
blurChanges:0,
freeze:0,
resume:0,
unloads:0,
ticks:0
},
signals:{
visibility:"unknown",
focus:"unknown",
online:"unknown",
frozen:false
}
},
_timers:{stateInt:0},
_bound:false,

init(ctx){
this._ctx=ctx;
this._state.ts0=Date.now();
this._safe(()=>this._bindEvents(),"init_bind");
this._safe(()=>this._installHooks(),"init_hooks");
this._emit("READY");
if(this._state.config.autoStart) this.api.start();
},

api:{
mount:()=>Engine_ZEN_MONK._mount(),
enable:()=>Engine_ZEN_MONK._setEnabled(true),
disable:()=>Engine_ZEN_MONK._setEnabled(false),
start:()=>Engine_ZEN_MONK._start(),
stop:()=>Engine_ZEN_MONK._stop(),
setConfig:(c)=>Engine_ZEN_MONK._setConfig(c),
snapshot:()=>Engine_ZEN_MONK._snapshot(),
status:()=>Engine_ZEN_MONK._status()
},

_mount(){
if(this._state.mounted) return;
this._state.mounted=true;
this._touch();
this._emit("MOUNTED");
this._emit("STATE");
},

_setEnabled(v){
this._state.enabled=!!v;
this._touch();
this._emit("STATE");
},

_start(){
if(!this._state.enabled||this._state.started) return;
this._state.started=true;
this._state.stats.starts++;
this._touch();
this._emit("STARTED");
this._emit("STATE");
this._startStateTicker();
},

_stop(){
if(!this._state.started) return;
this._state.started=false;
this._state.stats.stops++;
this._touch();
this._stopStateTicker();
this._emit("STOPPED");
this._emit("STATE");
},

_setConfig(c){
try{
if(!c||typeof c!=="object") return this._snapshot();
const cfg=this._state.config;
if(typeof c.autoStart==="boolean") cfg.autoStart=c.autoStart;
if(typeof c.emitStateHz==="number") cfg.emitStateHz=this._clamp(c.emitStateHz,0,10);
if(typeof c.visibilityTrack==="boolean") cfg.visibilityTrack=c.visibilityTrack;
if(typeof c.onlineTrack==="boolean") cfg.onlineTrack=c.onlineTrack;
if(typeof c.beforeUnload==="boolean") cfg.beforeUnload=c.beforeUnload;
if(typeof c.freezeTrack==="boolean") cfg.freezeTrack=c.freezeTrack;
this._touch();
this._emit("UPDATED",{config:this._clone(cfg)});
if(this._state.started){this._stopStateTicker();this._startStateTicker();}
return this._snapshot();
}catch(e){this._err("setConfig",e.message||String(e));return this._snapshot();}
},

_startStateTicker(){
this._stopStateTicker();
const hz=this._state.config.emitStateHz;
if(!hz||hz<=0) return;
const ms=Math.floor(1000/hz);
this._timers.stateInt=setInterval(()=>{
this._safe(()=>{
if(!this._state.enabled||!this._state.started) return;
this._state.stats.ticks++;
this._touch();
this._emit("TICK");
this._emit("STATE");
},"state_tick");
},ms);
},

_stopStateTicker(){
if(this._timers.stateInt){clearInterval(this._timers.stateInt);this._timers.stateInt=0;}
},

_installHooks(){
try{
if(this._bound) return;
this._bound=true;
if(typeof document!=="undefined"){
this._state.signals.visibility=document.visibilityState?String(document.visibilityState):"unknown";
if(this._state.config.visibilityTrack){
document.addEventListener("visibilitychange",()=>{
this._safe(()=>{
if(!this._state.enabled) return;
this._state.stats.visChanges++;
this._state.signals.visibility=document.visibilityState?String(document.visibilityState):"unknown";
this._touch();
this._emit("VISIBILITY",{visibility:this._state.signals.visibility});
this._emit("STATE");
},"visibilitychange");
});
}
}
if(typeof window!=="undefined"){
this._state.signals.focus=(document&&document.hasFocus&&document.hasFocus())?"focused":"blurred";
window.addEventListener("focus",()=>{
this._safe(()=>{
if(!this._state.enabled) return;
this._state.stats.focusChanges++;
this._state.signals.focus="focused";
this._touch();
this._emit("FOCUS");
this._emit("STATE");
},"focus");
});
window.addEventListener("blur",()=>{
this._safe(()=>{
if(!this._state.enabled) return;
this._state.stats.blurChanges++;
this._state.signals.focus="blurred";
this._touch();
this._emit("BLUR");
this._emit("STATE");
},"blur");
});
if(this._state.config.onlineTrack){
this._state.signals.online=(typeof navigator!=="undefined"&&"onLine"in navigator)?(navigator.onLine?"online":"offline"):"unknown";
window.addEventListener("online",()=>{
this._safe(()=>{
if(!this._state.enabled) return;
this._state.stats.onlineChanges++;
this._state.signals.online="online";
this._touch();
this._emit("ONLINE",{online:"online"});
this._emit("STATE");
},"online");
});
window.addEventListener("offline",()=>{
this._safe(()=>{
if(!this._state.enabled) return;
this._state.stats.onlineChanges++;
this._state.signals.online="offline";
this._touch();
this._emit("OFFLINE",{online:"offline"});
this._emit("STATE");
},"offline");
});
}
if(this._state.config.beforeUnload){
window.addEventListener("beforeunload",()=>{
this._safe(()=>{
if(!this._state.enabled) return;
this._state.stats.unloads++;
this._touch();
this._emit("BEFORE_UNLOAD");
this._emit("STATE");
},"beforeunload");
});
}
if(this._state.config.freezeTrack){
try{
if("onfreeze"in window){
window.addEventListener("freeze",()=>{
this._safe(()=>{
if(!this._state.enabled) return;
this._state.stats.freeze++;
this._state.signals.frozen=true;
this._touch();
this._emit("FREEZE");
this._emit("STATE");
},"freeze");
});
}
if("onresume"in window){
window.addEventListener("resume",()=>{
this._safe(()=>{
if(!this._state.enabled) return;
this._state.stats.resume++;
this._state.signals.frozen=false;
this._touch();
this._emit("RESUME");
this._emit("STATE");
},"resume");
});
}
}catch(e){this._err("freezeTrack",e.message||String(e));}
}
}
}catch(e){this._err("_installHooks",e.message||String(e));}
},

_snapshot(){
return{ id:this.id,state:this._statusObj(),ts:Date.now() };
},

_status(){
const o=this._snapshot();
this._emit("STATE",o);
return o;
},

_statusObj(){
const s=this._state;
return{
enabled:s.enabled,
mounted:s.mounted,
started:s.started,
lastError:s.lastError,
ts0:s.ts0,
lastUpdate:s.lastUpdate,
config:this._clone(s.config),
stats:this._clone(s.stats),
signals:this._clone(s.signals)
};
},

_emit(evt,data){
try{
if(!this._ctx||!this._ctx.bus) return;
const p={id:this.id,state:this._lite(),ts:Date.now()};
if(data) Object.assign(p,data);
this._ctx.bus.emit("EVT:ZEN_MONK:"+evt,p);
}catch(e){this._err("_emit",e.message||String(e));}
},

_lite(){
const s=this._state;
return{enabled:s.enabled,mounted:s.mounted,started:s.started,lastError:s.lastError,lastUpdate:s.lastUpdate};
},

_touch(){
this._state.lastUpdate=Date.now();
},

_err(where,msg){
this._state.lastError=String(msg||"error");
try{
this._ctx&&this._ctx.bus&&this._ctx.bus.emit("EVT:ZEN_MONK:ERROR",{id:this.id,where:String(where||"error"),error:String(msg||"error"),ts:Date.now()});
}catch(e){}
},

_safe(fn,where){
try{fn();}catch(e){this._err(where||"safe",e.message||String(e));}
},

_clamp(n,a,b){
n=Number(n);
if(!isFinite(n)) return a;
if(n<a) return a;
if(n>b) return b;
return n;
},

_clone(x){
try{return JSON.parse(JSON.stringify(x));}catch(e){return x;}
},

_bindEvents(){
const bus=this._ctx&&this._ctx.bus;
if(!bus) return;
const on=(t,fn)=>{
try{
if(typeof bus.on==="function") bus.on(t,fn);
else if(typeof bus.subscribe==="function") bus.subscribe(t,fn);
}catch(e){this._err("bind:"+t,e.message||String(e));}
};
on("REQ:ZEN_MONK:MOUNT",()=>this.api.mount());
on("REQ:ZEN_MONK:ENABLE",()=>this.api.enable());
on("REQ:ZEN_MONK:DISABLE",()=>this.api.disable());
on("REQ:ZEN_MONK:START",()=>this.api.start());
on("REQ:ZEN_MONK:STOP",()=>this.api.stop());
on("REQ:ZEN_MONK:CONFIG",(d)=>this.api.setConfig(d&&d.config?d.config:d));
on("REQ:ZEN_MONK:SNAPSHOT",()=>this.api.snapshot());
on("REQ:ZEN_MONK:STATUS",()=>this.api.status());
}
};

window.KOG=window.KOG||{};
window.KOG[Engine_ZEN_MONK.id]=Engine_ZEN_MONK;
/*-- üåäüßò-(20A)-(E)-(LIFECYCLE-ENGINE)-(ZEN-MONK)-(E)-(20A)-üßòüåä --*/
/*-- üìúüßø-(21A)-(S)-(LORE-CODEX-ENGINE)-(LORE-MASTER)-(S)-(21A)-üßøüìú --*/
const Engine_LORE_MASTER={
id:"LORE_MASTER",
_ctx:null,
_state:{
enabled:true,
mounted:false,
started:false,
lastError:null,
ts0:0,
lastUpdate:0,
config:{
autoStart:true,
maxEntries:300,
maxCategories:50,
emitHz:1,
persistKey:"KOG_LORE_CODEX",
persist:true
},
stats:{
adds:0,
removes:0,
clears:0,
loads:0,
saves:0,
queries:0,
emits:0
},
codex:{
byId:{},
order:[],
categories:{}
}
},
_timers:{emitInt:0},

init(ctx){
this._ctx=ctx;
this._state.ts0=Date.now();
this._safe(()=>this._bind(),"init_bind");
this._safe(()=>this._load(),"init_load");
this._emit("READY");
if(this._state.config.autoStart) this.api.start();
},

api:{
mount:()=>Engine_LORE_MASTER._mount(),
enable:()=>Engine_LORE_MASTER._setEnabled(true),
disable:()=>Engine_LORE_MASTER._setEnabled(false),
start:()=>Engine_LORE_MASTER._start(),
stop:()=>Engine_LORE_MASTER._stop(),
setConfig:(c)=>Engine_LORE_MASTER._setConfig(c),
add:(entry)=>Engine_LORE_MASTER._add(entry),
remove:(id)=>Engine_LORE_MASTER._remove(id),
clear:()=>Engine_LORE_MASTER._clear(),
get:(id)=>Engine_LORE_MASTER._get(id),
list:(q)=>Engine_LORE_MASTER._list(q),
search:(q)=>Engine_LORE_MASTER._search(q),
snapshot:()=>Engine_LORE_MASTER._snapshot(),
status:()=>Engine_LORE_MASTER._status()
},

_mount(){
if(this._state.mounted) return;
this._state.mounted=true;
this._touch();
this._emit("MOUNTED");
this._emit("STATE");
},

_setEnabled(v){
this._state.enabled=!!v;
this._touch();
this._emit("STATE");
},

_start(){
if(!this._state.enabled||this._state.started) return;
this._state.started=true;
this._touch();
this._emit("STARTED");
this._emit("STATE");
this._startEmitter();
},

_stop(){
if(!this._state.started) return;
this._state.started=false;
this._touch();
this._stopEmitter();
this._emit("STOPPED");
this._emit("STATE");
},

_setConfig(c){
try{
if(!c||typeof c!=="object") return this._snapshot();
const cfg=this._state.config;
if(typeof c.autoStart==="boolean") cfg.autoStart=c.autoStart;
if(typeof c.maxEntries==="number") cfg.maxEntries=this._clampInt(c.maxEntries,10,5000);
if(typeof c.maxCategories==="number") cfg.maxCategories=this._clampInt(c.maxCategories,1,500);
if(typeof c.emitHz==="number") cfg.emitHz=this._clamp(c.emitHz,0,10);
if(typeof c.persistKey==="string"&&c.persistKey) cfg.persistKey=c.persistKey;
if(typeof c.persist==="boolean") cfg.persist=c.persist;
this._touch();
this._emit("UPDATED",{config:this._clone(cfg)});
if(this._state.started){this._stopEmitter();this._startEmitter();}
this._save();
return this._snapshot();
}catch(e){this._err("setConfig",e.message||String(e));return this._snapshot();}
},

_add(entry){
try{
if(!this._state.enabled) return null;
const e=this._normalize(entry);
if(!e) return null;
if(this._state.codex.byId[e.id]) this._remove(e.id);
this._state.codex.byId[e.id]=e;
this._state.codex.order.unshift(e.id);
this._indexCategory(e);
this._state.stats.adds++;
this._trim();
this._touch();
this._emit("ADD",{entry:e});
this._save();
return e;
}catch(ex){this._err("add",ex.message||String(ex));return null;}
},

_remove(id){
try{
if(!this._state.enabled) return false;
id=String(id||"");
if(!id||!this._state.codex.byId[id]) return false;
const e=this._state.codex.byId[id];
delete this._state.codex.byId[id];
this._state.codex.order=this._state.codex.order.filter(x=>x!==id);
this._deindexCategory(e);
this._state.stats.removes++;
this._touch();
this._emit("REMOVE",{id});
this._save();
return true;
}catch(ex){this._err("remove",ex.message||String(ex));return false;}
},

_clear(){
try{
this._state.codex.byId={};
this._state.codex.order=[];
this._state.codex.categories={};
this._state.stats.clears++;
this._touch();
this._emit("CLEAR");
this._save();
return true;
}catch(ex){this._err("clear",ex.message||String(ex));return false;}
},

_get(id){
try{
this._state.stats.queries++;
id=String(id||"");
return this._state.codex.byId[id]||null;
}catch(ex){this._err("get",ex.message||String(ex));return null;}
},

_list(q){
try{
this._state.stats.queries++;
q=q||{};
const cat=q.category?String(q.category):"";
const limit=this._clampInt(q.limit||50,1,500);
let ids=this._state.codex.order.slice(0);
if(cat){
const c=this._state.codex.categories[cat];
ids=c?c.slice(0):[];
}
const out=[];
for(let i=0;i<ids.length&&out.length<limit;i++){
const e=this._state.codex.byId[ids[i]];
if(e) out.push(e);
}
return out;
}catch(ex){this._err("list",ex.message||String(ex));return[];}
},

_search(q){
try{
this._state.stats.queries++;
q=q||{};
const term=String(q.term||"").toLowerCase().trim();
const cat=q.category?String(q.category):"";
const limit=this._clampInt(q.limit||50,1,200);
if(!term&&cat) return this._list({category:cat,limit});
if(!term&&!cat) return this._list({limit});
const out=[];
const ids=cat?(this._state.codex.categories[cat]||[]):this._state.codex.order;
for(let i=0;i<ids.length&&out.length<limit;i++){
const e=this._state.codex.byId[ids[i]];
if(!e) continue;
if(term){
const hay=(e.title+" "+e.text+" "+(e.tags||[]).join(" ")).toLowerCase();
if(hay.indexOf(term)===-1) continue;
}
out.push(e);
}
return out;
}catch(ex){this._err("search",ex.message||String(ex));return[];}
},

_snapshot(){
return{ id:this.id,state:this._statusObj(),ts:Date.now() };
},

_status(){
const o=this._snapshot();
this._emit("STATE",o);
return o;
},

_statusObj(){
const s=this._state;
return{
enabled:s.enabled,
mounted:s.mounted,
started:s.started,
lastError:s.lastError,
ts0:s.ts0,
lastUpdate:s.lastUpdate,
config:this._clone(s.config),
stats:this._clone(s.stats),
counts:{
entries:s.codex.order.length,
categories:Object.keys(s.codex.categories).length
}
};
},

_startEmitter(){
this._stopEmitter();
const hz=this._state.config.emitHz;
if(!hz||hz<=0) return;
const ms=Math.floor(1000/hz);
this._timers.emitInt=setInterval(()=>{
this._safe(()=>{
if(!this._state.enabled||!this._state.started) return;
this._state.stats.emits++;
this._touch();
this._emit("UPDATED");
},"emit_tick");
},ms);
},

_stopEmitter(){
if(this._timers.emitInt){clearInterval(this._timers.emitInt);this._timers.emitInt=0;}
},

_trim(){
const max=this._state.config.maxEntries;
while(this._state.codex.order.length>max){
const id=this._state.codex.order.pop();
if(!id) break;
const e=this._state.codex.byId[id];
if(e){this._deindexCategory(e);delete this._state.codex.byId[id];}
}
this._trimCategories();
},

_trimCategories(){
const keys=Object.keys(this._state.codex.categories);
if(keys.length<=this._state.config.maxCategories) return;
keys.sort((a,b)=>((this._state.codex.categories[b]||[]).length-(this._state.codex.categories[a]||[]).length));
for(let i=this._state.config.maxCategories;i<keys.length;i++) delete this._state.codex.categories[keys[i]];
},

_indexCategory(e){
const cat=e.category||"";
if(!cat) return;
this._state.codex.categories[cat]=this._state.codex.categories[cat]||[];
this._state.codex.categories[cat].unshift(e.id);
},

_deindexCategory(e){
const cat=e.category||"";
if(!cat) return;
const arr=this._state.codex.categories[cat];
if(!arr) return;
this._state.codex.categories[cat]=arr.filter(x=>x!==e.id);
if(!this._state.codex.categories[cat].length) delete this._state.codex.categories[cat];
},

_normalize(entry){
entry=entry||{};
const id=entry.id?String(entry.id):this._uid();
const title=String(entry.title||"").slice(0,140);
const text=String(entry.text||entry.body||"").slice(0,4000);
const category=entry.category?String(entry.category).slice(0,60):"";
const tags=Array.isArray(entry.tags)?entry.tags.map(x=>String(x).slice(0,32)).slice(0,16):[];
const ts=typeof entry.ts==="number"?entry.ts:Date.now();
return{ id,title,text,category,tags,ts };
},

_uid(){
return "lore_"+Math.random().toString(16).slice(2)+Date.now().toString(16);
},

_load(){
try{
if(!this._state.config.persist) return;
if(typeof localStorage==="undefined") return;
const raw=localStorage.getItem(this._state.config.persistKey);
if(!raw) return;
const data=JSON.parse(raw);
if(!data||typeof data!=="object") return;
if(data.byId&&data.order){
this._state.codex.byId=data.byId;
this._state.codex.order=data.order;
this._state.codex.categories=data.categories||{};
this._state.stats.loads++;
this._touch();
this._emit("LOADED");
}
}catch(e){this._err("load",e.message||String(e));}
},

_save(){
try{
if(!this._state.config.persist) return;
if(typeof localStorage==="undefined") return;
const data={byId:this._state.codex.byId,order:this._state.codex.order,categories:this._state.codex.categories};
localStorage.setItem(this._state.config.persistKey,JSON.stringify(data));
this._state.stats.saves++;
}catch(e){this._err("save",e.message||String(e));}
},

_emit(evt,data){
try{
if(!this._ctx||!this._ctx.bus) return;
const p={id:this.id,state:this._lite(),ts:Date.now()};
if(data) Object.assign(p,data);
this._ctx.bus.emit("EVT:LORE_MASTER:"+evt,p);
}catch(e){this._err("_emit",e.message||String(e));}
},

_lite(){
const s=this._state;
return{enabled:s.enabled,mounted:s.mounted,started:s.started,lastError:s.lastError,lastUpdate:s.lastUpdate};
},

_touch(){
this._state.lastUpdate=Date.now();
},

_err(where,msg){
this._state.lastError=String(msg||"error");
try{
this._ctx&&this._ctx.bus&&this._ctx.bus.emit("EVT:LORE_MASTER:ERROR",{id:this.id,where:String(where||"error"),error:String(msg||"error"),ts:Date.now()});
}catch(e){}
},

_safe(fn,where){
try{fn();}catch(e){this._err(where||"safe",e.message||String(e));}
},

_bind(){
const bus=this._ctx&&this._ctx.bus;
if(!bus) return;
const on=(t,fn)=>{
try{
if(typeof bus.on==="function") bus.on(t,fn);
else if(typeof bus.subscribe==="function") bus.subscribe(t,fn);
}catch(e){this._err("bind:"+t,e.message||String(e));}
};
on("REQ:LORE_MASTER:MOUNT",()=>this.api.mount());
on("REQ:LORE_MASTER:ENABLE",()=>this.api.enable());
on("REQ:LORE_MASTER:DISABLE",()=>this.api.disable());
on("REQ:LORE_MASTER:START",()=>this.api.start());
on("REQ:LORE_MASTER:STOP",()=>this.api.stop());
on("REQ:LORE_MASTER:CONFIG",(d)=>this.api.setConfig(d&&d.config?d.config:d));
on("REQ:LORE_MASTER:ADD",(d)=>this.api.add(d&&d.entry?d.entry:d));
on("REQ:LORE_MASTER:REMOVE",(d)=>this.api.remove(d&&d.id?d.id:d));
on("REQ:LORE_MASTER:CLEAR",()=>this.api.clear());
on("REQ:LORE_MASTER:GET",(d)=>this.api.get(d&&d.id?d.id:d));
on("REQ:LORE_MASTER:LIST",(d)=>this.api.list(d||{}));
on("REQ:LORE_MASTER:SEARCH",(d)=>this.api.search(d||{}));
on("REQ:LORE_MASTER:SNAPSHOT",()=>this.api.snapshot());
on("REQ:LORE_MASTER:STATUS",()=>this.api.status());
}
,
_clamp(n,a,b){
n=Number(n);
if(!isFinite(n)) return a;
if(n<a) return a;
if(n>b) return b;
return n;
},
_clampInt(n,a,b){
n=Math.floor(Number(n));
if(!isFinite(n)) return a;
if(n<a) return a;
if(n>b) return b;
return n;
},
_clone(x){
try{return JSON.parse(JSON.stringify(x));}catch(e){return x;}
}
};

window.KOG=window.KOG||{};
window.KOG[Engine_LORE_MASTER.id]=Engine_LORE_MASTER;
/*-- üìúüßø-(21A)-(E)-(LORE-CODEX-ENGINE)-(LORE-MASTER)-(E)-(21A)-üßøüìú --*/
/*-- üéõÔ∏èüîä-(22A)-(S)-(AUDIO-MIXER-ENGINE)-(AUDIO-MANCER)-(S)-(22A)-üîäüéõÔ∏è --*/
const Engine_AUDIO_MANCER={
id:"AUDIO_MANCER",
_ctx:null,
_state:{
enabled:true,
mounted:false,
started:false,
lastError:null,
ts0:0,
lastUpdate:0,
config:{
master:1,
music:1,
sfx:1,
ui:1,
ambient:1,
emitHz:1,
clampMin:0,
clampMax:1.5,
autoResume:true
},
stats:{
sets:0,
mutes:0,
unmutes:0,
emits:0
},
levels:{
master:1,
music:1,
sfx:1,
ui:1,
ambient:1
},
muted:false
},
_timers:{emitInt:0},

init(ctx){
this._ctx=ctx;
this._state.ts0=Date.now();
this._safe(()=>this._bind(),"init_bind");
this._emit("READY");
},

api:{
mount:()=>Engine_AUDIO_MANCER._mount(),
enable:()=>Engine_AUDIO_MANCER._setEnabled(true),
disable:()=>Engine_AUDIO_MANCER._setEnabled(false),
start:()=>Engine_AUDIO_MANCER._start(),
stop:()=>Engine_AUDIO_MANCER._stop(),
setConfig:(c)=>Engine_AUDIO_MANCER._setConfig(c),
set:(k,v)=>Engine_AUDIO_MANCER._set(k,v),
get:(k)=>Engine_AUDIO_MANCER._get(k),
mute:()=>Engine_AUDIO_MANCER._mute(),
unmute:()=>Engine_AUDIO_MANCER._unmute(),
snapshot:()=>Engine_AUDIO_MANCER._snapshot(),
status:()=>Engine_AUDIO_MANCER._status()
},

_mount(){
if(this._state.mounted) return;
this._state.mounted=true;
this._touch();
this._emit("MOUNTED");
this._emit("STATE");
},

_setEnabled(v){
this._state.enabled=!!v;
this._touch();
this._emit("STATE");
},

_start(){
if(!this._state.enabled||this._state.started) return;
this._state.started=true;
this._touch();
this._emit("STARTED");
this._emit("STATE");
this._startEmitter();
},

_stop(){
if(!this._state.started) return;
this._state.started=false;
this._touch();
this._stopEmitter();
this._emit("STOPPED");
this._emit("STATE");
},

_setConfig(c){
try{
if(!c||typeof c!=="object") return this._snapshot();
const cfg=this._state.config;
["master","music","sfx","ui","ambient"].forEach(k=>{
if(typeof c[k]==="number") cfg[k]=this._clamp(c[k],cfg.clampMin,cfg.clampMax);
});
if(typeof c.emitHz==="number") cfg.emitHz=this._clamp(c.emitHz,0,10);
if(typeof c.autoResume==="boolean") cfg.autoResume=c.autoResume;
this._touch();
this._emit("UPDATED",{config:this._clone(cfg)});
if(this._state.started){this._stopEmitter();this._startEmitter();}
return this._snapshot();
}catch(e){this._err("setConfig",e.message||String(e));return this._snapshot();}
},

_set(k,v){
try{
if(!this._state.enabled) return null;
if(!this._state.levels.hasOwnProperty(k)) return null;
const val=this._clamp(v,this._state.config.clampMin,this._state.config.clampMax);
this._state.levels[k]=val;
this._state.stats.sets++;
this._touch();
this._emit("SET",{key:k,value:val});
return val;
}catch(e){this._err("set",e.message||String(e));return null;}
},

_get(k){
try{
return this._state.levels[k]??null;
}catch(e){this._err("get",e.message||String(e));return null;}
},

_mute(){
this._state.muted=true;
this._state.stats.mutes++;
this._touch();
this._emit("MUTE");
},

_unmute(){
this._state.muted=false;
this._state.stats.unmutes++;
this._touch();
this._emit("UNMUTE");
},

_snapshot(){
return{ id:this.id,state:this._statusObj(),ts:Date.now() };
},

_status(){
const o=this._snapshot();
this._emit("STATE",o);
return o;
},

_statusObj(){
const s=this._state;
return{
enabled:s.enabled,
mounted:s.mounted,
started:s.started,
muted:s.muted,
lastError:s.lastError,
lastUpdate:s.lastUpdate,
config:this._clone(s.config),
levels:this._clone(s.levels),
stats:this._clone(s.stats)
};
},

_startEmitter(){
this._stopEmitter();
const hz=this._state.config.emitHz;
if(!hz||hz<=0) return;
const ms=Math.floor(1000/hz);
this._timers.emitInt=setInterval(()=>{
this._safe(()=>{
if(!this._state.enabled||!this._state.started) return;
this._state.stats.emits++;
this._touch();
this._emit("UPDATED");
},"emit_tick");
},ms);
},

_stopEmitter(){
if(this._timers.emitInt){clearInterval(this._timers.emitInt);this._timers.emitInt=0;}
},

_emit(evt,data){
try{
if(!this._ctx||!this._ctx.bus) return;
const p={id:this.id,state:this._lite(),ts:Date.now()};
if(data) Object.assign(p,data);
this._ctx.bus.emit("EVT:AUDIO_MANCER:"+evt,p);
}catch(e){this._err("_emit",e.message||String(e));}
},

_lite(){
const s=this._state;
return{enabled:s.enabled,started:s.started,muted:s.muted,lastUpdate:s.lastUpdate};
},

_touch(){
this._state.lastUpdate=Date.now();
},

_err(where,msg){
this._state.lastError=String(msg||"error");
try{
this._ctx&&this._ctx.bus&&this._ctx.bus.emit("EVT:AUDIO_MANCER:ERROR",{id:this.id,where:String(where||"error"),error:String(msg||"error"),ts:Date.now()});
}catch(e){}
},

_safe(fn,where){
try{fn();}catch(e){this._err(where||"safe",e.message||String(e));}
},

_bind(){
const bus=this._ctx&&this._ctx.bus;
if(!bus) return;
const on=(t,fn)=>{
try{
if(typeof bus.on==="function") bus.on(t,fn);
else if(typeof bus.subscribe==="function") bus.subscribe(t,fn);
}catch(e){this._err("bind:"+t,e.message||String(e));}
};
on("REQ:AUDIO_MANCER:MOUNT",()=>this.api.mount());
on("REQ:AUDIO_MANCER:ENABLE",()=>this.api.enable());
on("REQ:AUDIO_MANCER:DISABLE",()=>this.api.disable());
on("REQ:AUDIO_MANCER:START",()=>this.api.start());
on("REQ:AUDIO_MANCER:STOP",()=>this.api.stop());
on("REQ:AUDIO_MANCER:CONFIG",(d)=>this.api.setConfig(d&&d.config?d.config:d));
on("REQ:AUDIO_MANCER:SET",(d)=>this.api.set(d&&d.key,d&&d.value));
on("REQ:AUDIO_MANCER:GET",(d)=>this.api.get(d&&d.key));
on("REQ:AUDIO_MANCER:MUTE",()=>this.api.mute());
on("REQ:AUDIO_MANCER:UNMUTE",()=>this.api.unmute());
on("REQ:AUDIO_MANCER:SNAPSHOT",()=>this.api.snapshot());
on("REQ:AUDIO_MANCER:STATUS",()=>this.api.status());
}
,
_clamp(n,a,b){
n=Number(n);
if(!isFinite(n)) return a;
if(n<a) return a;
if(n>b) return b;
return n;
},
_clone(x){
try{return JSON.parse(JSON.stringify(x));}catch(e){return x;}
}
};

window.KOG=window.KOG||{};
window.KOG[Engine_AUDIO_MANCER.id]=Engine_AUDIO_MANCER;
/*-- üéõÔ∏èüîä-(22A)-(E)-(AUDIO-MIXER-ENGINE)-(AUDIO-MANCER)-(E)-(22A)-üîäüéõÔ∏è --*/
/*-- üåÄüéØ-(23A)-(S)-(PERFORMANCE-ZERO-ENGINE)-(ZERO-POINT)-(S)-(23A)-üéØüåÄ --*/
const Engine_ZERO_POINT={
id:"ZERO_POINT",
_ctx:null,
_state:{
enabled:true,
mounted:false,
started:false,
lastError:null,
ts0:0,
lastUpdate:0,
visibility:"unknown",
config:{
sampleHz:2,
rafTrack:true,
longTaskTrack:true,
stallMs:1500,
frameBudgetMs:16.67,
fpsSoft:55,
fpsHard:40,
longTaskSoftMs:50,
longTaskHardMs:120,
memSoftMB:null,
memHardMB:null,
jitterSoftMs:6,
jitterHardMs:12
},
stats:{
fps:0,
frameMsAvg:0,
frameMsP95:0,
jitterAvg:0,
jitterP95:0,
longTasks:0,
longTaskMsTotal:0,
longTaskMsMax:0,
memMB:null,
heapMB:null,
samples:0,
stalls:0
},
buffers:{
frameMs:[],
jitterMs:[],
longTaskMs:[]
},
recommendation:{
level:"UPGRADE",
reasons:[],
score:0
},
device:{
dpr:1,
cores:null,
memGB:null,
ua:null
}
},
_timers:{sample:0,watchdog:0},
_rafId:0,
_lastFrame:0,
_lastWatch:0,
_lastStallEmit:0,
_lastStalls:0,
_longObs:null,

init(ctx){
this._ctx=ctx;
this._state.ts0=Date.now();
this._safe(()=>this._detectDevice(),"detect");
this._safe(()=>this._bind(),"bind");
this._emit("READY");
},

api:{
mount:()=>Engine_ZERO_POINT._mount(),
enable:()=>Engine_ZERO_POINT._setEnabled(true),
disable:()=>Engine_ZERO_POINT._setEnabled(false),
start:()=>Engine_ZERO_POINT._start(),
stop:()=>Engine_ZERO_POINT._stop(),
setConfig:(c)=>Engine_ZERO_POINT._setConfig(c),
tick:(l,t0,t1)=>Engine_ZERO_POINT._tick(l,t0,t1),
mark:(n)=>Engine_ZERO_POINT._mark(n),
measure:(n,s,e)=>Engine_ZERO_POINT._measure(n,s,e),
snapshot:()=>Engine_ZERO_POINT._snapshot(),
status:()=>Engine_ZERO_POINT._status()
},

_mount(){
if(this._state.mounted) return;
this._state.mounted=true;
this._touch();
this._emit("MOUNTED");
this._emit("STATE");
},

_setEnabled(v){
this._state.enabled=!!v;
this._touch();
this._emit("STATE");
},

_start(){
if(!this._state.enabled||this._state.started) return;
this._state.started=true;
this._touch();
this._emit("STARTED");
this._emit("STATE");
this._startSampling();
this._startWatchdog();
this._startRAF();
this._startLongTasks();
},

_stop(){
if(!this._state.started) return;
this._state.started=false;
this._touch();
this._stopSampling();
this._stopWatchdog();
this._stopRAF();
this._stopLongTasks();
this._emit("STOPPED");
this._emit("STATE");
},

_setConfig(c){
try{
if(!c||typeof c!=="object") return this._snapshot();
const cfg=this._state.config;
Object.keys(cfg).forEach(k=>{
if(typeof c[k]==="number") cfg[k]=c[k];
if(typeof c[k]==="boolean") cfg[k]=c[k];
});
cfg.sampleHz=this._clamp(cfg.sampleHz,0.5,10);
this._touch();
if(this._state.started){this._stopSampling();this._startSampling();}
this._emit("UPDATED");
return this._snapshot();
}catch(e){this._err("setConfig",e.message||String(e));return this._snapshot();}
},

_tick(label,t0,t1){
try{
label=label||"tick";
let d=0;
if(typeof t0==="number"&&typeof t1==="number") d=t1-t0;
else if(typeof t0==="number"&&performance&&performance.now) d=performance.now()-t0;
if(d<0||!isFinite(d)) return;
this._push(this._state.buffers.frameMs,d,240);
}catch(e){this._err("tick",e.message||String(e));}
},

_mark(n){
try{performance&&performance.mark&&performance.mark(n);}catch(e){}
},

_measure(n,s,e){
try{performance&&performance.measure&&performance.measure(n,s,e);}catch(e){}
},

_snapshot(){
return{ id:this.id,state:this._statusObj(),ts:Date.now() };
},

_status(){
const o=this._snapshot();
this._emit("STATE",o);
return o;
},

_statusObj(){
const s=this._state;
return{
enabled:s.enabled,
mounted:s.mounted,
started:s.started,
lastError:s.lastError,
lastUpdate:s.lastUpdate,
visibility:s.visibility,
config:this._clone(s.config),
stats:this._clone(s.stats),
recommendation:this._clone(s.recommendation),
device:this._clone(s.device)
};
},

_startSampling(){
this._stopSampling();
const ms=Math.floor(1000/this._state.config.sampleHz);
this._timers.sample=setInterval(()=>this._safe(()=>this._sample(),"sample"),ms);
},

_stopSampling(){
if(this._timers.sample){clearInterval(this._timers.sample);this._timers.sample=0;}
},

_sample(){
const b=this._state.buffers;
const s=this._state.stats;
s.frameMsAvg=this._avg(b.frameMs);
s.frameMsP95=this._p95(b.frameMs);
s.jitterAvg=this._avg(b.jitterMs);
s.jitterP95=this._p95(b.jitterMs);
s.fps=s.frameMsAvg>0?Math.min(120,1000/s.frameMsAvg):0;
if(performance&&performance.memory){
s.memMB=performance.memory.usedJSHeapSize/1048576;
s.heapMB=performance.memory.totalJSHeapSize/1048576;
}
this._recommend();
s.samples++;
this._touch();
this._emit("UPDATED");
},

_recommend(){
const s=this._state.stats;
const c=this._state.config;
let score=0;
let reasons=[];
if(s.fps<c.fpsHard){score+=35;reasons.push("fps_hard");}
else if(s.fps<c.fpsSoft){score+=15;reasons.push("fps_soft");}
if(s.frameMsP95>c.frameBudgetMs*2){score+=25;reasons.push("frame_p95_hard");}
else if(s.frameMsP95>c.frameBudgetMs*1.3){score+=10;reasons.push("frame_p95_soft");}
if(s.jitterP95>c.jitterHardMs){score+=15;reasons.push("jitter_hard");}
else if(s.jitterP95>c.jitterSoftMs){score+=7;reasons.push("jitter_soft");}
if(s.longTaskMsMax>=c.longTaskHardMs){score+=20;reasons.push("longtask_hard");}
else if(s.longTaskMsMax>=c.longTaskSoftMs){score+=8;reasons.push("longtask_soft");}
if(c.memSoftMB!=null&&s.memMB!=null){
if(s.memMB>=c.memHardMB){score+=20;reasons.push("mem_hard");}
else if(s.memMB>=c.memSoftMB){score+=8;reasons.push("mem_soft");}
}
if(s.stalls>this._lastStalls){score+=20;reasons.push("stall");}
this._lastStalls=s.stalls;
score=this._clamp(score,0,100);
let lvl="UPGRADE";
if(score>=70) lvl="PANIC";
else if(score>=40) lvl="DOWNGRADE";
else if(score>=20) lvl="HOLD";
this._state.recommendation={level:lvl,reasons:reasons,score:score};
},

_startWatchdog(){
this._stopWatchdog();
this._lastWatch=Date.now();
this._timers.watchdog=setInterval(()=>{
const now=Date.now();
const drift=now-this._lastWatch;
this._lastWatch=now;
if(drift>this._state.config.stallMs){
this._state.stats.stalls++;
if(now-this._lastStallEmit>2000){
this._lastStallEmit=now;
this._emit("STALL",{ms:drift});
}
}
},250);
},

_stopWatchdog(){
if(this._timers.watchdog){clearInterval(this._timers.watchdog);this._timers.watchdog=0;}
},

_startRAF(){
if(!this._state.config.rafTrack) return;
const loop=(t)=>{
if(!this._state.started) return;
if(this._lastFrame){
const d=t-this._lastFrame;
this._push(this._state.buffers.frameMs,d,240);
this._push(this._state.buffers.jitterMs,Math.abs(d-this._state.config.frameBudgetMs),240);
}
this._lastFrame=t;
this._rafId=requestAnimationFrame(loop);
};
this._rafId=requestAnimationFrame(loop);
},

_stopRAF(){
if(this._rafId){cancelAnimationFrame(this._rafId);this._rafId=0;}
this._lastFrame=0;
},

_startLongTasks(){
if(!this._state.config.longTaskTrack) return;
if(typeof PerformanceObserver!=="function") return;
try{
this._longObs=new PerformanceObserver((list)=>{
list.getEntries().forEach(e=>{
const d=this._clamp(e.duration,0,2000);
this._state.stats.longTasks++;
this._state.stats.longTaskMsTotal+=d;
this._state.stats.longTaskMsMax=Math.max(this._state.stats.longTaskMsMax,d);
this._push(this._state.buffers.longTaskMs,d,120);
});
});
this._longObs.observe({entryTypes:["longtask"]});
}catch(e){}
},

_stopLongTasks(){
try{this._longObs&&this._longObs.disconnect();}catch(e){}
this._longObs=null;
},

_detectDevice(){
try{
this._state.device.dpr=window.devicePixelRatio||1;
this._state.device.cores=navigator.hardwareConcurrency||null;
this._state.device.memGB=navigator.deviceMemory||null;
this._state.device.ua=navigator.userAgent||null;
}catch(e){}
},

_emit(evt,data){
try{
if(!this._ctx||!this._ctx.bus) return;
const p={id:this.id,state:this._statusObj(),ts:Date.now()};
if(data) Object.assign(p,data);
this._ctx.bus.emit("EVT:ZERO_POINT:"+evt,p);
}catch(e){this._err("_emit",e.message||String(e));}
},

_touch(){
this._state.lastUpdate=Date.now();
},

_err(where,msg){
this._state.lastError=String(msg||"error");
try{
this._ctx&&this._ctx.bus&&this._ctx.bus.emit("EVT:ZERO_POINT:ERROR",{id:this.id,where:String(where||"error"),error:String(msg||"error"),ts:Date.now()});
}catch(e){}
},

_safe(fn,where){
try{fn();}catch(e){this._err(where||"safe",e.message||String(e));}
},

_bind(){
const bus=this._ctx&&this._ctx.bus;
if(!bus) return;
const on=(t,f)=>{try{bus.on?bus.on(t,f):bus.subscribe&&bus.subscribe(t,f);}catch(e){}};
on("REQ:ZERO_POINT:MOUNT",()=>this.api.mount());
on("REQ:ZERO_POINT:ENABLE",()=>this.api.enable());
on("REQ:ZERO_POINT:DISABLE",()=>this.api.disable());
on("REQ:ZERO_POINT:START",()=>this.api.start());
on("REQ:ZERO_POINT:STOP",()=>this.api.stop());
on("REQ:ZERO_POINT:CONFIG",(d)=>this.api.setConfig(d));
on("REQ:ZERO_POINT:SNAPSHOT",()=>this.api.snapshot());
on("REQ:ZERO_POINT:STATUS",()=>this.api.status());
on("REQ:ZERO_POINT:TICK",(d)=>this.api.tick(d&&d.label,d&&d.t0,d&&d.t1));
},

_push(arr,v,max){
arr.push(v);
if(arr.length>max) arr.shift();
},

_avg(arr){
if(!arr.length) return 0;
return arr.reduce((a,b)=>a+b,0)/arr.length;
},

_p95(arr){
if(!arr.length) return 0;
const s=[...arr].sort((a,b)=>a-b);
const i=Math.floor(0.95*(s.length-1));
return s[i]||0;
},

_clamp(n,a,b){
n=Number(n);
if(!isFinite(n)) return a;
if(n<a) return a;
if(n>b) return b;
return n;
},

_clone(x){
try{return JSON.parse(JSON.stringify(x));}catch(e){return x;}
}
};

window.KOG=window.KOG||{};
window.KOG[Engine_ZERO_POINT.id]=Engine_ZERO_POINT;
/*-- üåÄüéØ-(23A)-(E)-(PERFORMANCE-ZERO-ENGINE)-(ZERO-POINT)-(E)-(23A)-üéØüåÄ --*/
/*-- ‚è≥üß≠-(24A)-(S)-(TIMELINE-SCHEDULER-ENGINE)-(CHRONO-LORD)-(S)-(24A)-üß≠‚è≥ --*/
const Engine_CHRONO_LORD = {
id:'CHRONO_LORD',
_ctx:null,
_state:{
enabled:true,
mounted:false,
started:false,
lastError:null,
timers:new Map()
},

init(ctx){
this._ctx=ctx;
const B=ctx.bus;

B.on('REQ:CHRONO_LORD:MOUNT',()=>this.api.mount());
B.on('REQ:CHRONO_LORD:ENABLE',()=>this.api.enable());
B.on('REQ:CHRONO_LORD:DISABLE',()=>this.api.disable());
B.on('REQ:CHRONO_LORD:START',()=>this.api.start());
B.on('REQ:CHRONO_LORD:STOP',()=>this.api.stop());
B.on('REQ:CHRONO_LORD:SCHEDULE',(p)=>this.api.schedule(p));
B.on('REQ:CHRONO_LORD:CLEAR',(p)=>this.api.clear(p));
B.on('REQ:CHRONO_LORD:STATUS',()=>this.api.status());

ctx.log.info('CHRONO_LORD','Initialized');
ctx.bus.emit('EVT:CHRONO_LORD:READY',{id:this.id,ts:Date.now()});
},

api:{
mount(){
const s=Engine_CHRONO_LORD._state;
if(s.mounted)return;
s.mounted=true;
Engine_CHRONO_LORD._ctx.bus.emit('EVT:CHRONO_LORD:MOUNTED',{id:'CHRONO_LORD',ts:Date.now()});
},

enable(){Engine_CHRONO_LORD._state.enabled=true;},
disable(){Engine_CHRONO_LORD._state.enabled=false;},

start(){
const s=Engine_CHRONO_LORD._state;
if(s.started)return;
s.started=true;
Engine_CHRONO_LORD._ctx.bus.emit('EVT:CHRONO_LORD:STARTED',{id:'CHRONO_LORD',ts:Date.now()});
},

stop(){
const s=Engine_CHRONO_LORD._state;
for(const t of s.timers.values())clearTimeout(t.id);
s.timers.clear();
s.started=false;
Engine_CHRONO_LORD._ctx.bus.emit('EVT:CHRONO_LORD:STOPPED',{id:'CHRONO_LORD',ts:Date.now()});
},

schedule(p){
try{
if(!p||!p.id||!p.delay||typeof p.fn!=='function')return;
const s=Engine_CHRONO_LORD._state;
if(s.timers.has(p.id))clearTimeout(s.timers.get(p.id).id);

const tid=setTimeout(()=>{
if(!s.enabled)return;
p.fn();
Engine_CHRONO_LORD._ctx.bus.emit('EVT:CHRONO_LORD:FIRED',{id:p.id,ts:Date.now()});
s.timers.delete(p.id);
},p.delay);

s.timers.set(p.id,{id:tid,delay:p.delay});
}catch(e){
Engine_CHRONO_LORD._state.lastError=e.message;
Engine_CHRONO_LORD._ctx.bus.emit('EVT:CHRONO_LORD:ERROR',{error:e.message,ts:Date.now()});
}
},

clear(p){
if(!p||!p.id)return;
const s=Engine_CHRONO_LORD._state;
if(s.timers.has(p.id)){
clearTimeout(s.timers.get(p.id).id);
s.timers.delete(p.id);
}
},

status(){
return{
id:'CHRONO_LORD',
state:Engine_CHRONO_LORD._state,
ts:Date.now()
};
}
}
};

window.KOG=window.KOG||{};
window.KOG[Engine_CHRONO_LORD.id]=Engine_CHRONO_LORD;
/*-- ‚è≥üß≠-(24A)-(E)-(TIMELINE-SCHEDULER-ENGINE)-(CHRONO-LORD)-(E)-(24A)-üß≠‚è≥ --*/
/*-- üî•ü™Ω-(25A)-(S)-(RECOVERY-RESTART-ENGINE)-(PHOENIX)-(S)-(25A)-ü™Ωüî• --*/
const Engine_PHOENIX={
id:"PHOENIX",
_ctx:null,
_state:{enabled:true,mounted:false,restarts:0,lastRestart:0,lastError:null,config:{cooldownMs:750,maxRestartsPerMinute:10,autoEnable:true}},
init(ctx){
this._ctx=ctx||null;
if(!this._ctx||!this._ctx.bus)return this._error("init","missing_ctx_bus");
this._wire();
if(this._state.config.autoEnable)this.enable();
return this;
},
_wire(){
var b=this._ctx.bus,me=this;
b.on("REQ:PHOENIX:MOUNT",function(p){me.mount(p);});
b.on("REQ:PHOENIX:ENABLE",function(){me.enable();});
b.on("REQ:PHOENIX:DISABLE",function(){me.disable();});
b.on("REQ:PHOENIX:RESTART",function(p){me.restart(p);});
b.on("REQ:PHOENIX:STATUS",function(){me._emitState("EVT:PHOENIX:STATE");});
},
_emit(ev,p){
try{this._ctx&&this._ctx.bus&&this._ctx.bus.emit(ev,p);}catch(e){this._error("_emit",e);}
},
_log(){
try{this._ctx&&this._ctx.log&&this._ctx.log.apply(this._ctx,arguments);}catch(e){}
},
_error(where,err){
var msg=(err&&err.message)?err.message:String(err||"error");
this._state.lastError=msg;
this._emit("EVT:PHOENIX:ERROR",{id:this.id,where:String(where||"unknown"),error:msg,ts:Date.now()});
return null;
},
_clamp(n,a,b){
n=Number(n);
if(!isFinite(n))n=a;
if(n<a)n=a;
if(n>b)n=b;
return n;
},
_setConfig(partial){
partial=partial||{};
var c=this._state.config;
if(partial.cooldownMs!=null)c.cooldownMs=this._clamp(partial.cooldownMs,0,60000);
if(partial.maxRestartsPerMinute!=null)c.maxRestartsPerMinute=this._clamp(partial.maxRestartsPerMinute,0,120);
if(partial.autoEnable!=null)c.autoEnable=!!partial.autoEnable;
},
mount(payload){
try{
payload=payload||{};
if(payload.config)this._setConfig(payload.config);
this._state.mounted=true;
this._emit("EVT:PHOENIX:MOUNTED",{id:this.id,ts:Date.now()});
this._emitState("EVT:PHOENIX:STATE");
}catch(e){this._error("mount",e);}
},
enable(){
try{
this._state.enabled=true;
this._emit("EVT:PHOENIX:STATE",{id:this.id,state:this._snapshotState(),ts:Date.now()});
}catch(e){this._error("enable",e);}
},
disable(){
try{
this._state.enabled=false;
this._emit("EVT:PHOENIX:STATE",{id:this.id,state:this._snapshotState(),ts:Date.now()});
}catch(e){this._error("disable",e);}
},
_restartRateOK(now){
var m=60000,limit=this._state.config.maxRestartsPerMinute;
if(!limit)return true;
if(!this._state._rt)this._state._rt=[];
var rt=this._state._rt,cut=now-m,i=0;
for(i=rt.length-1;i>=0;i--)if(rt[i]<cut)rt.splice(i,1);
if(rt.length>=limit)return false;
rt.push(now);
return true;
},
restart(payload){
try{
payload=payload||{};
if(payload.config)this._setConfig(payload.config);
if(!this._state.enabled)return;
var now=Date.now(),cd=this._state.config.cooldownMs;
if(now-this._state.lastRestart<cd)return;
if(!this._restartRateOK(now))return this._error("restart","rate_limited");
this._state.restarts++;
this._state.lastRestart=now;
this._emit("EVT:PHOENIX:RESTARTING",{id:this.id,ts:now});
var fn=null;
if(payload&&typeof payload.fn==="function")fn=payload.fn;
if(fn){
try{fn();}catch(e){this._error("restart.fn",e);}
}
this._emitState("EVT:PHOENIX:STATE");
}catch(e){this._error("restart",e);}
},
_snapshotState(){
return {enabled:this._state.enabled,mounted:this._state.mounted,restarts:this._state.restarts,lastRestart:this._state.lastRestart,lastError:this._state.lastError,config:{cooldownMs:this._state.config.cooldownMs,maxRestartsPerMinute:this._state.config.maxRestartsPerMinute,autoEnable:this._state.config.autoEnable}};
},
_emitState(ev){
this._emit(ev||"EVT:PHOENIX:STATE",{id:this.id,state:this._snapshotState(),ts:Date.now()});
},
status(){
return {id:this.id,state:this._snapshotState(),ts:Date.now()};
},
api:{
mount:function(p){return Engine_PHOENIX.mount(p);},
enable:function(){return Engine_PHOENIX.enable();},
disable:function(){return Engine_PHOENIX.disable();},
restart:function(p){return Engine_PHOENIX.restart(p);},
setConfig:function(p){return Engine_PHOENIX._setConfig(p);},
status:function(){return Engine_PHOENIX.status();}
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_PHOENIX.id]=Engine_PHOENIX;
/*-- üî•ü™Ω-(25A)-(E)-(RECOVERY-RESTART-ENGINE)-(PHOENIX)-(E)-(25A)-ü™Ωüî• --*/
/*-- üöÄüõ∞Ô∏è-(26A)-(S)-(EXTERNAL-LINK-PORTAL-ENGINE)-(SPACE-ACE)-(S)-(26A)-üõ∞Ô∏èüöÄ --*/
const Engine_SPACE_ACE={
id:'SPACE_ACE',
_ctx:null,
_state:{
enabled:true,
mounted:false,
opened:0,
blocked:0,
lastError:null
},

init(ctx){
this._ctx=ctx;
const B=ctx.bus;

B.on('REQ:SPACE_ACE:MOUNT',()=>this.api.mount());
B.on('REQ:SPACE_ACE:ENABLE',()=>this.api.enable());
B.on('REQ:SPACE_ACE:DISABLE',()=>this.api.disable());
B.on('REQ:SPACE_ACE:OPEN',(p)=>this.api.open(p));
B.on('REQ:SPACE_ACE:STATUS',()=>this.api.status());

ctx.log.info('SPACE_ACE','Initialized');
ctx.bus.emit('EVT:SPACE_ACE:READY',{id:this.id,ts:Date.now()});
},

api:{
mount(){
const s=Engine_SPACE_ACE._state;
if(s.mounted)return;
s.mounted=true;
Engine_SPACE_ACE._ctx.bus.emit('EVT:SPACE_ACE:MOUNTED',{id:'SPACE_ACE',ts:Date.now()});
},

enable(){Engine_SPACE_ACE._state.enabled=true;},
disable(){Engine_SPACE_ACE._state.enabled=false;},

open(p){
try{
const s=Engine_SPACE_ACE._state;
if(!s.enabled)return;
if(!p||!p.url){
s.blocked++;
return;
}

const target=p.target||'_blank';
const win=window.open(p.url,target);

if(win){
s.opened++;
Engine_SPACE_ACE._ctx.log.info('SPACE_ACE','Opened '+p.url);
Engine_SPACE_ACE._ctx.bus.emit('EVT:SPACE_ACE:OPENED',{
id:'SPACE_ACE',
url:p.url,
ts:Date.now()
});
}else{
s.blocked++;
Engine_SPACE_ACE._ctx.bus.emit('EVT:SPACE_ACE:BLOCKED',{
id:'SPACE_ACE',
url:p.url,
ts:Date.now()
});
}
}catch(e){
Engine_SPACE_ACE._state.lastError=e.message;
Engine_SPACE_ACE._ctx.bus.emit('EVT:SPACE_ACE:ERROR',{error:e.message,ts:Date.now()});
}
},

status(){
return{
id:'SPACE_ACE',
state:Engine_SPACE_ACE._state,
ts:Date.now()
};
}
}
};

window.KOG=window.KOG||{};
window.KOG[Engine_SPACE_ACE.id]=Engine_SPACE_ACE;
/*-- üöÄüõ∞Ô∏è-(26A)-(E)-(EXTERNAL-LINK-PORTAL-ENGINE)-(SPACE-ACE)-(E)-(26A)-üõ∞Ô∏èüöÄ --*/
/*-- ü§ùüíº-(27A)-(S)-(TASK-QUEUE-ENGINE)-(DEAL-CLOSER)-(S)-(27A)-üíºü§ù --*/
const Engine_DEAL_CLOSER={
id:'DEAL_CLOSER',
_ctx:null,
_state:{
enabled:true,
mounted:false,
processing:false,
lastError:null,
queue:[],
stats:{
enqueued:0,
processed:0,
failed:0
}
},

init(ctx){
this._ctx=ctx;
const B=ctx.bus;

B.on('REQ:DEAL_CLOSER:MOUNT',()=>this.api.mount());
B.on('REQ:DEAL_CLOSER:ENABLE',()=>this.api.enable());
B.on('REQ:DEAL_CLOSER:DISABLE',()=>this.api.disable());
B.on('REQ:DEAL_CLOSER:ENQUEUE',(p)=>this.api.enqueue(p));
B.on('REQ:DEAL_CLOSER:PROCESS',()=>this.api.process());
B.on('REQ:DEAL_CLOSER:CLEAR',()=>this.api.clear());
B.on('REQ:DEAL_CLOSER:STATUS',()=>this.api.status());

ctx.log.info('DEAL_CLOSER','Initialized');
ctx.bus.emit('EVT:DEAL_CLOSER:READY',{id:this.id,ts:Date.now()});
},

api:{
mount(){
const s=Engine_DEAL_CLOSER._state;
if(s.mounted)return;
s.mounted=true;
Engine_DEAL_CLOSER._ctx.bus.emit('EVT:DEAL_CLOSER:MOUNTED',{id:'DEAL_CLOSER',ts:Date.now()});
},

enable(){Engine_DEAL_CLOSER._state.enabled=true;},
disable(){Engine_DEAL_CLOSER._state.enabled=false;},

enqueue(task){
const s=Engine_DEAL_CLOSER._state;
if(!s.enabled||!task)return;
s.queue.push(task);
s.stats.enqueued++;
Engine_DEAL_CLOSER._ctx.bus.emit('EVT:DEAL_CLOSER:ENQUEUED',{
id:'DEAL_CLOSER',
size:s.queue.length,
ts:Date.now()
});
},

async process(){
const s=Engine_DEAL_CLOSER._state;
if(!s.enabled||s.processing||!s.queue.length)return;

s.processing=true;
Engine_DEAL_CLOSER._ctx.bus.emit('EVT:DEAL_CLOSER:PROCESS_START',{id:'DEAL_CLOSER',ts:Date.now()});

while(s.queue.length){
const job=s.queue.shift();
try{
if(typeof job==='function'){
await job();
}
s.stats.processed++;
}catch(e){
s.stats.failed++;
s.lastError=e.message;
Engine_DEAL_CLOSER._ctx.bus.emit('EVT:DEAL_CLOSER:ERROR',{
error:e.message,
ts:Date.now()
});
}
}

s.processing=false;
Engine_DEAL_CLOSER._ctx.bus.emit('EVT:DEAL_CLOSER:PROCESS_DONE',{
id:'DEAL_CLOSER',
processed:s.stats.processed,
ts:Date.now()
});
},

clear(){
const s=Engine_DEAL_CLOSER._state;
s.queue.length=0;
},

status(){
return{
id:'DEAL_CLOSER',
state:Engine_DEAL_CLOSER._state,
ts:Date.now()
};
}
}
};

window.KOG=window.KOG||{};
window.KOG[Engine_DEAL_CLOSER.id]=Engine_DEAL_CLOSER;
/*-- ü§ùüíº-(27A)-(E)-(TASK-QUEUE-ENGINE)-(DEAL-CLOSER)-(E)-(27A)-üíºü§ù --*/
/*-- üìºüåà-(28A)-(S)-(RETRO-FX-ENGINE)-(RETRO-WAVE)-(S)-(28A)-üåàüìº --*/
const Engine_RETRO_WAVE={
id:'RETRO_WAVE',
_ctx:null,
_state:{
enabled:true,
mounted:false,
active:false,
lastError:null,
config:{
scanlines:true,
noise:true,
chromatic:true,
intensity:0.35
}
},

init(ctx){
this._ctx=ctx;
const B=ctx.bus;

B.on('REQ:RETRO_WAVE:MOUNT',()=>this.api.mount());
B.on('REQ:RETRO_WAVE:ENABLE',()=>this.api.enable());
B.on('REQ:RETRO_WAVE:DISABLE',()=>this.api.disable());
B.on('REQ:RETRO_WAVE:APPLY',()=>this.api.apply());
B.on('REQ:RETRO_WAVE:REMOVE',()=>this.api.remove());
B.on('REQ:RETRO_WAVE:CONFIG',(p)=>this.api.setConfig(p));
B.on('REQ:RETRO_WAVE:STATUS',()=>this.api.status());

ctx.log.info('RETRO_WAVE','Initialized');
ctx.bus.emit('EVT:RETRO_WAVE:READY',{id:this.id,ts:Date.now()});
},

api:{
mount(){
const s=Engine_RETRO_WAVE._state;
if(s.mounted)return;
s.mounted=true;
Engine_RETRO_WAVE._ctx.bus.emit('EVT:RETRO_WAVE:MOUNTED',{id:'RETRO_WAVE',ts:Date.now()});
},

enable(){Engine_RETRO_WAVE._state.enabled=true;},
disable(){Engine_RETRO_WAVE._state.enabled=false;},

setConfig(p){
const c=Engine_RETRO_WAVE._state.config;
if(!p||typeof p!=='object')return;
Object.assign(c,p);
},

apply(){
const s=Engine_RETRO_WAVE._state;
if(!s.enabled||s.active)return;
s.active=true;
Engine_RETRO_WAVE._ctx.bus.emit('EVT:RETRO_WAVE:APPLIED',{
id:'RETRO_WAVE',
config:s.config,
ts:Date.now()
});
},

remove(){
const s=Engine_RETRO_WAVE._state;
if(!s.active)return;
s.active=false;
Engine_RETRO_WAVE._ctx.bus.emit('EVT:RETRO_WAVE:REMOVED',{
id:'RETRO_WAVE',
ts:Date.now()
});
},

status(){
return{
id:'RETRO_WAVE',
state:Engine_RETRO_WAVE._state,
ts:Date.now()
};
}
}
};

window.KOG=window.KOG||{};
window.KOG[Engine_RETRO_WAVE.id]=Engine_RETRO_WAVE;
/*-- üìºüåà-(28A)-(E)-(RETRO-FX-ENGINE)-(RETRO-WAVE)-(E)-(28A)-üåàüìº --*/
/*-- üêÄüß∞-(29A)-(S)-(DEBUG-TOOLKIT-ENGINE)-(STREET-RAT)-(S)-(29A)-üß∞üêÄ --*/
const Engine_STREET_RAT={
id:'STREET_RAT',
_ctx:null,
_state:{
enabled:true,
mounted:false,
lastError:null,
flags:{
log:true,
warn:true,
error:true,
trace:false
},
history:[],
maxHistory:200
},

init(ctx){
this._ctx=ctx;
const B=ctx.bus;

B.on('REQ:STREET_RAT:MOUNT',()=>this.api.mount());
B.on('REQ:STREET_RAT:ENABLE',()=>this.api.enable());
B.on('REQ:STREET_RAT:DISABLE',()=>this.api.disable());
B.on('REQ:STREET_RAT:LOG',(p)=>this.api.log('log',p));
B.on('REQ:STREET_RAT:WARN',(p)=>this.api.log('warn',p));
B.on('REQ:STREET_RAT:ERROR',(p)=>this.api.log('error',p));
B.on('REQ:STREET_RAT:TRACE',(p)=>this.api.log('trace',p));
B.on('REQ:STREET_RAT:CONFIG',(p)=>this.api.setFlags(p));
B.on('REQ:STREET_RAT:STATUS',()=>this.api.status());

ctx.log.info('STREET_RAT','Initialized');
ctx.bus.emit('EVT:STREET_RAT:READY',{id:this.id,ts:Date.now()});
},

api:{
mount(){
const s=Engine_STREET_RAT._state;
if(s.mounted)return;
s.mounted=true;
Engine_STREET_RAT._ctx.bus.emit('EVT:STREET_RAT:MOUNTED',{id:'STREET_RAT',ts:Date.now()});
},

enable(){Engine_STREET_RAT._state.enabled=true;},
disable(){Engine_STREET_RAT._state.enabled=false;},

setFlags(p){
const f=Engine_STREET_RAT._state.flags;
if(!p||typeof p!=='object')return;
Object.assign(f,p);
},

log(type,payload){
const s=Engine_STREET_RAT._state;
if(!s.enabled||!s.flags[type])return;
const entry={
type,
payload,
ts:Date.now()
};
s.history.push(entry);
if(s.history.length>s.maxHistory)s.history.shift();
Engine_STREET_RAT._ctx.bus.emit('EVT:STREET_RAT:'+type.toUpperCase(),entry);
},

status(){
return{
id:'STREET_RAT',
state:Engine_STREET_RAT._state,
ts:Date.now()
};
}
}
};

window.KOG=window.KOG||{};
window.KOG[Engine_STREET_RAT.id]=Engine_STREET_RAT;
/*-- üêÄüß∞-(29A)-(E)-(DEBUG-TOOLKIT-ENGINE)-(STREET-RAT)-(E)-(29A)-üß∞üêÄ --*/
/*-- üî±üëÅÔ∏è‚Äçüó®Ô∏è-(30A)-(S)-(GOD-MODE-OVERRIDE-ENGINE)-(GOD-MODE)-(S)-(30A)-üëÅÔ∏è‚Äçüó®Ô∏èüî± --*/
const Engine_GOD_MODE={
id:'GOD_MODE',
_ctx:null,
_state:{
enabled:false,
armed:false,
lastError:null,
overrides:{
errors:false,
locks:false,
limits:false
},
activatedAt:null
},

init(ctx){
this._ctx=ctx;
const B=ctx.bus;

B.on('REQ:GOD_MODE:ARM',()=>this.api.arm());
B.on('REQ:GOD_MODE:ENABLE',()=>this.api.enable());
B.on('REQ:GOD_MODE:DISABLE',()=>this.api.disable());
B.on('REQ:GOD_MODE:CONFIG',(p)=>this.api.setOverrides(p));
B.on('REQ:GOD_MODE:STATUS',()=>this.api.status());

ctx.log.warn('GOD_MODE','Loaded (DORMANT)');
ctx.bus.emit('EVT:GOD_MODE:READY',{id:this.id,ts:Date.now()});
},

api:{
arm(){
const s=Engine_GOD_MODE._state;
if(s.armed)return;
s.armed=true;
Engine_GOD_MODE._ctx.bus.emit('EVT:GOD_MODE:ARMED',{id:'GOD_MODE',ts:Date.now()});
},

enable(){
const s=Engine_GOD_MODE._state;
if(!s.armed)return;
s.enabled=true;
s.activatedAt=Date.now();
Engine_GOD_MODE._ctx.bus.emit('EVT:GOD_MODE:ENABLED',{id:'GOD_MODE',ts:s.activatedAt});
},

disable(){
const s=Engine_GOD_MODE._state;
s.enabled=false;
Engine_GOD_MODE._ctx.bus.emit('EVT:GOD_MODE:DISABLED',{id:'GOD_MODE',ts:Date.now()});
},

setOverrides(p){
if(!p||typeof p!=='object')return;
Object.assign(Engine_GOD_MODE._state.overrides,p);
},

status(){
return{
id:'GOD_MODE',
state:Engine_GOD_MODE._state,
ts:Date.now()
};
}
}
};

window.KOG=window.KOG||{};
window.KOG[Engine_GOD_MODE.id]=Engine_GOD_MODE;
/*-- üî±üëÅÔ∏è‚Äçüó®Ô∏è-(30A)-(E)-(GOD-MODE-OVERRIDE-ENGINE)-(GOD-MODE)-(E)-(30A)-üëÅÔ∏è‚Äçüó®Ô∏èüî± --*/
/*-- üé®üßä-(31A)-(S)-(PALETTE-MASTER-ENGINE)-(CHROMA-VAULT)-(S)-(31A)-üßäüé® --*/
const Engine_CHROMA_VAULT={
id:"CHROMA_VAULT",
_ctx:null,
_state:{
enabled:true,
mounted:false,
lastError:null,
ts0:0,
config:{
glassAlpha:0.22,
panelScrimAlpha:0.55,
buttonGlassAlpha:0.12,
glowIntensity:1,
maxColors:128
},
palette:{
colors:[],
byId:{}
},
binds:{
text:"toxic_green",
glow:"toxic_green"
},
device:{
dpr:1,
ua:null
}
},
init(ctx){
this._ctx=ctx||null;
this._state.ts0=Date.now();
this._state.device.dpr=(typeof devicePixelRatio==="number"&&isFinite(devicePixelRatio))?devicePixelRatio:1;
this._state.device.ua=(typeof navigator!=="undefined"&&navigator&&navigator.userAgent)?String(navigator.userAgent):null;
if(!this._ctx||!this._ctx.bus)return this._error("init","missing_ctx_bus");
this._buildDefaultPalette();
this._wire();
this._emit("EVT:CHROMA_VAULT:READY",{id:this.id,state:this.snapshot().state,ts:Date.now()});
return this;
},
_wire(){
var b=this._ctx.bus,me=this;
b.on("REQ:CHROMA_VAULT:MOUNT",function(p){me.mount(p);});
b.on("REQ:CHROMA_VAULT:ENABLE",function(){me.enable();});
b.on("REQ:CHROMA_VAULT:DISABLE",function(){me.disable();});
b.on("REQ:CHROMA_VAULT:CONFIG",function(p){me.setConfig(p);});
b.on("REQ:CHROMA_VAULT:SET",function(p){me.set(p);});
b.on("REQ:CHROMA_VAULT:GET",function(p){me.get(p);});
b.on("REQ:CHROMA_VAULT:LIST",function(){me._emit("EVT:CHROMA_VAULT:LIST",{id:me.id,colors:me.list(),ts:Date.now()});});
b.on("REQ:CHROMA_VAULT:SNAPSHOT",function(){me._emit("EVT:CHROMA_VAULT:STATE",me.snapshot());});
b.on("REQ:CHROMA_VAULT:STATUS",function(){me._emit("EVT:CHROMA_VAULT:STATE",me.status());});
},
_emit(ev,p){
try{this._ctx&&this._ctx.bus&&this._ctx.bus.emit(ev,p);}catch(e){this._error("_emit",e);}
},
_log(){
try{this._ctx&&this._ctx.log&&this._ctx.log.apply(this._ctx,arguments);}catch(e){}
},
_error(where,err){
var msg=(err&&err.message)?err.message:String(err||"error");
this._state.lastError=msg;
this._emit("EVT:CHROMA_VAULT:ERROR",{id:this.id,where:String(where||"unknown"),error:msg,ts:Date.now()});
return null;
},
_clamp(n,a,b){
n=Number(n);
if(!isFinite(n))n=a;
if(n<a)n=a;
if(n>b)n=b;
return n;
},
_normId(s){
s=String(s||"").trim().toLowerCase();
s=s.replace(/[^a-z0-9_]+/g,"_").replace(/^_+|_+$/g,"");
return s||"color";
},
_hexOK(h){
h=String(h||"").trim();
if(!h)return false;
if(h[0]!=="#")return false;
if(!(h.length===4||h.length===7))return false;
return /^[#][0-9a-fA-F]+$/.test(h);
},
_rgba(hex,a){
try{
a=this._clamp(a,0,1);
hex=String(hex||"").trim();
if(!this._hexOK(hex))return "rgba(0,0,0,"+a+")";
var r=0,g=0,b=0;
if(hex.length===4){
r=parseInt(hex[1]+hex[1],16);
g=parseInt(hex[2]+hex[2],16);
b=parseInt(hex[3]+hex[3],16);
}else{
r=parseInt(hex.slice(1,3),16);
g=parseInt(hex.slice(3,5),16);
b=parseInt(hex.slice(5,7),16);
}
return "rgba("+r+","+g+","+b+","+a+")";
}catch(e){this._error("_rgba",e);return "rgba(0,0,0,"+a+")";}
},
_buildDefaultPalette(){
try{
var list=[
{ id:"toxic_green", name:"Toxic Green", hex:"#00FF66", role:["glow","accent","energy"] },
{ id:"neon_cyan", name:"Neon Cyan", hex:"#00E5FF", role:["glow","accent","tech"] },
{ id:"laser_pink", name:"Laser Pink", hex:"#FF2D95", role:["accent","warn","pulse"] },
{ id:"royal_purple", name:"Royal Purple", hex:"#8A2BE2", role:["accent","mystic"] },
{ id:"ember_orange", name:"Ember Orange", hex:"#FF6A00", role:["accent","heat"] },
{ id:"ion_yellow", name:"Ion Yellow", hex:"#FFE600", role:["accent","signal"] },
{ id:"steel_blue", name:"Steel Blue", hex:"#2E6BFF", role:["accent","calm"] },
{ id:"blood_red", name:"Blood Red", hex:"#FF0033", role:["danger","alert"] },
{ id:"ghost_white", name:"Ghost White", hex:"#EAF2FF", role:["text","clean"] },
{ id:"void_black", name:"Void Black", hex:"#000000", role:["base","bg"] }
];
this._setPalette(list,true);
}catch(e){this._error("_buildDefaultPalette",e);}
},
_setPalette(list,force){
try{
list=Array.isArray(list)?list:[];
var max=this._state.config.maxColors;
if(list.length>max)list=list.slice(0,max);
var byId={},out=[],i=0,it=null,id="",hex="",name="",role=null;
for(i=0;i<list.length;i++){
it=list[i]||{};
id=this._normId(it.id||it.name||("color_"+i));
if(byId[id])continue;
hex=String(it.hex||"").trim();
if(!this._hexOK(hex))continue;
name=String(it.name||id).trim()||id;
role=Array.isArray(it.role)?it.role:[];
byId[id]={id:id,name:name,hex:hex,role:role};
out.push(byId[id]);
}
if(!out.length&&!force)return;
this._state.palette.colors=out;
this._state.palette.byId=byId;
if(!this._state.binds.text||!byId[this._state.binds.text])this._state.binds.text=out[0]?out[0].id:"toxic_green";
if(!this._state.binds.glow||!byId[this._state.binds.glow])this._state.binds.glow=out[0]?out[0].id:"toxic_green";
}catch(e){this._error("_setPalette",e);}
},
mount(payload){
try{
payload=payload||{};
if(payload.config)this.setConfig(payload.config);
if(payload.palette&&Array.isArray(payload.palette))this._setPalette(payload.palette,false);
if(payload.binds)this._setBinds(payload.binds,false);
this._state.mounted=true;
this._emit("EVT:CHROMA_VAULT:MOUNTED",{id:this.id,state:this.snapshot().state,ts:Date.now()});
this._emit("EVT:CHROMA_VAULT:STATE",this.snapshot());
}catch(e){this._error("mount",e);}
},
enable(){
try{
this._state.enabled=true;
this._emit("EVT:CHROMA_VAULT:STATE",this.snapshot());
}catch(e){this._error("enable",e);}
},
disable(){
try{
this._state.enabled=false;
this._emit("EVT:CHROMA_VAULT:STATE",this.snapshot());
}catch(e){this._error("disable",e);}
},
setConfig(partial){
try{
partial=partial||{};
var c=this._state.config;
if(partial.glassAlpha!=null)c.glassAlpha=this._clamp(partial.glassAlpha,0,0.9);
if(partial.panelScrimAlpha!=null)c.panelScrimAlpha=this._clamp(partial.panelScrimAlpha,0,0.95);
if(partial.buttonGlassAlpha!=null)c.buttonGlassAlpha=this._clamp(partial.buttonGlassAlpha,0,0.9);
if(partial.glowIntensity!=null)c.glowIntensity=this._clamp(partial.glowIntensity,0,3);
if(partial.maxColors!=null)c.maxColors=this._clamp(partial.maxColors,16,256);
this._emit("EVT:CHROMA_VAULT:STATE",this.snapshot());
}catch(e){this._error("setConfig",e);}
},
_setBinds(binds,emit){
binds=binds||{};
var byId=this._state.palette.byId;
var t=binds.text!=null?this._normId(binds.text):null;
var g=binds.glow!=null?this._normId(binds.glow):null;
if(t&&byId[t])this._state.binds.text=t;
if(g&&byId[g])this._state.binds.glow=g;
if(emit)this._emit("EVT:CHROMA_VAULT:STATE",this.snapshot());
},
set(payload){
try{
payload=payload||{};
if(payload.config)this.setConfig(payload.config);
if(payload.palette&&Array.isArray(payload.palette))this._setPalette(payload.palette,false);
if(payload.binds)this._setBinds(payload.binds,true);
}catch(e){this._error("set",e);}
},
get(payload){
try{
payload=payload||{};
var key=String(payload.key||"").trim();
if(key==="binds")return this._emit("EVT:CHROMA_VAULT:GET",{id:this.id,key:key,value:this.binds(),ts:Date.now()});
if(key==="config")return this._emit("EVT:CHROMA_VAULT:GET",{id:this.id,key:key,value:this.config(),ts:Date.now()});
if(key==="palette")return this._emit("EVT:CHROMA_VAULT:GET",{id:this.id,key:key,value:{colors:this.list()},ts:Date.now()});
if(key==="theme")return this._emit("EVT:CHROMA_VAULT:GET",{id:this.id,key:key,value:this.themeTokens(),ts:Date.now()});
return this._emit("EVT:CHROMA_VAULT:GET",{id:this.id,key:key,value:null,ts:Date.now()});
}catch(e){this._error("get",e);}
},
list(){
try{return (this._state.palette.colors||[]).slice();}catch(e){this._error("list",e);return [];}
},
color(id){
try{
id=this._normId(id);
return this._state.palette.byId[id]||null;
}catch(e){this._error("color",e);return null;}
},
binds(){
return {text:this._state.binds.text,glow:this._state.binds.glow};
},
config(){
var c=this._state.config;
return {glassAlpha:c.glassAlpha,panelScrimAlpha:c.panelScrimAlpha,buttonGlassAlpha:c.buttonGlassAlpha,glowIntensity:c.glowIntensity,maxColors:c.maxColors};
},
themeTokens(){
try{
var t=this.color(this._state.binds.text),g=this.color(this._state.binds.glow);
var textHex=t?t.hex:"#00FF66",glowHex=g?g.hex:"#00FF66";
var c=this._state.config;
return {
textHex:textHex,
glowHex:glowHex,
panelGlass:"rgba(0,0,0,"+c.glassAlpha+")",
buttonGlass:"rgba(0,0,0,"+c.buttonGlassAlpha+")",
panelScrim:"rgba(0,0,0,"+c.panelScrimAlpha+")",
glowRGBA:this._rgba(glowHex,Math.min(1,0.55*c.glowIntensity)),
textRGBA:this._rgba(textHex,1)
};
}catch(e){this._error("themeTokens",e);return {textHex:"#00FF66",glowHex:"#00FF66",panelGlass:"rgba(0,0,0,0.22)",buttonGlass:"rgba(0,0,0,0.12)",panelScrim:"rgba(0,0,0,0.55)",glowRGBA:"rgba(0,255,102,0.55)",textRGBA:"rgba(0,255,102,1)"};}
},
snapshot(){
return {id:this.id,state:this._snapshotState(),ts:Date.now()};
},
_snapshotState(){
return {
enabled:this._state.enabled,
mounted:this._state.mounted,
lastError:this._state.lastError,
ts0:this._state.ts0,
config:this.config(),
palette:{count:(this._state.palette.colors||[]).length,colors:this.list()},
binds:this.binds(),
theme:this.themeTokens(),
device:{dpr:this._state.device.dpr,ua:this._state.device.ua}
};
},
status(){
return this.snapshot();
},
api:{
mount:function(p){return Engine_CHROMA_VAULT.mount(p);},
enable:function(){return Engine_CHROMA_VAULT.enable();},
disable:function(){return Engine_CHROMA_VAULT.disable();},
setConfig:function(p){return Engine_CHROMA_VAULT.setConfig(p);},
set:function(p){return Engine_CHROMA_VAULT.set(p);},
get:function(p){return Engine_CHROMA_VAULT.get(p);},
list:function(){return Engine_CHROMA_VAULT.list();},
color:function(id){return Engine_CHROMA_VAULT.color(id);},
binds:function(){return Engine_CHROMA_VAULT.binds();},
themeTokens:function(){return Engine_CHROMA_VAULT.themeTokens();},
snapshot:function(){return Engine_CHROMA_VAULT.snapshot();},
status:function(){return Engine_CHROMA_VAULT.status();}
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_CHROMA_VAULT.id]=Engine_CHROMA_VAULT;
/*-- üé®üßä-(31A)-(E)-(PALETTE-MASTER-ENGINE)-(CHROMA-VAULT)-(E)-(31A)-üßäüé® --*/
/*-- üé®üß¨-(32A)-(S)-(COLOR-REGISTRY-ENGINE)-(CHROMA-CORE)-(S)-(32A)-üß¨üé® --*/
const Engine_CHROMA_CORE={
id:"CHROMA_CORE",
_ctx:null,
_state:{
mounted:false,
active:{
text:"#00FF00",
glow:"#00FF00"
},
defaults:{
text:"#00FF00",
glow:"#00FF00"
},
presets:{},
mode:"preset" // preset | custom
},
init(ctx){
this._ctx=ctx||null;
if(!this._ctx||!this._ctx.bus)return this._error("init","missing_ctx_bus");
this._wire();
return this;
},
_wire(){
var b=this._ctx.bus,me=this;
b.on("REQ:CHROMA:MOUNT",function(p){me.mount(p);});
b.on("REQ:CHROMA:SET_TEXT",function(c){me.setText(c);});
b.on("REQ:CHROMA:SET_GLOW",function(c){me.setGlow(c);});
b.on("REQ:CHROMA:SET_MODE",function(m){me.setMode(m);});
b.on("REQ:CHROMA:RESET",function(){me.reset();});
b.on("REQ:CHROMA:STATUS",function(){me._emitState();});
},
_emit(ev,p){
try{this._ctx&&this._ctx.bus&&this._ctx.bus.emit(ev,p);}catch(e){this._error("_emit",e);}
},
_error(where,err){
var msg=(err&&err.message)?err.message:String(err||"error");
this._emit("EVT:CHROMA:ERROR",{where:String(where),error:msg,ts:Date.now()});
return null;
},
_validHex(c){
return typeof c==="string"&&/^#[0-9A-Fa-f]{6}$/.test(c);
},
mount(payload){
payload=payload||{};
if(payload.defaults){
if(this._validHex(payload.defaults.text))this._state.defaults.text=payload.defaults.text;
if(this._validHex(payload.defaults.glow))this._state.defaults.glow=payload.defaults.glow;
this._state.active.text=this._state.defaults.text;
this._state.active.glow=this._state.defaults.glow;
}
if(payload.presets)this._state.presets=payload.presets;
this._state.mounted=true;
this._emit("EVT:CHROMA:MOUNTED",{id:this.id,ts:Date.now()});
this._emitState();
},
setText(color){
if(!this._validHex(color))return;
this._state.active.text=color;
this._emitUpdate();
},
setGlow(color){
if(!this._validHex(color))return;
this._state.active.glow=color;
this._emitUpdate();
},
setMode(mode){
if(mode!=="preset"&&mode!=="custom")return;
this._state.mode=mode;
this._emitUpdate();
},
reset(){
this._state.active.text=this._state.defaults.text;
this._state.active.glow=this._state.defaults.glow;
this._state.mode="preset";
this._emitUpdate();
},
_emitUpdate(){
this._emit("EVT:CHROMA:UPDATE",{
id:this.id,
mode:this._state.mode,
text:this._state.active.text,
glow:this._state.active.glow,
derived:this._derive(),
ts:Date.now()
});
},
_derive(){
return{
background:this._mix(this._state.active.text,this._state.active.glow,0.35),
particles:[
this._state.active.text,
this._state.active.glow
]
};
},
_mix(a,b,r){
function h(c){return parseInt(c.replace("#",""),16);}
function x(n){return Math.max(0,Math.min(255,n));}
var A=h(a),B=h(b);
var ar=(A>>16)&255,ag=(A>>8)&255,ab=A&255;
var br=(B>>16)&255,bg=(B>>8)&255,bb=B&255;
var rr=x(ar+(br-ar)*r)|0;
var rg=x(ag+(bg-ag)*r)|0;
var rb=x(ab+(bb-ab)*r)|0;
return "#"+((1<<24)+(rr<<16)+(rg<<8)+rb).toString(16).slice(1).toUpperCase();
},
status(){
return{
id:this.id,
state:JSON.parse(JSON.stringify(this._state)),
ts:Date.now()
};
},
api:{
setText:function(c){return Engine_CHROMA_CORE.setText(c);},
setGlow:function(c){return Engine_CHROMA_CORE.setGlow(c);},
setMode:function(m){return Engine_CHROMA_CORE.setMode(m);},
reset:function(){return Engine_CHROMA_CORE.reset();},
status:function(){return Engine_CHROMA_CORE.status();}
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_CHROMA_CORE.id]=Engine_CHROMA_CORE;
/*-- üé®üß¨-(32A)-(E)-(COLOR-REGISTRY-ENGINE)-(CHROMA-CORE)-(E)-(32A)-üß¨üé® --*/
/*-- üé®üß¨-(33A)-(S)-(COLOR-PRESET-LIBRARY)-(CHROMA-ARCHIVE)-(S)-(33A)-üß¨üé® --*/
const Engine_CHROMA_ARCHIVE={
id:"CHROMA_ARCHIVE",
_ctx:null,
_state:{enabled:true,mounted:false,started:false,lastError:null,ts0:0,lastUpdate:0,config:{autoEnable:true},palette:[],groups:[],indexByName:{},indexByHex:{},selected:{text:null,glow:null}},
init(ctx){
this._ctx=ctx||null;
this._state.ts0=Date.now();
if(!this._ctx||!this._ctx.bus)return this._error("init","missing_ctx_bus");
this._buildPalette();
this._wire();
if(this._state.config.autoEnable)this.enable();
this._emit("EVT:CHROMA_ARCHIVE:READY",{id:this.id,ts:Date.now()});
this._emitState("EVT:CHROMA_ARCHIVE:STATE");
return this;
},
_wire(){
var b=this._ctx.bus,me=this;
b.on("REQ:CHROMA_ARCHIVE:MOUNT",function(p){me.mount(p);});
b.on("REQ:CHROMA_ARCHIVE:ENABLE",function(){me.enable();});
b.on("REQ:CHROMA_ARCHIVE:DISABLE",function(){me.disable();});
b.on("REQ:CHROMA_ARCHIVE:START",function(){me.start();});
b.on("REQ:CHROMA_ARCHIVE:STOP",function(){me.stop();});
b.on("REQ:CHROMA_ARCHIVE:LIST",function(p){me._emit("EVT:CHROMA_ARCHIVE:LIST",{id:me.id,palette:me.list(p),ts:Date.now()});});
b.on("REQ:CHROMA_ARCHIVE:GET",function(p){me._emit("EVT:CHROMA_ARCHIVE:GET",{id:me.id,color:me.get(p&&p.key),ts:Date.now()});});
b.on("REQ:CHROMA_ARCHIVE:SELECT",function(p){me.select(p);});
b.on("REQ:CHROMA_ARCHIVE:APPLY_TEXT",function(p){me.apply("text",p);});
b.on("REQ:CHROMA_ARCHIVE:APPLY_GLOW",function(p){me.apply("glow",p);});
b.on("REQ:CHROMA_ARCHIVE:STATUS",function(){me._emitState("EVT:CHROMA_ARCHIVE:STATE");});
},
_emit(ev,p){
try{this._ctx&&this._ctx.bus&&this._ctx.bus.emit(ev,p);}catch(e){this._error("_emit",e);}
},
_log(){
try{this._ctx&&this._ctx.log&&this._ctx.log.apply(this._ctx,arguments);}catch(e){}
},
_error(where,err){
var msg=(err&&err.message)?err.message:String(err||"error");
this._state.lastError=msg;
this._emit("EVT:CHROMA_ARCHIVE:ERROR",{id:this.id,where:String(where||"unknown"),error:msg,ts:Date.now()});
return null;
},
_clamp(n,a,b){
n=Number(n);
if(!isFinite(n))n=a;
if(n<a)n=a;
if(n>b)n=b;
return n;
},
_normKey(k){
k=(k==null)?"":String(k);
k=k.trim();
if(!k)return "";
return k;
},
_hexNorm(h){
h=(h==null)?"":String(h).trim();
if(!h)return "";
if(h[0]!=="#")h="#"+h;
return h.toUpperCase();
},
_buildPalette(){
try{
var P=[
{name:"NEON_GREEN",hex:"#00FF66",group:"NEON",tags:["neon","green"]},
{name:"NEON_CYAN",hex:"#00FFFF",group:"NEON",tags:["neon","cyan"]},
{name:"NEON_BLUE",hex:"#00A3FF",group:"NEON",tags:["neon","blue"]},
{name:"NEON_PURPLE",hex:"#B100FF",group:"NEON",tags:["neon","purple"]},
{name:"NEON_PINK",hex:"#FF00C8",group:"NEON",tags:["neon","pink"]},
{name:"NEON_RED",hex:"#FF0033",group:"NEON",tags:["neon","red"]},
{name:"NEON_ORANGE",hex:"#FF6A00",group:"NEON",tags:["neon","orange"]},
{name:"NEON_YELLOW",hex:"#FFF200",group:"NEON",tags:["neon","yellow"]},
{name:"NEON_LIME",hex:"#B6FF00",group:"NEON",tags:["neon","lime"]},
{name:"NEON_MINT",hex:"#00FFB2",group:"NEON",tags:["neon","mint"]},

{name:"MILITARY_OLIVE",hex:"#556B2F",group:"MILITARY",tags:["military","olive"]},
{name:"MILITARY_DRAB",hex:"#6B8E23",group:"MILITARY",tags:["military","drab"]},
{name:"MILITARY_FOREST",hex:"#0B3D2E",group:"MILITARY",tags:["military","forest"]},
{name:"MILITARY_RANGER",hex:"#3A5F0B",group:"MILITARY",tags:["military","ranger"]},
{name:"MILITARY_TAN",hex:"#C2B280",group:"MILITARY",tags:["military","tan"]},
{name:"MILITARY_KHAKI",hex:"#BDB76B",group:"MILITARY",tags:["military","khaki"]},
{name:"MILITARY_COYOTE",hex:"#81613C",group:"MILITARY",tags:["military","coyote"]},
{name:"MILITARY_OD_GREEN",hex:"#3C5A14",group:"MILITARY",tags:["military","od"]},
{name:"MILITARY_GUNMETAL",hex:"#2A3439",group:"MILITARY",tags:["military","metal"]},
{name:"MILITARY_STEEL",hex:"#4B5563",group:"MILITARY",tags:["military","steel"]},

{name:"CYBER_BLACK",hex:"#0A0D12",group:"CYBER",tags:["cyber","black"]},
{name:"CYBER_VOID",hex:"#05070B",group:"CYBER",tags:["cyber","void"]},
{name:"CYBER_SLATE",hex:"#111827",group:"CYBER",tags:["cyber","slate"]},
{name:"CYBER_INDIGO",hex:"#2D2A6E",group:"CYBER",tags:["cyber","indigo"]},
{name:"CYBER_VIOLET",hex:"#5B21B6",group:"CYBER",tags:["cyber","violet"]},
{name:"CYBER_MAGENTA",hex:"#A21CAF",group:"CYBER",tags:["cyber","magenta"]},
{name:"CYBER_TEAL",hex:"#0F766E",group:"CYBER",tags:["cyber","teal"]},
{name:"CYBER_AQUA",hex:"#06B6D4",group:"CYBER",tags:["cyber","aqua"]},
{name:"CYBER_AMBER",hex:"#F59E0B",group:"CYBER",tags:["cyber","amber"]},
{name:"CYBER_CRIMSON",hex:"#DC2626",group:"CYBER",tags:["cyber","crimson"]},

{name:"PASTEL_MINT",hex:"#B8F2E6",group:"PASTEL",tags:["pastel","mint"]},
{name:"PASTEL_SKY",hex:"#BDE0FE",group:"PASTEL",tags:["pastel","sky"]},
{name:"PASTEL_LAVENDER",hex:"#CDB4DB",group:"PASTEL",tags:["pastel","lavender"]},
{name:"PASTEL_PINK",hex:"#FFAFCC",group:"PASTEL",tags:["pastel","pink"]},
{name:"PASTEL_PEACH",hex:"#FFC8A2",group:"PASTEL",tags:["pastel","peach"]},
{name:"PASTEL_LEMON",hex:"#FDFFB6",group:"PASTEL",tags:["pastel","lemon"]},
{name:"PASTEL_SAGE",hex:"#D8E2DC",group:"PASTEL",tags:["pastel","sage"]},
{name:"PASTEL_ROSE",hex:"#FEC5BB",group:"PASTEL",tags:["pastel","rose"]},
{name:"PASTEL_CORAL",hex:"#FFB5A7",group:"PASTEL",tags:["pastel","coral"]},
{name:"PASTEL_BABYBLUE",hex:"#A2D2FF",group:"PASTEL",tags:["pastel","babyblue"]},

{name:"MONO_WHITE",hex:"#FFFFFF",group:"MONO",tags:["mono","white"]},
{name:"MONO_SNOW",hex:"#F8FAFC",group:"MONO",tags:["mono","snow"]},
{name:"MONO_SILVER",hex:"#CBD5E1",group:"MONO",tags:["mono","silver"]},
{name:"MONO_GRAY",hex:"#94A3B8",group:"MONO",tags:["mono","gray"]},
{name:"MONO_SLATE",hex:"#64748B",group:"MONO",tags:["mono","slate"]},
{name:"MONO_CHARCOAL",hex:"#334155",group:"MONO",tags:["mono","charcoal"]},
{name:"MONO_GUN",hex:"#1F2937",group:"MONO",tags:["mono","gun"]},
{name:"MONO_NIGHT",hex:"#0F172A",group:"MONO",tags:["mono","night"]},
{name:"MONO_INK",hex:"#0B1220",group:"MONO",tags:["mono","ink"]},
{name:"MONO_BLACK",hex:"#000000",group:"MONO",tags:["mono","black"]},

{name:"FIRE_RED",hex:"#FF1E1E",group:"ELEMENT",tags:["element","fire"]},
{name:"FIRE_ORANGE",hex:"#FF6D00",group:"ELEMENT",tags:["element","fire"]},
{name:"FIRE_AMBER",hex:"#FFB000",group:"ELEMENT",tags:["element","fire"]},
{name:"LAVA",hex:"#CF1020",group:"ELEMENT",tags:["element","lava"]},
{name:"EMBER",hex:"#FF3D00",group:"ELEMENT",tags:["element","ember"]},
{name:"SUN_GOLD",hex:"#FFD60A",group:"ELEMENT",tags:["element","sun"]},
{name:"WATER_BLUE",hex:"#0077FF",group:"ELEMENT",tags:["element","water"]},
{name:"WATER_CYAN",hex:"#00C2FF",group:"ELEMENT",tags:["element","water"]},
{name:"ICE",hex:"#AEEBFF",group:"ELEMENT",tags:["element","ice"]},
{name:"STORM",hex:"#7C3AED",group:"ELEMENT",tags:["element","storm"]},

{name:"TOXIC_LIME",hex:"#A3E635",group:"VIBE",tags:["vibe","toxic"]},
{name:"ACID_GREEN",hex:"#39FF14",group:"VIBE",tags:["vibe","acid"]},
{name:"PLASMA",hex:"#FF00FF",group:"VIBE",tags:["vibe","plasma"]},
{name:"RETRO_PURPLE",hex:"#7B2CBF",group:"VIBE",tags:["vibe","retro"]},
{name:"RETRO_TEAL",hex:"#14B8A6",group:"VIBE",tags:["vibe","retro"]},
{name:"RETRO_ORANGE",hex:"#FB8500",group:"VIBE",tags:["vibe","retro"]},
{name:"SYNTH_PINK",hex:"#FF4D6D",group:"VIBE",tags:["vibe","synth"]},
{name:"SYNTH_BLUE",hex:"#3A86FF",group:"VIBE",tags:["vibe","synth"]},
{name:"SYNTH_YELLOW",hex:"#FFBE0B",group:"VIBE",tags:["vibe","synth"]},
{name:"SYNTH_MINT",hex:"#2EC4B6",group:"VIBE",tags:["vibe","synth"]},

{name:"ROYAL_PURPLE",hex:"#6D28D9",group:"ROYAL",tags:["royal","purple"]},
{name:"ROYAL_BLUE",hex:"#1D4ED8",group:"ROYAL",tags:["royal","blue"]},
{name:"ROYAL_EMERALD",hex:"#059669",group:"ROYAL",tags:["royal","emerald"]},
{name:"ROYAL_RUBY",hex:"#BE123C",group:"ROYAL",tags:["royal","ruby"]},
{name:"ROYAL_GOLD",hex:"#D4AF37",group:"ROYAL",tags:["royal","gold"]},
{name:"ROYAL_SAPPHIRE",hex:"#0EA5E9",group:"ROYAL",tags:["royal","sapphire"]},
{name:"ROYAL_AMETHYST",hex:"#9333EA",group:"ROYAL",tags:["royal","amethyst"]},
{name:"ROYAL_OBSIDIAN",hex:"#111111",group:"ROYAL",tags:["royal","obsidian"]},
{name:"ROYAL_IVORY",hex:"#FFF8E7",group:"ROYAL",tags:["royal","ivory"]},
{name:"ROYAL_BRONZE",hex:"#CD7F32",group:"ROYAL",tags:["royal","bronze"]},

{name:"SPACE_BLACK",hex:"#030712",group:"SPACE",tags:["space","black"]},
{name:"SPACE_NAVY",hex:"#0B1B3A",group:"SPACE",tags:["space","navy"]},
{name:"SPACE_PURPLE",hex:"#2B1055",group:"SPACE",tags:["space","purple"]},
{name:"SPACE_NEULA",hex:"#4C1D95",group:"SPACE",tags:["space","nebula"]},
{name:"SPACE_AURORA",hex:"#00F5D4",group:"SPACE",tags:["space","aurora"]},
{name:"SPACE_STAR",hex:"#E5E7EB",group:"SPACE",tags:["space","star"]},
{name:"SPACE_MARS",hex:"#B91C1C",group:"SPACE",tags:["space","mars"]},
{name:"SPACE_SUNSET",hex:"#F97316",group:"SPACE",tags:["space","sunset"]},
{name:"SPACE_COMET",hex:"#38BDF8",group:"SPACE",tags:["space","comet"]},
{name:"SPACE_PLUTO",hex:"#64748B",group:"SPACE",tags:["space","pluto"]},

{name:"UI_SUCCESS",hex:"#22C55E",group:"UI",tags:["ui","success"]},
{name:"UI_WARNING",hex:"#F59E0B",group:"UI",tags:["ui","warning"]},
{name:"UI_DANGER",hex:"#EF4444",group:"UI",tags:["ui","danger"]},
{name:"UI_INFO",hex:"#3B82F6",group:"UI",tags:["ui","info"]},
{name:"UI_PRIMARY",hex:"#8B5CF6",group:"UI",tags:["ui","primary"]},
{name:"UI_SECONDARY",hex:"#06B6D4",group:"UI",tags:["ui","secondary"]},
{name:"UI_MUTED",hex:"#94A3B8",group:"UI",tags:["ui","muted"]},
{name:"UI_ACCENT",hex:"#F472B6",group:"UI",tags:["ui","accent"]},
{name:"UI_HIGHLIGHT",hex:"#FDE047",group:"UI",tags:["ui","highlight"]},
{name:"UI_INK",hex:"#0F172A",group:"UI",tags:["ui","ink"]}
];
this._state.palette=P;
this._state.groups=["NEON","MILITARY","CYBER","PASTEL","MONO","ELEMENT","VIBE","ROYAL","SPACE","UI"];
this._state.indexByName={};
this._state.indexByHex={};
var i=0,kk="",hh="";
for(i=0;i<P.length;i++){
kk=this._normKey(P[i].name).toUpperCase();
hh=this._hexNorm(P[i].hex);
if(kk)this._state.indexByName[kk]=i;
if(hh)this._state.indexByHex[hh]=i;
}
}catch(e){this._error("_buildPalette",e);}
},
mount(payload){
try{
payload=payload||{};
this._state.mounted=true;
this._emit("EVT:CHROMA_ARCHIVE:MOUNTED",{id:this.id,ts:Date.now()});
this._emitState("EVT:CHROMA_ARCHIVE:STATE");
}catch(e){this._error("mount",e);}
},
enable(){
try{
this._state.enabled=true;
this._emitState("EVT:CHROMA_ARCHIVE:STATE");
}catch(e){this._error("enable",e);}
},
disable(){
try{
this._state.enabled=false;
this._emitState("EVT:CHROMA_ARCHIVE:STATE");
}catch(e){this._error("disable",e);}
},
start(){
try{
this._state.started=true;
this._emit("EVT:CHROMA_ARCHIVE:STARTED",{id:this.id,ts:Date.now()});
this._emitState("EVT:CHROMA_ARCHIVE:STATE");
}catch(e){this._error("start",e);}
},
stop(){
try{
this._state.started=false;
this._emit("EVT:CHROMA_ARCHIVE:STOPPED",{id:this.id,ts:Date.now()});
this._emitState("EVT:CHROMA_ARCHIVE:STATE");
}catch(e){this._error("stop",e);}
},
list(payload){
try{
payload=payload||{};
var g=this._normKey(payload.group).toUpperCase(),q=this._normKey(payload.q).toLowerCase();
var P=this._state.palette,out=[],i=0,c=null,ok=true;
for(i=0;i<P.length;i++){
c=P[i];ok=true;
if(g&&String(c.group).toUpperCase()!==g)ok=false;
if(ok&&q){
if(String(c.name).toLowerCase().indexOf(q)===-1&&String(c.hex).toLowerCase().indexOf(q)===-1)ok=false;
}
if(ok)out.push(c);
}
return out;
}catch(e){this._error("list",e);return [];}
},
get(key){
try{
key=this._normKey(key);
if(!key)return null;
var k=key.toUpperCase(),h=this._hexNorm(key);
var idx=null;
if(this._state.indexByName[k]!=null)idx=this._state.indexByName[k];
else if(this._state.indexByHex[h]!=null)idx=this._state.indexByHex[h];
if(idx==null)return null;
return this._state.palette[idx]||null;
}catch(e){this._error("get",e);return null;}
},
select(payload){
try{
payload=payload||{};
var target=this._normKey(payload.target).toLowerCase();
if(target!=="text"&&target!=="glow")target="text";
var c=this.get(payload.key||payload.name||payload.hex);
if(!c&&payload.hex)c={name:"CUSTOM",hex:this._hexNorm(payload.hex),group:"CUSTOM",tags:["custom"]};
if(!c)return this._error("select","unknown_color");
this._state.selected[target]={name:c.name,hex:this._hexNorm(c.hex),group:c.group||"CUSTOM"};
this._emit("EVT:CHROMA_ARCHIVE:SELECTED",{id:this.id,target:target,color:this._state.selected[target],ts:Date.now()});
this._emitState("EVT:CHROMA_ARCHIVE:STATE");
return this._state.selected[target];
}catch(e){this._error("select",e);return null;}
},
apply(target,payload){
try{
payload=payload||{};
target=this._normKey(target).toLowerCase();
if(target!=="text"&&target!=="glow")target="text";
var sel=this.select({target:target,key:payload.key||payload.name||payload.hex,hex:payload.hex});
if(!sel)return null;
this._emit("EVT:CHROMA_ARCHIVE:APPLY",{id:this.id,target:target,color:sel,ts:Date.now()});
return sel;
}catch(e){this._error("apply",e);return null;}
},
_snapshotState(){
return {enabled:this._state.enabled,mounted:this._state.mounted,started:this._state.started,lastError:this._state.lastError,config:{autoEnable:this._state.config.autoEnable},groups:this._state.groups.slice(0),selected:{text:this._state.selected.text,glow:this._state.selected.glow},count:this._state.palette.length};
},
_emitState(ev){
this._state.lastUpdate=Date.now();
this._emit(ev||"EVT:CHROMA_ARCHIVE:STATE",{id:this.id,state:this._snapshotState(),ts:Date.now()});
},
status(){
return {id:this.id,state:this._snapshotState(),ts:Date.now()};
},
api:{
mount:function(p){return Engine_CHROMA_ARCHIVE.mount(p);},
enable:function(){return Engine_CHROMA_ARCHIVE.enable();},
disable:function(){return Engine_CHROMA_ARCHIVE.disable();},
start:function(){return Engine_CHROMA_ARCHIVE.start();},
stop:function(){return Engine_CHROMA_ARCHIVE.stop();},
list:function(p){return Engine_CHROMA_ARCHIVE.list(p);},
get:function(k){return Engine_CHROMA_ARCHIVE.get(k);},
select:function(p){return Engine_CHROMA_ARCHIVE.select(p);},
applyText:function(p){return Engine_CHROMA_ARCHIVE.apply("text",p||{});},
applyGlow:function(p){return Engine_CHROMA_ARCHIVE.apply("glow",p||{});},
status:function(){return Engine_CHROMA_ARCHIVE.status();}
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_CHROMA_ARCHIVE.id]=Engine_CHROMA_ARCHIVE;
/*-- üé®üß¨-(33A)-(E)-(COLOR-PRESET-LIBRARY)-(CHROMA-ARCHIVE)-(E)-(33A)-üß¨üé® --*/
/*-- üé®‚ö°-(34A)-(S)-(THEME-APPLY-BRIDGE)-(AURA-WEAVER)-(S)-(34A)-‚ö°üé® --*/
const Engine_AURA_WEAVER={
id:"AURA_WEAVER",
_ctx:null,
_state:{
enabled:true,
mounted:false,
lastError:null,
theme:{
text:"#00ff99",
glow:"#00ff99",
bg:"#000000"
}
},
init(ctx){
this._ctx=ctx||null;
if(!this._ctx||!this._ctx.bus)return this._error("init","missing_ctx_bus");
this._wire();
this.applyTheme(this._state.theme);
return this;
},
_wire(){
var b=this._ctx.bus,me=this;
b.on("EVT:COLOR:TEXT",function(c){me.setText(c);});
b.on("EVT:COLOR:GLOW",function(c){me.setGlow(c);});
b.on("REQ:AURA:APPLY",function(t){me.applyTheme(t);});
b.on("REQ:AURA:STATUS",function(){me._emitState();});
},
_emit(ev,p){
try{this._ctx.bus.emit(ev,p);}catch(e){this._error("_emit",e);}
},
_error(where,err){
var msg=(err&&err.message)?err.message:String(err||"error");
this._state.lastError=msg;
this._emit("EVT:AURA:ERROR",{id:this.id,where:where,error:msg,ts:Date.now()});
},
_setVar(k,v){
try{document.documentElement.style.setProperty(k,v);}catch(e){}
},
_applyCSS(){
this._setVar("--kog-text",this._state.theme.text);
this._setVar("--kog-glow",this._state.theme.glow);
this._setVar("--kog-bg",this._state.theme.bg);
},
_applyGlow(){
var g=this._state.theme.glow;
try{
document.querySelectorAll("[data-glow]").forEach(function(el){
el.style.boxShadow="0 0 12px "+g+", inset 0 0 8px "+g;
});
}catch(e){}
},
applyTheme(t){
try{
if(t){
if(t.text)this._state.theme.text=t.text;
if(t.glow)this._state.theme.glow=t.glow;
if(t.bg)this._state.theme.bg=t.bg;
}
this._applyCSS();
this._applyGlow();
this._emit("EVT:THEME:CHANGED",{theme:this._state.theme,ts:Date.now()});
}catch(e){this._error("applyTheme",e);}
},
setText(c){
if(!c)return;
this._state.theme.text=c;
this.applyTheme();
},
setGlow(c){
if(!c)return;
this._state.theme.glow=c;
this.applyTheme();
},
status(){
return{theme:this._state.theme,ts:Date.now()};
},
_emitState(){
this._emit("EVT:AURA:STATE",this.status());
},
api:{
apply:function(t){return Engine_AURA_WEAVER.applyTheme(t);},
setText:function(c){return Engine_AURA_WEAVER.setText(c);},
setGlow:function(c){return Engine_AURA_WEAVER.setGlow(c);},
status:function(){return Engine_AURA_WEAVER.status();}
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_AURA_WEAVER.id]=Engine_AURA_WEAVER;
/*-- üé®‚ö°-(34A)-(E)-(THEME-APPLY-BRIDGE)-(AURA-WEAVER)-(E)-(34A)-‚ö°üé® --*/
/*-- üéõÔ∏èüßæ-(35A)-(S)-(THEME-MENU-BINDER)-(PANEL-OVERLAY)-(S)-(35A)-üßæüéõÔ∏è --*/
const Engine_MENU_BINDER={
id:"MENU_BINDER",
_ctx:null,
_state:{
enabled:true,mounted:false,started:false,lastError:null,ts0:0,lastUpdate:0,
open:false,activeSection:"",
theme:{text:"#9CFF00",glow:"#00FFB7"},
config:{widthPct:0.75,zIndex:99990,topGapPx:0,bottomGapPx:0,lockScroll:true,fadeMs:120},
sections:[
{id:"TEXT",label:"TEXT COLOR",kind:"picker"},
{id:"GLOW",label:"GLOW COLOR",kind:"picker"},
{id:"BG",label:"BACKGROUND",kind:"options"},
{id:"PART",label:"PARTICLES",kind:"options"},
{id:"FONT",label:"FONTS",kind:"options"},
{id:"SFX",label:"SFX",kind:"options"},
{id:"ABOUT",label:"ABOUT",kind:"info"}
],
selected:{TEXT:"",GLOW:"",BG:"",PART:"",FONT:"",SFX:""},
dom:{root:null,veil:null,panel:null,head:null,title:null,close:null,body:null,scroller:null},
metrics:{lastResize:0,lastOpenTs:0}
},
init(ctx){
this._ctx=ctx||null;
this._state.ts0=Date.now();
if(!this._ctx||!this._ctx.bus)return this._error("init","missing_ctx_bus");
this._wire();
this._emit("EVT:MENU_BINDER:READY",{id:this.id,ts:Date.now()});
return this;
},
_wire(){
var b=this._ctx.bus,me=this;
b.on("REQ:MENU_BINDER:MOUNT",function(p){me.mount(p);});
b.on("REQ:MENU_BINDER:ENABLE",function(){me.enable();});
b.on("REQ:MENU_BINDER:DISABLE",function(){me.disable();});
b.on("REQ:MENU_BINDER:START",function(){me.start();});
b.on("REQ:MENU_BINDER:STOP",function(){me.stop();});
b.on("REQ:MENU_BINDER:OPEN",function(p){me.open(p);});
b.on("REQ:MENU_BINDER:CLOSE",function(){me.close();});
b.on("REQ:MENU_BINDER:TOGGLE",function(p){me.toggle(p);});
b.on("REQ:MENU_BINDER:SECTION",function(p){me.section(p);});
b.on("REQ:MENU_BINDER:THEME",function(p){me.setTheme(p);});
b.on("REQ:MENU_BINDER:CONFIG",function(p){me.setConfig(p);});
b.on("REQ:MENU_BINDER:STATUS",function(){me._emitState("EVT:MENU_BINDER:STATE");});
b.on("REQ:MENU_BINDER:SNAPSHOT",function(){me._emit("EVT:MENU_BINDER:SNAPSHOT",me.snapshot());});
},
_emit(ev,p){
try{this._ctx&&this._ctx.bus&&this._ctx.bus.emit(ev,p);}catch(e){this._error("_emit",e);}
},
_log(){
try{this._ctx&&this._ctx.log&&this._ctx.log.apply(this._ctx,arguments);}catch(e){}
},
_error(where,err){
var msg=(err&&err.message)?err.message:String(err||"error");
this._state.lastError=msg;
this._emit("EVT:MENU_BINDER:ERROR",{id:this.id,where:String(where||"unknown"),error:msg,ts:Date.now()});
return null;
},
_now(){
try{if(window.performance&&typeof performance.now==="function")return performance.now();}catch(e){}
return Date.now();
},
_clamp(n,a,b){
n=Number(n);
if(!isFinite(n))n=a;
if(n<a)n=a;
if(n>b)n=b;
return n;
},
_cssVar(name,fallback){
try{
var v=getComputedStyle(document.documentElement).getPropertyValue(name);
v=(v||"").trim();
return v||fallback;
}catch(e){return fallback;}
},
_hexOk(s){
s=String(s||"").trim();
if(!s)return "";
if(s[0]!=="#")return "";
if(!(s.length===4||s.length===7))return "";
return s;
},
_applyThemeToPanel(){
try{
var t=this._state.theme.text||this._cssVar("--kog-text","#9CFF00");
var g=this._state.theme.glow||this._cssVar("--kog-glow","#00FFB7");
this._state.theme.text=t;
this._state.theme.glow=g;
if(!this._state.dom.root)return;
this._state.dom.root.style.setProperty("--mb-text",t);
this._state.dom.root.style.setProperty("--mb-glow",g);
this._state.dom.root.style.setProperty("--mb-veil","rgba(0,0,0,0.62)");
this._state.dom.root.style.setProperty("--mb-panel","rgba(0,0,0,0.58)");
this._state.dom.root.style.setProperty("--mb-panel2","rgba(0,0,0,0.34)");
}catch(e){this._error("_applyThemeToPanel",e);}
},
_build(){
try{
if(this._state.dom.root)return;
var root=document.createElement("div");
root.setAttribute("data-kog","MENU_BINDER");
root.style.position="fixed";
root.style.left="0";
root.style.top="0";
root.style.width="100vw";
root.style.height="100vh";
root.style.zIndex=String(this._state.config.zIndex||99990);
root.style.pointerEvents="none";
root.style.opacity="0";
root.style.transition="opacity "+String(this._state.config.fadeMs||120)+"ms linear";
root.style.setProperty("--mb-text",this._state.theme.text);
root.style.setProperty("--mb-glow",this._state.theme.glow);
root.style.setProperty("--mb-veil","rgba(0,0,0,0.62)");
root.style.setProperty("--mb-panel","rgba(0,0,0,0.58)");
root.style.setProperty("--mb-panel2","rgba(0,0,0,0.34)");

var veil=document.createElement("div");
veil.style.position="absolute";
veil.style.left="0";
veil.style.top="0";
veil.style.width="100%";
veil.style.height="100%";
veil.style.background="var(--mb-veil)";
veil.style.backdropFilter="blur(6px)";
veil.style.webkitBackdropFilter="blur(6px)";
veil.style.pointerEvents="auto";

var panel=document.createElement("div");
panel.style.position="absolute";
panel.style.left="50%";
panel.style.transform="translateX(-50%)";
panel.style.width="calc("+String(Math.round(this._state.config.widthPct*100))+"vw - 10px)";
panel.style.maxWidth="980px";
panel.style.minWidth="260px";
panel.style.border="2px solid var(--mb-glow)";
panel.style.boxShadow="0 0 16px var(--mb-glow)";
panel.style.borderRadius="16px";
panel.style.background="linear-gradient(180deg,var(--mb-panel),var(--mb-panel2))";
panel.style.pointerEvents="auto";
panel.style.overflow="hidden";

var head=document.createElement("div");
head.style.display="flex";
head.style.alignItems="center";
head.style.justifyContent="space-between";
head.style.gap="10px";
head.style.padding="10px 12px";
head.style.borderBottom="1px solid rgba(255,255,255,0.10)";
head.style.background="rgba(0,0,0,0.35)";

var title=document.createElement("div");
title.textContent="SETTINGS";
title.style.fontFamily="monospace";
title.style.fontSize="16px";
title.style.letterSpacing="1px";
title.style.color="var(--mb-text)";
title.style.textShadow="0 0 10px var(--mb-glow)";

var close=document.createElement("button");
close.type="button";
close.textContent="‚úï";
close.style.width="40px";
close.style.height="34px";
close.style.borderRadius="10px";
close.style.border="1px solid var(--mb-glow)";
close.style.background="transparent";
close.style.color="var(--mb-text)";
close.style.boxShadow="0 0 10px var(--mb-glow)";
close.style.cursor="pointer";
close.style.fontSize="16px";
close.onclick=this._onClose.bind(this);

var body=document.createElement("div");
body.style.display="block";
body.style.height="100%";

var scroller=document.createElement("div");
scroller.style.maxHeight="60vh";
scroller.style.overflow="auto";
scroller.style.padding="10px 10px 12px 10px";
scroller.style.background="transparent";
scroller.style.scrollbarWidth="thin";
scroller.style.scrollbarColor="var(--mb-glow) transparent";

head.appendChild(title);
head.appendChild(close);
body.appendChild(scroller);
panel.appendChild(head);
panel.appendChild(body);
root.appendChild(veil);
root.appendChild(panel);
document.body.appendChild(root);

veil.addEventListener("click",this._onVeil.bind(this),{passive:true});
window.addEventListener("resize",this._onResize.bind(this),{passive:true});
document.addEventListener("keydown",this._onKey.bind(this),{passive:false});

this._state.dom.root=root;
this._state.dom.veil=veil;
this._state.dom.panel=panel;
this._state.dom.head=head;
this._state.dom.title=title;
this._state.dom.close=close;
this._state.dom.body=body;
this._state.dom.scroller=scroller;

this._layout();
this._renderSections();
this._applyThemeToPanel();
}catch(e){this._error("_build",e);}
},
_layout(){
try{
if(!this._state.dom.panel)return;
var top=this._state.config.topGapPx||0;
var bottom=this._state.config.bottomGapPx||0;
var h=window.innerHeight||0;
var y=Math.max(10,Math.round((h*0.10)+top));
var maxH=Math.max(240,Math.round(h-(y+10+bottom)));
this._state.dom.panel.style.top=String(y)+"px";
this._state.dom.panel.style.maxHeight=String(maxH)+"px";
if(this._state.dom.scroller)this._state.dom.scroller.style.maxHeight=String(Math.max(200,maxH-64))+"px";
}catch(e){this._error("_layout",e);}
},
_lockScroll(on){
try{
if(!this._state.config.lockScroll)return;
var b=document.body;
if(!b)return;
if(on){
if(!b.hasAttribute("data-mb-lock")){
b.setAttribute("data-mb-lock","1");
b.setAttribute("data-mb-prev-overflow",b.style.overflow||"");
b.style.overflow="hidden";
}
}else{
if(b.hasAttribute("data-mb-lock")){
var prev=b.getAttribute("data-mb-prev-overflow")||"";
b.style.overflow=prev;
b.removeAttribute("data-mb-prev-overflow");
b.removeAttribute("data-mb-lock");
}
}
}catch(e){this._error("_lockScroll",e);}
},
_onVeil(e){
try{if(!this._state.open)return;this.close();}catch(err){this._error("_onVeil",err);}
},
_onClose(e){
try{if(e&&e.preventDefault)e.preventDefault();this.close();}catch(err){this._error("_onClose",err);}
},
_onKey(e){
try{
if(!this._state.open)return;
var k=e&&e.key?String(e.key):"";
if(k==="Escape"){e.preventDefault();this.close();return;}
}catch(err){this._error("_onKey",err);}
},
_onResize(){
try{
var now=Date.now();
if(now-this._state.metrics.lastResize<60)return;
this._state.metrics.lastResize=now;
this._layout();
}catch(err){this._error("_onResize",err);}
},
_btnBase(){
return "display:flex;align-items:center;justify-content:space-between;gap:10px;width:100%;padding:10px 12px;border-radius:14px;border:1px solid var(--mb-glow);background:transparent;color:var(--mb-text);box-shadow:0 0 10px var(--mb-glow);cursor:pointer;font-family:monospace;font-size:14px;letter-spacing:0.5px;user-select:none;";
},
_btnActive(){
return "background:var(--mb-text);color:#000;border-color:var(--mb-text);box-shadow:0 0 14px var(--mb-text);";
},
_rowWrap(){
return "display:flex;flex-direction:column;gap:8px;margin:10px 0 12px 0;";
},
_card(){
return "border:1px solid rgba(255,255,255,0.12);border-radius:14px;padding:10px 10px 12px 10px;background:rgba(0,0,0,0.22);";
},
_label(){
return "font-family:monospace;font-size:12px;letter-spacing:0.6px;color:var(--mb-text);opacity:0.95;text-shadow:0 0 10px var(--mb-glow);";
},
_mini(){
return "font-family:monospace;font-size:12px;color:rgba(255,255,255,0.75);";
},
_renderSections(){
try{
if(!this._state.dom.scroller)return;
var s=this._state.dom.scroller;
s.innerHTML="";
var i=0,sec=null;
for(i=0;i<this._state.sections.length;i++){
sec=this._state.sections[i];
s.appendChild(this._makeSection(sec));
}
}catch(e){this._error("_renderSections",e);}
},
_makeSection(sec){
var wrap=document.createElement("div");
wrap.style.cssText=this._card();

var btn=document.createElement("button");
btn.type="button";
btn.setAttribute("data-sec",sec.id);
btn.style.cssText=this._btnBase();
btn.onclick=this._onSection.bind(this);

var left=document.createElement("div");
left.textContent=sec.label;

var right=document.createElement("div");
right.textContent="‚ñæ";
right.style.opacity="0.8";

btn.appendChild(left);
btn.appendChild(right);

var body=document.createElement("div");
body.setAttribute("data-sec-body",sec.id);
body.style.display="none";
body.style.marginTop="10px";
body.style.cssText=body.style.cssText+";"+this._rowWrap();

var content=this._makeSectionBody(sec);
body.appendChild(content);

wrap.appendChild(btn);
wrap.appendChild(body);
return wrap;
},
_makeSectionBody(sec){
var box=document.createElement("div");
box.style.display="flex";
box.style.flexDirection="column";
box.style.gap="10px";

var a=document.createElement("div");
a.style.cssText=this._label();
a.textContent="LIVE PREVIEW ‚Ä¢ TAP OPTIONS";
box.appendChild(a);

if(sec.kind==="picker"){
box.appendChild(this._makePickerStub(sec.id));
return box;
}

if(sec.kind==="info"){
var t=document.createElement("div");
t.style.cssText=this._mini();
t.innerHTML="‚Ä¢ Menu overlay is isolated (you see the background/particles, not the app behind).<br>‚Ä¢ Buttons are transparent with glow borders.<br>‚Ä¢ Selected buttons invert (text becomes background).";
box.appendChild(t);
return box;
}

var note=document.createElement("div");
note.style.cssText=this._mini();
note.textContent="(Hook point) This section will populate from engines later: presets, fonts, sfx, particles, etc.";
box.appendChild(note);

var demo=document.createElement("button");
demo.type="button";
demo.textContent="EMIT TEST SELECT";
demo.style.cssText=this._btnBase();
demo.onclick=this._onDemoSelect.bind(this,sec.id);
box.appendChild(demo);

return box;
},
_makePickerStub(kind){
var wrap=document.createElement("div");
wrap.style.display="flex";
wrap.style.flexDirection="column";
wrap.style.gap="10px";

var row=document.createElement("div");
row.style.display="flex";
row.style.gap="10px";
row.style.flexWrap="wrap";
row.style.alignItems="center";

var lab=document.createElement("div");
lab.style.cssText=this._mini();
lab.textContent=(kind==="TEXT")?"Text =":"Glow =";

var input=document.createElement("input");
input.type="text";
input.placeholder="#RRGGBB";
input.value=(kind==="TEXT")?this._state.theme.text:this._state.theme.glow;
input.style.flex="1";
input.style.minWidth="160px";
input.style.padding="10px 12px";
input.style.borderRadius="12px";
input.style.border="1px solid var(--mb-glow)";
input.style.background="rgba(0,0,0,0.18)";
input.style.color="var(--mb-text)";
input.style.boxShadow="0 0 10px var(--mb-glow)";
input.style.fontFamily="monospace";
input.style.fontSize="14px";
input.onchange=this._onHexInput.bind(this,kind,input);
input.oninput=this._onHexLive.bind(this,kind,input);

var apply=document.createElement("button");
apply.type="button";
apply.textContent="APPLY";
apply.style.cssText=this._btnBase()+"width:auto;min-width:110px;";
apply.onclick=this._onApplyHex.bind(this,kind,input);

var def=document.createElement("button");
def.type="button";
def.textContent="DEFAULT";
def.style.cssText=this._btnBase()+"width:auto;min-width:110px;";
def.onclick=this._onDefault.bind(this,kind,input);

row.appendChild(lab);
row.appendChild(input);
row.appendChild(apply);
row.appendChild(def);

var wheel=document.createElement("div");
wheel.setAttribute("data-wheel",kind);
wheel.style.width="100%";
wheel.style.height="140px";
wheel.style.borderRadius="18px";
wheel.style.border="1px solid rgba(255,255,255,0.12)";
wheel.style.boxShadow="0 0 12px rgba(0,0,0,0.55) inset, 0 0 10px var(--mb-glow)";
wheel.style.background="radial-gradient(circle at 50% 50%, rgba(255,255,255,0.05), rgba(0,0,0,0.20) 45%, rgba(0,0,0,0.45) 100%), conic-gradient(from 0deg, #ff004c, #ff9c00, #e6ff00, #00ff6a, #00fff0, #0076ff, #a000ff, #ff00d8, #ff004c)";
wheel.style.cursor="crosshair";
wheel.style.position="relative";
wheel.onpointerdown=this._onWheelDown.bind(this,kind,wheel,input);

var dot=document.createElement("div");
dot.setAttribute("data-dot",kind);
dot.style.width="18px";
dot.style.height="18px";
dot.style.borderRadius="999px";
dot.style.border="2px solid #000";
dot.style.boxShadow="0 0 12px rgba(255,255,255,0.25), 0 0 12px var(--mb-glow)";
dot.style.background="var(--mb-text)";
dot.style.position="absolute";
dot.style.left="calc(50% - 9px)";
dot.style.top="calc(50% - 9px)";
wheel.appendChild(dot);

wrap.appendChild(row);
wrap.appendChild(wheel);
return wrap;
},
_onSection(e){
try{
var b=e&&e.currentTarget?e.currentTarget:null;
if(!b)return;
var id=b.getAttribute("data-sec")||"";
this._toggleSection(id);
}catch(err){this._error("_onSection",err);}
},
_toggleSection(id){
try{
id=String(id||"");
if(!id||!this._state.dom.scroller)return;
var active=this._state.activeSection||"";
var next=(active===id)?"":id;
this._state.activeSection=next;

var bodies=this._state.dom.scroller.querySelectorAll("[data-sec-body]");
var i=0,el=null,secId="";
for(i=0;i<bodies.length;i++){
el=bodies[i];
secId=el.getAttribute("data-sec-body")||"";
el.style.display=(secId===next)?"flex":"none";
}

var btns=this._state.dom.scroller.querySelectorAll("button[data-sec]");
for(i=0;i<btns.length;i++){
el=btns[i];
secId=el.getAttribute("data-sec")||"";
if(secId===next)el.style.cssText=this._btnBase()+this._btnActive();
else el.style.cssText=this._btnBase();
}

this._emitState("EVT:MENU_BINDER:STATE");
}catch(e){this._error("_toggleSection",e);}
},
_onDemoSelect(secId){
try{
var payload={id:this.id,section:String(secId||""),value:"demo",ts:Date.now()};
this._emit("EVT:MENU_BINDER:SELECT",payload);
}catch(e){this._error("_onDemoSelect",e);}
},
_onHexInput(kind,input){
try{this._applyHex(kind,input&&input.value?input.value:"",false);}catch(e){this._error("_onHexInput",e);}
},
_onHexLive(kind,input){
try{this._applyHex(kind,input&&input.value?input.value:"",true);}catch(e){this._error("_onHexLive",e);}
},
_onApplyHex(kind,input){
try{this._applyHex(kind,input&&input.value?input.value:"",false,true);}catch(e){this._error("_onApplyHex",e);}
},
_onDefault(kind,input){
try{
var def=(kind==="TEXT")?"#9CFF00":"#00FFB7";
if(input)input.value=def;
this._applyHex(kind,def,false,true,true);
}catch(e){this._error("_onDefault",e);}
},
_applyHex(kind,val,live,emit,forceDefault){
try{
kind=String(kind||"");
val=this._hexOk(val);
if(!val)return;
if(kind==="TEXT")this._state.theme.text=val;
if(kind==="GLOW")this._state.theme.glow=val;
this._applyThemeToPanel();
this._emit("EVT:MENU_BINDER:THEME_PREVIEW",{id:this.id,kind:kind,value:val,live:!!live,ts:Date.now()});
if(emit){
this._emit("EVT:MENU_BINDER:THEME_COMMIT",{id:this.id,kind:kind,value:val,default:!!forceDefault,ts:Date.now()});
}
this._emitState("EVT:MENU_BINDER:STATE");
}catch(e){this._error("_applyHex",e);}
},
_rgbToHex(r,g,b){
r=this._clamp(r,0,255)|0;
g=this._clamp(g,0,255)|0;
b=this._clamp(b,0,255)|0;
var s=((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1);
return "#"+s.toUpperCase();
},
_hsvToRgb(h,s,v){
h=(h%1+1)%1;
s=this._clamp(s,0,1);
v=this._clamp(v,0,1);
var i=Math.floor(h*6);
var f=h*6-i;
var p=v*(1-s);
var q=v*(1-f*s);
var t=v*(1-(1-f)*s);
var r=0,g=0,b=0;
if(i===0){r=v;g=t;b=p;}
else if(i===1){r=q;g=v;b=p;}
else if(i===2){r=p;g=v;b=t;}
else if(i===3){r=p;g=q;b=v;}
else if(i===4){r=t;g=p;b=v;}
else{r=v;g=p;b=q;}
return {r:Math.round(r*255),g:Math.round(g*255),b:Math.round(b*255)};
},
_onWheelDown(kind,wheel,input,e){
try{
if(!wheel||!e)return;
e.preventDefault();
wheel.setPointerCapture&&wheel.setPointerCapture(e.pointerId);
this._wheelMove(kind,wheel,input,e);
var me=this;
var up=function(ev){
try{
wheel.removeEventListener("pointermove",mv);
wheel.removeEventListener("pointerup",up);
wheel.removeEventListener("pointercancel",up);
me._emit("EVT:MENU_BINDER:THEME_COMMIT",{id:me.id,kind:String(kind||""),value:(kind==="TEXT")?me._state.theme.text:me._state.theme.glow,default:false,ts:Date.now()});
}catch(err){me._error("_wheelUp",err);}
};
var mv=function(ev){me._wheelMove(kind,wheel,input,ev);};
wheel.addEventListener("pointermove",mv,{passive:false});
wheel.addEventListener("pointerup",up,{passive:true});
wheel.addEventListener("pointercancel",up,{passive:true});
}catch(err){this._error("_onWheelDown",err);}
},
_wheelMove(kind,wheel,input,e){
try{
if(!wheel||!e)return;
var r=wheel.getBoundingClientRect();
var x=this._clamp((e.clientX-r.left)/Math.max(1,r.width),0,1);
var y=this._clamp((e.clientY-r.top)/Math.max(1,r.height),0,1);
var h=x;
var s=1.0;
var v=this._clamp(1.0-(y*0.65),0.35,1.0);
var rgb=this._hsvToRgb(h,s,v);
var hex=this._rgbToHex(rgb.r,rgb.g,rgb.b);
if(input)input.value=hex;
this._applyHex(kind,hex,true,false);

var dot=wheel.querySelector("[data-dot]");
if(dot){
dot.style.left="calc("+(x*100).toFixed(2)+"% - 9px)";
dot.style.top="calc("+(y*100).toFixed(2)+"% - 9px)";
dot.style.background=(kind==="TEXT")?this._state.theme.text:this._state.theme.glow;
}
}catch(err){this._error("_wheelMove",err);}
},
mount(payload){
try{
payload=payload||{};
if(payload.config)this.setConfig(payload.config);
if(payload.theme)this.setTheme(payload.theme);
this._build();
this._state.mounted=true;
this._emit("EVT:MENU_BINDER:MOUNTED",{id:this.id,ts:Date.now()});
this._emitState("EVT:MENU_BINDER:STATE");
}catch(e){this._error("mount",e);}
},
enable(){
try{
this._state.enabled=true;
this._emitState("EVT:MENU_BINDER:STATE");
}catch(e){this._error("enable",e);}
},
disable(){
try{
this.close();
this._state.enabled=false;
this._emitState("EVT:MENU_BINDER:STATE");
}catch(e){this._error("disable",e);}
},
start(){
try{
if(!this._state.mounted)this.mount({});
this._state.started=true;
this._emit("EVT:MENU_BINDER:STARTED",{id:this.id,ts:Date.now()});
this._emitState("EVT:MENU_BINDER:STATE");
}catch(e){this._error("start",e);}
},
stop(){
try{
this.close();
this._state.started=false;
this._emit("EVT:MENU_BINDER:STOPPED",{id:this.id,ts:Date.now()});
this._emitState("EVT:MENU_BINDER:STATE");
}catch(e){this._error("stop",e);}
},
setConfig(partial){
try{
partial=partial||{};
var c=this._state.config;
if(partial.widthPct!=null)c.widthPct=this._clamp(partial.widthPct,0.45,0.95);
if(partial.zIndex!=null)c.zIndex=this._clamp(partial.zIndex,1000,999999);
if(partial.topGapPx!=null)c.topGapPx=this._clamp(partial.topGapPx,0,500);
if(partial.bottomGapPx!=null)c.bottomGapPx=this._clamp(partial.bottomGapPx,0,500);
if(partial.lockScroll!=null)c.lockScroll=!!partial.lockScroll;
if(partial.fadeMs!=null)c.fadeMs=this._clamp(partial.fadeMs,0,800);
if(this._state.dom.root){
this._state.dom.root.style.zIndex=String(c.zIndex);
this._state.dom.root.style.transition="opacity "+String(c.fadeMs)+"ms linear";
this._layout();
}
this._emitState("EVT:MENU_BINDER:STATE");
}catch(e){this._error("setConfig",e);}
},
setTheme(payload){
try{
payload=payload||{};
var t=this._hexOk(payload.text)||this._hexOk(payload.TEXT)||"";
var g=this._hexOk(payload.glow)||this._hexOk(payload.GLOW)||"";
if(t)this._state.theme.text=t;
if(g)this._state.theme.glow=g;
this._applyThemeToPanel();
this._emit("EVT:MENU_BINDER:THEME_SYNC",{id:this.id,theme:{text:this._state.theme.text,glow:this._state.theme.glow},ts:Date.now()});
this._emitState("EVT:MENU_BINDER:STATE");
}catch(e){this._error("setTheme",e);}
},
open(payload){
try{
payload=payload||{};
if(!this._state.enabled)return;
if(!this._state.mounted)this.mount({});
if(!this._state.started)this.start();
if(payload.section)this._state.activeSection=String(payload.section||"");
this._applyThemeToPanel();
this._layout();
this._lockScroll(true);
this._state.open=true;
this._state.metrics.lastOpenTs=Date.now();
if(this._state.dom.root){
this._state.dom.root.style.pointerEvents="auto";
this._state.dom.root.style.opacity="1";
}
if(this._state.activeSection)this._toggleSection(this._state.activeSection);
this._emit("EVT:MENU_BINDER:OPENED",{id:this.id,ts:Date.now()});
this._emitState("EVT:MENU_BINDER:STATE");
}catch(e){this._error("open",e);}
},
close(){
try{
if(!this._state.open)return;
this._state.open=false;
this._lockScroll(false);
if(this._state.dom.root){
this._state.dom.root.style.opacity="0";
this._state.dom.root.style.pointerEvents="none";
}
this._emit("EVT:MENU_BINDER:CLOSED",{id:this.id,ts:Date.now()});
this._emitState("EVT:MENU_BINDER:STATE");
}catch(e){this._error("close",e);}
},
toggle(payload){
try{
if(this._state.open)this.close();
else this.open(payload||{});
}catch(e){this._error("toggle",e);}
},
section(payload){
try{
payload=payload||{};
var id=String(payload.id||payload.section||"");
if(!id)return;
this._toggleSection(id);
}catch(e){this._error("section",e);}
},
snapshot(){
return {id:this.id,state:this._snapshotState(),ts:Date.now()};
},
_snapshotState(){
return {
enabled:this._state.enabled,mounted:this._state.mounted,started:this._state.started,
open:this._state.open,activeSection:this._state.activeSection,
theme:{text:this._state.theme.text,glow:this._state.theme.glow},
config:{widthPct:this._state.config.widthPct,zIndex:this._state.config.zIndex,topGapPx:this._state.config.topGapPx,bottomGapPx:this._state.config.bottomGapPx,lockScroll:this._state.config.lockScroll,fadeMs:this._state.config.fadeMs},
lastError:this._state.lastError
};
},
_emitState(ev){
this._emit(ev||"EVT:MENU_BINDER:STATE",{id:this.id,state:this._snapshotState(),ts:Date.now()});
},
status(){
return this.snapshot();
},
api:{
mount:function(p){return Engine_MENU_BINDER.mount(p);},
enable:function(){return Engine_MENU_BINDER.enable();},
disable:function(){return Engine_MENU_BINDER.disable();},
start:function(){return Engine_MENU_BINDER.start();},
stop:function(){return Engine_MENU_BINDER.stop();},
open:function(p){return Engine_MENU_BINDER.open(p);},
close:function(){return Engine_MENU_BINDER.close();},
toggle:function(p){return Engine_MENU_BINDER.toggle(p);},
section:function(p){return Engine_MENU_BINDER.section(p);},
setTheme:function(p){return Engine_MENU_BINDER.setTheme(p);},
setConfig:function(p){return Engine_MENU_BINDER.setConfig(p);},
snapshot:function(){return Engine_MENU_BINDER.snapshot();},
status:function(){return Engine_MENU_BINDER.status();}
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_MENU_BINDER.id]=Engine_MENU_BINDER;
/*-- üéõÔ∏èüßæ-(35A)-(E)-(THEME-MENU-BINDER)-(PANEL-OVERLAY)-(E)-(35A)-üßæüéõÔ∏è --*/
/*-- üéÜüß¨-(36A)-(S)-(PARTICLE-THEME-SYNC)-(DUAL-TONE-DRIVER)-(S)-(36A)-üß¨üéÜ --*/
const Engine_PARTICLE_SYNC={
id:"PARTICLE_SYNC",
_ctx:null,
_state:{
enabled:true,mounted:false,started:false,lastError:null,ts0:0,lastUpdate:0,
theme:{text:"#9CFF00",glow:"#00FFB7"},
config:{
autoEnable:true,
autoStart:true,
targetSelector:"[data-kog='PARTICLE_FIELD'],canvas[data-kog='PARTICLE_FIELD']",
useCssVars:true,
cssTextVar:"--kog-text",
cssGlowVar:"--kog-glow",
emitPreview:true,
emitCommit:true
},
lastApplied:{text:"",glow:""}
},
init(ctx){
this._ctx=ctx||null;
this._state.ts0=Date.now();
if(!this._ctx||!this._ctx.bus)return this._error("init","missing_ctx_bus");
this._wire();
if(this._state.config.autoEnable)this.enable();
this._emit("EVT:PARTICLE_SYNC:READY",{id:this.id,ts:Date.now()});
return this;
},
_wire(){
var b=this._ctx.bus,me=this;
b.on("REQ:PARTICLE_SYNC:MOUNT",function(p){me.mount(p);});
b.on("REQ:PARTICLE_SYNC:ENABLE",function(){me.enable();});
b.on("REQ:PARTICLE_SYNC:DISABLE",function(){me.disable();});
b.on("REQ:PARTICLE_SYNC:START",function(){me.start();});
b.on("REQ:PARTICLE_SYNC:STOP",function(){me.stop();});
b.on("REQ:PARTICLE_SYNC:THEME",function(p){me.setTheme(p);});
b.on("REQ:PARTICLE_SYNC:CONFIG",function(p){me.setConfig(p);});
b.on("REQ:PARTICLE_SYNC:APPLY",function(p){me.apply(p);});
b.on("REQ:PARTICLE_SYNC:STATUS",function(){me._emitState("EVT:PARTICLE_SYNC:STATE");});
b.on("EVT:THEME_APPLY:PREVIEW",function(p){me._onThemePreview(p);});
b.on("EVT:THEME_APPLY:CHANGED",function(p){me._onThemeCommit(p);});
b.on("EVT:MENU_BINDER:THEME_PREVIEW",function(p){me._onBinderPreview(p);});
b.on("EVT:MENU_BINDER:THEME_COMMIT",function(p){me._onBinderCommit(p);});
},
_emit(ev,p){
try{this._ctx&&this._ctx.bus&&this._ctx.bus.emit(ev,p);}catch(e){this._error("_emit",e);}
},
_log(){
try{this._ctx&&this._ctx.log&&this._ctx.log.apply(this._ctx,arguments);}catch(e){}
},
_error(where,err){
var msg=(err&&err.message)?err.message:String(err||"error");
this._state.lastError=msg;
this._emit("EVT:PARTICLE_SYNC:ERROR",{id:this.id,where:String(where||"unknown"),error:msg,ts:Date.now()});
return null;
},
_clamp(n,a,b){
n=Number(n);
if(!isFinite(n))n=a;
if(n<a)n=a;
if(n>b)n=b;
return n;
},
_hexOk(s){
s=String(s||"").trim();
if(!s)return "";
if(s[0]!=="#")return "";
if(!(s.length===4||s.length===7))return "";
return s;
},
_cssVar(name,fallback){
try{
var v=getComputedStyle(document.documentElement).getPropertyValue(name);
v=(v||"").trim();
return v||fallback;
}catch(e){return fallback;}
},
_pickThemeFromPayload(p){
p=p||{};
var t=this._hexOk(p.text)||this._hexOk(p.TEXT)||this._hexOk(p.primary)||"";
var g=this._hexOk(p.glow)||this._hexOk(p.GLOW)||this._hexOk(p.secondary)||"";
if(!t&&this._state.config.useCssVars)t=this._cssVar(this._state.config.cssTextVar,"");
if(!g&&this._state.config.useCssVars)g=this._cssVar(this._state.config.cssGlowVar,"");
t=t||this._state.theme.text;
g=g||this._state.theme.glow;
return {text:t,glow:g};
},
_resolveTargets(){
try{
var sel=String(this._state.config.targetSelector||"");
if(!sel)return [];
var nodes=document.querySelectorAll(sel);
return nodes?Array.prototype.slice.call(nodes):[];
}catch(e){this._error("_resolveTargets",e);return [];}
},
_applyToNode(node,t,g){
try{
if(!node||!node.style)return;
node.style.setProperty("--pt-text",t);
node.style.setProperty("--pt-glow",g);
node.style.setProperty("--pt-a",t);
node.style.setProperty("--pt-b",g);
node.setAttribute("data-pt-text",t);
node.setAttribute("data-pt-glow",g);
}catch(e){this._error("_applyToNode",e);}
},
_applyTheme(theme,mode,src){
try{
theme=theme||{};
var t=this._hexOk(theme.text)||this._state.theme.text;
var g=this._hexOk(theme.glow)||this._state.theme.glow;
this._state.theme.text=t;
this._state.theme.glow=g;

var changed=(t!==this._state.lastApplied.text)||(g!==this._state.lastApplied.glow);
this._state.lastApplied.text=t;
this._state.lastApplied.glow=g;

if(!this._state.enabled||!this._state.started)return;

var targets=this._resolveTargets();
var i=0;
for(i=0;i<targets.length;i++)this._applyToNode(targets[i],t,g);

this._emit("EVT:PARTICLE_SYNC:APPLIED",{id:this.id,mode:String(mode||"apply"),source:String(src||"unknown"),theme:{text:t,glow:g},changed:!!changed,count:targets.length,ts:Date.now()});
this._emitState("EVT:PARTICLE_SYNC:STATE");
}catch(e){this._error("_applyTheme",e);}
},
_onThemePreview(p){
if(!this._state.enabled||!this._state.started)return;
if(!this._state.config.emitPreview)return;
var th=this._pickThemeFromPayload(p||{});
this._applyTheme(th,"preview","THEME_APPLY");
},
_onThemeCommit(p){
if(!this._state.enabled||!this._state.started)return;
if(!this._state.config.emitCommit)return;
var th=this._pickThemeFromPayload(p||{});
this._applyTheme(th,"commit","THEME_APPLY");
},
_onBinderPreview(p){
if(!this._state.enabled||!this._state.started)return;
if(!this._state.config.emitPreview)return;
p=p||{};
var kind=String(p.kind||"").toUpperCase();
var val=this._hexOk(p.value)||"";
if(!val)return;
var th={text:this._state.theme.text,glow:this._state.theme.glow};
if(kind==="TEXT")th.text=val;
if(kind==="GLOW")th.glow=val;
this._applyTheme(th,"preview","MENU_BINDER");
},
_onBinderCommit(p){
if(!this._state.enabled||!this._state.started)return;
if(!this._state.config.emitCommit)return;
p=p||{};
var kind=String(p.kind||"").toUpperCase();
var val=this._hexOk(p.value)||"";
if(!val)return;
var th={text:this._state.theme.text,glow:this._state.theme.glow};
if(kind==="TEXT")th.text=val;
if(kind==="GLOW")th.glow=val;
this._applyTheme(th,"commit","MENU_BINDER");
},
mount(payload){
try{
payload=payload||{};
if(payload.config)this.setConfig(payload.config);
if(payload.theme)this.setTheme(payload.theme);
this._state.mounted=true;
this._emit("EVT:PARTICLE_SYNC:MOUNTED",{id:this.id,ts:Date.now()});
if(this._state.config.autoStart)this.start();
this._emitState("EVT:PARTICLE_SYNC:STATE");
}catch(e){this._error("mount",e);}
},
enable(){
try{
this._state.enabled=true;
this._emitState("EVT:PARTICLE_SYNC:STATE");
}catch(e){this._error("enable",e);}
},
disable(){
try{
this._state.enabled=false;
this.stop();
this._emitState("EVT:PARTICLE_SYNC:STATE");
}catch(e){this._error("disable",e);}
},
start(){
try{
if(!this._state.mounted)this.mount({});
this._state.started=true;
this._emit("EVT:PARTICLE_SYNC:STARTED",{id:this.id,ts:Date.now()});
this.apply({mode:"start"});
}catch(e){this._error("start",e);}
},
stop(){
try{
this._state.started=false;
this._emit("EVT:PARTICLE_SYNC:STOPPED",{id:this.id,ts:Date.now()});
this._emitState("EVT:PARTICLE_SYNC:STATE");
}catch(e){this._error("stop",e);}
},
setConfig(partial){
try{
partial=partial||{};
var c=this._state.config;
if(partial.autoEnable!=null)c.autoEnable=!!partial.autoEnable;
if(partial.autoStart!=null)c.autoStart=!!partial.autoStart;
if(partial.targetSelector!=null)c.targetSelector=String(partial.targetSelector||"");
if(partial.useCssVars!=null)c.useCssVars=!!partial.useCssVars;
if(partial.cssTextVar!=null)c.cssTextVar=String(partial.cssTextVar||"--kog-text");
if(partial.cssGlowVar!=null)c.cssGlowVar=String(partial.cssGlowVar||"--kog-glow");
if(partial.emitPreview!=null)c.emitPreview=!!partial.emitPreview;
if(partial.emitCommit!=null)c.emitCommit=!!partial.emitCommit;
this._emitState("EVT:PARTICLE_SYNC:STATE");
}catch(e){this._error("setConfig",e);}
},
setTheme(payload){
try{
var th=this._pickThemeFromPayload(payload||{});
this._state.theme.text=th.text;
this._state.theme.glow=th.glow;
this._emit("EVT:PARTICLE_SYNC:THEME_SYNC",{id:this.id,theme:{text:th.text,glow:th.glow},ts:Date.now()});
this.apply({mode:"theme"});
}catch(e){this._error("setTheme",e);}
},
apply(payload){
try{
payload=payload||{};
var th=this._pickThemeFromPayload(payload||{});
this._applyTheme(th,String(payload.mode||"apply"),String(payload.source||"manual"));
}catch(e){this._error("apply",e);}
},
_snapshotState(){
return {
enabled:this._state.enabled,mounted:this._state.mounted,started:this._state.started,
theme:{text:this._state.theme.text,glow:this._state.theme.glow},
config:{
autoEnable:this._state.config.autoEnable,autoStart:this._state.config.autoStart,
targetSelector:this._state.config.targetSelector,useCssVars:this._state.config.useCssVars,
cssTextVar:this._state.config.cssTextVar,cssGlowVar:this._state.config.cssGlowVar,
emitPreview:this._state.config.emitPreview,emitCommit:this._state.config.emitCommit
},
lastApplied:{text:this._state.lastApplied.text,glow:this._state.lastApplied.glow},
lastError:this._state.lastError
};
},
_emitState(ev){
this._emit(ev||"EVT:PARTICLE_SYNC:STATE",{id:this.id,state:this._snapshotState(),ts:Date.now()});
},
status(){
return {id:this.id,state:this._snapshotState(),ts:Date.now()};
},
api:{
mount:function(p){return Engine_PARTICLE_SYNC.mount(p);},
enable:function(){return Engine_PARTICLE_SYNC.enable();},
disable:function(){return Engine_PARTICLE_SYNC.disable();},
start:function(){return Engine_PARTICLE_SYNC.start();},
stop:function(){return Engine_PARTICLE_SYNC.stop();},
setTheme:function(p){return Engine_PARTICLE_SYNC.setTheme(p);},
setConfig:function(p){return Engine_PARTICLE_SYNC.setConfig(p);},
apply:function(p){return Engine_PARTICLE_SYNC.apply(p);},
status:function(){return Engine_PARTICLE_SYNC.status();}
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_PARTICLE_SYNC.id]=Engine_PARTICLE_SYNC;
/*-- üéÜüß¨-(36A)-(E)-(PARTICLE-THEME-SYNC)-(DUAL-TONE-DRIVER)-(E)-(36A)-üß¨üéÜ --*/
/*-- üéÆüß©-(37A)-(S)-(GAME-ADAPTER-INTERFACE)-(THEME-INHERIT)-(S)-(37A)-üß©üéÆ --*/
const Engine_GAME_ADAPTER={
id:"GAME_ADAPTER",
_ctx:null,
_state:{
enabled:true,mounted:false,started:false,lastError:null,ts0:0,lastUpdate:0,
theme:{text:"#9CFF00",glow:"#00FFB7"},
config:{
autoEnable:true,
autoStart:true,
emitPreview:true,
emitCommit:true
},
games:{}
},
init(ctx){
this._ctx=ctx||null;
this._state.ts0=Date.now();
if(!this._ctx||!this._ctx.bus)return this._error("init","missing_ctx_bus");
this._wire();
if(this._state.config.autoEnable)this.enable();
this._emit("EVT:GAME_ADAPTER:READY",{id:this.id,ts:Date.now()});
return this;
},
_wire(){
var b=this._ctx.bus,me=this;
b.on("REQ:GAME_ADAPTER:MOUNT",function(p){me.mount(p);});
b.on("REQ:GAME_ADAPTER:ENABLE",function(){me.enable();});
b.on("REQ:GAME_ADAPTER:DISABLE",function(){me.disable();});
b.on("REQ:GAME_ADAPTER:START",function(){me.start();});
b.on("REQ:GAME_ADAPTER:STOP",function(){me.stop();});
b.on("REQ:GAME_ADAPTER:REGISTER",function(p){me.register(p);});
b.on("REQ:GAME_ADAPTER:UNREGISTER",function(p){me.unregister(p);});
b.on("REQ:GAME_ADAPTER:THEME",function(p){me.setTheme(p);});
b.on("REQ:GAME_ADAPTER:APPLY",function(p){me.apply(p);});
b.on("REQ:GAME_ADAPTER:STATUS",function(){me._emitState("EVT:GAME_ADAPTER:STATE");});

b.on("EVT:THEME_APPLY:PREVIEW",function(p){me._onThemePreview(p);});
b.on("EVT:THEME_APPLY:CHANGED",function(p){me._onThemeCommit(p);});
b.on("EVT:MENU_BINDER:THEME_PREVIEW",function(p){me._onBinderPreview(p);});
b.on("EVT:MENU_BINDER:THEME_COMMIT",function(p){me._onBinderCommit(p);});
},
_emit(ev,p){
try{this._ctx&&this._ctx.bus&&this._ctx.bus.emit(ev,p);}catch(e){this._error("_emit",e);}
},
_error(where,err){
var msg=(err&&err.message)?err.message:String(err||"error");
this._state.lastError=msg;
this._emit("EVT:GAME_ADAPTER:ERROR",{id:this.id,where:String(where||"unknown"),error:msg,ts:Date.now()});
return null;
},
_hexOk(s){
s=String(s||"").trim();
if(!s)return "";
if(s[0]!=="#")return "";
if(!(s.length===4||s.length===7))return "";
return s;
},
_pickTheme(p){
p=p||{};
var t=this._hexOk(p.text)||this._hexOk(p.TEXT)||this._state.theme.text;
var g=this._hexOk(p.glow)||this._hexOk(p.GLOW)||this._state.theme.glow;
return {text:t,glow:g};
},
_applyToGame(game,theme,mode){
try{
if(!game||!game.applyTheme)return;
var payload={
text:theme.text,
glow:theme.glow,
board:theme.glow,
pieces:theme.text,
mode:String(mode||"apply"),
ts:Date.now()
};
game.applyTheme(payload);
}catch(e){this._error("_applyToGame",e);}
},
_applyAll(theme,mode,src){
try{
var k=null,g=null;
for(k in this._state.games){
g=this._state.games[k];
this._applyToGame(g,theme,mode);
}
this._emit("EVT:GAME_ADAPTER:APPLIED",{id:this.id,mode:String(mode||"apply"),source:String(src||"unknown"),theme:theme,count:Object.keys(this._state.games).length,ts:Date.now()});
this._emitState("EVT:GAME_ADAPTER:STATE");
}catch(e){this._error("_applyAll",e);}
},
_onThemePreview(p){
if(!this._state.enabled||!this._state.started||!this._state.config.emitPreview)return;
var th=this._pickTheme(p);
this._state.theme=th;
this._applyAll(th,"preview","THEME_APPLY");
},
_onThemeCommit(p){
if(!this._state.enabled||!this._state.started||!this._state.config.emitCommit)return;
var th=this._pickTheme(p);
this._state.theme=th;
this._applyAll(th,"commit","THEME_APPLY");
},
_onBinderPreview(p){
if(!this._state.enabled||!this._state.started||!this._state.config.emitPreview)return;
p=p||{};
var th={text:this._state.theme.text,glow:this._state.theme.glow};
if(p.kind==="TEXT")th.text=this._hexOk(p.value)||th.text;
if(p.kind==="GLOW")th.glow=this._hexOk(p.value)||th.glow;
this._state.theme=th;
this._applyAll(th,"preview","MENU_BINDER");
},
_onBinderCommit(p){
if(!this._state.enabled||!this._state.started||!this._state.config.emitCommit)return;
p=p||{};
var th={text:this._state.theme.text,glow:this._state.theme.glow};
if(p.kind==="TEXT")th.text=this._hexOk(p.value)||th.text;
if(p.kind==="GLOW")th.glow=this._hexOk(p.value)||th.glow;
this._state.theme=th;
this._applyAll(th,"commit","MENU_BINDER");
},
register(payload){
try{
payload=payload||{};
var id=String(payload.id||"");
var api=payload.api||payload.game||null;
if(!id||!api||typeof api.applyTheme!=="function")return;
this._state.games[id]=api;
this._applyToGame(api,this._state.theme,"sync");
this._emit("EVT:GAME_ADAPTER:REGISTERED",{id:this.id,game:id,ts:Date.now()});
this._emitState("EVT:GAME_ADAPTER:STATE");
}catch(e){this._error("register",e);}
},
unregister(payload){
try{
payload=payload||{};
var id=String(payload.id||"");
if(!id)return;
delete this._state.games[id];
this._emit("EVT:GAME_ADAPTER:UNREGISTERED",{id:this.id,game:id,ts:Date.now()});
this._emitState("EVT:GAME_ADAPTER:STATE");
}catch(e){this._error("unregister",e);}
},
mount(){
this._state.mounted=true;
this._emit("EVT:GAME_ADAPTER:MOUNTED",{id:this.id,ts:Date.now()});
if(this._state.config.autoStart)this.start();
this._emitState("EVT:GAME_ADAPTER:STATE");
},
enable(){
this._state.enabled=true;
this._emitState("EVT:GAME_ADAPTER:STATE");
},
disable(){
this._state.enabled=false;
this.stop();
this._emitState("EVT:GAME_ADAPTER:STATE");
},
start(){
if(!this._state.mounted)this.mount();
this._state.started=true;
this._applyAll(this._state.theme,"start","system");
this._emit("EVT:GAME_ADAPTER:STARTED",{id:this.id,ts:Date.now()});
},
stop(){
this._state.started=false;
this._emit("EVT:GAME_ADAPTER:STOPPED",{id:this.id,ts:Date.now()});
this._emitState("EVT:GAME_ADAPTER:STATE");
},
setTheme(p){
var th=this._pickTheme(p);
this._state.theme=th;
this._applyAll(th,"set","manual");
},
apply(p){
var th=this._pickTheme(p);
this._state.theme=th;
this._applyAll(th,String(p&&p.mode||"apply"),"manual");
},
_snapshotState(){
return {
enabled:this._state.enabled,
mounted:this._state.mounted,
started:this._state.started,
theme:this._state.theme,
games:Object.keys(this._state.games),
lastError:this._state.lastError
};
},
_emitState(ev){
this._emit(ev||"EVT:GAME_ADAPTER:STATE",{id:this.id,state:this._snapshotState(),ts:Date.now()});
},
status(){
return {id:this.id,state:this._snapshotState(),ts:Date.now()};
},
api:{
register:function(p){return Engine_GAME_ADAPTER.register(p);},
unregister:function(p){return Engine_GAME_ADAPTER.unregister(p);},
setTheme:function(p){return Engine_GAME_ADAPTER.setTheme(p);},
apply:function(p){return Engine_GAME_ADAPTER.apply(p);},
status:function(){return Engine_GAME_ADAPTER.status();}
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_GAME_ADAPTER.id]=Engine_GAME_ADAPTER;
/*-- üéÆüß©-(37A)-(E)-(GAME-ADAPTER-INTERFACE)-(THEME-INHERIT)-(E)-(37A)-üß©üéÆ --*/
/*-- üî§üß¨-(38A)-(S)-(FONT-OVERRIDE-ENGINE)-(PACK+AUTO-FIT)-(S)-(38A)-üß¨üî§ --*/
const Engine_FONT_OVERRIDE={
id:"FONT_OVERRIDE",
_ctx:null,
_bus:null,
_log:null,
_state:{mode:"shell",active:"system-ui",fonts:{},defaults:{shell:{min:8,max:64,step:1,lineHeight:1.08,letterSpacing:"0px",weight:"600"},app:{min:1,max:256,step:1,lineHeight:1.12,letterSpacing:"0px",weight:"500"}}},
_watch:{seq:0,map:{}},

init:function(ctx){
this._ctx=ctx||{};
this._bus=this._ctx.bus||{};
if(typeof this._bus.on!=="function") this._bus.on=function(){};
if(typeof this._bus.emit!=="function") this._bus.emit=function(){};
this._log=(this._ctx.log&&typeof this._ctx.log==="object")?this._ctx.log:{};
if(typeof this._log.info!=="function") this._log.info=function(){};
if(typeof this._log.warn!=="function") this._log.warn=function(){};
this._seedPack();
this._wireBus();
return this;
},

_wireBus:function(){
var self=this;
try{
this._bus.on("FONT_MODE_SET",function(p){self.setMode(p&&p.mode?p.mode:"shell");});
this._bus.on("FONT_ACTIVE_SET",function(p){self.setActive(p&&p.name?p.name:"system-ui");});
this._bus.on("FONT_APPLY",function(p){if(!p||!p.el) return;self.apply(p.el,p.opts||{});});
this._bus.on("FONT_FIT",function(p){if(!p||!p.el) return;self.fit(p.el,p.opts||{});});
this._bus.on("FONT_REGISTER",function(p){if(!p||!p.name) return;self.registerFont(p.name,p.family||p.name,p.meta||{});});
this._bus.on("FONT_PACK_REGISTER",function(p){if(!p||!p.pack) return;self.registerPack(p.pack);});
}catch(e){}
},

_seedPack:function(){
var f=this._state.fonts;
f["system-ui"]={family:"system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif",meta:{kind:"system",tags:["clean","default"]}};
f["serif"]={family:"Georgia,Times New Roman,Times,serif",meta:{kind:"system",tags:["serif"]}};
f["mono"]={family:"ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,monospace",meta:{kind:"system",tags:["mono"]}};
f["impact"]={family:"Impact,Haettenschweiler,Arial Black,sans-serif",meta:{kind:"system",tags:["bold","poster"]}};
f["comic"]={family:"Comic Sans MS,Comic Sans,cursive",meta:{kind:"system",tags:["fun"]}};
f["cursive"]={family:"Brush Script MT,Apple Chancery,cursive",meta:{kind:"system",tags:["script"]}};
f["display"]={family:"Trebuchet MS,Verdana,Geneva,Tahoma,sans-serif",meta:{kind:"system",tags:["display"]}};
f["pixel"]={family:"monospace",meta:{kind:"fallback",tags:["pixel","8bit"],note:"Register a real pixel font via registerFont/loadCSS for true pixel look."}};
f["gothic"]={family:"Franklin Gothic Medium,Arial Narrow,Arial,sans-serif",meta:{kind:"system",tags:["gothic"]}};
f["lux"]={family:"Palatino Linotype,Book Antiqua,Palatino,serif",meta:{kind:"system",tags:["luxury"]}};
f["news"]={family:"Times New Roman,Times,serif",meta:{kind:"system",tags:["news"]}};
f["tech"]={family:"Segoe UI,Roboto,Helvetica,Arial,sans-serif",meta:{kind:"system",tags:["tech"]}};
f["round"]={family:"Arial Rounded MT Bold,Arial,sans-serif",meta:{kind:"system",tags:["round"]}};
f["thin"]={family:"Helvetica Neue,Helvetica,Arial,sans-serif",meta:{kind:"system",tags:["thin"],hint:{weight:"300"}}};
},

setMode:function(mode){
this._state.mode=(mode==="app")?"app":"shell";
try{this._bus.emit("FONT_MODE_CHANGED",{mode:this._state.mode});}catch(e){}
return this._state.mode;
},

getMode:function(){
return this._state.mode;
},

setActive:function(name){
if(!name) name="system-ui";
if(!this._state.fonts[name]) name="system-ui";
this._state.active=name;
try{this._bus.emit("FONT_ACTIVE_CHANGED",{name:name});}catch(e){}
return this._state.active;
},

getActive:function(){
return this._state.active;
},

registerFont:function(name,family,meta){
if(!name) return false;
this._state.fonts[name]={family:(family||name),meta:(meta||{})};
try{this._bus.emit("FONT_REGISTERED",{name:name});}catch(e){}
return true;
},

registerPack:function(pack){
if(!pack) return 0;
var n=0,i=0,it=null;
if(Array.isArray(pack)){
for(i=0;i<pack.length;i++){
it=pack[i];
if(!it||!it.name) continue;
this.registerFont(it.name,it.family||it.name,it.meta||{});
n++;
}
}else if(typeof pack==="object"){
for(i in pack){
it=pack[i];
if(!it) continue;
this.registerFont(i,it.family||it.name||i,it.meta||{});
n++;
}
}
return n;
},

listFonts:function(){
return Object.keys(this._state.fonts);
},

getFont:function(name){
return this._state.fonts[name]||null;
},

getDefaults:function(){
return (this._state.mode==="app")?this._state.defaults.app:this._state.defaults.shell;
},

_applyStyle:function(el,o){
if(!el||!el.style) return;
var d=this.getDefaults();
var fontName=(o&&o.font)?o.font:this._state.active;
if(!this._state.fonts[fontName]) fontName="system-ui";
var fam=this._state.fonts[fontName].family;
var weight=(o&&o.weight!=null)?String(o.weight):((this._state.fonts[fontName].meta&&this._state.fonts[fontName].meta.hint&&this._state.fonts[fontName].meta.hint.weight)?String(this._state.fonts[fontName].meta.hint.weight):String(d.weight));
var lh=(o&&o.lineHeight!=null)?String(o.lineHeight):String(d.lineHeight);
var ls=(o&&o.letterSpacing!=null)?String(o.letterSpacing):String(d.letterSpacing);
el.style.fontFamily=fam;
el.style.fontWeight=weight;
el.style.lineHeight=lh;
el.style.letterSpacing=ls;
if(o&&o.color!=null) el.style.color=String(o.color);
if(o&&o.align!=null) el.style.textAlign=String(o.align);
if(o&&o.transform!=null) el.style.textTransform=String(o.transform);
},

apply:function(el,opts){
if(!el) return false;
var o=opts||{};
this._applyStyle(el,o);
if(o.fit===true) this.fit(el,o);
return true;
},

_fitMeasure:function(el){
return {sw:el.scrollWidth,sh:el.scrollHeight,cw:el.clientWidth,ch:el.clientHeight};
},

_fits:function(el){
var m=this._fitMeasure(el);
return (m.sw<=m.cw+0.5)&&(m.sh<=m.ch+0.5);
},

fit:function(el,opts){
if(!el) return 0;
var o=opts||{};
var d=this.getDefaults();
var min=(o.min!=null)?Number(o.min):Number(d.min);
var max=(o.max!=null)?Number(o.max):Number(d.max);
var step=(o.step!=null)?Number(o.step):Number(d.step);
if(!isFinite(min)||min<1) min=1;
if(!isFinite(max)||max<min) max=min;
if(!isFinite(step)||step<1) step=1;

this._applyStyle(el,o);

var prev=el.style.whiteSpace;
var clamp=(o.clamp!=null)?!!o.clamp:(this._state.mode==="shell");
if(clamp) el.style.overflow="hidden";
if(o.nowrap===true) el.style.whiteSpace="nowrap";
if(o.nowrap!==true&&o.wrap===true) el.style.whiteSpace="normal";

var hi=max,lo=min,best=min;
var mid=0,tries=0;
while(lo<=hi&&tries<40){
mid=Math.floor((lo+hi)/2/step)*step;
if(mid<lo) mid=lo;
el.style.fontSize=mid+"px";
if(this._fits(el)){
best=mid;
lo=mid+step;
}else{
hi=mid-step;
}
tries++;
}
el.style.fontSize=best+"px";

if(prev!=null) el.style.whiteSpace=prev;
try{this._bus.emit("FONT_FIT_DONE",{px:best,mode:this._state.mode});}catch(e){}
return best;
},

watch:function(el,opts){
if(!el) return null;
var o=opts||{};
var self=this;
var ro=null,mo=null;
var token="FO_WATCH_"+(++this._watch.seq);
var run=function(){self.fit(el,o);};

try{
ro=new ResizeObserver(function(){run();});
ro.observe(el);
}catch(e){}

try{
mo=new MutationObserver(function(){run();});
mo.observe(el,{subtree:true,childList:true,characterData:true});
}catch(e){}

this._watch.map[token]={el:el,ro:ro,mo:mo,opts:o};
run();

var kill=function(){self.unwatch(token);};
return {token:token,kill:kill};
},

unwatch:function(token){
var it=this._watch.map[token];
if(!it) return false;
try{if(it.ro) it.ro.disconnect();}catch(e){}
try{if(it.mo) it.mo.disconnect();}catch(e){}
delete this._watch.map[token];
return true;
},

loadCSS:function(cssText,id){
try{
var sid=id||("FO_STYLE_"+Math.random().toString(16).slice(2));
var el=document.getElementById(sid);
if(!el){
el=document.createElement("style");
el.id=sid;
document.head.appendChild(el);
}
el.textContent=String(cssText||"");
return sid;
}catch(e){}
return null;
},

loadLink:function(href,id){
try{
var lid=id||("FO_LINK_"+Math.random().toString(16).slice(2));
var el=document.getElementById(lid);
if(!el){
el=document.createElement("link");
el.id=lid;
el.rel="stylesheet";
el.href=String(href||"");
document.head.appendChild(el);
}else{
el.href=String(href||"");
}
return lid;
}catch(e){}
return null;
}
};

window.Engine_FONT_OVERRIDE=Engine_FONT_OVERRIDE;
/*-- üî§üß¨-(38A)-(E)-(FONT-OVERRIDE-ENGINE)-(PACK+AUTO-FIT)-(E)-(38A)-üß¨üî§ --*/
üéÆ --*/
/*-- üéÆ‚ôüÔ∏è-(1B)-(S)-(CARTRIDGE-CORE-BOOT)-(LEGION-CHESS)-(S)-(1B)-‚ôüÔ∏èüéÆ --*/
const Cartridge_LEGION_CHESS={
id:"LEGION_CHESS",
type:"CARTRIDGE",
version:"0.1.0",
_ctx:null,
_state:{enabled:true,mounted:false,started:false,ts0:0,lastError:null,lastUpdate:0,meta:{name:"LEGION CHESS",slug:"legion-chess",author:"KOG LEGION",desc:"Chess cartridge that inherits shell theme + runs in header/footer safe zone."}},
init(ctx){
this._ctx=ctx||null;
this._state.ts0=Date.now();
if(!this._ctx||!this._ctx.bus)return this._error("init","missing_ctx_bus");
this._wire();
this._emit("EVT:LEGION_CHESS:READY",{id:this.id,ts:Date.now(),meta:this._state.meta,version:this.version});
return this;
},
_wire(){
var b=this._ctx.bus,me=this;
b.on("REQ:LEGION_CHESS:MOUNT",function(p){me.mount(p);});
b.on("REQ:LEGION_CHESS:UNMOUNT",function(){me.unmount();});
b.on("REQ:LEGION_CHESS:ENABLE",function(){me.enable();});
b.on("REQ:LEGION_CHESS:DISABLE",function(){me.disable();});
b.on("REQ:LEGION_CHESS:START",function(p){me.start(p);});
b.on("REQ:LEGION_CHESS:STOP",function(){me.stop();});
b.on("REQ:LEGION_CHESS:MANIFEST",function(){me._emit("EVT:LEGION_CHESS:MANIFEST",me.manifest());});
b.on("REQ:LEGION_CHESS:STATUS",function(){me._emitState("EVT:LEGION_CHESS:STATE");});
},
_emit(ev,p){
try{this._ctx&&this._ctx.bus&&this._ctx.bus.emit(ev,p);}catch(e){this._error("_emit",e);}
},
_error(where,err){
var msg=(err&&err.message)?err.message:String(err||"error");
this._state.lastError=msg;
this._emit("EVT:LEGION_CHESS:ERROR",{id:this.id,where:String(where||"unknown"),error:msg,ts:Date.now()});
return null;
},
_touch(){
this._state.lastUpdate=Date.now();
},
manifest(){
return {id:this.id,type:this.type,version:this.version,meta:this._state.meta,ts:Date.now(),requires:["34A_THEME_APPLY_BRIDGE","35A_MENU_BINDER"],provides:["LEGION_CHESS_BOARD","LEGION_CHESS_SETTINGS","LEGION_CHESS_AI"]};
},
mount(payload){
try{
payload=payload||{};
this._state.mounted=true;
this._touch();
this._emit("EVT:LEGION_CHESS:MOUNTED",{id:this.id,ts:Date.now(),payload:payload||{}});
this._emitState("EVT:LEGION_CHESS:STATE");
}catch(e){this._error("mount",e);}
},
unmount(){
try{
this.stop();
this._state.mounted=false;
this._touch();
this._emit("EVT:LEGION_CHESS:UNMOUNTED",{id:this.id,ts:Date.now()});
this._emitState("EVT:LEGION_CHESS:STATE");
}catch(e){this._error("unmount",e);}
},
enable(){
try{
this._state.enabled=true;
this._touch();
this._emitState("EVT:LEGION_CHESS:STATE");
}catch(e){this._error("enable",e);}
},
disable(){
try{
this.stop();
this._state.enabled=false;
this._touch();
this._emitState("EVT:LEGION_CHESS:STATE");
}catch(e){this._error("disable",e);}
},
start(payload){
try{
payload=payload||{};
if(!this._state.enabled)return;
if(!this._state.mounted)this.mount(payload);
this._state.started=true;
this._touch();
this._emit("EVT:LEGION_CHESS:STARTED",{id:this.id,ts:Date.now(),payload:payload||{}});
this._emitState("EVT:LEGION_CHESS:STATE");
this._emit("EVT:LEGION_CHESS:BOOT",{id:this.id,ts:Date.now(),mode:String(payload.mode||"AI_EASY")});
}catch(e){this._error("start",e);}
},
stop(){
try{
if(!this._state.started)return;
this._state.started=false;
this._touch();
this._emit("EVT:LEGION_CHESS:STOPPED",{id:this.id,ts:Date.now()});
this._emitState("EVT:LEGION_CHESS:STATE");
}catch(e){this._error("stop",e);}
},
_snapshotState(){
return {enabled:this._state.enabled,mounted:this._state.mounted,started:this._state.started,lastError:this._state.lastError,ts0:this._state.ts0,lastUpdate:this._state.lastUpdate,meta:this._state.meta,version:this.version};
},
_emitState(ev){
this._emit(ev||"EVT:LEGION_CHESS:STATE",{id:this.id,state:this._snapshotState(),ts:Date.now()});
},
status(){
return {id:this.id,state:this._snapshotState(),ts:Date.now()};
},
api:{
mount:function(p){return Cartridge_LEGION_CHESS.mount(p);},
unmount:function(){return Cartridge_LEGION_CHESS.unmount();},
enable:function(){return Cartridge_LEGION_CHESS.enable();},
disable:function(){return Cartridge_LEGION_CHESS.disable();},
start:function(p){return Cartridge_LEGION_CHESS.start(p);},
stop:function(){return Cartridge_LEGION_CHESS.stop();},
manifest:function(){return Cartridge_LEGION_CHESS.manifest();},
status:function(){return Cartridge_LEGION_CHESS.status();}
}
};
window.KOG=window.KOG||{};
window.KOG.CARTRIDGES=window.KOG.CARTRIDGES||{};
window.KOG.CARTRIDGES[Cartridge_LEGION_CHESS.id]=Cartridge_LEGION_CHESS;
/*-- üéÆ‚ôüÔ∏è-(1B)-(E)-(CARTRIDGE-CORE-BOOT)-(LEGION-CHESS)-(E)-(1B)-‚ôüÔ∏èüéÆ --*/
/*-- üé®üß¨-(2B)-(S)-(THEME-INHERIT-BRIDGE)-(TEXT+GLOW)-(S)-(2B)-üß¨üé® --*/
const Engine_CHESS_THEME_BRIDGE={
id:"CHESS_THEME_BRIDGE",
_ctx:null,
_state:{
enabled:true,mounted:false,started:false,lastError:null,ts0:0,lastUpdate:0,
theme:{text:"#9CFF00",glow:"#00FFB7"},
source:{text:"--kog-text",glow:"--kog-glow"},
gameOverride:{enabled:false,text:"",glow:""},
sync:{live:true,emit:true}
},
init(ctx){
this._ctx=ctx||null;
this._state.ts0=Date.now();
if(!this._ctx||!this._ctx.bus)return this._error("init","missing_ctx_bus");
this._wire();
this._pullCss();
this._emit("EVT:CHESS_THEME_BRIDGE:READY",{id:this.id,ts:Date.now(),theme:this._snapshotTheme()});
return this;
},
_wire(){
var b=this._ctx.bus,me=this;
b.on("REQ:CHESS_THEME_BRIDGE:MOUNT",function(p){me.mount(p);});
b.on("REQ:CHESS_THEME_BRIDGE:ENABLE",function(){me.enable();});
b.on("REQ:CHESS_THEME_BRIDGE:DISABLE",function(){me.disable();});
b.on("REQ:CHESS_THEME_BRIDGE:START",function(){me.start();});
b.on("REQ:CHESS_THEME_BRIDGE:STOP",function(){me.stop();});
b.on("REQ:CHESS_THEME_BRIDGE:PULL",function(){me.pull();});
b.on("REQ:CHESS_THEME_BRIDGE:SET",function(p){me.setTheme(p);});
b.on("REQ:CHESS_THEME_BRIDGE:OVERRIDE",function(p){me.setOverride(p);});
b.on("REQ:CHESS_THEME_BRIDGE:STATUS",function(){me._emitState("EVT:CHESS_THEME_BRIDGE:STATE");});
},
_emit(ev,p){
try{this._ctx&&this._ctx.bus&&this._ctx.bus.emit(ev,p);}catch(e){this._error("_emit",e);}
},
_error(where,err){
var msg=(err&&err.message)?err.message:String(err||"error");
this._state.lastError=msg;
this._emit("EVT:CHESS_THEME_BRIDGE:ERROR",{id:this.id,where:String(where||"unknown"),error:msg,ts:Date.now()});
return null;
},
_touch(){
this._state.lastUpdate=Date.now();
},
_clamp(n,a,b){
n=Number(n);
if(!isFinite(n))n=a;
if(n<a)n=a;
if(n>b)n=b;
return n;
},
_hexOk(s){
s=String(s||"").trim();
if(!s)return "";
if(s[0]!=="#")return "";
if(!(s.length===4||s.length===7))return "";
return s.toUpperCase();
},
_cssVar(name,fallback){
try{
var v=getComputedStyle(document.documentElement).getPropertyValue(name);
v=(v||"").trim();
return v||fallback;
}catch(e){return fallback;}
},
_pullCss(){
try{
var t=this._cssVar(this._state.source.text,this._state.theme.text);
var g=this._cssVar(this._state.source.glow,this._state.theme.glow);
t=this._hexOk(t)||this._state.theme.text;
g=this._hexOk(g)||this._state.theme.glow;
this._state.theme.text=t;
this._state.theme.glow=g;
}catch(e){this._error("_pullCss",e);}
},
_snapshotTheme(){
var t=this._state.theme.text;
var g=this._state.theme.glow;
if(this._state.gameOverride.enabled){
if(this._state.gameOverride.text)t=this._state.gameOverride.text;
if(this._state.gameOverride.glow)g=this._state.gameOverride.glow;
}
return {text:t,glow:g};
},
_broadcast(reason){
try{
if(!this._state.sync.emit)return;
var th=this._snapshotTheme();
this._emit("EVT:LEGION_CHESS:THEME",{id:this.id,reason:String(reason||"sync"),theme:th,ts:Date.now()});
this._emitState("EVT:CHESS_THEME_BRIDGE:STATE");
}catch(e){this._error("_broadcast",e);}
},
mount(payload){
try{
payload=payload||{};
if(payload.source){
if(payload.source.text)this._state.source.text=String(payload.source.text||this._state.source.text);
if(payload.source.glow)this._state.source.glow=String(payload.source.glow||this._state.source.glow);
}
if(payload.sync){
if(payload.sync.live!=null)this._state.sync.live=!!payload.sync.live;
if(payload.sync.emit!=null)this._state.sync.emit=!!payload.sync.emit;
}
this._pullCss();
this._state.mounted=true;
this._touch();
this._emit("EVT:CHESS_THEME_BRIDGE:MOUNTED",{id:this.id,ts:Date.now(),theme:this._snapshotTheme()});
this._broadcast("mount");
}catch(e){this._error("mount",e);}
},
enable(){
try{
this._state.enabled=true;
this._touch();
this._emitState("EVT:CHESS_THEME_BRIDGE:STATE");
}catch(e){this._error("enable",e);}
},
disable(){
try{
this._state.enabled=false;
this._touch();
this._emitState("EVT:CHESS_THEME_BRIDGE:STATE");
}catch(e){this._error("disable",e);}
},
start(){
try{
if(!this._state.mounted)this.mount({});
this._state.started=true;
this._touch();
this._emit("EVT:CHESS_THEME_BRIDGE:STARTED",{id:this.id,ts:Date.now()});
this._broadcast("start");
}catch(e){this._error("start",e);}
},
stop(){
try{
this._state.started=false;
this._touch();
this._emit("EVT:CHESS_THEME_BRIDGE:STOPPED",{id:this.id,ts:Date.now()});
this._emitState("EVT:CHESS_THEME_BRIDGE:STATE");
}catch(e){this._error("stop",e);}
},
pull(){
try{
if(!this._state.enabled||!this._state.started)return;
this._pullCss();
this._touch();
this._broadcast("pull");
}catch(e){this._error("pull",e);}
},
setTheme(payload){
try{
payload=payload||{};
var t=this._hexOk(payload.text||payload.TEXT)||"";
var g=this._hexOk(payload.glow||payload.GLOW)||"";
if(t)this._state.theme.text=t;
if(g)this._state.theme.glow=g;
this._touch();
this._broadcast("setTheme");
}catch(e){this._error("setTheme",e);}
},
setOverride(payload){
try{
payload=payload||{};
if(payload.enabled!=null)this._state.gameOverride.enabled=!!payload.enabled;
var t=this._hexOk(payload.text||payload.TEXT)||"";
var g=this._hexOk(payload.glow||payload.GLOW)||"";
if(payload.text!=null||payload.TEXT!=null)this._state.gameOverride.text=t;
if(payload.glow!=null||payload.GLOW!=null)this._state.gameOverride.glow=g;
this._touch();
this._broadcast("override");
}catch(e){this._error("setOverride",e);}
},
_snapshotState(){
return {enabled:this._state.enabled,mounted:this._state.mounted,started:this._state.started,theme:this._state.theme,source:this._state.source,override:this._state.gameOverride,sync:this._state.sync,lastError:this._state.lastError,ts0:this._state.ts0,lastUpdate:this._state.lastUpdate};
},
_emitState(ev){
this._emit(ev||"EVT:CHESS_THEME_BRIDGE:STATE",{id:this.id,state:this._snapshotState(),ts:Date.now()});
},
status(){
return {id:this.id,state:this._snapshotState(),ts:Date.now()};
},
api:{
mount:function(p){return Engine_CHESS_THEME_BRIDGE.mount(p);},
enable:function(){return Engine_CHESS_THEME_BRIDGE.enable();},
disable:function(){return Engine_CHESS_THEME_BRIDGE.disable();},
start:function(){return Engine_CHESS_THEME_BRIDGE.start();},
stop:function(){return Engine_CHESS_THEME_BRIDGE.stop();},
pull:function(){return Engine_CHESS_THEME_BRIDGE.pull();},
setTheme:function(p){return Engine_CHESS_THEME_BRIDGE.setTheme(p);},
setOverride:function(p){return Engine_CHESS_THEME_BRIDGE.setOverride(p);},
status:function(){return Engine_CHESS_THEME_BRIDGE.status();}
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_CHESS_THEME_BRIDGE.id]=Engine_CHESS_THEME_BRIDGE;
/*-- üé®üß¨-(2B)-(E)-(THEME-INHERIT-BRIDGE)-(TEXT+GLOW)-(E)-(2B)-üß¨üé® --*/
/*-- üßøüßæ-(3B)-(S)-(SETTINGS-MENU-HOOK)-(SHELL-MENU-SLOT)-(S)-(3B)-üßæüßø --*/
const Engine_CHESS_MENU_HOOK={
id:"CHESS_MENU_HOOK",
_ctx:null,
_state:{
enabled:true,mounted:false,started:false,lastError:null,ts0:0,lastUpdate:0,
hooks:{headerTitle:false,hotkey:false},
config:{openSection:"",useShellBinder:true,openOnStart:false},
bind:{titleEl:null},
stats:{opens:0,closes:0,lastOpen:0,lastClose:0}
},
init(ctx){
this._ctx=ctx||null;
this._state.ts0=Date.now();
if(!this._ctx||!this._ctx.bus)return this._error("init","missing_ctx_bus");
this._wire();
this._emit("EVT:CHESS_MENU_HOOK:READY",{id:this.id,ts:Date.now()});
return this;
},
_wire(){
var b=this._ctx.bus,me=this;
b.on("REQ:CHESS_MENU_HOOK:MOUNT",function(p){me.mount(p);});
b.on("REQ:CHESS_MENU_HOOK:ENABLE",function(){me.enable();});
b.on("REQ:CHESS_MENU_HOOK:DISABLE",function(){me.disable();});
b.on("REQ:CHESS_MENU_HOOK:START",function(){me.start();});
b.on("REQ:CHESS_MENU_HOOK:STOP",function(){me.stop();});
b.on("REQ:CHESS_MENU_HOOK:OPEN",function(p){me.open(p);});
b.on("REQ:CHESS_MENU_HOOK:CLOSE",function(){me.close();});
b.on("REQ:CHESS_MENU_HOOK:TOGGLE",function(p){me.toggle(p);});
b.on("REQ:CHESS_MENU_HOOK:STATUS",function(){me._emitState("EVT:CHESS_MENU_HOOK:STATE");});

b.on("EVT:MENU_BINDER:THEME_COMMIT",function(p){me._relayThemeCommit(p);});
b.on("EVT:MENU_BINDER:THEME_PREVIEW",function(p){me._relayThemePreview(p);});
},
_emit(ev,p){
try{this._ctx&&this._ctx.bus&&this._ctx.bus.emit(ev,p);}catch(e){this._error("_emit",e);}
},
_error(where,err){
var msg=(err&&err.message)?err.message:String(err||"error");
this._state.lastError=msg;
this._emit("EVT:CHESS_MENU_HOOK:ERROR",{id:this.id,where:String(where||"unknown"),error:msg,ts:Date.now()});
return null;
},
_touch(){
this._state.lastUpdate=Date.now();
},
_clamp(n,a,b){
n=Number(n);
if(!isFinite(n))n=a;
if(n<a)n=a;
if(n>b)n=b;
return n;
},
_tryEmit(ev,p){
try{this._emit(ev,p);}catch(e){}
},
_isOn(){
return !!(this._state.enabled&&this._state.started);
},
_findTitleEl(){
try{
if(this._state.bind.titleEl&&document.contains(this._state.bind.titleEl))return this._state.bind.titleEl;
var el=null;
el=document.querySelector("[data-kog-header-title]");
if(el)return el;
el=document.querySelector("[data-kog='TITLE_BAR'] [data-role='title']");
if(el)return el;
el=document.querySelector("[data-kog*='HEADER'] [data-role='title']");
if(el)return el;
el=document.querySelector("#kogTitle");
if(el)return el;
return null;
}catch(e){return null;}
},
_bindHeaderTitle(){
try{
var el=this._findTitleEl();
if(!el)return false;
this._state.bind.titleEl=el;
if(el.getAttribute("data-chess-menu-hook")==="1")return true;
el.setAttribute("data-chess-menu-hook","1");
el.style.cursor="pointer";
var me=this;
el.addEventListener("click",function(){if(me._isOn())me.toggle({section:me._state.config.openSection||""});},{passive:true});
this._state.hooks.headerTitle=true;
return true;
}catch(e){this._error("_bindHeaderTitle",e);return false;}
},
_bindHotkey(){
try{
if(this._state.hooks.hotkey)return true;
var me=this;
document.addEventListener("keydown",function(e){
try{
if(!me._isOn())return;
var k=e&&e.key?String(e.key):"";
if(k==="m"||k==="M"){
if(e.preventDefault)e.preventDefault();
me.toggle({section:me._state.config.openSection||""});
}
}catch(err){me._error("hotkey",err);}
},{passive:false});
this._state.hooks.hotkey=true;
return true;
}catch(e){this._error("_bindHotkey",e);return false;}
},
_openShellBinder(section){
try{
if(!this._state.config.useShellBinder)return false;
this._emit("REQ:MENU_BINDER:OPEN",{section:String(section||"")});
return true;
}catch(e){this._error("_openShellBinder",e);return false;}
},
_closeShellBinder(){
try{
if(!this._state.config.useShellBinder)return false;
this._emit("REQ:MENU_BINDER:CLOSE",{});
return true;
}catch(e){this._error("_closeShellBinder",e);return false;}
},
_relayThemePreview(p){
try{
p=p||{};
var kind=String(p.kind||"");
var value=String(p.value||"");
if(!kind||!value)return;
this._emit("EVT:LEGION_CHESS:THEME_PREVIEW",{id:this.id,kind:kind,value:value,live:!!p.live,ts:Date.now()});
}catch(e){this._error("_relayThemePreview",e);}
},
_relayThemeCommit(p){
try{
p=p||{};
var kind=String(p.kind||"");
var value=String(p.value||"");
if(!kind||!value)return;
this._emit("EVT:LEGION_CHESS:THEME_COMMIT",{id:this.id,kind:kind,value:value,default:!!p.default,ts:Date.now()});
}catch(e){this._error("_relayThemeCommit",e);}
},
mount(payload){
try{
payload=payload||{};
if(payload.config){
if(payload.config.openSection!=null)this._state.config.openSection=String(payload.config.openSection||"");
if(payload.config.useShellBinder!=null)this._state.config.useShellBinder=!!payload.config.useShellBinder;
if(payload.config.openOnStart!=null)this._state.config.openOnStart=!!payload.config.openOnStart;
}
this._state.mounted=true;
this._touch();
this._emit("EVT:CHESS_MENU_HOOK:MOUNTED",{id:this.id,ts:Date.now(),config:this._state.config});
this._emitState("EVT:CHESS_MENU_HOOK:STATE");
}catch(e){this._error("mount",e);}
},
enable(){
try{
this._state.enabled=true;
this._touch();
this._emitState("EVT:CHESS_MENU_HOOK:STATE");
}catch(e){this._error("enable",e);}
},
disable(){
try{
this.close();
this._state.enabled=false;
this._touch();
this._emitState("EVT:CHESS_MENU_HOOK:STATE");
}catch(e){this._error("disable",e);}
},
start(){
try{
if(!this._state.mounted)this.mount({});
this._state.started=true;
this._bindHeaderTitle();
this._bindHotkey();
this._touch();
this._emit("EVT:CHESS_MENU_HOOK:STARTED",{id:this.id,ts:Date.now()});
this._emitState("EVT:CHESS_MENU_HOOK:STATE");
if(this._state.config.openOnStart)this.open({section:this._state.config.openSection||""});
}catch(e){this._error("start",e);}
},
stop(){
try{
this.close();
this._state.started=false;
this._touch();
this._emit("EVT:CHESS_MENU_HOOK:STOPPED",{id:this.id,ts:Date.now()});
this._emitState("EVT:CHESS_MENU_HOOK:STATE");
}catch(e){this._error("stop",e);}
},
open(payload){
try{
if(!this._isOn())return;
payload=payload||{};
var sec=String(payload.section||payload.id||"");
this._state.stats.opens++;
this._state.stats.lastOpen=Date.now();
this._touch();
this._openShellBinder(sec);
this._emit("EVT:CHESS_MENU_HOOK:OPENED",{id:this.id,section:sec,ts:Date.now()});
this._emitState("EVT:CHESS_MENU_HOOK:STATE");
}catch(e){this._error("open",e);}
},
close(){
try{
if(!this._state.enabled)return;
this._state.stats.closes++;
this._state.stats.lastClose=Date.now();
this._touch();
this._closeShellBinder();
this._emit("EVT:CHESS_MENU_HOOK:CLOSED",{id:this.id,ts:Date.now()});
this._emitState("EVT:CHESS_MENU_HOOK:STATE");
}catch(e){this._error("close",e);}
},
toggle(payload){
try{
if(!this._isOn())return;
payload=payload||{};
var sec=String(payload.section||payload.id||"");
this._emit("REQ:MENU_BINDER:TOGGLE",{section:sec});
this._touch();
this._emit("EVT:CHESS_MENU_HOOK:TOGGLED",{id:this.id,section:sec,ts:Date.now()});
this._emitState("EVT:CHESS_MENU_HOOK:STATE");
}catch(e){this._error("toggle",e);}
},
_snapshotState(){
return {enabled:this._state.enabled,mounted:this._state.mounted,started:this._state.started,hooks:this._state.hooks,config:this._state.config,stats:this._state.stats,lastError:this._state.lastError,ts0:this._state.ts0,lastUpdate:this._state.lastUpdate};
},
_emitState(ev){
this._emit(ev||"EVT:CHESS_MENU_HOOK:STATE",{id:this.id,state:this._snapshotState(),ts:Date.now()});
},
status(){
return {id:this.id,state:this._snapshotState(),ts:Date.now()};
},
api:{
mount:function(p){return Engine_CHESS_MENU_HOOK.mount(p);},
enable:function(){return Engine_CHESS_MENU_HOOK.enable();},
disable:function(){return Engine_CHESS_MENU_HOOK.disable();},
start:function(){return Engine_CHESS_MENU_HOOK.start();},
stop:function(){return Engine_CHESS_MENU_HOOK.stop();},
open:function(p){return Engine_CHESS_MENU_HOOK.open(p);},
close:function(){return Engine_CHESS_MENU_HOOK.close();},
toggle:function(p){return Engine_CHESS_MENU_HOOK.toggle(p);},
status:function(){return Engine_CHESS_MENU_HOOK.status();}
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_CHESS_MENU_HOOK.id]=Engine_CHESS_MENU_HOOK;
/*-- üßøüßæ-(3B)-(E)-(SETTINGS-MENU-HOOK)-(SHELL-MENU-SLOT)-(E)-(3B)-üßæüßø --*/
/*-- üß†‚ôüÔ∏è-(4B)-(S)-(CHESS-RULES-ENGINE)-(LEGAL-MOVES)-(S)-(4B)-‚ôüÔ∏èüß† --*/
const Engine_CHESS_RULES={
id:"CHESS_RULES",
_ctx:null,
_state:{
enabled:true,mounted:false,started:false,lastError:null,ts0:0,lastUpdate:0,
cfg:{allowSelfCheck:false},
meta:{turn:"w",halfmove:0,fullmove:1,enPassant:-1,castle:{wK:true,wQ:true,bK:true,bQ:true}},
board:null
},
init(ctx){
this._ctx=ctx||null;
this._state.ts0=Date.now();
if(!this._ctx||!this._ctx.bus)return this._error("init","missing_ctx_bus");
this._wire();
this._emit("EVT:CHESS_RULES:READY",{id:this.id,ts:Date.now()});
return this;
},
_wire(){
var b=this._ctx.bus,me=this;
b.on("REQ:CHESS_RULES:MOUNT",function(p){me.mount(p);});
b.on("REQ:CHESS_RULES:ENABLE",function(){me.enable();});
b.on("REQ:CHESS_RULES:DISABLE",function(){me.disable();});
b.on("REQ:CHESS_RULES:START",function(){me.start();});
b.on("REQ:CHESS_RULES:STOP",function(){me.stop();});
b.on("REQ:CHESS_RULES:RESET",function(p){me.reset(p);});
b.on("REQ:CHESS_RULES:LOAD",function(p){me.load(p);});
b.on("REQ:CHESS_RULES:GET",function(){me._emit("EVT:CHESS_RULES:POSITION",me.getPosition());});
b.on("REQ:CHESS_RULES:MOVES",function(p){me._emit("EVT:CHESS_RULES:MOVES",{id:me.id,from:me._sq(p&&p.from!=null?p.from:-1),moves:me.legalMovesFrom(p&&p.from!=null?p.from:-1),ts:Date.now()});});
b.on("REQ:CHESS_RULES:APPLY",function(p){me.applyMove(p);});
b.on("REQ:CHESS_RULES:VALIDATE",function(p){me._emit("EVT:CHESS_RULES:VALID",{id:me.id,ok:me.validateMove(p),move:p||null,ts:Date.now()});});
b.on("REQ:CHESS_RULES:CHECK",function(p){me._emit("EVT:CHESS_RULES:CHECK",{id:me.id,side:String(p&&p.side?p.side:me._state.meta.turn),inCheck:me.isInCheck(String(p&&p.side?p.side:me._state.meta.turn)),ts:Date.now()});});
b.on("REQ:CHESS_RULES:STATUS",function(){me._emitState("EVT:CHESS_RULES:STATE");});
},
_emit(ev,p){
try{this._ctx&&this._ctx.bus&&this._ctx.bus.emit(ev,p);}catch(e){this._error("_emit",e);}
},
_error(where,err){
var msg=(err&&err.message)?err.message:String(err||"error");
this._state.lastError=msg;
this._emit("EVT:CHESS_RULES:ERROR",{id:this.id,where:String(where||"unknown"),error:msg,ts:Date.now()});
return null;
},
_touch(){
this._state.lastUpdate=Date.now();
},
_on(){
return !!(this._state.enabled&&this._state.started&&this._state.board);
},
_sq(i){
i=Number(i);
if(!isFinite(i))return -1;
i=i|0;
if(i<0||i>63)return -1;
return i;
},
_xy(i){
i=this._sq(i);
return {x:i%8,y:(i/8)|0};
},
_i(x,y){
x=x|0;y=y|0;
if(x<0||x>7||y<0||y>7)return -1;
return (y*8+x)|0;
},
_isWhite(p){return !!p&&p===p.toUpperCase();},
_isBlack(p){return !!p&&p===p.toLowerCase();},
_sideOf(p){if(!p)return "";return this._isWhite(p)?"w":"b";},
_opp(s){return (s==="w")?"b":"w";},
_pieceAt(i){
i=this._sq(i);
if(i<0||!this._state.board)return "";
return this._state.board[i]||"";
},
_setAt(b,i,p){
i=this._sq(i);
if(i<0)return;
b[i]=p||"";
},
_cloneBoard(b){
var n=new Array(64),i=0;
for(i=0;i<64;i++)n[i]=b[i]||"";
return n;
},
_defaultBoard(){
var b=new Array(64),i=0;
for(i=0;i<64;i++)b[i]="";
var backW=["R","N","B","Q","K","B","N","R"];
var backB=["r","n","b","q","k","b","n","r"];
for(i=0;i<8;i++){b[this._i(i,7)]=backW[i];b[this._i(i,6)]="P";b[this._i(i,1)]="p";b[this._i(i,0)]=backB[i];}
return b;
},
_resetMeta(){
this._state.meta.turn="w";
this._state.meta.halfmove=0;
this._state.meta.fullmove=1;
this._state.meta.enPassant=-1;
this._state.meta.castle={wK:true,wQ:true,bK:true,bQ:true};
},
mount(payload){
try{
payload=payload||{};
if(payload.cfg){
if(payload.cfg.allowSelfCheck!=null)this._state.cfg.allowSelfCheck=!!payload.cfg.allowSelfCheck;
}
if(!this._state.board)this._state.board=this._defaultBoard();
this._resetMeta();
this._state.mounted=true;
this._touch();
this._emit("EVT:CHESS_RULES:MOUNTED",{id:this.id,ts:Date.now()});
this._emit("EVT:CHESS_RULES:POSITION",this.getPosition());
this._emitState("EVT:CHESS_RULES:STATE");
}catch(e){this._error("mount",e);}
},
enable(){
try{this._state.enabled=true;this._touch();this._emitState("EVT:CHESS_RULES:STATE");}catch(e){this._error("enable",e);}
},
disable(){
try{this._state.enabled=false;this._touch();this._emitState("EVT:CHESS_RULES:STATE");}catch(e){this._error("disable",e);}
},
start(){
try{
if(!this._state.mounted)this.mount({});
this._state.started=true;
this._touch();
this._emit("EVT:CHESS_RULES:STARTED",{id:this.id,ts:Date.now()});
this._emitState("EVT:CHESS_RULES:STATE");
}catch(e){this._error("start",e);}
},
stop(){
try{
this._state.started=false;
this._touch();
this._emit("EVT:CHESS_RULES:STOPPED",{id:this.id,ts:Date.now()});
this._emitState("EVT:CHESS_RULES:STATE");
}catch(e){this._error("stop",e);}
},
reset(payload){
try{
payload=payload||{};
this._state.board=this._defaultBoard();
this._resetMeta();
if(payload.turn==="b"||payload.turn==="w")this._state.meta.turn=payload.turn;
this._touch();
this._emit("EVT:CHESS_RULES:RESET",{id:this.id,ts:Date.now()});
this._emit("EVT:CHESS_RULES:POSITION",this.getPosition());
this._emitState("EVT:CHESS_RULES:STATE");
}catch(e){this._error("reset",e);}
},
load(payload){
try{
payload=payload||{};
if(payload.board&&payload.board.length===64)this._state.board=this._cloneBoard(payload.board);
if(payload.meta){
var m=payload.meta;
if(m.turn==="w"||m.turn==="b")this._state.meta.turn=m.turn;
if(m.halfmove!=null)this._state.meta.halfmove=(Number(m.halfmove)||0)|0;
if(m.fullmove!=null)this._state.meta.fullmove=(Number(m.fullmove)||1)|0;
if(m.enPassant!=null)this._state.meta.enPassant=this._sq(m.enPassant);
if(m.castle)this._state.meta.castle={wK:!!m.castle.wK,wQ:!!m.castle.wQ,bK:!!m.castle.bK,bQ:!!m.castle.bQ};
}
this._touch();
this._emit("EVT:CHESS_RULES:LOADED",{id:this.id,ts:Date.now()});
this._emit("EVT:CHESS_RULES:POSITION",this.getPosition());
this._emitState("EVT:CHESS_RULES:STATE");
}catch(e){this._error("load",e);}
},
getPosition(){
return {id:this.id,board:this._state.board?this._cloneBoard(this._state.board):this._defaultBoard(),meta:{turn:this._state.meta.turn,halfmove:this._state.meta.halfmove,fullmove:this._state.meta.fullmove,enPassant:this._state.meta.enPassant,castle:{wK:!!this._state.meta.castle.wK,wQ:!!this._state.meta.castle.wQ,bK:!!this._state.meta.castle.bK,bQ:!!this._state.meta.castle.bQ}},ts:Date.now()};
},
_findKing(side,b){
var i=0,k=(side==="w")?"K":"k";
for(i=0;i<64;i++)if((b[i]||"")===k)return i;
return -1;
},
_attackedBy(side,b,at){
var i=0,p="",from=0,moves=null;
for(i=0;i<64;i++){
p=b[i]||"";
if(!p)continue;
if(this._sideOf(p)!==side)continue;
moves=this._pseudoMovesFrom(i,b,true);
for(from=0;from<moves.length;from++)if(moves[from].to===at)return true;
}
return false;
},
isInCheck(side){
try{
if(!this._state.board)return false;
side=(side==="b")?"b":"w";
var b=this._state.board;
var k=this._findKing(side,b);
if(k<0)return false;
return this._attackedBy(this._opp(side),b,k);
}catch(e){this._error("isInCheck",e);return false;}
},
_pseudoMovesFrom(from,b,forAttack){
from=this._sq(from);
if(from<0)return [];
b=b||this._state.board;
if(!b)return [];
var p=b[from]||"";
if(!p)return [];
var side=this._sideOf(p);
var x=from%8,y=(from/8)|0;
var out=[];
var me=this;
var push=function(to,flags,promo){
to=me._sq(to);
if(to<0)return;
out.push({from:from,to:to,flags:flags||"",promo:promo||""});
};
var at=function(xx,yy){return me._i(xx,yy);};
var occ=function(i2){return b[i2]||"";};
var isFriend=function(q){return q&&(me._sideOf(q)===side);};
var isEnemy=function(q){return q&&(me._sideOf(q)!==side);};

var dir=(side==="w")?-1:1;

if(p.toLowerCase()==="p"){
var f1=at(x,y+dir);
if(!forAttack){
if(f1>=0&&!occ(f1))push(f1,"");
var startRank=(side==="w")?6:1;
var f2=at(x,y+dir+dir);
if(y===startRank&&f2>=0&&!occ(f1)&&!occ(f2))push(f2,"P2");
}
var c1=at(x-1,y+dir);
var c2=at(x+1,y+dir);
if(c1>=0){
if(forAttack)push(c1,"A");
else if(isEnemy(occ(c1)))push(c1,"C");
else if(this._state.meta.enPassant===c1)push(c1,"E");
}
if(c2>=0){
if(forAttack)push(c2,"A");
else if(isEnemy(occ(c2)))push(c2,"C");
else if(this._state.meta.enPassant===c2)push(c2,"E");
}
var promoRank=(side==="w")?0:7;
var i0=0;
if(!forAttack){
for(i0=out.length-1;i0>=0;i0--){
var mv=out[i0];
var ty=(mv.to/8)|0;
if(ty===promoRank){
out.splice(i0,1);
push(mv.to,mv.flags+"=Q","Q");
push(mv.to,mv.flags+"=R","R");
push(mv.to,mv.flags+"=B","B");
push(mv.to,mv.flags+"=N","N");
}
}
}
return out;
}

if(p.toLowerCase()==="n"){
var dx=[-2,-1,1,2,2,1,-1,-2];
var dy=[1,2,2,1,-1,-2,-2,-1];
var j=0,tx=0,ty=0,ti=-1,q="";
for(j=0;j<8;j++){
tx=x+dx[j];ty=y+dy[j];ti=at(tx,ty);
if(ti<0)continue;
q=occ(ti);
if(!q)push(ti,"");
else if(isEnemy(q))push(ti,"C");
}
return out;
}

if(p.toLowerCase()==="b"||p.toLowerCase()==="r"||p.toLowerCase()==="q"){
var dirs=[];
if(p.toLowerCase()==="b"||p.toLowerCase()==="q")dirs=dirs.concat([[1,1],[-1,1],[1,-1],[-1,-1]]);
if(p.toLowerCase()==="r"||p.toLowerCase()==="q")dirs=dirs.concat([[1,0],[-1,0],[0,1],[0,-1]]);
var d=0,xx=0,yy=0,ii=-1,qq="";
for(d=0;d<dirs.length;d++){
xx=x;yy=y;
while(true){
xx+=dirs[d][0];yy+=dirs[d][1];
ii=at(xx,yy);
if(ii<0)break;
qq=occ(ii);
if(!qq){push(ii,"");continue;}
if(isEnemy(qq))push(ii,"C");
break;
}
}
return out;
}

if(p.toLowerCase()==="k"){
var kdx=[-1,0,1,-1,1,-1,0,1];
var kdy=[-1,-1,-1,0,0,1,1,1];
var t=0,tx2=0,ty2=0,ki=-1,kq="";
for(t=0;t<8;t++){
tx2=x+kdx[t];ty2=y+kdy[t];ki=at(tx2,ty2);
if(ki<0)continue;
kq=occ(ki);
if(!kq)push(ki,"");
else if(isEnemy(kq))push(ki,"C");
}
if(!forAttack){
var canK=(side==="w")?this._state.meta.castle.wK:this._state.meta.castle.bK;
var canQ=(side==="w")?this._state.meta.castle.wQ:this._state.meta.castle.bQ;
if(canK)this._tryCastle(side,"K",b,out);
if(canQ)this._tryCastle(side,"Q",b,out);
}
return out;
}

return out;
},
_tryCastle(side,wing,b,out){
try{
var y=(side==="w")?7:0;
var kFrom=this._i(4,y);
var rFrom=(wing==="K")?this._i(7,y):this._i(0,y);
var kTo=(wing==="K")?this._i(6,y):this._i(2,y);
var path=(wing==="K")?[this._i(5,y),this._i(6,y)]:[this._i(3,y),this._i(2,y),this._i(1,y)];
var pass=(wing==="K")?[this._i(4,y),this._i(5,y),this._i(6,y)]:[this._i(4,y),this._i(3,y),this._i(2,y)];
var k=b[kFrom]||"",r=b[rFrom]||"";
if(!k||!r)return;
if(this._sideOf(k)!==side)return;
if(this._sideOf(r)!==side)return;
var i=0;
for(i=0;i<path.length;i++)if(b[path[i]])return;
for(i=0;i<pass.length;i++){
if(this._attackedBy(this._opp(side),b,pass[i]))return;
}
out.push({from:kFrom,to:kTo,flags:"K"+wing,promo:""});
}catch(e){this._error("_tryCastle",e);}
},
_filterLegal(moves,side,from){
var b0=this._state.board;
var i=0,ok=[],mv=null;
for(i=0;i<moves.length;i++){
mv=moves[i];
if(this._makesSelfCheck(side,from,mv.to,mv))continue;
ok.push(mv);
}
return ok;
},
_makesSelfCheck(side,from,to,mv){
try{
if(this._state.cfg.allowSelfCheck)return false;
var b=this._cloneBoard(this._state.board);
var p=b[from]||"";
if(!p)return true;

var captured="";
if(mv&&mv.flags&&mv.flags.indexOf("E")>=0){
var dir=(side==="w")?-1:1;
var cx=to%8,cy=((to/8)|0)-dir;
var capI=this._i(cx,cy);
captured=b[capI]||"";
b[capI]="";
}else{
captured=b[to]||"";
}

b[to]=p;
b[from]="";

if(mv&&mv.flags&&mv.flags.indexOf("K")===0){
var y=(side==="w")?7:0;
if(mv.flags==="KK"){
b[this._i(5,y)]=b[this._i(7,y)];
b[this._i(7,y)]="";
}else if(mv.flags==="KQ"){
b[this._i(3,y)]=b[this._i(0,y)];
b[this._i(0,y)]="";
}
}

var promo=mv&&mv.promo?String(mv.promo):"";
if(promo){
b[to]=(side==="w")?promo.toUpperCase():promo.toLowerCase();
}

var k=this._findKing(side,b);
if(k<0)return true;
return this._attackedBy(this._opp(side),b,k);
}catch(e){this._error("_makesSelfCheck",e);return true;}
},
legalMovesFrom(from){
try{
if(!this._on())return [];
from=this._sq(from);
if(from<0)return [];
var p=this._pieceAt(from);
if(!p)return [];
var side=this._sideOf(p);
if(side!==this._state.meta.turn)return [];
var raw=this._pseudoMovesFrom(from,this._state.board,false);
return this._filterLegal(raw,side,from);
}catch(e){this._error("legalMovesFrom",e);return [];}
},
_allLegal(side){
var b=this._state.board;
var i=0,p="",out=[];
for(i=0;i<64;i++){
p=b[i]||"";
if(!p)continue;
if(this._sideOf(p)!==side)continue;
out=out.concat(this._filterLegal(this._pseudoMovesFrom(i,b,false),side,i));
}
return out;
},
validateMove(m){
try{
if(!this._on())return false;
m=m||{};
var from=this._sq(m.from);
var to=this._sq(m.to);
if(from<0||to<0)return false;
var list=this.legalMovesFrom(from);
var i=0;
for(i=0;i<list.length;i++){
if(list[i].to===to){
if(m.promo){
if(String(list[i].promo||"")!==String(m.promo||""))continue;
}
return true;
}
}
return false;
}catch(e){this._error("validateMove",e);return false;}
},
_applyMetaAfterMove(side,mv,from,to,piece,captured){
try{
var m=this._state.meta;
m.enPassant=-1;
if(piece.toLowerCase()==="p"){
m.halfmove=0;
var fy=(from/8)|0,ty=(to/8)|0;
if(Math.abs(ty-fy)===2){
var midY=(fy+ty)/2;
m.enPassant=this._i(from%8,midY|0);
}
}else{
m.halfmove++;
}
if(captured)m.halfmove=0;

if(piece.toLowerCase()==="k"){
if(side==="w"){m.castle.wK=false;m.castle.wQ=false;}
else{m.castle.bK=false;m.castle.bQ=false;}
}
if(piece.toLowerCase()==="r"){
if(from===this._i(0,7))m.castle.wQ=false;
if(from===this._i(7,7))m.castle.wK=false;
if(from===this._i(0,0))m.castle.bQ=false;
if(from===this._i(7,0))m.castle.bK=false;
}
if(captured&&captured.toLowerCase()==="r"){
if(to===this._i(0,7))m.castle.wQ=false;
if(to===this._i(7,7))m.castle.wK=false;
if(to===this._i(0,0))m.castle.bQ=false;
if(to===this._i(7,0))m.castle.bK=false;
}

if(side==="b")m.fullmove++;

m.turn=this._opp(side);
}catch(e){this._error("_applyMetaAfterMove",e);}
},
applyMove(payload){
try{
if(!this._on())return this._error("applyMove","not_ready");
payload=payload||{};
var from=this._sq(payload.from);
var to=this._sq(payload.to);
var promo=payload.promo?String(payload.promo):"";
if(from<0||to<0)return this._error("applyMove","bad_squares");
var side=this._state.meta.turn;
var legal=this.legalMovesFrom(from);
var mv=null,i=0;
for(i=0;i<legal.length;i++){
if(legal[i].to===to){
if(promo&&String(legal[i].promo||"")!==promo)continue;
mv=legal[i];
break;
}
}
if(!mv)return this._error("applyMove","illegal");
var b=this._state.board;
var piece=b[from]||"";
var captured="";
if(mv.flags.indexOf("E")>=0){
var dir=(side==="w")?-1:1;
var cx=to%8,cy=((to/8)|0)-dir;
var capI=this._i(cx,cy);
captured=b[capI]||"";
b[capI]="";
}else{
captured=b[to]||"";
}
b[to]=piece;
b[from]="";

if(mv.flags==="KK"||mv.flags==="KQ"){
var y=(side==="w")?7:0;
if(mv.flags==="KK"){
b[this._i(5,y)]=b[this._i(7,y)];
b[this._i(7,y)]="";
}else{
b[this._i(3,y)]=b[this._i(0,y)];
b[this._i(0,y)]="";
}
}

if(mv.promo){
b[to]=(side==="w")?mv.promo.toUpperCase():mv.promo.toLowerCase();
}

this._applyMetaAfterMove(side,mv,from,to,piece,captured);
this._touch();

var ev={
id:this.id,
move:{from:from,to:to,piece:piece,captured:captured,flags:mv.flags||"",promo:mv.promo||""},
meta:{turn:this._state.meta.turn,halfmove:this._state.meta.halfmove,fullmove:this._state.meta.fullmove,enPassant:this._state.meta.enPassant,castle:{wK:!!this._state.meta.castle.wK,wQ:!!this._state.meta.castle.wQ,bK:!!this._state.meta.castle.bK,bQ:!!this._state.meta.castle.bQ}},
ts:Date.now()
};
this._emit("EVT:CHESS_RULES:MOVED",ev);
this._emit("EVT:CHESS_RULES:POSITION",this.getPosition());
this._emitState("EVT:CHESS_RULES:STATE");
return ev;
}catch(e){this._error("applyMove",e);return null;}
},
hasAnyLegal(side){
try{
if(!this._state.board)return false;
side=(side==="b")?"b":"w";
return this._allLegal(side).length>0;
}catch(e){this._error("hasAnyLegal",e);return false;}
},
result(){
try{
if(!this._state.board)return {status:"none"};
var side=this._state.meta.turn;
var inCheck=this.isInCheck(side);
var any=this.hasAnyLegal(side);
if(any)return {status:"playing",turn:side,inCheck:!!inCheck};
if(inCheck)return {status:"checkmate",winner:this._opp(side),loser:side};
return {status:"stalemate",winner:"",loser:""};
}catch(e){this._error("result",e);return {status:"error"};}
},
snapshot(){
return {id:this.id,state:this._snapshotState(),ts:Date.now()};
},
_snapshotState(){
return {enabled:this._state.enabled,mounted:this._state.mounted,started:this._state.started,cfg:this._state.cfg,meta:{turn:this._state.meta.turn,halfmove:this._state.meta.halfmove,fullmove:this._state.meta.fullmove,enPassant:this._state.meta.enPassant,castle:this._state.meta.castle},lastError:this._state.lastError,ts0:this._state.ts0,lastUpdate:this._state.lastUpdate};
},
_emitState(ev){
this._emit(ev||"EVT:CHESS_RULES:STATE",{id:this.id,state:this._snapshotState(),ts:Date.now()});
},
status(){
return this.snapshot();
},
api:{
mount:function(p){return Engine_CHESS_RULES.mount(p);},
enable:function(){return Engine_CHESS_RULES.enable();},
disable:function(){return Engine_CHESS_RULES.disable();},
start:function(){return Engine_CHESS_RULES.start();},
stop:function(){return Engine_CHESS_RULES.stop();},
reset:function(p){return Engine_CHESS_RULES.reset(p);},
load:function(p){return Engine_CHESS_RULES.load(p);},
get:function(){return Engine_CHESS_RULES.getPosition();},
movesFrom:function(i){return Engine_CHESS_RULES.legalMovesFrom(i);},
applyMove:function(m){return Engine_CHESS_RULES.applyMove(m);},
validate:function(m){return Engine_CHESS_RULES.validateMove(m);},
inCheck:function(s){return Engine_CHESS_RULES.isInCheck(s);},
result:function(){return Engine_CHESS_RULES.result();},
status:function(){return Engine_CHESS_RULES.status();}
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_CHESS_RULES.id]=Engine_CHESS_RULES;
/*-- üß†‚ôüÔ∏è-(4B)-(E)-(CHESS-RULES-ENGINE)-(LEGAL-MOVES)-(E)-(4B)-‚ôüÔ∏èüß† --*/
/*-- ü§ñ‚ôüÔ∏è-(5B)-(S)-(AI-COMMAND-ENGINE)-(EASY/MED/HARD)-(S)-(5B)-‚ôüÔ∏èü§ñ --*/
const Engine_CHESS_AI={
id:"CHESS_AI",
_ctx:null,
_state:{
enabled:true,mounted:false,started:false,lastError:null,ts0:0,lastUpdate:0,
mode:"AI",
level:"EASY",
thinking:false,
cfg:{thinkDelayMs:{EASY:140,MED:240,HARD:360},rngSalt:0.22,maxBranch:{EASY:16,MED:28,HARD:48}},
last:{move:null,score:0,reason:"",ts:0}
},
init(ctx){
this._ctx=ctx||null;
this._state.ts0=Date.now();
if(!this._ctx||!this._ctx.bus)return this._error("init","missing_ctx_bus");
this._wire();
this._emit("EVT:CHESS_AI:READY",{id:this.id,ts:Date.now()});
return this;
},
_wire(){
var b=this._ctx.bus,me=this;
b.on("REQ:CHESS_AI:MOUNT",function(p){me.mount(p);});
b.on("REQ:CHESS_AI:ENABLE",function(){me.enable();});
b.on("REQ:CHESS_AI:DISABLE",function(){me.disable();});
b.on("REQ:CHESS_AI:START",function(){me.start();});
b.on("REQ:CHESS_AI:STOP",function(){me.stop();});
b.on("REQ:CHESS_AI:LEVEL",function(p){me.setLevel(p);});
b.on("REQ:CHESS_AI:MODE",function(p){me.setMode(p);});
b.on("REQ:CHESS_AI:THINK",function(p){me.think(p);});
b.on("REQ:CHESS_AI:STATUS",function(){me._emitState("EVT:CHESS_AI:STATE");});
b.on("EVT:CHESS_RULES:MOVED",function(ev){me._onMoved(ev);});
},
_emit(ev,p){
try{this._ctx&&this._ctx.bus&&this._ctx.bus.emit(ev,p);}catch(e){this._error("_emit",e);}
},
_error(where,err){
var msg=(err&&err.message)?err.message:String(err||"error");
this._state.lastError=msg;
this._emit("EVT:CHESS_AI:ERROR",{id:this.id,where:String(where||"unknown"),error:msg,ts:Date.now()});
return null;
},
_now(){
try{if(window.performance&&typeof performance.now==="function")return performance.now();}catch(e){}
return Date.now();
},
_touch(){this._state.lastUpdate=Date.now();},
_on(){return !!(this._state.enabled&&this._state.started&&this._state.mounted);},
_clamp(n,a,b){
n=Number(n);
if(!isFinite(n))n=a;
if(n<a)n=a;
if(n>b)n=b;
return n;
},
_sq(i){
i=Number(i);
if(!isFinite(i))return -1;
i=i|0;
if(i<0||i>63)return -1;
return i;
},
_xy(i){i=this._sq(i);return {x:i%8,y:(i/8)|0};},
_i(x,y){
x=x|0;y=y|0;
if(x<0||x>7||y<0||y>7)return -1;
return (y*8+x)|0;
},
_isWhite(p){return !!p&&p===p.toUpperCase();},
_isBlack(p){return !!p&&p===p.toLowerCase();},
_sideOf(p){if(!p)return "";return this._isWhite(p)?"w":"b";},
_opp(s){return (s==="w")?"b":"w";},
_rand(){
var r=Math.random();
var salt=this._state.cfg.rngSalt||0;
return (r*(1-salt))+(Math.random()*salt);
},
_mountRules(){
return (window.KOG&&window.KOG.CHESS_RULES)?window.KOG.CHESS_RULES:null;
},
mount(payload){
try{
payload=payload||{};
if(payload.cfg){
var c=payload.cfg;
if(c.rngSalt!=null)this._state.cfg.rngSalt=this._clamp(c.rngSalt,0,0.95);
if(c.maxBranch){
if(c.maxBranch.EASY!=null)this._state.cfg.maxBranch.EASY=this._clamp(c.maxBranch.EASY,1,256)|0;
if(c.maxBranch.MED!=null)this._state.cfg.maxBranch.MED=this._clamp(c.maxBranch.MED,1,256)|0;
if(c.maxBranch.HARD!=null)this._state.cfg.maxBranch.HARD=this._clamp(c.maxBranch.HARD,1,256)|0;
}
if(c.thinkDelayMs){
if(c.thinkDelayMs.EASY!=null)this._state.cfg.thinkDelayMs.EASY=this._clamp(c.thinkDelayMs.EASY,0,2000)|0;
if(c.thinkDelayMs.MED!=null)this._state.cfg.thinkDelayMs.MED=this._clamp(c.thinkDelayMs.MED,0,2000)|0;
if(c.thinkDelayMs.HARD!=null)this._state.cfg.thinkDelayMs.HARD=this._clamp(c.thinkDelayMs.HARD,0,2000)|0;
}
}
if(payload.level)this.setLevel({level:payload.level});
if(payload.mode)this.setMode({mode:payload.mode});
this._state.mounted=true;
this._touch();
this._emit("EVT:CHESS_AI:MOUNTED",{id:this.id,ts:Date.now()});
this._emitState("EVT:CHESS_AI:STATE");
}catch(e){this._error("mount",e);}
},
enable(){try{this._state.enabled=true;this._touch();this._emitState("EVT:CHESS_AI:STATE");}catch(e){this._error("enable",e);}},
disable(){try{this._state.enabled=false;this._state.thinking=false;this._touch();this._emitState("EVT:CHESS_AI:STATE");}catch(e){this._error("disable",e);}},
start(){
try{
if(!this._state.mounted)this.mount({});
this._state.started=true;
this._touch();
this._emit("EVT:CHESS_AI:STARTED",{id:this.id,ts:Date.now()});
this._emitState("EVT:CHESS_AI:STATE");
}catch(e){this._error("start",e);}
},
stop(){
try{
this._state.started=false;
this._state.thinking=false;
this._touch();
this._emit("EVT:CHESS_AI:STOPPED",{id:this.id,ts:Date.now()});
this._emitState("EVT:CHESS_AI:STATE");
}catch(e){this._error("stop",e);}
},
setMode(payload){
try{
payload=payload||{};
var m=String(payload.mode||payload.value||"");
if(m!=="AI"&&m!=="OFF")m="AI";
this._state.mode=m;
this._touch();
this._emit("EVT:CHESS_AI:MODE",{id:this.id,mode:this._state.mode,ts:Date.now()});
this._emitState("EVT:CHESS_AI:STATE");
}catch(e){this._error("setMode",e);}
},
setLevel(payload){
try{
payload=payload||{};
var l=String(payload.level||payload.value||"").toUpperCase();
if(l!=="EASY"&&l!=="MED"&&l!=="HARD")l="EASY";
this._state.level=l;
this._touch();
this._emit("EVT:CHESS_AI:LEVEL",{id:this.id,level:this._state.level,ts:Date.now()});
this._emitState("EVT:CHESS_AI:STATE");
}catch(e){this._error("setLevel",e);}
},
_onMoved(ev){
try{
if(!this._on())return;
if(this._state.mode!=="AI")return;
var rules=this._mountRules();
if(!rules||!rules.api||!rules.api.get)return;
var pos=rules.api.get();
var turn=pos&&pos.meta?pos.meta.turn:"w";
var aiSide="b";
if(turn!==aiSide)return;
this.think({side:aiSide,reason:"auto"});
}catch(e){this._error("_onMoved",e);}
},
think(payload){
try{
if(!this._on())return;
if(this._state.mode!=="AI")return;
if(this._state.thinking)return;
payload=payload||{};
var side=String(payload.side||"b");
if(side!=="w"&&side!=="b")side="b";
var rules=this._mountRules();
if(!rules||!rules.api||!rules.api.get||!rules.api.applyMove)return this._error("think","missing_rules");
var pos=rules.api.get();
var turn=pos&&pos.meta?pos.meta.turn:"w";
if(turn!==side)return;

this._state.thinking=true;
this._emit("EVT:CHESS_AI:THINKING",{id:this.id,side:side,level:this._state.level,ts:Date.now()});

var delay=(this._state.cfg.thinkDelayMs[this._state.level]||0)|0;
var me=this;
setTimeout(function(){me._chooseAndPlay(side);},delay);
}catch(e){this._state.thinking=false;this._error("think",e);}
},
_chooseAndPlay(side){
try{
var rules=this._mountRules();
if(!rules||!rules.api||!rules.api.get||!rules.api.applyMove){this._state.thinking=false;return;}
var pos=rules.api.get();
var board=(pos&&pos.board)?pos.board:null;
if(!board||board.length!==64){this._state.thinking=false;return;}
var moves=this._genAllMoves(side,board,pos.meta||{});
if(!moves.length){this._state.thinking=false;this._emit("EVT:CHESS_AI:NO_MOVES",{id:this.id,side:side,ts:Date.now()});return;}

var pick=this._pickMove(side,board,pos.meta||{},moves);
this._state.last.move=pick.move;
this._state.last.score=pick.score;
this._state.last.reason=pick.reason;
this._state.last.ts=Date.now();

this._emit("EVT:CHESS_AI:CHOSEN",{id:this.id,side:side,level:this._state.level,move:pick.move,score:pick.score,reason:pick.reason,ts:Date.now()});

rules.api.applyMove(pick.move);

this._state.thinking=false;
this._touch();
this._emitState("EVT:CHESS_AI:STATE");
}catch(e){this._state.thinking=false;this._error("_chooseAndPlay",e);}
},
_genAllMoves(side,board,meta){
try{
var rules=this._mountRules();
var out=[],i=0,p="",s="";
for(i=0;i<64;i++){
p=board[i]||"";
if(!p)continue;
s=this._sideOf(p);
if(s!==side)continue;
var lm=rules.legalMovesFrom?rules.legalMovesFrom(i):(rules.api&&rules.api.movesFrom?rules.api.movesFrom(i):[]);
var j=0;
for(j=0;j<lm.length;j++)out.push(lm[j]);
}
return out;
}catch(e){this._error("_genAllMoves",e);return [];}
},
_valPiece(p){
p=String(p||"");
if(!p)return 0;
var q=p.toLowerCase();
if(q==="p")return 100;
if(q==="n")return 320;
if(q==="b")return 330;
if(q==="r")return 500;
if(q==="q")return 900;
if(q==="k")return 20000;
return 0;
},
_eval(board,side){
var i=0,p="",sum=0,v=0,s="";
for(i=0;i<64;i++){
p=board[i]||"";
if(!p)continue;
v=this._valPiece(p);
s=this._sideOf(p);
sum+= (s===side)?v:-v;
}
return sum;
},
_applyMoveSim(board,meta,mv,side){
var b=this._clone(board);
var from=this._sq(mv.from),to=this._sq(mv.to);
var piece=b[from]||"";
var captured="";
if(mv.flags&&String(mv.flags).indexOf("E")>=0){
var dir=(side==="w")?-1:1;
var cx=to%8,cy=((to/8)|0)-dir;
var capI=this._i(cx,cy);
captured=b[capI]||"";
b[capI]="";
}else captured=b[to]||"";
b[to]=piece;
b[from]="";
if(mv.flags==="KK"||mv.flags==="KQ"){
var y=(side==="w")?7:0;
if(mv.flags==="KK"){b[this._i(5,y)]=b[this._i(7,y)];b[this._i(7,y)]="";}
else{b[this._i(3,y)]=b[this._i(0,y)];b[this._i(0,y)]="";}
}
if(mv.promo){
b[to]=(side==="w")?String(mv.promo).toUpperCase():String(mv.promo).toLowerCase();
}
return {board:b,captured:captured};
},
_clone(b){
var n=new Array(64),i=0;
for(i=0;i<64;i++)n[i]=b[i]||"";
return n;
},
_pickMove(side,board,meta,moves){
var lvl=this._state.level;
var cap=[];
var i=0,mv=null,to=0,tPiece="",score=0,best=null,bestS=-1e9,reason="";
for(i=0;i<moves.length;i++){
mv=moves[i];
to=this._sq(mv.to);
tPiece=board[to]||"";
if(tPiece)cap.push(mv);
}
if(lvl==="EASY"){
if(cap.length&&this._rand()>0.35){mv=cap[(cap.length*this._rand())|0];return {move:{from:mv.from,to:mv.to,promo:mv.promo||""},score:0,reason:"random_capture"};}
mv=moves[(moves.length*this._rand())|0];
return {move:{from:mv.from,to:mv.to,promo:mv.promo||""},score:0,reason:"random_move"};
}
if(lvl==="MED"){
var limit=this._state.cfg.maxBranch.MED|0;
var pool=moves.slice(0);
pool.sort((a,b)=>{var va=this._valPiece(board[this._sq(a.to)]||"");var vb=this._valPiece(board[this._sq(b.to)]||"");return vb-va;});
if(pool.length>limit)pool=pool.slice(0,limit);
for(i=0;i<pool.length;i++){
mv=pool[i];
var sim=this._applyMoveSim(board,meta,mv,side);
score=this._eval(sim.board,side);
score+=this._rand()*6;
if(score>bestS){bestS=score;best=mv;reason="1ply_eval";}
}
return {move:{from:best.from,to:best.to,promo:best.promo||""},score:bestS,reason:reason};
}
var limitH=this._state.cfg.maxBranch.HARD|0;
var poolH=moves.slice(0);
poolH.sort((a,b)=>{var va=this._valPiece(board[this._sq(a.to)]||"");var vb=this._valPiece(board[this._sq(b.to)]||"");return vb-va;});
if(poolH.length>limitH)poolH=poolH.slice(0,limitH);

var opp=this._opp(side);
var rules=this._mountRules();
for(i=0;i<poolH.length;i++){
mv=poolH[i];
var sim1=this._applyMoveSim(board,meta,mv,side);
var s1=this._eval(sim1.board,side);
var oppMoves=this._genAllMoves(opp,sim1.board,meta);
var j=0,worst=1e9;
if(!oppMoves.length)worst=-999999;
for(j=0;j<oppMoves.length;j++){
var om=oppMoves[j];
var sim2=this._applyMoveSim(sim1.board,meta,om,opp);
var s2=this._eval(sim2.board,side);
if(s2<worst)worst=s2;
}
score=(0.55*s1)+(0.45*worst);
score+=this._rand()*3;
if(score>bestS){bestS=score;best=mv;reason="2ply_minimax";}
}
return {move:{from:best.from,to:best.to,promo:best.promo||""},score:bestS,reason:reason};
},
snapshot(){
return {id:this.id,state:this._snapshotState(),ts:Date.now()};
},
_snapshotState(){
return {enabled:this._state.enabled,mounted:this._state.mounted,started:this._state.started,mode:this._state.mode,level:this._state.level,thinking:this._state.thinking,cfg:this._state.cfg,last:this._state.last,lastError:this._state.lastError,ts0:this._state.ts0,lastUpdate:this._state.lastUpdate};
},
_emitState(ev){
this._emit(ev||"EVT:CHESS_AI:STATE",{id:this.id,state:this._snapshotState(),ts:Date.now()});
},
status(){return this.snapshot();},
api:{
mount:function(p){return Engine_CHESS_AI.mount(p);},
enable:function(){return Engine_CHESS_AI.enable();},
disable:function(){return Engine_CHESS_AI.disable();},
start:function(){return Engine_CHESS_AI.start();},
stop:function(){return Engine_CHESS_AI.stop();},
setLevel:function(p){return Engine_CHESS_AI.setLevel(p);},
setMode:function(p){return Engine_CHESS_AI.setMode(p);},
think:function(p){return Engine_CHESS_AI.think(p);},
status:function(){return Engine_CHESS_AI.status();}
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_CHESS_AI.id]=Engine_CHESS_AI;
/*-- ü§ñ‚ôüÔ∏è-(5B)-(E)-(AI-COMMAND-ENGINE)-(EASY/MED/HARD)-(E)-(5B)-‚ôüÔ∏èü§ñ --*/
/*-- üë•‚ôüÔ∏è-(6B)-(S)-(PVP-LOCAL-ENGINE)-(HOTSEAT)-(S)-(6B)-‚ôüÔ∏èüë• --*/
const Engine_CHESS_PVP={
id:"CHESS_PVP",
_ctx:null,
_state:{
enabled:true,mounted:false,started:false,lastError:null,ts0:0,lastUpdate:0,
mode:"PVP",
seat:{p1:"w",p2:"b",active:"w"},
lockInput:false,
meta:{moves:0,lastMove:null,lastTs:0},
cfg:{autoStart:true,emitOnTurn:true}
},
init(ctx){
this._ctx=ctx||null;
this._state.ts0=Date.now();
if(!this._ctx||!this._ctx.bus)return this._error("init","missing_ctx_bus");
this._wire();
if(this._state.cfg.autoStart)this.start();
this._emit("EVT:CHESS_PVP:READY",{id:this.id,ts:Date.now()});
return this;
},
_wire(){
var b=this._ctx.bus,me=this;
b.on("REQ:CHESS_PVP:MOUNT",function(p){me.mount(p);});
b.on("REQ:CHESS_PVP:ENABLE",function(){me.enable();});
b.on("REQ:CHESS_PVP:DISABLE",function(){me.disable();});
b.on("REQ:CHESS_PVP:START",function(){me.start();});
b.on("REQ:CHESS_PVP:STOP",function(){me.stop();});
b.on("REQ:CHESS_PVP:MODE",function(p){me.setMode(p);});
b.on("REQ:CHESS_PVP:SEAT",function(p){me.setSeat(p);});
b.on("REQ:CHESS_PVP:TURN",function(p){me.setTurn(p);});
b.on("REQ:CHESS_PVP:LOCK",function(p){me.lock(p);});
b.on("REQ:CHESS_PVP:STATUS",function(){me._emitState("EVT:CHESS_PVP:STATE");});
b.on("EVT:CHESS_RULES:NEW_GAME",function(ev){me._onNew(ev);});
b.on("EVT:CHESS_RULES:MOVED",function(ev){me._onMoved(ev);});
b.on("EVT:CHESS_RULES:UNDO",function(ev){me._onUndo(ev);});
},
_emit(ev,p){
try{this._ctx&&this._ctx.bus&&this._ctx.bus.emit(ev,p);}catch(e){this._error("_emit",e);}
},
_error(where,err){
var msg=(err&&err.message)?err.message:String(err||"error");
this._state.lastError=msg;
this._emit("EVT:CHESS_PVP:ERROR",{id:this.id,where:String(where||"unknown"),error:msg,ts:Date.now()});
return null;
},
_touch(){this._state.lastUpdate=Date.now();},
_on(){return !!(this._state.enabled&&this._state.started&&this._state.mounted);},
_sideOk(s){s=String(s||"");return (s==="w"||s==="b")?s:"";},
_opp(s){return (s==="w")?"b":"w";},
_rules(){
return (window.KOG&&window.KOG.CHESS_RULES)?window.KOG.CHESS_RULES:null;
},
mount(payload){
try{
payload=payload||{};
if(payload.cfg){
var c=payload.cfg;
if(c.autoStart!=null)this._state.cfg.autoStart=!!c.autoStart;
if(c.emitOnTurn!=null)this._state.cfg.emitOnTurn=!!c.emitOnTurn;
}
if(payload.seat)this.setSeat(payload.seat);
if(payload.turn)this.setTurn({side:payload.turn});
if(payload.mode)this.setMode(payload.mode);
this._state.mounted=true;
this._touch();
this._emit("EVT:CHESS_PVP:MOUNTED",{id:this.id,ts:Date.now()});
this._emitState("EVT:CHESS_PVP:STATE");
}catch(e){this._error("mount",e);}
},
enable(){try{this._state.enabled=true;this._touch();this._emitState("EVT:CHESS_PVP:STATE");}catch(e){this._error("enable",e);}},
disable(){try{this._state.enabled=false;this._touch();this._emitState("EVT:CHESS_PVP:STATE");}catch(e){this._error("disable",e);}},
start(){
try{
if(!this._state.mounted)this.mount({});
this._state.started=true;
this._touch();
this._emit("EVT:CHESS_PVP:STARTED",{id:this.id,ts:Date.now()});
this._emitTurn("EVT:CHESS_PVP:TURN");
this._emitState("EVT:CHESS_PVP:STATE");
}catch(e){this._error("start",e);}
},
stop(){
try{
this._state.started=false;
this._touch();
this._emit("EVT:CHESS_PVP:STOPPED",{id:this.id,ts:Date.now()});
this._emitState("EVT:CHESS_PVP:STATE");
}catch(e){this._error("stop",e);}
},
setMode(payload){
try{
payload=payload||{};
var m=String(payload.mode||payload.value||payload||"").toUpperCase();
if(m!=="PVP"&&m!=="OFF")m="PVP";
this._state.mode=m;
this._touch();
this._emit("EVT:CHESS_PVP:MODE",{id:this.id,mode:this._state.mode,ts:Date.now()});
this._emitState("EVT:CHESS_PVP:STATE");
}catch(e){this._error("setMode",e);}
},
setSeat(payload){
try{
payload=payload||{};
var p1=this._sideOk(payload.p1||payload.P1||payload.white||"w")||"w";
var p2=this._sideOk(payload.p2||payload.P2||payload.black||"b")||"b";
if(p1===p2)p2=this._opp(p1);
this._state.seat.p1=p1;
this._state.seat.p2=p2;
this._touch();
this._emit("EVT:CHESS_PVP:SEAT",{id:this.id,seat:{p1:p1,p2:p2,active:this._state.seat.active},ts:Date.now()});
this._emitState("EVT:CHESS_PVP:STATE");
}catch(e){this._error("setSeat",e);}
},
setTurn(payload){
try{
payload=payload||{};
var s=this._sideOk(payload.side||payload.turn||payload.value||"");
if(!s)return;
this._state.seat.active=s;
this._touch();
this._emitTurn("EVT:CHESS_PVP:TURN");
this._emitState("EVT:CHESS_PVP:STATE");
}catch(e){this._error("setTurn",e);}
},
lock(payload){
try{
payload=payload||{};
this._state.lockInput=!!(payload.on!=null?payload.on:payload.lock!=null?payload.lock:payload.value);
this._touch();
this._emit("EVT:CHESS_PVP:LOCK",{id:this.id,lock:this._state.lockInput,ts:Date.now()});
this._emitState("EVT:CHESS_PVP:STATE");
}catch(e){this._error("lock",e);}
},
_emitTurn(ev){
try{
if(!this._state.cfg.emitOnTurn)return;
this._emit(ev||"EVT:CHESS_PVP:TURN",{id:this.id,mode:this._state.mode,active:this._state.seat.active,seat:{p1:this._state.seat.p1,p2:this._state.seat.p2},lock:this._state.lockInput,ts:Date.now()});
}catch(e){this._error("_emitTurn",e);}
},
_onNew(ev){
try{
if(!this._on())return;
this._state.meta.moves=0;
this._state.meta.lastMove=null;
this._state.meta.lastTs=Date.now();
var rules=this._rules();
if(rules&&rules.api&&rules.api.get){
var pos=rules.api.get();
var t=pos&&pos.meta?pos.meta.turn:"w";
this._state.seat.active=this._sideOk(t)||"w";
}
this._emitTurn("EVT:CHESS_PVP:TURN");
this._emitState("EVT:CHESS_PVP:STATE");
}catch(e){this._error("_onNew",e);}
},
_onUndo(ev){
try{
if(!this._on())return;
var rules=this._rules();
if(rules&&rules.api&&rules.api.get){
var pos=rules.api.get();
var t=pos&&pos.meta?pos.meta.turn:"w";
this._state.seat.active=this._sideOk(t)||"w";
}
this._emitTurn("EVT:CHESS_PVP:TURN");
this._emitState("EVT:CHESS_PVP:STATE");
}catch(e){this._error("_onUndo",e);}
},
_onMoved(ev){
try{
if(!this._on())return;
if(this._state.mode!=="PVP")return;
if(this._state.lockInput)return;
var rules=this._rules();
if(!rules||!rules.api||!rules.api.get)return;
var pos=rules.api.get();
var t=pos&&pos.meta?pos.meta.turn:"w";
t=this._sideOk(t)||"w";
this._state.seat.active=t;
this._state.meta.moves=(this._state.meta.moves|0)+1;
this._state.meta.lastMove=ev&&ev.move?ev.move:null;
this._state.meta.lastTs=Date.now();
this._emitTurn("EVT:CHESS_PVP:TURN");
this._emitState("EVT:CHESS_PVP:STATE");
}catch(e){this._error("_onMoved",e);}
},
snapshot(){
return {id:this.id,state:this._snapshotState(),ts:Date.now()};
},
_snapshotState(){
return {
enabled:this._state.enabled,mounted:this._state.mounted,started:this._state.started,
mode:this._state.mode,seat:this._state.seat,lockInput:this._state.lockInput,
meta:this._state.meta,cfg:this._state.cfg,lastError:this._state.lastError,ts0:this._state.ts0,lastUpdate:this._state.lastUpdate
};
},
_emitState(ev){
this._emit(ev||"EVT:CHESS_PVP:STATE",{id:this.id,state:this._snapshotState(),ts:Date.now()});
},
status(){return this.snapshot();},
api:{
mount:function(p){return Engine_CHESS_PVP.mount(p);},
enable:function(){return Engine_CHESS_PVP.enable();},
disable:function(){return Engine_CHESS_PVP.disable();},
start:function(){return Engine_CHESS_PVP.start();},
stop:function(){return Engine_CHESS_PVP.stop();},
setMode:function(p){return Engine_CHESS_PVP.setMode(p);},
setSeat:function(p){return Engine_CHESS_PVP.setSeat(p);},
setTurn:function(p){return Engine_CHESS_PVP.setTurn(p);},
lock:function(p){return Engine_CHESS_PVP.lock(p);},
status:function(){return Engine_CHESS_PVP.status();}
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_CHESS_PVP.id]=Engine_CHESS_PVP;
/*-- üë•‚ôüÔ∏è-(6B)-(E)-(PVP-LOCAL-ENGINE)-(HOTSEAT)-(E)-(6B)-‚ôüÔ∏èüë• --*/
/*-- üß©üéõÔ∏è-(7B)-(S)-(GAME-OVERRIDE-PROFILE)-(BOARD/TILES/PIECES)-(S)-(7B)-üéõÔ∏èüß© --*/
const Engine_CHESS_OVERRIDES={
id:"CHESS_OVERRIDES",
_ctx:null,
_state:{
enabled:true,mounted:false,started:false,lastError:null,ts0:0,lastUpdate:0,
keys:{store:"KOG_LEGION_CHESS_OVERRIDES_V1"},
theme:{text:"#9CFF00",glow:"#00FFB7"},
defaults:{
board:{borderGlow:true,borderGlowStrength:1.0,frameAlpha:0.22,frameBlur:6},
tiles:{
light:"#0B0F14",dark:"#070A0F",
lightAlpha:0.22,darkAlpha:0.36,
useGlowTint:true,glowMix:0.22,
gridLines:true,gridAlpha:0.16
},
pieces:{
friendly:"#9CFF00",enemy:"#FF2BD6",
friendlyGlow:"#00FFB7",enemyGlow:"#FF2BD6",
useThemeForFriendly:true,useThemeForEnemy:false,
emojiLayout:0,emojiEnabled:true
},
hud:{fontFamily:"monospace",fontScale:1.0,useThemeText:true,text:"#9CFF00"},
particles:{on:true,dim:0.55,useTheme:true,colorA:"#9CFF00",colorB:"#00FFB7"}
},
override:null
},
init(ctx){
this._ctx=ctx||null;
this._state.ts0=Date.now();
if(!this._ctx||!this._ctx.bus)return this._error("init","missing_ctx_bus");
this._wire();
this._load();
this._emit("EVT:CHESS_OVERRIDES:READY",{id:this.id,ts:Date.now()});
return this;
},
_wire(){
var b=this._ctx.bus,me=this;
b.on("REQ:CHESS_OVERRIDES:MOUNT",function(p){me.mount(p);});
b.on("REQ:CHESS_OVERRIDES:ENABLE",function(){me.enable();});
b.on("REQ:CHESS_OVERRIDES:DISABLE",function(){me.disable();});
b.on("REQ:CHESS_OVERRIDES:START",function(){me.start();});
b.on("REQ:CHESS_OVERRIDES:STOP",function(){me.stop();});
b.on("REQ:CHESS_OVERRIDES:THEME",function(p){me.setTheme(p);});
b.on("REQ:CHESS_OVERRIDES:SET",function(p){me.set(p);});
b.on("REQ:CHESS_OVERRIDES:PATCH",function(p){me.patch(p);});
b.on("REQ:CHESS_OVERRIDES:RESET",function(p){me.reset(p);});
b.on("REQ:CHESS_OVERRIDES:GET",function(){me._emit("EVT:CHESS_OVERRIDES:DATA",me.get());});
b.on("REQ:CHESS_OVERRIDES:STATUS",function(){me._emitState("EVT:CHESS_OVERRIDES:STATE");});
b.on("EVT:MENU_BINDER:THEME_SYNC",function(p){me._onShellTheme(p);});
b.on("EVT:MENU_BINDER:THEME_COMMIT",function(p){me._onShellThemeCommit(p);});
},
_emit(ev,p){
try{this._ctx&&this._ctx.bus&&this._ctx.bus.emit(ev,p);}catch(e){this._error("_emit",e);}
},
_error(where,err){
var msg=(err&&err.message)?err.message:String(err||"error");
this._state.lastError=msg;
this._emit("EVT:CHESS_OVERRIDES:ERROR",{id:this.id,where:String(where||"unknown"),error:msg,ts:Date.now()});
return null;
},
_touch(){this._state.lastUpdate=Date.now();},
_clamp(n,a,b){
n=Number(n);
if(!isFinite(n))n=a;
if(n<a)n=a;
if(n>b)n=b;
return n;
},
_hexOk(s){
s=String(s||"").trim();
if(!s)return "";
if(s[0]!=="#")return "";
if(!(s.length===4||s.length===7))return "";
return s;
},
_deepCopy(o){try{return JSON.parse(JSON.stringify(o));}catch(e){return null;}},
_merge(dst,src){
if(!dst||!src)return dst;
var k=null,v=null;
for(k in src){
if(!Object.prototype.hasOwnProperty.call(src,k))continue;
v=src[k];
if(v&&typeof v==="object"&&!Array.isArray(v)){
if(!dst[k]||typeof dst[k]!=="object")dst[k]={};
this._merge(dst[k],v);
}else dst[k]=v;
}
return dst;
},
_sanitize(o){
try{
o=o||{};
if(!o.board)o.board={};
if(!o.tiles)o.tiles={};
if(!o.pieces)o.pieces={};
if(!o.hud)o.hud={};
if(!o.particles)o.particles={};

if(o.board.borderGlow!=null)o.board.borderGlow=!!o.board.borderGlow;
if(o.board.borderGlowStrength!=null)o.board.borderGlowStrength=this._clamp(o.board.borderGlowStrength,0,3);
if(o.board.frameAlpha!=null)o.board.frameAlpha=this._clamp(o.board.frameAlpha,0,1);
if(o.board.frameBlur!=null)o.board.frameBlur=this._clamp(o.board.frameBlur,0,18);

if(o.tiles.light!=null)o.tiles.light=this._hexOk(o.tiles.light)||o.tiles.light;
if(o.tiles.dark!=null)o.tiles.dark=this._hexOk(o.tiles.dark)||o.tiles.dark;
if(o.tiles.lightAlpha!=null)o.tiles.lightAlpha=this._clamp(o.tiles.lightAlpha,0,1);
if(o.tiles.darkAlpha!=null)o.tiles.darkAlpha=this._clamp(o.tiles.darkAlpha,0,1);
if(o.tiles.useGlowTint!=null)o.tiles.useGlowTint=!!o.tiles.useGlowTint;
if(o.tiles.glowMix!=null)o.tiles.glowMix=this._clamp(o.tiles.glowMix,0,1);
if(o.tiles.gridLines!=null)o.tiles.gridLines=!!o.tiles.gridLines;
if(o.tiles.gridAlpha!=null)o.tiles.gridAlpha=this._clamp(o.tiles.gridAlpha,0,1);

if(o.pieces.friendly!=null)o.pieces.friendly=this._hexOk(o.pieces.friendly)||o.pieces.friendly;
if(o.pieces.enemy!=null)o.pieces.enemy=this._hexOk(o.pieces.enemy)||o.pieces.enemy;
if(o.pieces.friendlyGlow!=null)o.pieces.friendlyGlow=this._hexOk(o.pieces.friendlyGlow)||o.pieces.friendlyGlow;
if(o.pieces.enemyGlow!=null)o.pieces.enemyGlow=this._hexOk(o.pieces.enemyGlow)||o.pieces.enemyGlow;
if(o.pieces.useThemeForFriendly!=null)o.pieces.useThemeForFriendly=!!o.pieces.useThemeForFriendly;
if(o.pieces.useThemeForEnemy!=null)o.pieces.useThemeForEnemy=!!o.pieces.useThemeForEnemy;
if(o.pieces.emojiLayout!=null)o.pieces.emojiLayout=this._clamp(o.pieces.emojiLayout,0,9)|0;
if(o.pieces.emojiEnabled!=null)o.pieces.emojiEnabled=!!o.pieces.emojiEnabled;

if(o.hud.fontFamily!=null)o.hud.fontFamily=String(o.hud.fontFamily||"monospace");
if(o.hud.fontScale!=null)o.hud.fontScale=this._clamp(o.hud.fontScale,0.6,1.8);
if(o.hud.useThemeText!=null)o.hud.useThemeText=!!o.hud.useThemeText;
if(o.hud.text!=null)o.hud.text=this._hexOk(o.hud.text)||o.hud.text;

if(o.particles.on!=null)o.particles.on=!!o.particles.on;
if(o.particles.dim!=null)o.particles.dim=this._clamp(o.particles.dim,0,1);
if(o.particles.useTheme!=null)o.particles.useTheme=!!o.particles.useTheme;
if(o.particles.colorA!=null)o.particles.colorA=this._hexOk(o.particles.colorA)||o.particles.colorA;
if(o.particles.colorB!=null)o.particles.colorB=this._hexOk(o.particles.colorB)||o.particles.colorB;

return o;
}catch(e){this._error("_sanitize",e);return o;}
},
_defaultsResolved(){
var base=this._deepCopy(this._state.defaults)||{};
var t=this._state.theme||{};
if(base.pieces){
if(base.pieces.useThemeForFriendly)base.pieces.friendly=t.text||base.pieces.friendly;
if(base.pieces.useThemeForFriendly)base.pieces.friendlyGlow=t.glow||base.pieces.friendlyGlow;
}
if(base.hud&&base.hud.useThemeText)base.hud.text=t.text||base.hud.text;
if(base.particles&&base.particles.useTheme){
base.particles.colorA=t.text||base.particles.colorA;
base.particles.colorB=t.glow||base.particles.colorB;
}
return base;
},
_resolve(){
var d=this._defaultsResolved();
var o=this._deepCopy(d)||{};
if(this._state.override)this._merge(o,this._state.override);
return this._sanitize(o);
},
_save(){
try{
if(!window.localStorage)return;
var payload={v:1,ts:Date.now(),theme:this._state.theme,override:this._state.override};
localStorage.setItem(this._state.keys.store,JSON.stringify(payload));
}catch(e){}
},
_load(){
try{
if(!window.localStorage)return;
var raw=localStorage.getItem(this._state.keys.store);
if(!raw)return;
var j=JSON.parse(raw);
if(j&&j.override)this._state.override=this._sanitize(j.override);
if(j&&j.theme){
var t=this._hexOk(j.theme.text)||"";
var g=this._hexOk(j.theme.glow)||"";
if(t)this._state.theme.text=t;
if(g)this._state.theme.glow=g;
}
}catch(e){}
},
_onShellTheme(p){
try{
p=p||{};
if(p.theme){
if(p.theme.text)this._state.theme.text=this._hexOk(p.theme.text)||this._state.theme.text;
if(p.theme.glow)this._state.theme.glow=this._hexOk(p.theme.glow)||this._state.theme.glow;
}
this._touch();
this._emit("EVT:CHESS_OVERRIDES:THEME",{id:this.id,theme:this._state.theme,ts:Date.now()});
this._emit("EVT:CHESS_OVERRIDES:RESOLVED",this.get());
}catch(e){this._error("_onShellTheme",e);}
},
_onShellThemeCommit(p){
try{
p=p||{};
if(p.kind==="TEXT"&&p.value)this._state.theme.text=this._hexOk(p.value)||this._state.theme.text;
if(p.kind==="GLOW"&&p.value)this._state.theme.glow=this._hexOk(p.value)||this._state.theme.glow;
this._touch();
this._emit("EVT:CHESS_OVERRIDES:THEME",{id:this.id,theme:this._state.theme,ts:Date.now()});
this._emit("EVT:CHESS_OVERRIDES:RESOLVED",this.get());
}catch(e){this._error("_onShellThemeCommit",e);}
},
mount(payload){
try{
payload=payload||{};
if(payload.theme)this.setTheme(payload.theme);
if(payload.override)this.set(payload.override);
this._state.mounted=true;
this._touch();
this._emit("EVT:CHESS_OVERRIDES:MOUNTED",{id:this.id,ts:Date.now()});
this._emitState("EVT:CHESS_OVERRIDES:STATE");
this._emit("EVT:CHESS_OVERRIDES:RESOLVED",this.get());
}catch(e){this._error("mount",e);}
},
enable(){try{this._state.enabled=true;this._touch();this._emitState("EVT:CHESS_OVERRIDES:STATE");}catch(e){this._error("enable",e);}},
disable(){try{this._state.enabled=false;this._touch();this._emitState("EVT:CHESS_OVERRIDES:STATE");}catch(e){this._error("disable",e);}},
start(){
try{
if(!this._state.mounted)this.mount({});
this._state.started=true;
this._touch();
this._emit("EVT:CHESS_OVERRIDES:STARTED",{id:this.id,ts:Date.now()});
this._emit("EVT:CHESS_OVERRIDES:RESOLVED",this.get());
this._emitState("EVT:CHESS_OVERRIDES:STATE");
}catch(e){this._error("start",e);}
},
stop(){
try{
this._state.started=false;
this._touch();
this._emit("EVT:CHESS_OVERRIDES:STOPPED",{id:this.id,ts:Date.now()});
this._emitState("EVT:CHESS_OVERRIDES:STATE");
}catch(e){this._error("stop",e);}
},
setTheme(payload){
try{
payload=payload||{};
var t=this._hexOk(payload.text||payload.TEXT)||"";
var g=this._hexOk(payload.glow||payload.GLOW)||"";
if(t)this._state.theme.text=t;
if(g)this._state.theme.glow=g;
this._touch();
this._save();
this._emit("EVT:CHESS_OVERRIDES:THEME",{id:this.id,theme:this._state.theme,ts:Date.now()});
this._emit("EVT:CHESS_OVERRIDES:RESOLVED",this.get());
this._emitState("EVT:CHESS_OVERRIDES:STATE");
}catch(e){this._error("setTheme",e);}
},
set(obj){
try{
obj=obj||{};
this._state.override=this._sanitize(this._deepCopy(obj)||obj);
this._touch();
this._save();
this._emit("EVT:CHESS_OVERRIDES:SET",{id:this.id,ts:Date.now()});
this._emit("EVT:CHESS_OVERRIDES:RESOLVED",this.get());
this._emitState("EVT:CHESS_OVERRIDES:STATE");
}catch(e){this._error("set",e);}
},
patch(partial){
try{
partial=partial||{};
if(!this._state.override)this._state.override={};
this._merge(this._state.override,partial);
this._state.override=this._sanitize(this._state.override);
this._touch();
this._save();
this._emit("EVT:CHESS_OVERRIDES:PATCH",{id:this.id,patch:partial,ts:Date.now()});
this._emit("EVT:CHESS_OVERRIDES:RESOLVED",this.get());
this._emitState("EVT:CHESS_OVERRIDES:STATE");
}catch(e){this._error("patch",e);}
},
reset(payload){
try{
payload=payload||{};
var scope=String(payload.scope||payload.id||payload.value||"").toUpperCase();
if(!scope||scope==="ALL"){this._state.override=null;}
else{
if(!this._state.override)this._state.override={};
if(scope==="BOARD")delete this._state.override.board;
if(scope==="TILES")delete this._state.override.tiles;
if(scope==="PIECES")delete this._state.override.pieces;
if(scope==="HUD")delete this._state.override.hud;
if(scope==="PARTICLES")delete this._state.override.particles;
}
this._touch();
this._save();
this._emit("EVT:CHESS_OVERRIDES:RESET",{id:this.id,scope:(scope||"ALL"),ts:Date.now()});
this._emit("EVT:CHESS_OVERRIDES:RESOLVED",this.get());
this._emitState("EVT:CHESS_OVERRIDES:STATE");
}catch(e){this._error("reset",e);}
},
get(){
return {id:this.id,theme:this._state.theme,resolved:this._resolve(),override:this._state.override,ts:Date.now()};
},
snapshot(){
return {id:this.id,state:this._snapshotState(),ts:Date.now()};
},
_snapshotState(){
return {enabled:this._state.enabled,mounted:this._state.mounted,started:this._state.started,lastError:this._state.lastError,ts0:this._state.ts0,lastUpdate:this._state.lastUpdate,theme:this._state.theme,hasOverride:!!this._state.override};
},
_emitState(ev){
this._emit(ev||"EVT:CHESS_OVERRIDES:STATE",{id:this.id,state:this._snapshotState(),ts:Date.now()});
},
status(){return this.snapshot();},
api:{
mount:function(p){return Engine_CHESS_OVERRIDES.mount(p);},
enable:function(){return Engine_CHESS_OVERRIDES.enable();},
disable:function(){return Engine_CHESS_OVERRIDES.disable();},
start:function(){return Engine_CHESS_OVERRIDES.start();},
stop:function(){return Engine_CHESS_OVERRIDES.stop();},
setTheme:function(p){return Engine_CHESS_OVERRIDES.setTheme(p);},
set:function(p){return Engine_CHESS_OVERRIDES.set(p);},
patch:function(p){return Engine_CHESS_OVERRIDES.patch(p);},
reset:function(p){return Engine_CHESS_OVERRIDES.reset(p);},
get:function(){return Engine_CHESS_OVERRIDES.get();},
status:function(){return Engine_CHESS_OVERRIDES.status();}
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_CHESS_OVERRIDES.id]=Engine_CHESS_OVERRIDES;
/*-- üß©üéõÔ∏è-(7B)-(E)-(GAME-OVERRIDE-PROFILE)-(BOARD/TILES/PIECES)-(E)-(7B)-üéõÔ∏èüß© --*/
/*-- üèÅüß±-(8B)-(S)-(RESPONSIVE-BOARD-LAYOUT)-(MAX-FIT)-(S)-(8B)-üß±üèÅ --*/
const Engine_CHESS_LAYOUT={
id:"CHESS_LAYOUT",
_ctx:null,
_state:{
enabled:true,mounted:false,started:false,lastError:null,ts0:0,lastUpdate:0,
config:{
slotId:"C17",
padPx:10,
minBoardPx:220,
maxBoardPx:9999,
respectHeaderFooter:true,
headerSel:'[data-kog="HEADER"],[data-kog="TITLE_BAR"],#kog-header',
footerSel:'[data-kog="FOOTER"],[data-kog="HUD_FOOTER"],#kog-footer',
boardSel:'[data-kog="CHESS_BOARD"],#kog-chess-board',
useCellIfPresent:true
},
metrics:{w:0,h:0,availW:0,availH:0,size:0,left:0,top:0,cellRect:null},
dom:{cell:null,board:null},
_lastResize:0
},
init(ctx){
this._ctx=ctx||null;
this._state.ts0=Date.now();
if(!this._ctx||!this._ctx.bus)return this._error("init","missing_ctx_bus");
this._wire();
this._emit("EVT:CHESS_LAYOUT:READY",{id:this.id,ts:Date.now()});
return this;
},
_wire(){
var b=this._ctx.bus,me=this;
b.on("REQ:CHESS_LAYOUT:MOUNT",function(p){me.mount(p);});
b.on("REQ:CHESS_LAYOUT:ENABLE",function(){me.enable();});
b.on("REQ:CHESS_LAYOUT:DISABLE",function(){me.disable();});
b.on("REQ:CHESS_LAYOUT:START",function(){me.start();});
b.on("REQ:CHESS_LAYOUT:STOP",function(){me.stop();});
b.on("REQ:CHESS_LAYOUT:CONFIG",function(p){me.setConfig(p);});
b.on("REQ:CHESS_LAYOUT:MEASURE",function(){me.measure(true);});
b.on("REQ:CHESS_LAYOUT:STATUS",function(){me._emitState("EVT:CHESS_LAYOUT:STATE");});
},
_emit(ev,p){
try{this._ctx&&this._ctx.bus&&this._ctx.bus.emit(ev,p);}catch(e){this._error("_emit",e);}
},
_error(where,err){
var msg=(err&&err.message)?err.message:String(err||"error");
this._state.lastError=msg;
this._emit("EVT:CHESS_LAYOUT:ERROR",{id:this.id,where:String(where||"unknown"),error:msg,ts:Date.now()});
return null;
},
_touch(){this._state.lastUpdate=Date.now();},
_clamp(n,a,b){
n=Number(n);
if(!isFinite(n))n=a;
if(n<a)n=a;
if(n>b)n=b;
return n;
},
_q(sel){
try{return document.querySelector(sel);}catch(e){return null;}
},
_qAll(sel){
try{return document.querySelectorAll(sel);}catch(e){return [];}
},
_pickFirst(selList){
var i=0,sel="",el=null;
selList=String(selList||"");
if(!selList)return null;
var parts=selList.split(",");
for(i=0;i<parts.length;i++){
sel=String(parts[i]||"").trim();
if(!sel)continue;
el=this._q(sel);
if(el)return el;
}
return null;
},
_rect(el){
try{
if(!el||!el.getBoundingClientRect)return null;
var r=el.getBoundingClientRect();
return {x:r.left,y:r.top,w:r.width,h:r.height};
}catch(e){return null;}
},
_findCell(){
try{
if(!this._state.config.useCellIfPresent)return null;
var slot=String(this._state.config.slotId||"C17");
var el=null;
el=this._q('[data-cell="'+slot+'"]');
if(el)return el;
el=this._q('#'+slot);
if(el)return el;
return null;
}catch(e){return null;}
},
_findBoard(){
try{
var el=this._pickFirst(this._state.config.boardSel);
if(el)return el;
el=this._q('[data-kog="CHESS_BOARD"]');
if(el)return el;
return null;
}catch(e){return null;}
},
_headerFooterHeights(){
try{
if(!this._state.config.respectHeaderFooter)return {top:0,bottom:0};
var hEl=this._pickFirst(this._state.config.headerSel);
var fEl=this._pickFirst(this._state.config.footerSel);
var hr=this._rect(hEl),fr=this._rect(fEl);
return {top:hr?hr.h:0,bottom:fr?fr.h:0};
}catch(e){return {top:0,bottom:0};}
},
measure(emit){
try{
if(!this._state.enabled)return null;
var pad=this._clamp(this._state.config.padPx,0,80);
var minB=this._clamp(this._state.config.minBoardPx,120,1200);
var maxB=this._clamp(this._state.config.maxBoardPx,minB,20000);

var vw=Math.max(0,window.innerWidth||0);
var vh=Math.max(0,window.innerHeight||0);

var hf=this._headerFooterHeights();
var topH=Math.max(0,hf.top||0);
var botH=Math.max(0,hf.bottom||0);

var availW=Math.max(0,vw-(pad*2));
var availH=Math.max(0,vh-(pad*2)-topH-botH);

var cell=this._findCell();
var cellRect=this._rect(cell);

if(cell&&cellRect&&cellRect.w>0&&cellRect.h>0){
availW=Math.max(0,cellRect.w-(pad*2));
availH=Math.max(0,cellRect.h-(pad*2));
}

var size=Math.floor(Math.min(availW,availH));
size=this._clamp(size,minB,maxB);

var left=pad;
var top=pad+topH;

if(cell&&cellRect){
left=Math.round(cellRect.x+((cellRect.w-size)/2));
top=Math.round(cellRect.y+((cellRect.h-size)/2));
}else{
left=Math.round((vw-size)/2);
top=Math.round(topH+((vh-topH-botH-size)/2));
top=Math.max(top,topH+pad);
}

this._state.metrics={w:vw,h:vh,availW:availW,availH:availH,size:size,left:left,top:top,cellRect:cellRect||null};
this._state.dom.cell=cell||null;
this._state.dom.board=this._findBoard();

this._touch();
if(emit)this._emit("EVT:CHESS_LAYOUT:MEASURE",{id:this.id,metrics:this._state.metrics,ts:Date.now()});
return this._state.metrics;
}catch(e){this._error("measure",e);return null;}
},
apply(){
try{
var m=this.measure(false);
if(!m)return;
var board=this._state.dom.board||this._findBoard();
if(!board)return;

board.style.position="fixed";
board.style.left=String(m.left)+"px";
board.style.top=String(m.top)+"px";
board.style.width=String(m.size)+"px";
board.style.height=String(m.size)+"px";
board.style.maxWidth="none";
board.style.maxHeight="none";
board.style.boxSizing="border-box";

this._emit("EVT:CHESS_LAYOUT:APPLIED",{id:this.id,metrics:m,ts:Date.now()});
this._emitState("EVT:CHESS_LAYOUT:STATE");
}catch(e){this._error("apply",e);}
},
_onResize(){
try{
var now=Date.now();
if(now-this._state._lastResize<60)return;
this._state._lastResize=now;
if(!this._state.started)return;
this.apply();
}catch(e){this._error("_onResize",e);}
},
mount(payload){
try{
payload=payload||{};
if(payload.config)this.setConfig(payload.config);
this._state.mounted=true;
this._touch();
this._emit("EVT:CHESS_LAYOUT:MOUNTED",{id:this.id,ts:Date.now()});
this._emitState("EVT:CHESS_LAYOUT:STATE");
}catch(e){this._error("mount",e);}
},
enable(){try{this._state.enabled=true;this._touch();this._emitState("EVT:CHESS_LAYOUT:STATE");}catch(e){this._error("enable",e);}},
disable(){try{this._state.enabled=false;this._touch();this._emitState("EVT:CHESS_LAYOUT:STATE");}catch(e){this._error("disable",e);}},
start(){
try{
if(!this._state.mounted)this.mount({});
if(this._state.started)return;
this._state.started=true;
window.addEventListener("resize",this._onResize.bind(this),{passive:true});
window.addEventListener("orientationchange",this._onResize.bind(this),{passive:true});
this.apply();
this._emit("EVT:CHESS_LAYOUT:STARTED",{id:this.id,ts:Date.now()});
this._emitState("EVT:CHESS_LAYOUT:STATE");
}catch(e){this._error("start",e);}
},
stop(){
try{
this._state.started=false;
this._emit("EVT:CHESS_LAYOUT:STOPPED",{id:this.id,ts:Date.now()});
this._emitState("EVT:CHESS_LAYOUT:STATE");
}catch(e){this._error("stop",e);}
},
setConfig(partial){
try{
partial=partial||{};
var c=this._state.config;
if(partial.slotId!=null)c.slotId=String(partial.slotId||"C17");
if(partial.padPx!=null)c.padPx=this._clamp(partial.padPx,0,80);
if(partial.minBoardPx!=null)c.minBoardPx=this._clamp(partial.minBoardPx,120,1400);
if(partial.maxBoardPx!=null)c.maxBoardPx=this._clamp(partial.maxBoardPx,c.minBoardPx,20000);
if(partial.respectHeaderFooter!=null)c.respectHeaderFooter=!!partial.respectHeaderFooter;
if(partial.headerSel!=null)c.headerSel=String(partial.headerSel||c.headerSel);
if(partial.footerSel!=null)c.footerSel=String(partial.footerSel||c.footerSel);
if(partial.boardSel!=null)c.boardSel=String(partial.boardSel||c.boardSel);
if(partial.useCellIfPresent!=null)c.useCellIfPresent=!!partial.useCellIfPresent;
this._touch();
if(this._state.started)this.apply();
this._emitState("EVT:CHESS_LAYOUT:STATE");
}catch(e){this._error("setConfig",e);}
},
snapshot(){
return {id:this.id,state:this._snapshotState(),ts:Date.now()};
},
_snapshotState(){
return {enabled:this._state.enabled,mounted:this._state.mounted,started:this._state.started,lastError:this._state.lastError,ts0:this._state.ts0,lastUpdate:this._state.lastUpdate,config:this._state.config,metrics:this._state.metrics};
},
_emitState(ev){
this._emit(ev||"EVT:CHESS_LAYOUT:STATE",{id:this.id,state:this._snapshotState(),ts:Date.now()});
},
status(){return this.snapshot();},
api:{
mount:function(p){return Engine_CHESS_LAYOUT.mount(p);},
enable:function(){return Engine_CHESS_LAYOUT.enable();},
disable:function(){return Engine_CHESS_LAYOUT.disable();},
start:function(){return Engine_CHESS_LAYOUT.start();},
stop:function(){return Engine_CHESS_LAYOUT.stop();},
setConfig:function(p){return Engine_CHESS_LAYOUT.setConfig(p);},
measure:function(){return Engine_CHESS_LAYOUT.measure(true);},
apply:function(){return Engine_CHESS_LAYOUT.apply();},
status:function(){return Engine_CHESS_LAYOUT.status();}
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_CHESS_LAYOUT.id]=Engine_CHESS_LAYOUT;
/*-- üèÅüß±-(8B)-(E)-(RESPONSIVE-BOARD-LAYOUT)-(MAX-FIT)-(E)-(8B)-üß±üèÅ --*/
/*-- ‚ôüÔ∏èüßø-(9B)-(S)-(RENDER-BOARD-ENGINE)-(CANVAS/DOM)-(S)-(9B)-üßø‚ôüÔ∏è --*/
const Engine_CHESS_BOARD_RENDER={
id:"CHESS_BOARD",
_ctx:null,
_state:{
enabled:true,mounted:false,started:false,lastError:null,ts0:0,lastUpdate:0,
theme:{text:"#9CFF00",glow:"#00FFB7"},
config:{
slotId:"C17",
boardId:"kog-chess-board",
zIndex:22000,
bgA:"rgba(0,0,0,0.18)",
bgB:"rgba(0,0,0,0.06)",
tileLight:"rgba(255,255,255,0.08)",
tileDark:"rgba(0,0,0,0.18)",
tileGlowAlpha:0.18,
lineAlpha:0.22,
radius:18,
borderW:2,
shadowBlur:16,
useCanvas:true,
dprCap:2.0
},
dom:{slot:null,root:null,canvas:null,ctx:null,overlay:null},
metrics:{size:0,dpr:1,cssW:0,cssH:0,pxW:0,pxH:0},
board:{
tiles:new Array(64),
flip:false
}
},
init(ctx){
this._ctx=ctx||null;
this._state.ts0=Date.now();
if(!this._ctx||!this._ctx.bus)return this._error("init","missing_ctx_bus");
this._wire();
this._emit("EVT:CHESS_BOARD:READY",{id:this.id,ts:Date.now()});
return this;
},
_wire(){
var b=this._ctx.bus,me=this;
b.on("REQ:CHESS_BOARD:MOUNT",function(p){me.mount(p);});
b.on("REQ:CHESS_BOARD:ENABLE",function(){me.enable();});
b.on("REQ:CHESS_BOARD:DISABLE",function(){me.disable();});
b.on("REQ:CHESS_BOARD:START",function(){me.start();});
b.on("REQ:CHESS_BOARD:STOP",function(){me.stop();});
b.on("REQ:CHESS_BOARD:THEME",function(p){me.setTheme(p);});
b.on("REQ:CHESS_BOARD:CONFIG",function(p){me.setConfig(p);});
b.on("REQ:CHESS_BOARD:RENDER",function(){me.render();});
b.on("REQ:CHESS_BOARD:FLIP",function(p){me.setFlip(p);});
b.on("REQ:CHESS_BOARD:STATUS",function(){me._emitState("EVT:CHESS_BOARD:STATE");});
},
_emit(ev,p){
try{this._ctx&&this._ctx.bus&&this._ctx.bus.emit(ev,p);}catch(e){this._error("_emit",e);}
},
_error(where,err){
var msg=(err&&err.message)?err.message:String(err||"error");
this._state.lastError=msg;
this._emit("EVT:CHESS_BOARD:ERROR",{id:this.id,where:String(where||"unknown"),error:msg,ts:Date.now()});
return null;
},
_touch(){this._state.lastUpdate=Date.now();},
_clamp(n,a,b){
n=Number(n);
if(!isFinite(n))n=a;
if(n<a)n=a;
if(n>b)n=b;
return n;
},
_hexOk(s){
s=String(s||"").trim();
if(!s)return "";
if(s[0]!=="#")return "";
if(!(s.length===4||s.length===7))return "";
return s;
},
_q(sel){
try{return document.querySelector(sel);}catch(e){return null;}
},
_findSlot(){
try{
var slot=String(this._state.config.slotId||"C17");
var el=null;
el=this._q('[data-cell="'+slot+'"]');
if(el)return el;
el=this._q("#"+slot);
if(el)return el;
return document.body;
}catch(e){return document.body;}
},
_cssVar(name,fallback){
try{
var v=getComputedStyle(document.documentElement).getPropertyValue(name);
v=(v||"").trim();
return v||fallback;
}catch(e){return fallback;}
},
_applyThemeVars(){
try{
var t=this._state.theme.text||this._cssVar("--kog-text","#9CFF00");
var g=this._state.theme.glow||this._cssVar("--kog-glow","#00FFB7");
this._state.theme.text=t;
this._state.theme.glow=g;
if(!this._state.dom.root)return;
this._state.dom.root.style.setProperty("--cb-text",t);
this._state.dom.root.style.setProperty("--cb-glow",g);
}catch(e){this._error("_applyThemeVars",e);}
},
_build(){
try{
if(this._state.dom.root)return;
var slot=this._findSlot();

var root=document.createElement("div");
root.id=this._state.config.boardId;
root.setAttribute("data-kog","CHESS_BOARD");
root.style.position="fixed";
root.style.left="0";
root.style.top="0";
root.style.width="320px";
root.style.height="320px";
root.style.zIndex=String(this._state.config.zIndex||22000);
root.style.pointerEvents="auto";
root.style.userSelect="none";
root.style.webkitUserSelect="none";
root.style.touchAction="none";
root.style.border=String(this._state.config.borderW||2)+"px solid var(--cb-glow)";
root.style.borderRadius=String(this._state.config.radius||18)+"px";
root.style.boxShadow="0 0 "+String(this._state.config.shadowBlur||16)+"px var(--cb-glow)";
root.style.background="linear-gradient(180deg,"+String(this._state.config.bgA)+","+String(this._state.config.bgB)+")";
root.style.overflow="hidden";
root.style.boxSizing="border-box";
root.style.setProperty("--cb-text",this._state.theme.text);
root.style.setProperty("--cb-glow",this._state.theme.glow);

var canvas=document.createElement("canvas");
canvas.style.width="100%";
canvas.style.height="100%";
canvas.style.display="block";
canvas.style.position="absolute";
canvas.style.left="0";
canvas.style.top="0";

var overlay=document.createElement("div");
overlay.setAttribute("data-kog","CHESS_OVERLAY");
overlay.style.position="absolute";
overlay.style.left="0";
overlay.style.top="0";
overlay.style.width="100%";
overlay.style.height="100%";
overlay.style.pointerEvents="none";

root.appendChild(canvas);
root.appendChild(overlay);

slot.appendChild(root);

this._state.dom.slot=slot;
this._state.dom.root=root;
this._state.dom.canvas=canvas;
this._state.dom.ctx=canvas.getContext("2d",{alpha:true,desynchronized:true});
this._state.dom.overlay=overlay;

this._applyThemeVars();
this._touch();
}catch(e){this._error("_build",e);}
},
_setCanvasSize(px){
try{
var c=this._state.dom.canvas,ctx=this._state.dom.ctx;
if(!c||!ctx)return;
var dpr=this._state.metrics.dpr||1;
var w=Math.max(1,Math.round(px*dpr));
var h=Math.max(1,Math.round(px*dpr));
c.width=w;
c.height=h;
this._state.metrics.pxW=w;
this._state.metrics.pxH=h;
}catch(e){this._error("_setCanvasSize",e);}
},
_syncLayout(){
try{
var root=this._state.dom.root;
if(!root)return;
var m=null;
if(window.KOG&&window.KOG.CHESS_LAYOUT&&window.KOG.CHESS_LAYOUT.api&&window.KOG.CHESS_LAYOUT.api.measure)m=window.KOG.CHESS_LAYOUT.api.measure();
if(!m||!m.size){
var r=root.getBoundingClientRect();
m={size:Math.round(Math.min(r.width,r.height)),left:Math.round(r.left),top:Math.round(r.top)};
}
var cssW=Math.max(1,Math.round(m.size));
var cssH=cssW;

var dpr=1;
try{dpr=(window.devicePixelRatio||1);}catch(e){dpr=1;}
dpr=this._clamp(dpr,1,Number(this._state.config.dprCap||2.0));

this._state.metrics.size=cssW;
this._state.metrics.cssW=cssW;
this._state.metrics.cssH=cssH;
this._state.metrics.dpr=dpr;

root.style.width=String(cssW)+"px";
root.style.height=String(cssH)+"px";

this._setCanvasSize(cssW);
}catch(e){this._error("_syncLayout",e);}
},
_drawBoard(){
try{
var ctx=this._state.dom.ctx,c=this._state.dom.canvas,root=this._state.dom.root;
if(!ctx||!c||!root)return;
var t=this._state.theme.text,g=this._state.theme.glow;
var a=this._state.config.tileLight;
var b=this._state.config.tileDark;
var lineA=this._clamp(this._state.config.lineAlpha,0,1);
var glowA=this._clamp(this._state.config.tileGlowAlpha,0,1);
var dpr=this._state.metrics.dpr||1;
var size=this._state.metrics.cssW||320;
var pxW=this._state.metrics.pxW||c.width;
var pxH=this._state.metrics.pxH||c.height;

ctx.setTransform(1,0,0,1,0,0);
ctx.clearRect(0,0,pxW,pxH);
ctx.scale(dpr,dpr);

var s=size;
var tile=s/8;
var i=0,x=0,y=0,ix=0,iy=0,isLight=false;

ctx.save();
ctx.lineWidth=1;
ctx.strokeStyle="rgba(255,255,255,"+String(lineA)+")";

for(iy=0;iy<8;iy++){
for(ix=0;ix<8;ix++){
isLight=((ix+iy)%2)===0;
x=ix*tile;
y=iy*tile;
ctx.fillStyle=isLight?a:b;
ctx.fillRect(x,y,tile,tile);
}
}

ctx.strokeStyle="rgba(255,255,255,"+String(lineA)+")";
for(i=1;i<8;i++){
ctx.beginPath();
ctx.moveTo(i*tile,0);
ctx.lineTo(i*tile,s);
ctx.stroke();
ctx.beginPath();
ctx.moveTo(0,i*tile);
ctx.lineTo(s,i*tile);
ctx.stroke();
}

ctx.globalAlpha=glowA;
ctx.strokeStyle=g;
ctx.lineWidth=2;
ctx.strokeRect(1,1,s-2,s-2);
ctx.globalAlpha=1;

ctx.restore();

this._emit("EVT:CHESS_BOARD:RENDERED",{id:this.id,ts:Date.now()});
}catch(e){this._error("_drawBoard",e);}
},
render(){
try{
if(!this._state.enabled||!this._state.started)return;
this._syncLayout();
this._applyThemeVars();
this._drawBoard();
this._touch();
this._emitState("EVT:CHESS_BOARD:STATE");
}catch(e){this._error("render",e);}
},
setFlip(payload){
try{
payload=payload||{};
var v=(payload.flip!=null)?!!payload.flip:((payload.value!=null)?!!payload.value:false);
this._state.board.flip=v;
this.render();
this._emit("EVT:CHESS_BOARD:FLIP",{id:this.id,flip:v,ts:Date.now()});
}catch(e){this._error("setFlip",e);}
},
mount(payload){
try{
payload=payload||{};
if(payload.config)this.setConfig(payload.config);
if(payload.theme)this.setTheme(payload.theme);
this._build();
this._state.mounted=true;
this._touch();
this._emit("EVT:CHESS_BOARD:MOUNTED",{id:this.id,ts:Date.now()});
this._emitState("EVT:CHESS_BOARD:STATE");
}catch(e){this._error("mount",e);}
},
enable(){try{this._state.enabled=true;this._touch();this._emitState("EVT:CHESS_BOARD:STATE");}catch(e){this._error("enable",e);}},
disable(){try{this._state.enabled=false;this._touch();this._emitState("EVT:CHESS_BOARD:STATE");}catch(e){this._error("disable",e);}},
start(){
try{
if(!this._state.mounted)this.mount({});
if(this._state.started)return;
this._state.started=true;
this._syncLayout();
if(window.KOG&&window.KOG.CHESS_LAYOUT&&window.KOG.CHESS_LAYOUT.api&&window.KOG.CHESS_LAYOUT.api.start)window.KOG.CHESS_LAYOUT.api.start();
this.render();
this._emit("EVT:CHESS_BOARD:STARTED",{id:this.id,ts:Date.now()});
this._emitState("EVT:CHESS_BOARD:STATE");
}catch(e){this._error("start",e);}
},
stop(){
try{
this._state.started=false;
this._emit("EVT:CHESS_BOARD:STOPPED",{id:this.id,ts:Date.now()});
this._emitState("EVT:CHESS_BOARD:STATE");
}catch(e){this._error("stop",e);}
},
setTheme(payload){
try{
payload=payload||{};
var t=this._hexOk(payload.text)||this._hexOk(payload.TEXT)||"";
var g=this._hexOk(payload.glow)||this._hexOk(payload.GLOW)||"";
if(t)this._state.theme.text=t;
if(g)this._state.theme.glow=g;
this._applyThemeVars();
if(this._state.started)this.render();
this._emit("EVT:CHESS_BOARD:THEME",{id:this.id,theme:{text:this._state.theme.text,glow:this._state.theme.glow},ts:Date.now()});
this._emitState("EVT:CHESS_BOARD:STATE");
}catch(e){this._error("setTheme",e);}
},
setConfig(partial){
try{
partial=partial||{};
var c=this._state.config;
if(partial.slotId!=null)c.slotId=String(partial.slotId||"C17");
if(partial.boardId!=null)c.boardId=String(partial.boardId||"kog-chess-board");
if(partial.zIndex!=null)c.zIndex=this._clamp(partial.zIndex,1000,999999);
if(partial.bgA!=null)c.bgA=String(partial.bgA||c.bgA);
if(partial.bgB!=null)c.bgB=String(partial.bgB||c.bgB);
if(partial.tileLight!=null)c.tileLight=String(partial.tileLight||c.tileLight);
if(partial.tileDark!=null)c.tileDark=String(partial.tileDark||c.tileDark);
if(partial.tileGlowAlpha!=null)c.tileGlowAlpha=this._clamp(partial.tileGlowAlpha,0,1);
if(partial.lineAlpha!=null)c.lineAlpha=this._clamp(partial.lineAlpha,0,1);
if(partial.radius!=null)c.radius=this._clamp(partial.radius,0,60);
if(partial.borderW!=null)c.borderW=this._clamp(partial.borderW,0,8);
if(partial.shadowBlur!=null)c.shadowBlur=this._clamp(partial.shadowBlur,0,60);
if(partial.useCanvas!=null)c.useCanvas=!!partial.useCanvas;
if(partial.dprCap!=null)c.dprCap=this._clamp(partial.dprCap,1,4);

if(this._state.dom.root){
this._state.dom.root.style.zIndex=String(c.zIndex);
this._state.dom.root.style.border=String(c.borderW)+"px solid var(--cb-glow)";
this._state.dom.root.style.borderRadius=String(c.radius)+"px";
this._state.dom.root.style.boxShadow="0 0 "+String(c.shadowBlur)+"px var(--cb-glow)";
this._state.dom.root.style.background="linear-gradient(180deg,"+String(c.bgA)+","+String(c.bgB)+")";
}

this._touch();
if(this._state.started)this.render();
this._emitState("EVT:CHESS_BOARD:STATE");
}catch(e){this._error("setConfig",e);}
},
snapshot(){return {id:this.id,state:this._snapshotState(),ts:Date.now()};},
_snapshotState(){
return {
enabled:this._state.enabled,mounted:this._state.mounted,started:this._state.started,lastError:this._state.lastError,
theme:{text:this._state.theme.text,glow:this._state.theme.glow},
config:this._state.config,
metrics:this._state.metrics,
flip:this._state.board.flip
};
},
_emitState(ev){
this._emit(ev||"EVT:CHESS_BOARD:STATE",{id:this.id,state:this._snapshotState(),ts:Date.now()});
},
status(){return this.snapshot();},
api:{
mount:function(p){return Engine_CHESS_BOARD_RENDER.mount(p);},
enable:function(){return Engine_CHESS_BOARD_RENDER.enable();},
disable:function(){return Engine_CHESS_BOARD_RENDER.disable();},
start:function(){return Engine_CHESS_BOARD_RENDER.start();},
stop:function(){return Engine_CHESS_BOARD_RENDER.stop();},
render:function(){return Engine_CHESS_BOARD_RENDER.render();},
setTheme:function(p){return Engine_CHESS_BOARD_RENDER.setTheme(p);},
setConfig:function(p){return Engine_CHESS_BOARD_RENDER.setConfig(p);},
setFlip:function(p){return Engine_CHESS_BOARD_RENDER.setFlip(p);},
status:function(){return Engine_CHESS_BOARD_RENDER.status();}
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_CHESS_BOARD_RENDER.id]=Engine_CHESS_BOARD_RENDER;
/*-- ‚ôüÔ∏èüßø-(9B)-(E)-(RENDER-BOARD-ENGINE)-(CANVAS/DOM)-(E)-(9B)-üßø‚ôüÔ∏è --*/
/*-- ‚ôüÔ∏è‚ú®-(10B)-(S)-(PIECE-RENDER-ENGINE)-(REAL+MICRO-EMOJI)-(S)-(10B)-‚ú®‚ôüÔ∏è --*/
const Engine_CHESS_PIECE_RENDER={
id:"CHESS_PIECES",
_ctx:null,
_state:{
enabled:true,mounted:false,started:false,lastError:null,ts0:0,lastUpdate:0,
theme:{text:"#9CFF00",glow:"#00FFB7"},
config:{
zIndex:22110,
baseOpacity:0.98,
outerGlowPx:10,
emojiGlowPx:6,
shadowA:0.55,
shadowB:0.25,
fontFamily:'"Trebuchet MS",Verdana,Arial,sans-serif',
symbolWeight:900,
symbolScale:0.84,
emojiScale:0.20,
emojiPad:0.06,
useSystemEmojiFont:true,
pieceLight:"#F2F2F2",
pieceDark:"#111111",
enemyTint:"",
allyTint:"",
showMicroEmoji:true,
microEmojiSet:"DEFAULT"
},
dom:{boardRoot:null,layer:null},
metrics:{size:0,tile:0,flip:false},
pieces:{list:[]}
},
init(ctx){
this._ctx=ctx||null;
this._state.ts0=Date.now();
if(!this._ctx||!this._ctx.bus)return this._error("init","missing_ctx_bus");
this._wire();
this._emit("EVT:CHESS_PIECES:READY",{id:this.id,ts:Date.now()});
return this;
},
_wire(){
var b=this._ctx.bus,me=this;
b.on("REQ:CHESS_PIECES:MOUNT",function(p){me.mount(p);});
b.on("REQ:CHESS_PIECES:ENABLE",function(){me.enable();});
b.on("REQ:CHESS_PIECES:DISABLE",function(){me.disable();});
b.on("REQ:CHESS_PIECES:START",function(){me.start();});
b.on("REQ:CHESS_PIECES:STOP",function(){me.stop();});
b.on("REQ:CHESS_PIECES:THEME",function(p){me.setTheme(p);});
b.on("REQ:CHESS_PIECES:CONFIG",function(p){me.setConfig(p);});
b.on("REQ:CHESS_PIECES:SYNC_LAYOUT",function(p){me.syncLayout(p);});
b.on("REQ:CHESS_PIECES:SET_POSITIONS",function(p){me.setPositions(p);});
b.on("REQ:CHESS_PIECES:RENDER",function(){me.render();});
b.on("EVT:CHESS_BOARD:STATE",function(p){me._onBoardState(p);});
b.on("EVT:CHESS_EMOJI:LAYOUT",function(p){me._onEmojiLayout(p);});
b.on("EVT:CHESS_OVERRIDES:APPLY",function(p){me._onOverrides(p);});
},
_emit(ev,p){
try{this._ctx&&this._ctx.bus&&this._ctx.bus.emit(ev,p);}catch(e){this._error("_emit",e);}
},
_error(where,err){
var msg=(err&&err.message)?err.message:String(err||"error");
this._state.lastError=msg;
this._emit("EVT:CHESS_PIECES:ERROR",{id:this.id,where:String(where||"unknown"),error:msg,ts:Date.now()});
return null;
},
_touch(){this._state.lastUpdate=Date.now();},
_clamp(n,a,b){
n=Number(n);
if(!isFinite(n))n=a;
if(n<a)n=a;
if(n>b)n=b;
return n;
},
_hexOk(s){
s=String(s||"").trim();
if(!s)return "";
if(s[0]!=="#")return "";
if(!(s.length===4||s.length===7))return "";
return s;
},
_cssVar(name,fallback){
try{
var v=getComputedStyle(document.documentElement).getPropertyValue(name);
v=(v||"").trim();
return v||fallback;
}catch(e){return fallback;}
},
_applyThemeVars(){
try{
var t=this._state.theme.text||this._cssVar("--kog-text","#9CFF00");
var g=this._state.theme.glow||this._cssVar("--kog-glow","#00FFB7");
this._state.theme.text=t;
this._state.theme.glow=g;
if(!this._state.dom.layer)return;
this._state.dom.layer.style.setProperty("--cp-text",t);
this._state.dom.layer.style.setProperty("--cp-glow",g);
}catch(e){this._error("_applyThemeVars",e);}
},
_findBoardRoot(){
try{
if(window.KOG&&window.KOG.CHESS_BOARD&&window.KOG.CHESS_BOARD._state&&window.KOG.CHESS_BOARD._state.dom&&window.KOG.CHESS_BOARD._state.dom.root)return window.KOG.CHESS_BOARD._state.dom.root;
var id="kog-chess-board";
var el=document.getElementById(id);
if(el)return el;
el=document.querySelector('[data-kog="CHESS_BOARD"]');
if(el)return el;
return null;
}catch(e){return null;}
},
_build(){
try{
if(this._state.dom.layer)return;
var board=this._findBoardRoot();
if(!board)return this._error("_build","missing_board_root");
var layer=document.createElement("div");
layer.setAttribute("data-kog","CHESS_PIECE_LAYER");
layer.style.position="absolute";
layer.style.left="0";
layer.style.top="0";
layer.style.width="100%";
layer.style.height="100%";
layer.style.pointerEvents="none";
layer.style.zIndex=String(this._state.config.zIndex||22110);
layer.style.setProperty("--cp-text",this._state.theme.text);
layer.style.setProperty("--cp-glow",this._state.theme.glow);
layer.style.fontFamily=this._state.config.fontFamily;
layer.style.userSelect="none";
layer.style.webkitUserSelect="none";
board.appendChild(layer);

this._state.dom.boardRoot=board;
this._state.dom.layer=layer;

this._applyThemeVars();
this._touch();
}catch(e){this._error("_build",e);}
},
syncLayout(payload){
try{
payload=payload||{};
if(payload.tile!=null)this._state.metrics.tile=Number(payload.tile)||this._state.metrics.tile;
if(payload.size!=null)this._state.metrics.size=Number(payload.size)||this._state.metrics.size;
if(payload.flip!=null)this._state.metrics.flip=!!payload.flip;
this._touch();
this.render();
}catch(e){this._error("syncLayout",e);}
},
_setPiecesDefault(){
try{
this._state.pieces.list=[
{id:"wK",side:"W",type:"K",x:4,y:7},
{id:"wQ",side:"W",type:"Q",x:3,y:7},
{id:"wR1",side:"W",type:"R",x:0,y:7},
{id:"wR2",side:"W",type:"R",x:7,y:7},
{id:"wB1",side:"W",type:"B",x:2,y:7},
{id:"wB2",side:"W",type:"B",x:5,y:7},
{id:"wN1",side:"W",type:"N",x:1,y:7},
{id:"wN2",side:"W",type:"N",x:6,y:7},
{id:"wP1",side:"W",type:"P",x:0,y:6},
{id:"wP2",side:"W",type:"P",x:1,y:6},
{id:"wP3",side:"W",type:"P",x:2,y:6},
{id:"wP4",side:"W",type:"P",x:3,y:6},
{id:"wP5",side:"W",type:"P",x:4,y:6},
{id:"wP6",side:"W",type:"P",x:5,y:6},
{id:"wP7",side:"W",type:"P",x:6,y:6},
{id:"wP8",side:"W",type:"P",x:7,y:6},

{id:"bK",side:"B",type:"K",x:4,y:0},
{id:"bQ",side:"B",type:"Q",x:3,y:0},
{id:"bR1",side:"B",type:"R",x:0,y:0},
{id:"bR2",side:"B",type:"R",x:7,y:0},
{id:"bB1",side:"B",type:"B",x:2,y:0},
{id:"bB2",side:"B",type:"B",x:5,y:0},
{id:"bN1",side:"B",type:"N",x:1,y:0},
{id:"bN2",side:"B",type:"N",x:6,y:0},
{id:"bP1",side:"B",type:"P",x:0,y:1},
{id:"bP2",side:"B",type:"P",x:1,y:1},
{id:"bP3",side:"B",type:"P",x:2,y:1},
{id:"bP4",side:"B",type:"P",x:3,y:1},
{id:"bP5",side:"B",type:"P",x:4,y:1},
{id:"bP6",side:"B",type:"P",x:5,y:1},
{id:"bP7",side:"B",type:"P",x:6,y:1},
{id:"bP8",side:"B",type:"P",x:7,y:1}
];
}catch(e){this._error("_setPiecesDefault",e);}
},
setPositions(payload){
try{
payload=payload||{};
var list=payload.list||payload.pieces||null;
if(!list||!list.length)return;
this._state.pieces.list=list;
this._touch();
this.render();
}catch(e){this._error("setPositions",e);}
},
_symbolFor(piece){
var t=String(piece.type||"").toUpperCase();
var s=String(piece.side||"W").toUpperCase();
if(s==="W"){
if(t==="K")return "‚ôî";
if(t==="Q")return "‚ôï";
if(t==="R")return "‚ôñ";
if(t==="B")return "‚ôó";
if(t==="N")return "‚ôò";
return "‚ôô";
}else{
if(t==="K")return "‚ôö";
if(t==="Q")return "‚ôõ";
if(t==="R")return "‚ôú";
if(t==="B")return "‚ôù";
if(t==="N")return "‚ôû";
return "‚ôü";
}
},
_pieceFill(piece){
try{
var cfg=this._state.config;
var s=String(piece.side||"W").toUpperCase();
var base=(s==="W")?cfg.pieceLight:cfg.pieceDark;
var tint=(s==="W")?(cfg.allyTint||""):(cfg.enemyTint||"");
tint=this._hexOk(tint);
return tint||base;
}catch(e){return "#FFF";}
},
_pieceStroke(piece){
var g=this._state.theme.glow;
return g;
},
_pickMicroEmoji(piece){
try{
if(window.KOG&&window.KOG.CHESS_EMOJI&&window.KOG.CHESS_EMOJI.api&&window.KOG.CHESS_EMOJI.api.pick)return window.KOG.CHESS_EMOJI.api.pick(piece);
}catch(e){}
var t=String(piece.type||"P").toUpperCase();
if(t==="K")return "üëë";
if(t==="Q")return "üíé";
if(t==="R")return "üè∞";
if(t==="B")return "üßô";
if(t==="N")return "üê¥";
return "üß©";
},
_clearLayer(){
try{
var layer=this._state.dom.layer;
if(!layer)return;
layer.innerHTML="";
}catch(e){this._error("_clearLayer",e);}
},
_renderOne(piece,tile){
try{
var layer=this._state.dom.layer;
if(!layer)return;
var x=Number(piece.x)||0,y=Number(piece.y)||0;
x=this._clamp(x,0,7);
y=this._clamp(y,0,7);

var flip=!!this._state.metrics.flip;
var drawX=flip?(7-x):x;
var drawY=flip?(7-y):y;

var left=(drawX*tile);
var top=(drawY*tile);

var box=document.createElement("div");
box.setAttribute("data-piece",String(piece.id||""));
box.style.position="absolute";
box.style.left=String(left)+"px";
box.style.top=String(top)+"px";
box.style.width=String(tile)+"px";
box.style.height=String(tile)+"px";
box.style.display="flex";
box.style.alignItems="center";
box.style.justifyContent="center";
box.style.pointerEvents="none";

var glyph=document.createElement("div");
glyph.textContent=this._symbolFor(piece);
glyph.style.fontFamily=this._state.config.fontFamily;
glyph.style.fontWeight=String(this._state.config.symbolWeight||900);
glyph.style.fontSize=String(Math.max(12,Math.round(tile*this._state.config.symbolScale)))+"px";
glyph.style.lineHeight="1";
glyph.style.opacity=String(this._state.config.baseOpacity||0.98);

var fill=this._pieceFill(piece);
var glow=this._state.theme.glow;

glyph.style.color=fill;
glyph.style.textShadow=
"0 0 "+String(Math.round(this._state.config.outerGlowPx||10))+"px "+glow+","+
"0 3px 0 rgba(0,0,0,"+String(this._state.config.shadowA||0.55)+"),"+
"0 10px 18px rgba(0,0,0,"+String(this._state.config.shadowB||0.25)+")";

box.appendChild(glyph);

if(this._state.config.showMicroEmoji){
var emo=document.createElement("div");
emo.setAttribute("data-emo","1");
emo.textContent=this._pickMicroEmoji(piece);
emo.style.position="absolute";
emo.style.left="50%";
emo.style.bottom=String(Math.round(tile*this._state.config.emojiPad))+"px";
emo.style.transform="translateX(-50%)";
emo.style.fontSize=String(Math.max(10,Math.round(tile*this._state.config.emojiScale)))+"px";
emo.style.lineHeight="1";
emo.style.filter="drop-shadow(0 0 "+String(Math.round(this._state.config.emojiGlowPx||6))+"px "+this._state.theme.glow+")";
emo.style.opacity="0.92";
emo.style.pointerEvents="none";
box.appendChild(emo);
}

layer.appendChild(box);
}catch(e){this._error("_renderOne",e);}
},
render(){
try{
if(!this._state.enabled||!this._state.started)return;
if(!this._state.dom.layer)this._build();
if(!this._state.dom.layer)return;
this._applyThemeVars();

var tile=this._state.metrics.tile||0;
var size=this._state.metrics.size||0;

if(!tile||!size){
try{
if(window.KOG&&window.KOG.CHESS_LAYOUT&&window.KOG.CHESS_LAYOUT.api&&window.KOG.CHESS_LAYOUT.api.measure){
var m=window.KOG.CHESS_LAYOUT.api.measure();
if(m&&m.size){size=m.size;tile=size/8;}
}
}catch(e){}
}

if(!tile){
var br=this._state.dom.boardRoot.getBoundingClientRect();
size=Math.round(Math.min(br.width,br.height));
tile=size/8;
}

this._state.metrics.size=size;
this._state.metrics.tile=tile;

this._clearLayer();

var list=this._state.pieces.list||[];
var i=0;
for(i=0;i<list.length;i++)this._renderOne(list[i],tile);

this._touch();
this._emit("EVT:CHESS_PIECES:RENDERED",{id:this.id,count:list.length,ts:Date.now()});
this._emitState("EVT:CHESS_PIECES:STATE");
}catch(e){this._error("render",e);}
},
_onBoardState(p){
try{
p=p||{};
var st=p.state||p;
if(!st||!st.metrics)return;
this.syncLayout({size:st.metrics.cssW||st.metrics.size,tile:(st.metrics.cssW||st.metrics.size)/8,flip:!!st.flip});
}catch(e){this._error("_onBoardState",e);}
},
_onEmojiLayout(p){
try{
p=p||{};
if(p.show!=null)this._state.config.showMicroEmoji=!!p.show;
if(p.emojiScale!=null)this._state.config.emojiScale=this._clamp(p.emojiScale,0.10,0.42);
if(p.emojiPad!=null)this._state.config.emojiPad=this._clamp(p.emojiPad,0.00,0.18);
this.render();
}catch(e){this._error("_onEmojiLayout",e);}
},
_onOverrides(p){
try{
p=p||{};
var o=p.overrides||p;
if(!o)return;
if(o.pieceLight!=null)this._state.config.pieceLight=String(o.pieceLight||this._state.config.pieceLight);
if(o.pieceDark!=null)this._state.config.pieceDark=String(o.pieceDark||this._state.config.pieceDark);
if(o.enemyTint!=null)this._state.config.enemyTint=String(o.enemyTint||"");
if(o.allyTint!=null)this._state.config.allyTint=String(o.allyTint||"");
if(o.fontFamily!=null)this._state.config.fontFamily=String(o.fontFamily||this._state.config.fontFamily);
if(o.showMicroEmoji!=null)this._state.config.showMicroEmoji=!!o.showMicroEmoji;
if(o.emojiScale!=null)this._state.config.emojiScale=this._clamp(o.emojiScale,0.10,0.42);
this.render();
}catch(e){this._error("_onOverrides",e);}
},
mount(payload){
try{
payload=payload||{};
if(payload.config)this.setConfig(payload.config);
if(payload.theme)this.setTheme(payload.theme);
this._build();
if(!this._state.pieces.list||!this._state.pieces.list.length)this._setPiecesDefault();
this._state.mounted=true;
this._touch();
this._emit("EVT:CHESS_PIECES:MOUNTED",{id:this.id,ts:Date.now()});
this._emitState("EVT:CHESS_PIECES:STATE");
}catch(e){this._error("mount",e);}
},
enable(){try{this._state.enabled=true;this._touch();this._emitState("EVT:CHESS_PIECES:STATE");}catch(e){this._error("enable",e);}},
disable(){try{this._state.enabled=false;this._touch();this._emitState("EVT:CHESS_PIECES:STATE");}catch(e){this._error("disable",e);}},
start(){
try{
if(!this._state.mounted)this.mount({});
this._state.started=true;
this.render();
this._emit("EVT:CHESS_PIECES:STARTED",{id:this.id,ts:Date.now()});
this._emitState("EVT:CHESS_PIECES:STATE");
}catch(e){this._error("start",e);}
},
stop(){
try{
this._state.started=false;
this._emit("EVT:CHESS_PIECES:STOPPED",{id:this.id,ts:Date.now()});
this._emitState("EVT:CHESS_PIECES:STATE");
}catch(e){this._error("stop",e);}
},
setTheme(payload){
try{
payload=payload||{};
var t=this._hexOk(payload.text)||this._hexOk(payload.TEXT)||"";
var g=this._hexOk(payload.glow)||this._hexOk(payload.GLOW)||"";
if(t)this._state.theme.text=t;
if(g)this._state.theme.glow=g;
this._applyThemeVars();
if(this._state.started)this.render();
this._emit("EVT:CHESS_PIECES:THEME",{id:this.id,theme:{text:this._state.theme.text,glow:this._state.theme.glow},ts:Date.now()});
this._emitState("EVT:CHESS_PIECES:STATE");
}catch(e){this._error("setTheme",e);}
},
setConfig(partial){
try{
partial=partial||{};
var c=this._state.config;
if(partial.zIndex!=null)c.zIndex=this._clamp(partial.zIndex,1000,999999);
if(partial.fontFamily!=null)c.fontFamily=String(partial.fontFamily||c.fontFamily);
if(partial.pieceLight!=null)c.pieceLight=String(partial.pieceLight||c.pieceLight);
if(partial.pieceDark!=null)c.pieceDark=String(partial.pieceDark||c.pieceDark);
if(partial.enemyTint!=null)c.enemyTint=String(partial.enemyTint||"");
if(partial.allyTint!=null)c.allyTint=String(partial.allyTint||"");
if(partial.showMicroEmoji!=null)c.showMicroEmoji=!!partial.showMicroEmoji;
if(partial.emojiScale!=null)c.emojiScale=this._clamp(partial.emojiScale,0.10,0.42);
if(partial.emojiPad!=null)c.emojiPad=this._clamp(partial.emojiPad,0.00,0.18);
if(partial.outerGlowPx!=null)c.outerGlowPx=this._clamp(partial.outerGlowPx,0,30);
if(partial.emojiGlowPx!=null)c.emojiGlowPx=this._clamp(partial.emojiGlowPx,0,24);
if(this._state.dom.layer){
this._state.dom.layer.style.zIndex=String(c.zIndex);
this._state.dom.layer.style.fontFamily=c.fontFamily;
}
this._touch();
if(this._state.started)this.render();
this._emitState("EVT:CHESS_PIECES:STATE");
}catch(e){this._error("setConfig",e);}
},
snapshot(){return {id:this.id,state:this._snapshotState(),ts:Date.now()};},
_snapshotState(){
return {
enabled:this._state.enabled,mounted:this._state.mounted,started:this._state.started,lastError:this._state.lastError,
theme:{text:this._state.theme.text,glow:this._state.theme.glow},
config:this._state.config,
metrics:this._state.metrics,
count:(this._state.pieces.list||[]).length
};
},
_emitState(ev){
this._emit(ev||"EVT:CHESS_PIECES:STATE",{id:this.id,state:this._snapshotState(),ts:Date.now()});
},
status(){return this.snapshot();},
api:{
mount:function(p){return Engine_CHESS_PIECE_RENDER.mount(p);},
enable:function(){return Engine_CHESS_PIECE_RENDER.enable();},
disable:function(){return Engine_CHESS_PIECE_RENDER.disable();},
start:function(){return Engine_CHESS_PIECE_RENDER.start();},
stop:function(){return Engine_CHESS_PIECE_RENDER.stop();},
render:function(){return Engine_CHESS_PIECE_RENDER.render();},
setTheme:function(p){return Engine_CHESS_PIECE_RENDER.setTheme(p);},
setConfig:function(p){return Engine_CHESS_PIECE_RENDER.setConfig(p);},
setPositions:function(p){return Engine_CHESS_PIECE_RENDER.setPositions(p);},
syncLayout:function(p){return Engine_CHESS_PIECE_RENDER.syncLayout(p);},
status:function(){return Engine_CHESS_PIECE_RENDER.status();}
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_CHESS_PIECE_RENDER.id]=Engine_CHESS_PIECE_RENDER;
/*-- ‚ôüÔ∏è‚ú®-(10B)-(E)-(PIECE-RENDER-ENGINE)-(REAL+MICRO-EMOJI)-(E)-(10B)-‚ú®‚ôüÔ∏è --*/
/*-- üß∑üòÄ-(11B)-(S)-(EMOJI-INFUSION-PACK)-(10-LAYOUTS)-(S)-(11B)-üòÄüß∑ --*/
const Engine_CHESS_EMOJI_PACK={
id:"CHESS_EMOJI",
_ctx:null,
_state:{
enabled:true,mounted:false,started:false,lastError:null,ts0:0,lastUpdate:0,
cfg:{
activeLayout:0,
layoutsCount:10,
show:true,
emojiScale:0.20,
emojiPad:0.06,
glowPx:6,
setId:"DEFAULT",
enemySetId:"DEFAULT",
allySetId:"DEFAULT",
fallbackByType:{K:"üëë",Q:"üíé",R:"üè∞",B:"üßô",N:"üê¥",P:"üß©"},
sets:{
DEFAULT:{K:["üëë","ü¶Å","üß†"],Q:["üíé","ü™Ñ","ü¶Ñ"],R:["üè∞","üß±","üöÄ"],B:["üßô","üîÆ","üïØÔ∏è"],N:["üê¥","‚ö°","ü•∑"],P:["üß©","üî•","‚ú®"]},
FIRE:{K:["üî•","üëë","üåã"],Q:["üíé","üî•","ü´ß"],R:["üè∞","üî•","üß±"],B:["üßô","üî•","üîÆ"],N:["üê¥","üî•","‚ö°"],P:["üî•","üß©","‚ú®"]},
ICE:{K:["‚ùÑÔ∏è","üëë","üßä"],Q:["üíé","‚ùÑÔ∏è","ü´ß"],R:["üè∞","‚ùÑÔ∏è","üß±"],B:["üßô","‚ùÑÔ∏è","üîÆ"],N:["üê¥","‚ùÑÔ∏è","‚ö°"],P:["‚ùÑÔ∏è","üß©","‚ú®"]},
NEON:{K:["üíö","üëë","‚ö°"],Q:["üíú","üíé","‚ú®"],R:["üü©","üè∞","üß±"],B:["üü¶","üßô","üîÆ"],N:["üü®","üê¥","‚ö°"],P:["üü•","üß©","‚ú®"]},
ARCANE:{K:["üëë","üîÆ","üúÅ"],Q:["üíé","ü™Ñ","üúÇ"],R:["üè∞","üß±","üúÉ"],B:["üßô","üïØÔ∏è","üúÑ"],N:["üê¥","‚ö°","ü™Ñ"],P:["üß©","‚ú®","üîÆ"]}
},
layoutFns:[]
}
},
init(ctx){
this._ctx=ctx||null;
this._state.ts0=Date.now();
if(!this._ctx||!this._ctx.bus)return this._error("init","missing_ctx_bus");
this._buildLayouts();
this._wire();
this._emit("EVT:CHESS_EMOJI:READY",{id:this.id,ts:Date.now()});
return this;
},
_wire(){
var b=this._ctx.bus,me=this;
b.on("REQ:CHESS_EMOJI:MOUNT",function(p){me.mount(p);});
b.on("REQ:CHESS_EMOJI:ENABLE",function(){me.enable();});
b.on("REQ:CHESS_EMOJI:DISABLE",function(){me.disable();});
b.on("REQ:CHESS_EMOJI:START",function(){me.start();});
b.on("REQ:CHESS_EMOJI:STOP",function(){me.stop();});
b.on("REQ:CHESS_EMOJI:CONFIG",function(p){me.setConfig(p);});
b.on("REQ:CHESS_EMOJI:SET_LAYOUT",function(p){me.setLayout(p);});
b.on("REQ:CHESS_EMOJI:SET_SET",function(p){me.setSet(p);});
b.on("REQ:CHESS_EMOJI:TOGGLE",function(p){me.toggle(p);});
},
_emit(ev,p){
try{this._ctx&&this._ctx.bus&&this._ctx.bus.emit(ev,p);}catch(e){this._error("_emit",e);}
},
_error(where,err){
var msg=(err&&err.message)?err.message:String(err||"error");
this._state.lastError=msg;
this._emit("EVT:CHESS_EMOJI:ERROR",{id:this.id,where:String(where||"unknown"),error:msg,ts:Date.now()});
return null;
},
_touch(){this._state.lastUpdate=Date.now();},
_clamp(n,a,b){
n=Number(n);
if(!isFinite(n))n=a;
if(n<a)n=a;
if(n>b)n=b;
return n;
},
_str(s,f){
s=(s==null)?"":String(s);
s=s.trim();
return s||String(f||"");
},
_buildLayouts(){
var me=this,c=this._state.cfg;
c.layoutFns.length=0;

c.layoutFns.push(function(){return {x:0.50,y:0.84,scale:1.00,rot:0,alpha:0.92};});
c.layoutFns.push(function(){return {x:0.50,y:0.16,scale:1.00,rot:0,alpha:0.92};});
c.layoutFns.push(function(){return {x:0.16,y:0.84,scale:0.95,rot:0,alpha:0.92};});
c.layoutFns.push(function(){return {x:0.84,y:0.84,scale:0.95,rot:0,alpha:0.92};});
c.layoutFns.push(function(){return {x:0.16,y:0.16,scale:0.95,rot:0,alpha:0.92};});
c.layoutFns.push(function(){return {x:0.84,y:0.16,scale:0.95,rot:0,alpha:0.92};});
c.layoutFns.push(function(){return {x:0.50,y:0.74,scale:1.05,rot:0,alpha:0.92};});
c.layoutFns.push(function(){return {x:0.50,y:0.90,scale:0.88,rot:0,alpha:0.92};});
c.layoutFns.push(function(){return {x:0.50,y:0.84,scale:1.00,rot:8,alpha:0.90};});
c.layoutFns.push(function(){return {x:0.50,y:0.84,scale:1.00,rot:-8,alpha:0.90};});

c.layoutsCount=c.layoutFns.length;
},
_resolveSetId(side){
var c=this._state.cfg;
side=String(side||"").toUpperCase();
if(side==="W")return c.allySetId||c.setId||"DEFAULT";
if(side==="B")return c.enemySetId||c.setId||"DEFAULT";
return c.setId||"DEFAULT";
},
_pickFromSet(setId,type,seed){
var c=this._state.cfg;
type=String(type||"P").toUpperCase();
setId=this._str(setId,"DEFAULT");
var set=c.sets[setId]||c.sets.DEFAULT||{};
var arr=set[type]||null;
if(!arr||!arr.length)return c.fallbackByType[type]||"üß©";
seed=Number(seed)||0;
var idx=Math.abs(seed)%arr.length;
return arr[idx];
},
hash32(s){
s=this._str(s,"");
var h=2166136261,i=0;
for(i=0;i<s.length;i++){h^=s.charCodeAt(i);h=(h*16777619)>>>0;}
return h>>>0;
},
layoutFor(piece){
var c=this._state.cfg;
var idx=this._clamp(c.activeLayout,0,c.layoutsCount-1);
var fn=c.layoutFns[idx]||c.layoutFns[0];
var o=fn?fn():{x:0.5,y:0.84,scale:1,rot:0,alpha:0.92};
o.x=this._clamp(o.x,0,1);
o.y=this._clamp(o.y,0,1);
o.scale=this._clamp(o.scale,0.5,1.6);
o.rot=this._clamp(o.rot,-25,25);
o.alpha=this._clamp(o.alpha,0.0,1.0);
return o;
},
pick(piece){
try{
var c=this._state.cfg;
if(!c.show)return "";
piece=piece||{};
var side=String(piece.side||"W").toUpperCase();
var type=String(piece.type||"P").toUpperCase();
var setId=this._resolveSetId(side);
var seed=this.hash32(String(piece.id||"")+":"+String(piece.type||"")+":"+String(piece.side||"")+":"+String(c.activeLayout));
return this._pickFromSet(setId,type,seed);
}catch(e){this._error("pick",e);return "üß©";}
},
applyToPieceLayerEmit(){
try{
var c=this._state.cfg;
this._emit("EVT:CHESS_EMOJI:LAYOUT",{id:this.id,layout:c.activeLayout,show:c.show,emojiScale:c.emojiScale,emojiPad:c.emojiPad,glowPx:c.glowPx,setId:c.setId,enemySetId:c.enemySetId,allySetId:c.allySetId,ts:Date.now()});
this._emitState("EVT:CHESS_EMOJI:STATE");
}catch(e){this._error("applyToPieceLayerEmit",e);}
},
mount(payload){
try{
payload=payload||{};
if(payload.config)this.setConfig(payload.config);
this._state.mounted=true;
this._touch();
this.applyToPieceLayerEmit();
this._emit("EVT:CHESS_EMOJI:MOUNTED",{id:this.id,ts:Date.now()});
}catch(e){this._error("mount",e);}
},
enable(){try{this._state.enabled=true;this._touch();this._emitState("EVT:CHESS_EMOJI:STATE");}catch(e){this._error("enable",e);}},
disable(){try{this._state.enabled=false;this._touch();this._emitState("EVT:CHESS_EMOJI:STATE");}catch(e){this._error("disable",e);}},
start(){
try{
if(!this._state.mounted)this.mount({});
this._state.started=true;
this.applyToPieceLayerEmit();
this._emit("EVT:CHESS_EMOJI:STARTED",{id:this.id,ts:Date.now()});
}catch(e){this._error("start",e);}
},
stop(){
try{
this._state.started=false;
this._emit("EVT:CHESS_EMOJI:STOPPED",{id:this.id,ts:Date.now()});
this._emitState("EVT:CHESS_EMOJI:STATE");
}catch(e){this._error("stop",e);}
},
setConfig(partial){
try{
partial=partial||{};
var c=this._state.cfg;
if(partial.activeLayout!=null)c.activeLayout=this._clamp(partial.activeLayout,0,c.layoutsCount-1);
if(partial.show!=null)c.show=!!partial.show;
if(partial.emojiScale!=null)c.emojiScale=this._clamp(partial.emojiScale,0.10,0.42);
if(partial.emojiPad!=null)c.emojiPad=this._clamp(partial.emojiPad,0.00,0.18);
if(partial.glowPx!=null)c.glowPx=this._clamp(partial.glowPx,0,24);
if(partial.setId!=null)c.setId=this._str(partial.setId,c.setId);
if(partial.enemySetId!=null)c.enemySetId=this._str(partial.enemySetId,c.enemySetId);
if(partial.allySetId!=null)c.allySetId=this._str(partial.allySetId,c.allySetId);
this._touch();
this.applyToPieceLayerEmit();
}catch(e){this._error("setConfig",e);}
},
setLayout(p){
try{
p=p||{};
var v=(p.index!=null)?p.index:((p.layout!=null)?p.layout:p);
this._state.cfg.activeLayout=this._clamp(v,0,this._state.cfg.layoutsCount-1);
this._touch();
this.applyToPieceLayerEmit();
}catch(e){this._error("setLayout",e);}
},
setSet(p){
try{
p=p||{};
var c=this._state.cfg;
if(p.setId!=null)c.setId=this._str(p.setId,c.setId);
if(p.enemySetId!=null)c.enemySetId=this._str(p.enemySetId,c.enemySetId);
if(p.allySetId!=null)c.allySetId=this._str(p.allySetId,c.allySetId);
this._touch();
this.applyToPieceLayerEmit();
}catch(e){this._error("setSet",e);}
},
toggle(p){
try{
p=p||{};
var c=this._state.cfg;
if(p.show!=null)c.show=!!p.show;
else c.show=!c.show;
this._touch();
this.applyToPieceLayerEmit();
}catch(e){this._error("toggle",e);}
},
snapshot(){return {id:this.id,state:this._snapshotState(),ts:Date.now()};},
_snapshotState(){
var c=this._state.cfg;
return {enabled:this._state.enabled,mounted:this._state.mounted,started:this._state.started,lastError:this._state.lastError,activeLayout:c.activeLayout,layoutsCount:c.layoutsCount,show:c.show,emojiScale:c.emojiScale,emojiPad:c.emojiPad,glowPx:c.glowPx,setId:c.setId,enemySetId:c.enemySetId,allySetId:c.allySetId};
},
_emitState(ev){
this._emit(ev||"EVT:CHESS_EMOJI:STATE",{id:this.id,state:this._snapshotState(),ts:Date.now()});
},
api:{
mount:function(p){return Engine_CHESS_EMOJI_PACK.mount(p);},
start:function(){return Engine_CHESS_EMOJI_PACK.start();},
stop:function(){return Engine_CHESS_EMOJI_PACK.stop();},
setConfig:function(p){return Engine_CHESS_EMOJI_PACK.setConfig(p);},
setLayout:function(p){return Engine_CHESS_EMOJI_PACK.setLayout(p);},
setSet:function(p){return Engine_CHESS_EMOJI_PACK.setSet(p);},
toggle:function(p){return Engine_CHESS_EMOJI_PACK.toggle(p);},
pick:function(piece){return Engine_CHESS_EMOJI_PACK.pick(piece);},
layoutFor:function(piece){return Engine_CHESS_EMOJI_PACK.layoutFor(piece);},
status:function(){return Engine_CHESS_EMOJI_PACK.snapshot();}
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_CHESS_EMOJI_PACK.id]=Engine_CHESS_EMOJI_PACK;
/*-- üß∑üòÄ-(11B)-(E)-(EMOJI-INFUSION-PACK)-(10-LAYOUTS)-(E)-(11B)-üòÄüß∑ --*/
/*-- üéØüëÜ-(12B)-(S)-(INPUT-SELECT-MOVE)-(HIGHLIGHT-MOVES)-(S)-(12B)-üëÜüéØ --*/
const Engine_CHESS_INPUT_SELECT_MOVE={
id:"CHESS_INPUT",
_ctx:null,
_state:{
mounted:false,started:false,enabled:true,lastError:null,ts0:0,
hoverSq:-1,downSq:-1,selSq:-1,selId:"",
dragging:false,
legalCache:null,
lastTapTs:0,
cfg:{
tapMode:true,
dragMode:true,
allowReselect:true,
emitHover:true,
emitCursor:true,
autoDeselectOnMiss:true,
preferCaptureHint:true
}
},
init(ctx){
this._ctx=ctx||null;
this._state.ts0=Date.now();
if(!this._ctx||!this._ctx.bus)return this._error("init","missing_ctx_bus");
this._wire();
this._emit("EVT:CHESS_INPUT:READY",{id:this.id,ts:Date.now()});
return this;
},
_wire(){
var b=this._ctx.bus,me=this;
b.on("REQ:CHESS_INPUT:MOUNT",function(p){me.mount(p);});
b.on("REQ:CHESS_INPUT:START",function(){me.start();});
b.on("REQ:CHESS_INPUT:STOP",function(){me.stop();});
b.on("REQ:CHESS_INPUT:ENABLE",function(){me.enable();});
b.on("REQ:CHESS_INPUT:DISABLE",function(){me.disable();});
b.on("REQ:CHESS_INPUT:RESET",function(){me.reset();});
b.on("EVT:CHESS_BOARD:POINTER",function(p){me.onPointer(p);});
b.on("EVT:CHESS_GAME:STATE",function(p){me.onGameState(p);});
b.on("EVT:CHESS_RULES:LEGAL_MOVES",function(p){me.onLegalMoves(p);});
},
_emit(ev,p){
try{this._ctx&&this._ctx.bus&&this._ctx.bus.emit(ev,p);}catch(e){this._error("_emit",e);}
},
_error(where,err){
var msg=(err&&err.message)?err.message:String(err||"error");
this._state.lastError=msg;
this._emit("EVT:CHESS_INPUT:ERROR",{id:this.id,where:String(where||"unknown"),error:msg,ts:Date.now()});
return null;
},
_touch(){},
_clamp(n,a,b){
n=Number(n);
if(!isFinite(n))n=a;
if(n<a)n=a;
if(n>b)n=b;
return n;
},
_sqi(x,y){return (y<<3)|x;},
_xyi(sq){return {x:sq&7,y:(sq>>3)&7};},
_same(a,b){return Number(a)===Number(b);},
_isDown(t){t=String(t||"");return (t==="down"||t==="pointerdown"||t==="touchstart"||t==="mousedown");},
_isUp(t){t=String(t||"");return (t==="up"||t==="pointerup"||t==="touchend"||t==="mouseup");},
_isMove(t){t=String(t||"");return (t==="move"||t==="pointermove"||t==="touchmove"||t==="mousemove");},
mount(p){
try{
p=p||{};
if(p.config)this.setConfig(p.config);
this._state.mounted=true;
this._emit("EVT:CHESS_INPUT:MOUNTED",{id:this.id,ts:Date.now()});
}catch(e){this._error("mount",e);}
},
start(){
try{
if(!this._state.mounted)this.mount({});
this._state.started=true;
this._emit("EVT:CHESS_INPUT:STARTED",{id:this.id,ts:Date.now()});
}catch(e){this._error("start",e);}
},
stop(){
try{
this._state.started=false;
this._emit("EVT:CHESS_INPUT:STOPPED",{id:this.id,ts:Date.now()});
}catch(e){this._error("stop",e);}
},
enable(){this._state.enabled=true;this._emitState();},
disable(){this._state.enabled=false;this._emitState();},
reset(){
this._state.hoverSq=-1;
this._state.downSq=-1;
this._state.selSq=-1;
this._state.selId="";
this._state.dragging=false;
this._state.legalCache=null;
this._emit("EVT:CHESS_INPUT:RESET",{id:this.id,ts:Date.now()});
this._emit("EVT:CHESS_HILITE:CLEAR",{id:this.id,ts:Date.now()});
this._emitState();
},
setConfig(partial){
try{
partial=partial||{};
var c=this._state.cfg;
if(partial.tapMode!=null)c.tapMode=!!partial.tapMode;
if(partial.dragMode!=null)c.dragMode=!!partial.dragMode;
if(partial.allowReselect!=null)c.allowReselect=!!partial.allowReselect;
if(partial.emitHover!=null)c.emitHover=!!partial.emitHover;
if(partial.emitCursor!=null)c.emitCursor=!!partial.emitCursor;
if(partial.autoDeselectOnMiss!=null)c.autoDeselectOnMiss=!!partial.autoDeselectOnMiss;
if(partial.preferCaptureHint!=null)c.preferCaptureHint=!!partial.preferCaptureHint;
this._emitState();
}catch(e){this._error("setConfig",e);}
},
_emitState(){
this._emit("EVT:CHESS_INPUT:STATE",{id:this.id,state:{mounted:this._state.mounted,started:this._state.started,enabled:this._state.enabled,hoverSq:this._state.hoverSq,downSq:this._state.downSq,selSq:this._state.selSq,selId:this._state.selId,dragging:this._state.dragging},ts:Date.now()});
},
onGameState(p){
try{
p=p||{};
if(p.reset===true)this.reset();
if(p.turnLocked===true)this._emit("EVT:CHESS_HILITE:LOCK",{id:this.id,ts:Date.now()});
if(p.turnLocked===false)this._emit("EVT:CHESS_HILITE:UNLOCK",{id:this.id,ts:Date.now()});
}catch(e){this._error("onGameState",e);}
},
onLegalMoves(p){
try{
p=p||{};
if(!p||p.forSq==null)return;
this._state.legalCache={forSq:Number(p.forSq),moves:p.moves||[],meta:p.meta||{}};
}catch(e){this._error("onLegalMoves",e);}
},
onPointer(p){
try{
if(!this._state.enabled||!this._state.started)return;
p=p||{};
var type=String(p.type||"");
var sq=(p.sq==null)?-1:Number(p.sq);
if(this._isMove(type))return this._onMove(p,sq);
if(this._isDown(type))return this._onDown(p,sq);
if(this._isUp(type))return this._onUp(p,sq);
}catch(e){this._error("onPointer",e);}
},
_onMove(p,sq){
var c=this._state.cfg;
if(c.emitHover){
if(!this._same(this._state.hoverSq,sq)){
this._state.hoverSq=sq;
this._emit("EVT:CHESS_INPUT:HOVER",{id:this.id,sq:sq,ts:Date.now()});
}
}
if(c.emitCursor)this._emit("EVT:CHESS_INPUT:CURSOR",{id:this.id,sq:sq,inside:(sq>=0&&sq<64),ts:Date.now()});
if(this._state.dragging&&this._state.selSq>=0&&sq>=0){
this._emit("EVT:CHESS_INPUT:DRAG_OVER",{id:this.id,fromSq:this._state.selSq,toSq:sq,ts:Date.now()});
}
},
_onDown(p,sq){
this._state.downSq=sq;
if(sq<0)return;
if(this._state.cfg.dragMode&&this._state.selSq===sq)this._state.dragging=true;
this._emit("EVT:CHESS_INPUT:DOWN",{id:this.id,sq:sq,ts:Date.now()});
},
_onUp(p,sq){
var now=Date.now();
var wasDownSq=this._state.downSq;
this._state.downSq=-1;
this._emit("EVT:CHESS_INPUT:UP",{id:this.id,sq:sq,ts:now});
if(this._state.dragging){
this._state.dragging=false;
if(this._state.selSq>=0&&sq>=0&&!this._same(this._state.selSq,sq))return this._tryMove(this._state.selSq,sq,"drag");
}
if(!this._state.cfg.tapMode)return;
if(wasDownSq>=0&&sq>=0&&!this._same(wasDownSq,sq))return;
return this._tapSquare(sq,now);
},
_tapSquare(sq,now){
if(sq<0)return;
var sel=this._state.selSq;
if(sel<0)return this._selectAttempt(sq,now);
if(this._same(sel,sq)){
if(this._state.cfg.allowReselect){
this._emit("REQ:CHESS_RULES:LEGAL_MOVES",{fromSq:sq,reason:"reselect",ts:now});
this._emit("EVT:CHESS_INPUT:RESELECT",{id:this.id,sq:sq,ts:now});
}
return;
}
return this._tryMove(sel,sq,"tap");
},
_selectAttempt(sq,now){
this._emit("REQ:CHESS_GAME:PIECE_AT",{sq:sq,ts:now,reqId:"sel_"+now});
this._emit("EVT:CHESS_INPUT:SELECT_ATTEMPT",{id:this.id,sq:sq,ts:now});
},
confirmSelect(payload){
try{
payload=payload||{};
var sq=(payload.sq==null)?-1:Number(payload.sq);
var piece=payload.piece||null;
if(!piece||sq<0){
if(this._state.cfg.autoDeselectOnMiss)this._missDeselect();
return;
}
this._state.selSq=sq;
this._state.selId=String(piece.id||"");
this._emit("REQ:CHESS_RULES:LEGAL_MOVES",{fromSq:sq,reason:"select",ts:Date.now()});
this._emit("EVT:CHESS_INPUT:SELECTED",{id:this.id,sq:sq,pieceId:this._state.selId,ts:Date.now()});
this._emit("EVT:CHESS_HILITE:FOCUS",{id:this.id,sq:sq,ts:Date.now()});
},
catch(e){this._error("confirmSelect",e);}
},
_missDeselect(){
this._state.selSq=-1;
this._state.selId="";
this._emit("EVT:CHESS_INPUT:DESELECT",{id:this.id,ts:Date.now()});
this._emit("EVT:CHESS_HILITE:CLEAR",{id:this.id,ts:Date.now()});
this._emitState();
},
_tryMove(fromSq,toSq,mode){
var legal=this._state.legalCache;
var ok=false,move=null,i=0,arr=null;
if(legal&&Number(legal.forSq)===Number(fromSq)){
arr=legal.moves||[];
for(i=0;i<arr.length;i++){
if(Number(arr[i].toSq)===Number(toSq)){ok=true;move=arr[i];break;}
}
}
this._emit("EVT:CHESS_INPUT:MOVE_ATTEMPT",{id:this.id,fromSq:fromSq,toSq:toSq,mode:String(mode||"tap"),legalKnown:!!legal,ok:ok,ts:Date.now()});
if(!ok){
this._emit("EVT:CHESS_HILITE:ILLEGAL",{id:this.id,fromSq:fromSq,toSq:toSq,ts:Date.now()});
return;
}
this._emit("REQ:CHESS_GAME:MAKE_MOVE",{fromSq:fromSq,toSq:toSq,move:move||{fromSq:fromSq,toSq:toSq},ts:Date.now()});
},
api:{
mount:function(p){return Engine_CHESS_INPUT_SELECT_MOVE.mount(p);},
start:function(){return Engine_CHESS_INPUT_SELECT_MOVE.start();},
stop:function(){return Engine_CHESS_INPUT_SELECT_MOVE.stop();},
enable:function(){return Engine_CHESS_INPUT_SELECT_MOVE.enable();},
disable:function(){return Engine_CHESS_INPUT_SELECT_MOVE.disable();},
reset:function(){return Engine_CHESS_INPUT_SELECT_MOVE.reset();},
setConfig:function(p){return Engine_CHESS_INPUT_SELECT_MOVE.setConfig(p);},
confirmSelect:function(p){return Engine_CHESS_INPUT_SELECT_MOVE.confirmSelect(p);},
status:function(){return {id:Engine_CHESS_INPUT_SELECT_MOVE.id,state:Engine_CHESS_INPUT_SELECT_MOVE._state,ts:Date.now()};}
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_CHESS_INPUT_SELECT_MOVE.id]=Engine_CHESS_INPUT_SELECT_MOVE;
/*-- üéØüëÜ-(12B)-(E)-(INPUT-SELECT-MOVE)-(HIGHLIGHT-MOVES)-(E)-(12B)-üëÜüéØ --*/
/*-- üü¢üß≠-(13B)-(S)-(MOVE-HIGHLIGHT-FX)-(GLOW-GRID)-(S)-(13B)-üß≠üü¢ --*/
const Engine_CHESS_MOVE_HILITE_FX={
id:"CHESS_HILITE",
_ctx:null,
_state:{
mounted:false,started:false,enabled:true,lastError:null,ts0:0,
root:null,
layer:null,
grid:null,
markers:null,
focus:null,
lock:false,
cfg:{
glowPx:10,
glowOpacity:0.85,
gridOpacity:0.55,
legalOpacity:0.85,
captureOpacity:0.9,
illegalOpacity:0.9,
focusOpacity:0.95,
borderPx:2,
radiusPx:10,
useBlend:true,
zIndex:50
},
theme:{
text:"#ffffff",
glow:"#00ffcc",
enemy:"#ff3366",
ally:"#00aaff",
tileA:"#111111",
tileB:"#222222",
boardBg:"#000000"
},
layout:{
boardRect:{x:0,y:0,w:0,h:0},
cellSize:0,
originX:0,
originY:0
}
},
init(ctx){
this._ctx=ctx||null;
this._state.ts0=Date.now();
if(!this._ctx||!this._ctx.bus)return this._error("init","missing_ctx_bus");
this._wire();
this._emit("EVT:CHESS_HILITE:READY",{id:this.id,ts:Date.now()});
return this;
},
_wire(){
var b=this._ctx.bus,me=this;
b.on("REQ:CHESS_HILITE:MOUNT",function(p){me.mount(p);});
b.on("REQ:CHESS_HILITE:START",function(){me.start();});
b.on("REQ:CHESS_HILITE:STOP",function(){me.stop();});
b.on("REQ:CHESS_HILITE:ENABLE",function(){me.enable();});
b.on("REQ:CHESS_HILITE:DISABLE",function(){me.disable();});
b.on("REQ:CHESS_HILITE:SET_CFG",function(p){me.setCfg(p);});
b.on("EVT:CHESS_THEME:SYNC",function(p){me.onTheme(p);});
b.on("EVT:CHESS_BOARD:LAYOUT",function(p){me.onLayout(p);});
b.on("EVT:CHESS_INPUT:HOVER",function(p){me.onHover(p);});
b.on("EVT:CHESS_INPUT:SELECTED",function(p){me.onSelected(p);});
b.on("EVT:CHESS_INPUT:DESELECT",function(p){me.onDeselect(p);});
b.on("EVT:CHESS_INPUT:MOVE_ATTEMPT",function(p){me.onMoveAttempt(p);});
b.on("EVT:CHESS_RULES:LEGAL_MOVES",function(p){me.onLegalMoves(p);});
b.on("EVT:CHESS_HILITE:FOCUS",function(p){me.focusSq(p&&p.sq);});
b.on("EVT:CHESS_HILITE:CLEAR",function(){me.clear();});
b.on("EVT:CHESS_HILITE:ILLEGAL",function(p){me.flashIllegal(p);});
b.on("EVT:CHESS_HILITE:LOCK",function(){me.lock(true);});
b.on("EVT:CHESS_HILITE:UNLOCK",function(){me.lock(false);});
},
_emit(ev,p){try{this._ctx&&this._ctx.bus&&this._ctx.bus.emit(ev,p);}catch(e){this._error("_emit",e);}},
_error(where,err){
var msg=(err&&err.message)?err.message:String(err||"error");
this._state.lastError=msg;
this._emit("EVT:CHESS_HILITE:ERROR",{id:this.id,where:String(where||"unknown"),error:msg,ts:Date.now()});
return null;
},
mount(p){
try{
p=p||{};
if(this._state.mounted)return;
this._buildDOM(p.mountEl||null);
this._state.mounted=true;
this._emit("EVT:CHESS_HILITE:MOUNTED",{id:this.id,ts:Date.now()});
}catch(e){this._error("mount",e);}
},
start(){
try{
if(!this._state.mounted)this.mount({});
this._state.started=true;
this._applyCfg();
this._emit("EVT:CHESS_HILITE:STARTED",{id:this.id,ts:Date.now()});
}catch(e){this._error("start",e);}
},
stop(){
try{
this._state.started=false;
this.clear();
this._emit("EVT:CHESS_HILITE:STOPPED",{id:this.id,ts:Date.now()});
}catch(e){this._error("stop",e);}
},
enable(){this._state.enabled=true;this._applyCfg();this._emitState();},
disable(){this._state.enabled=false;this._applyCfg();this.clear();this._emitState();},
_emitState(){
this._emit("EVT:CHESS_HILITE:STATE",{id:this.id,state:{mounted:this._state.mounted,started:this._state.started,enabled:this._state.enabled,lock:this._state.lock},ts:Date.now()});
},
setCfg(partial){
try{
partial=partial||{};
var c=this._state.cfg;
if(partial.glowPx!=null)c.glowPx=this._n(partial.glowPx,0,64);
if(partial.glowOpacity!=null)c.glowOpacity=this._n(partial.glowOpacity,0,1);
if(partial.gridOpacity!=null)c.gridOpacity=this._n(partial.gridOpacity,0,1);
if(partial.legalOpacity!=null)c.legalOpacity=this._n(partial.legalOpacity,0,1);
if(partial.captureOpacity!=null)c.captureOpacity=this._n(partial.captureOpacity,0,1);
if(partial.illegalOpacity!=null)c.illegalOpacity=this._n(partial.illegalOpacity,0,1);
if(partial.focusOpacity!=null)c.focusOpacity=this._n(partial.focusOpacity,0,1);
if(partial.borderPx!=null)c.borderPx=this._n(partial.borderPx,0,12);
if(partial.radiusPx!=null)c.radiusPx=this._n(partial.radiusPx,0,40);
if(partial.useBlend!=null)c.useBlend=!!partial.useBlend;
if(partial.zIndex!=null)c.zIndex=this._n(partial.zIndex,0,9999);
this._applyCfg();
this._emit("EVT:CHESS_HILITE:CFG",{id:this.id,cfg:this._clone(c),ts:Date.now()});
}catch(e){this._error("setCfg",e);}
},
lock(v){
this._state.lock=!!v;
if(this._state.lock)this.clear();
this._emitState();
},
onTheme(p){
try{
p=p||{};
if(p.text!=null)this._state.theme.text=String(p.text);
if(p.glow!=null)this._state.theme.glow=String(p.glow);
if(p.enemy!=null)this._state.theme.enemy=String(p.enemy);
if(p.ally!=null)this._state.theme.ally=String(p.ally);
if(p.tileA!=null)this._state.theme.tileA=String(p.tileA);
if(p.tileB!=null)this._state.theme.tileB=String(p.tileB);
if(p.boardBg!=null)this._state.theme.boardBg=String(p.boardBg);
this._applyCfg();
}catch(e){this._error("onTheme",e);}
},
onLayout(p){
try{
p=p||{};
if(!p.boardRect)return;
this._state.layout.boardRect={x:Number(p.boardRect.x||0),y:Number(p.boardRect.y||0),w:Number(p.boardRect.w||0),h:Number(p.boardRect.h||0)};
this._state.layout.cellSize=Number(p.cellSize||0);
this._state.layout.originX=Number(p.originX||0);
this._state.layout.originY=Number(p.originY||0);
this._reposition();
}catch(e){this._error("onLayout",e);}
},
onHover(p){
if(!this._ok())return;
if(this._state.lock)return;
p=p||{};
var sq=(p.sq==null)?-1:Number(p.sq);
this._hoverSq(sq);
},
onSelected(p){
if(!this._ok())return;
if(this._state.lock)return;
p=p||{};
this.focusSq(p.sq);
},
onDeselect(){
if(!this._ok())return;
this.clear();
},
onLegalMoves(p){
if(!this._ok())return;
if(this._state.lock)return;
p=p||{};
if(p.forSq==null)return;
this._renderLegal(p.forSq,p.moves||[]);
},
onMoveAttempt(p){
if(!this._ok())return;
p=p||{};
if(p.ok===false&&p.fromSq!=null&&p.toSq!=null)this.flashIllegal(p);
},
flashIllegal(p){
if(!this._ok())return;
if(this._state.lock)return;
p=p||{};
var fromSq=(p.fromSq==null)?-1:Number(p.fromSq);
var toSq=(p.toSq==null)?-1:Number(p.toSq);
this._illegalPulse(fromSq,toSq);
},
focusSq(sq){
if(!this._ok())return;
if(this._state.lock)return;
sq=(sq==null)?-1:Number(sq);
if(sq<0){this._clearFocus();return;}
this._renderFocus(sq);
},
clear(){
this._clearGrid();
this._clearMarkers();
this._clearFocus();
},
_ok(){return !!(this._state.enabled&&this._state.started&&this._state.layer);},
_buildDOM(mountEl){
var host=mountEl||document.body;
var r=document.createElement("div");
r.id="kog_chess_hilite_root";
r.style.position="fixed";
r.style.left="0px";
r.style.top="0px";
r.style.width="0px";
r.style.height="0px";
r.style.pointerEvents="none";
r.style.zIndex=String(this._state.cfg.zIndex);
var layer=document.createElement("div");
layer.id="kog_chess_hilite_layer";
layer.style.position="absolute";
layer.style.left="0px";
layer.style.top="0px";
layer.style.width="0px";
layer.style.height="0px";
layer.style.pointerEvents="none";
layer.style.transformOrigin="0 0";
var grid=document.createElement("canvas");
grid.id="kog_chess_hilite_grid";
grid.width=8;
grid.height=8;
grid.style.position="absolute";
grid.style.left="0px";
grid.style.top="0px";
grid.style.width="0px";
grid.style.height="0px";
grid.style.pointerEvents="none";
var markers=document.createElement("canvas");
markers.id="kog_chess_hilite_markers";
markers.width=8;
markers.height=8;
markers.style.position="absolute";
markers.style.left="0px";
markers.style.top="0px";
markers.style.width="0px";
markers.style.height="0px";
markers.style.pointerEvents="none";
var focus=document.createElement("canvas");
focus.id="kog_chess_hilite_focus";
focus.width=8;
focus.height=8;
focus.style.position="absolute";
focus.style.left="0px";
focus.style.top="0px";
focus.style.width="0px";
focus.style.height="0px";
focus.style.pointerEvents="none";
layer.appendChild(grid);
layer.appendChild(markers);
layer.appendChild(focus);
r.appendChild(layer);
host.appendChild(r);
this._state.root=r;
this._state.layer=layer;
this._state.grid=grid;
this._state.markers=markers;
this._state.focus=focus;
this._applyCfg();
this._reposition();
},
_applyCfg(){
if(!this._state.root)return;
var c=this._state.cfg,t=this._state.theme;
this._state.root.style.zIndex=String(c.zIndex);
this._state.layer.style.mixBlendMode=c.useBlend?"screen":"normal";
this._state.layer.style.filter="drop-shadow(0px 0px "+c.glowPx+"px "+this._rgba(t.glow,c.glowOpacity)+")";
},
_reposition(){
if(!this._state.layer)return;
var br=this._state.layout.boardRect;
var cs=this._state.layout.cellSize;
if(!br||!cs||br.w<=0||br.h<=0)return;
this._state.layer.style.left=br.x+"px";
this._state.layer.style.top=br.y+"px";
this._state.layer.style.width=br.w+"px";
this._state.layer.style.height=br.h+"px";
this._resizeCanvas(this._state.grid,br.w,br.h);
this._resizeCanvas(this._state.markers,br.w,br.h);
this._resizeCanvas(this._state.focus,br.w,br.h);
this._drawGrid();
},
_resizeCanvas(cv,w,h){
w=Math.max(1,Math.floor(Number(w)||1));
h=Math.max(1,Math.floor(Number(h)||1));
if(cv.width!==w)cv.width=w;
if(cv.height!==h)cv.height=h;
cv.style.width=w+"px";
cv.style.height=h+"px";
},
_drawGrid(){
var cv=this._state.grid;
if(!cv)return;
var ctx=cv.getContext("2d");
var br=this._state.layout.boardRect;
var cs=this._state.layout.cellSize;
if(!ctx||!cs||!br||br.w<=0)return;
ctx.clearRect(0,0,cv.width,cv.height);
var c=this._state.cfg,t=this._state.theme;
ctx.globalAlpha=this._clamp01(c.gridOpacity);
ctx.lineWidth=Math.max(0.5,Number(c.borderPx||1));
ctx.strokeStyle=this._rgba(t.glow,0.55);
var i=0,x=0,y=0,w=cv.width,h=cv.height;
for(i=0;i<=8;i++){
x=Math.round(i*cs)+0.5;
ctx.beginPath();
ctx.moveTo(x,0);
ctx.lineTo(x,h);
ctx.stroke();
y=Math.round(i*cs)+0.5;
ctx.beginPath();
ctx.moveTo(0,y);
ctx.lineTo(w,y);
ctx.stroke();
}
ctx.globalAlpha=1;
},
_renderLegal(forSq,moves){
this._clearMarkers();
if(!moves||!moves.length)return;
var cv=this._state.markers,ctx=cv.getContext("2d");
var cs=this._state.layout.cellSize;
if(!ctx||!cs)return;
var c=this._state.cfg,t=this._state.theme;
ctx.clearRect(0,0,cv.width,cv.height);
var i=0,m=null,to=0,cap=false;
for(i=0;i<moves.length;i++){
m=moves[i]||{};
to=Number(m.toSq);
cap=!!m.capture;
this._drawMarker(ctx,to,cap?this._rgba(t.enemy,c.captureOpacity):this._rgba(t.glow,c.legalOpacity),cap);
}
this._emit("EVT:CHESS_HILITE:LEGAL_RENDERED",{id:this.id,forSq:Number(forSq),count:moves.length,ts:Date.now()});
},
_drawMarker(ctx,sq,color,isCapture){
if(sq<0||sq>63)return;
var cs=this._state.layout.cellSize;
var x=(sq&7)*cs,y=((sq>>3)&7)*cs;
var pad=Math.max(2,Math.floor(cs*0.18));
var r=Math.max(4,Math.floor(cs*0.16));
ctx.save();
ctx.globalCompositeOperation="source-over";
ctx.fillStyle=color;
ctx.strokeStyle=color;
ctx.lineWidth=Math.max(2,Math.floor(cs*0.06));
if(isCapture){
ctx.beginPath();
ctx.arc(x+cs/2,y+cs/2,Math.max(6,Math.floor(cs*0.42)),0,Math.PI*2);
ctx.stroke();
}else{
ctx.beginPath();
ctx.arc(x+cs/2,y+cs/2,r,0,Math.PI*2);
ctx.fill();
}
ctx.restore();
},
_hoverSq(sq){
if(sq<0||sq>63)return;
this._emit("EVT:CHESS_HILITE:HOVER",{id:this.id,sq:sq,ts:Date.now()});
},
_renderFocus(sq){
this._clearFocus();
if(sq<0||sq>63)return;
var cv=this._state.focus,ctx=cv.getContext("2d");
var cs=this._state.layout.cellSize;
if(!ctx||!cs)return;
var c=this._state.cfg,t=this._state.theme;
var x=(sq&7)*cs,y=((sq>>3)&7)*cs;
ctx.clearRect(0,0,cv.width,cv.height);
ctx.save();
ctx.globalAlpha=this._clamp01(c.focusOpacity);
ctx.lineWidth=Math.max(2,Math.floor(cs*0.08));
ctx.strokeStyle=this._rgba(t.glow,0.95);
this._roundRect(ctx,x+1,y+1,cs-2,cs-2,Math.min(c.radiusPx,Math.floor(cs*0.25)));
ctx.stroke();
ctx.restore();
},
_illegalPulse(fromSq,toSq){
var cv=this._state.focus,ctx=cv.getContext("2d");
var cs=this._state.layout.cellSize;
if(!ctx||!cs)return;
var c=this._state.cfg,t=this._state.theme;
var me=this;
var t0=performance.now();
var dur=240;
function draw(){
var now=performance.now();
var k=(now-t0)/dur;
if(k>=1){me._renderFocus(me._state.selSq);return;}
var a=Math.sin(k*Math.PI);
ctx.clearRect(0,0,cv.width,cv.height);
ctx.save();
ctx.globalAlpha=a*me._clamp01(c.illegalOpacity);
ctx.lineWidth=Math.max(2,Math.floor(cs*0.1));
ctx.strokeStyle=me._rgba(t.enemy,0.95);
if(fromSq>=0&&fromSq<=63)me._strokeSq(ctx,fromSq,cs);
if(toSq>=0&&toSq<=63)me._strokeSq(ctx,toSq,cs);
ctx.restore();
requestAnimationFrame(draw);
}
requestAnimationFrame(draw);
this._emit("EVT:CHESS_HILITE:ILLEGAL_FLASH",{id:this.id,fromSq:fromSq,toSq:toSq,ts:Date.now()});
},
_strokeSq(ctx,sq,cs){
var x=(sq&7)*cs,y=((sq>>3)&7)*cs;
this._roundRect(ctx,x+1,y+1,cs-2,cs-2,Math.floor(cs*0.18));
ctx.stroke();
},
_clearGrid(){
var cv=this._state.grid;
if(!cv)return;
var ctx=cv.getContext("2d");
ctx&&ctx.clearRect(0,0,cv.width,cv.height);
this._drawGrid();
},
_clearMarkers(){
var cv=this._state.markers;
if(!cv)return;
var ctx=cv.getContext("2d");
ctx&&ctx.clearRect(0,0,cv.width,cv.height);
},
_clearFocus(){
var cv=this._state.focus;
if(!cv)return;
var ctx=cv.getContext("2d");
ctx&&ctx.clearRect(0,0,cv.width,cv.height);
},
_roundRect(ctx,x,y,w,h,r){
r=Math.max(0,Number(r)||0);
if(r<=0){ctx.rect(x,y,w,h);return;}
var rr=Math.min(r,Math.min(w,h)/2);
ctx.beginPath();
ctx.moveTo(x+rr,y);
ctx.arcTo(x+w,y,x+w,y+h,rr);
ctx.arcTo(x+w,y+h,x,y+h,rr);
ctx.arcTo(x,y+h,x,y,rr);
ctx.arcTo(x,y,x+w,y,rr);
ctx.closePath();
},
_rgba(hex,a){
hex=String(hex||"#00ffcc");
a=this._clamp01(a);
var h=hex.replace("#","").trim();
if(h.length===3)h=h[0]+h[0]+h[1]+h[1]+h[2]+h[2];
var r=parseInt(h.substring(0,2),16);
var g=parseInt(h.substring(2,4),16);
var b=parseInt(h.substring(4,6),16);
if(!isFinite(r))r=0;if(!isFinite(g))g=255;if(!isFinite(b))b=204;
return "rgba("+r+","+g+","+b+","+a+")";
},
_n(v,a,b){
v=Number(v);
if(!isFinite(v))v=a;
if(v<a)v=a;
if(v>b)v=b;
return v;
},
_clamp01(v){return this._n(v,0,1);},
_clone(o){try{return JSON.parse(JSON.stringify(o));}catch(e){return o;}},
api:{
mount:function(p){return Engine_CHESS_MOVE_HILITE_FX.mount(p);},
start:function(){return Engine_CHESS_MOVE_HILITE_FX.start();},
stop:function(){return Engine_CHESS_MOVE_HILITE_FX.stop();},
enable:function(){return Engine_CHESS_MOVE_HILITE_FX.enable();},
disable:function(){return Engine_CHESS_MOVE_HILITE_FX.disable();},
setCfg:function(p){return Engine_CHESS_MOVE_HILITE_FX.setCfg(p);},
lock:function(v){return Engine_CHESS_MOVE_HILITE_FX.lock(v);},
clear:function(){return Engine_CHESS_MOVE_HILITE_FX.clear();},
status:function(){return {id:Engine_CHESS_MOVE_HILITE_FX.id,state:Engine_CHESS_MOVE_HILITE_FX._state,ts:Date.now()};}
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_CHESS_MOVE_HILITE_FX.id]=Engine_CHESS_MOVE_HILITE_FX;
/*-- üü¢üß≠-(13B)-(E)-(MOVE-HIGHLIGHT-FX)-(GLOW-GRID)-(E)-(13B)-üß≠üü¢ --*/
/*-- üí•‚ôüÔ∏è-(14B)-(S)-(CAPTURE-FX-ENGINE)-(ANIM/FLASH)-(S)-(14B)-‚ôüÔ∏èüí• --*/
const Engine_CHESS_CAPTURE_FX={
id:"CHESS_CAPTURE_FX",
_ctx:null,
_state:{
mounted:false,started:false,enabled:true,lastError:null,ts0:0,
root:null,
layer:null,
canvas:null,
ctx2d:null,
cfg:{
zIndex:60,
useBlend:true,
shakeMs:0,
flashMs:180,
ringMs:260,
burstMs:320,
maxParticles:36,
particleSize:0.22,
ringWidth:0.08,
glowPx:14,
opacity:0.95
},
theme:{
glow:"#00ffcc",
enemy:"#ff3366",
ally:"#00aaff",
smoke:"#ffffff"
},
layout:{
boardRect:{x:0,y:0,w:0,h:0},
cellSize:0
},
fx:{
running:false,
queue:[],
active:[],
tLast:0
}
},
init(ctx){
this._ctx=ctx||null;
this._state.ts0=Date.now();
if(!this._ctx||!this._ctx.bus)return this._error("init","missing_ctx_bus");
this._wire();
this._emit("EVT:CHESS_CAPTURE_FX:READY",{id:this.id,ts:Date.now()});
return this;
},
_wire(){
var b=this._ctx.bus,me=this;
b.on("REQ:CHESS_CAPTURE_FX:MOUNT",function(p){me.mount(p);});
b.on("REQ:CHESS_CAPTURE_FX:START",function(){me.start();});
b.on("REQ:CHESS_CAPTURE_FX:STOP",function(){me.stop();});
b.on("REQ:CHESS_CAPTURE_FX:ENABLE",function(){me.enable();});
b.on("REQ:CHESS_CAPTURE_FX:DISABLE",function(){me.disable();});
b.on("REQ:CHESS_CAPTURE_FX:SET_CFG",function(p){me.setCfg(p);});
b.on("EVT:CHESS_THEME:SYNC",function(p){me.onTheme(p);});
b.on("EVT:CHESS_BOARD:LAYOUT",function(p){me.onLayout(p);});
b.on("EVT:CHESS_GAME:CAPTURE",function(p){me.onCapture(p);});
b.on("EVT:CHESS_CAPTURE_FX:TRIGGER",function(p){me.trigger(p);});
b.on("EVT:CHESS_CAPTURE_FX:CLEAR",function(){me.clear();});
},
_emit(ev,p){try{this._ctx&&this._ctx.bus&&this._ctx.bus.emit(ev,p);}catch(e){this._error("_emit",e);}},
_error(where,err){
var msg=(err&&err.message)?err.message:String(err||"error");
this._state.lastError=msg;
this._emit("EVT:CHESS_CAPTURE_FX:ERROR",{id:this.id,where:String(where||"unknown"),error:msg,ts:Date.now()});
return null;
},
mount(p){
try{
p=p||{};
if(this._state.mounted)return;
this._buildDOM(p.mountEl||null);
this._state.mounted=true;
this._emit("EVT:CHESS_CAPTURE_FX:MOUNTED",{id:this.id,ts:Date.now()});
}catch(e){this._error("mount",e);}
},
start(){
try{
if(!this._state.mounted)this.mount({});
this._state.started=true;
this._applyCfg();
this._tickStart();
this._emit("EVT:CHESS_CAPTURE_FX:STARTED",{id:this.id,ts:Date.now()});
}catch(e){this._error("start",e);}
},
stop(){
try{
this._state.started=false;
this.clear();
this._emit("EVT:CHESS_CAPTURE_FX:STOPPED",{id:this.id,ts:Date.now()});
}catch(e){this._error("stop",e);}
},
enable(){this._state.enabled=true;this._applyCfg();this._emitState();},
disable(){this._state.enabled=false;this._applyCfg();this.clear();this._emitState();},
_emitState(){
this._emit("EVT:CHESS_CAPTURE_FX:STATE",{id:this.id,state:{mounted:this._state.mounted,started:this._state.started,enabled:this._state.enabled},ts:Date.now()});
},
setCfg(partial){
try{
partial=partial||{};
var c=this._state.cfg;
if(partial.zIndex!=null)c.zIndex=this._n(partial.zIndex,0,9999);
if(partial.useBlend!=null)c.useBlend=!!partial.useBlend;
if(partial.shakeMs!=null)c.shakeMs=this._n(partial.shakeMs,0,1200);
if(partial.flashMs!=null)c.flashMs=this._n(partial.flashMs,0,1200);
if(partial.ringMs!=null)c.ringMs=this._n(partial.ringMs,0,2000);
if(partial.burstMs!=null)c.burstMs=this._n(partial.burstMs,0,2000);
if(partial.maxParticles!=null)c.maxParticles=this._n(partial.maxParticles,0,200);
if(partial.particleSize!=null)c.particleSize=this._n(partial.particleSize,0.05,0.8);
if(partial.ringWidth!=null)c.ringWidth=this._n(partial.ringWidth,0.01,0.5);
if(partial.glowPx!=null)c.glowPx=this._n(partial.glowPx,0,64);
if(partial.opacity!=null)c.opacity=this._n(partial.opacity,0,1);
this._applyCfg();
this._emit("EVT:CHESS_CAPTURE_FX:CFG",{id:this.id,cfg:this._clone(c),ts:Date.now()});
}catch(e){this._error("setCfg",e);}
},
onTheme(p){
try{
p=p||{};
if(p.glow!=null)this._state.theme.glow=String(p.glow);
if(p.enemy!=null)this._state.theme.enemy=String(p.enemy);
if(p.ally!=null)this._state.theme.ally=String(p.ally);
if(p.smoke!=null)this._state.theme.smoke=String(p.smoke);
this._applyCfg();
}catch(e){this._error("onTheme",e);}
},
onLayout(p){
try{
p=p||{};
if(!p.boardRect)return;
this._state.layout.boardRect={x:Number(p.boardRect.x||0),y:Number(p.boardRect.y||0),w:Number(p.boardRect.w||0),h:Number(p.boardRect.h||0)};
this._state.layout.cellSize=Number(p.cellSize||0);
this._reposition();
}catch(e){this._error("onLayout",e);}
},
onCapture(p){
this.trigger(p);
},
trigger(p){
if(!this._ok())return;
p=p||{};
var toSq=(p.toSq==null)?-1:Number(p.toSq);
var capSq=(p.captureSq!=null)?Number(p.captureSq):toSq;
var victim=(p.victimColor!=null)?String(p.victimColor):"enemy";
var power=(p.power!=null)?String(p.power):"minor";
if(capSq<0||capSq>63)return;
this._enqueue({sq:capSq,victim:victim,power:power,ts:Date.now()});
},
clear(){
this._state.fx.queue.length=0;
this._state.fx.active.length=0;
this._clearCanvas();
},
_ok(){return !!(this._state.enabled&&this._state.started&&this._state.canvas&&this._state.ctx2d);},
_buildDOM(mountEl){
var host=mountEl||document.body;
var r=document.createElement("div");
r.id="kog_chess_capturefx_root";
r.style.position="fixed";
r.style.left="0px";
r.style.top="0px";
r.style.width="0px";
r.style.height="0px";
r.style.pointerEvents="none";
r.style.zIndex=String(this._state.cfg.zIndex);
var layer=document.createElement("div");
layer.id="kog_chess_capturefx_layer";
layer.style.position="absolute";
layer.style.left="0px";
layer.style.top="0px";
layer.style.width="0px";
layer.style.height="0px";
layer.style.pointerEvents="none";
layer.style.transformOrigin="0 0";
var cv=document.createElement("canvas");
cv.id="kog_chess_capturefx_canvas";
cv.width=8;
cv.height=8;
cv.style.position="absolute";
cv.style.left="0px";
cv.style.top="0px";
cv.style.width="0px";
cv.style.height="0px";
cv.style.pointerEvents="none";
layer.appendChild(cv);
r.appendChild(layer);
host.appendChild(r);
this._state.root=r;
this._state.layer=layer;
this._state.canvas=cv;
this._state.ctx2d=cv.getContext("2d");
this._applyCfg();
this._reposition();
},
_applyCfg(){
if(!this._state.root)return;
var c=this._state.cfg;
this._state.root.style.zIndex=String(c.zIndex);
this._state.layer.style.mixBlendMode=c.useBlend?"screen":"normal";
this._state.layer.style.filter="drop-shadow(0px 0px "+c.glowPx+"px rgba(0,0,0,0.0))";
},
_reposition(){
if(!this._state.layer)return;
var br=this._state.layout.boardRect;
if(!br||br.w<=0||br.h<=0)return;
this._state.layer.style.left=br.x+"px";
this._state.layer.style.top=br.y+"px";
this._state.layer.style.width=br.w+"px";
this._state.layer.style.height=br.h+"px";
this._resizeCanvas(this._state.canvas,br.w,br.h);
},
_resizeCanvas(cv,w,h){
w=Math.max(1,Math.floor(Number(w)||1));
h=Math.max(1,Math.floor(Number(h)||1));
if(cv.width!==w)cv.width=w;
if(cv.height!==h)cv.height=h;
cv.style.width=w+"px";
cv.style.height=h+"px";
},
_clearCanvas(){
var cv=this._state.canvas,ctx=this._state.ctx2d;
if(!cv||!ctx)return;
ctx.clearRect(0,0,cv.width,cv.height);
},
_enqueue(ev){
this._state.fx.queue.push(ev);
this._tickStart();
},
_tickStart(){
if(this._state.fx.running)return;
this._state.fx.running=true;
this._state.fx.tLast=performance.now();
this._raf();
},
_raf(){
var me=this;
requestAnimationFrame(function(t){me._tick(t);});
},
_tick(t){
if(!this._state.started||!this._state.enabled){this._state.fx.running=false;return;}
var fx=this._state.fx;
var dt=Math.min(48,Math.max(0,t-fx.tLast));
fx.tLast=t;
this._stepQueue();
this._updateActive(dt,t);
this._render(t);
if(fx.active.length||fx.queue.length){this._raf();return;}
fx.running=false;
},
_stepQueue(){
var q=this._state.fx.queue;
if(!q.length)return;
var ev=q.shift();
this._spawn(ev);
},
_spawn(ev){
var cs=this._state.layout.cellSize;
if(!cs)return;
var t=this._state.theme,c=this._state.cfg;
var col=(ev.victim==="ally")?t.ally:t.enemy;
var pwr=(ev.power==="major")?1.0:(ev.power==="medium")?0.72:0.5;
var center=this._sqCenter(ev.sq);
var burstN=Math.max(8,Math.floor(c.maxParticles*pwr));
var i=0,ang=0,spd=0;
var a=this._state.fx.active;
a.push({kind:"flash",x:center.x,y:center.y,t0:performance.now(),dur:c.flashMs,alpha:c.opacity,clr:this._rgba(col,1)});
a.push({kind:"ring",x:center.x,y:center.y,t0:performance.now(),dur:c.ringMs,alpha:c.opacity,clr:this._rgba(col,1),pwr:pwr});
for(i=0;i<burstN;i++){
ang=Math.random()*Math.PI*2;
spd=(0.35+Math.random()*0.65)*cs*(0.006+0.01*pwr);
a.push({kind:"p",x:center.x,y:center.y,vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd,drag:0.992-(0.003*pwr),t0:performance.now(),dur:c.burstMs*(0.7+Math.random()*0.6),alpha:c.opacity*(0.65+Math.random()*0.35),clr:this._rgba(t.smoke,1),size:cs*c.particleSize*(0.55+Math.random()*0.9),spin:(Math.random()*2-1)*0.02});
}
this._emit("EVT:CHESS_CAPTURE_FX:FIRED",{id:this.id,sq:ev.sq,victim:ev.victim,power:ev.power,ts:Date.now()});
},
_updateActive(dt,t){
var a=this._state.fx.active;
var i=a.length-1,o=null,age=0;
for(i=a.length-1;i>=0;i--){
o=a[i];
age=t-o.t0;
if(age>=o.dur){a.splice(i,1);continue;}
if(o.kind==="p"){
o.vx*=o.drag;
o.vy*=o.drag;
o.x+=o.vx*dt;
o.y+=o.vy*dt;
o.vy+=0.0009*dt*(this._state.layout.cellSize||1);
o.spin*=0.992;
}
}
},
_render(t){
var cv=this._state.canvas,ctx=this._state.ctx2d;
if(!cv||!ctx)return;
ctx.clearRect(0,0,cv.width,cv.height);
var a=this._state.fx.active;
if(!a.length)return;
var i=0,o=null,cs=this._state.layout.cellSize;
var c=this._state.cfg;
ctx.save();
ctx.globalCompositeOperation="lighter";
for(i=0;i<a.length;i++){
o=a[i];
if(o.kind==="flash")this._drawFlash(ctx,o,t,cs);
if(o.kind==="ring")this._drawRing(ctx,o,t,cs);
if(o.kind==="p")this._drawParticle(ctx,o,t,cs);
}
ctx.restore();
},
_drawFlash(ctx,o,t,cs){
var k=(t-o.t0)/o.dur;
var a=(1-k);
a=a*a;
ctx.save();
ctx.globalAlpha=a*o.alpha;
ctx.fillStyle=o.clr;
ctx.beginPath();
ctx.arc(o.x,o.y,Math.max(8,cs*0.52*(0.7+0.4*(1-k))),0,Math.PI*2);
ctx.fill();
ctx.restore();
},
_drawRing(ctx,o,t,cs){
var k=(t-o.t0)/o.dur;
var a=(1-k);
ctx.save();
ctx.globalAlpha=a*o.alpha;
ctx.strokeStyle=o.clr;
ctx.lineWidth=Math.max(1,cs*this._state.cfg.ringWidth*(0.6+0.8*o.pwr));
ctx.beginPath();
ctx.arc(o.x,o.y,Math.max(8,cs*0.3+cs*(1.1+1.4*o.pwr)*k),0,Math.PI*2);
ctx.stroke();
ctx.restore();
},
_drawParticle(ctx,o,t,cs){
var k=(t-o.t0)/o.dur;
var a=(1-k);
a=a*a;
ctx.save();
ctx.globalAlpha=a*o.alpha;
ctx.fillStyle=o.clr;
ctx.beginPath();
ctx.arc(o.x,o.y,Math.max(1,o.size*(0.6+0.7*a)),0,Math.PI*2);
ctx.fill();
ctx.restore();
},
_sqCenter(sq){
var cs=this._state.layout.cellSize;
var x=(sq&7)*cs+cs/2;
var y=((sq>>3)&7)*cs+cs/2;
return {x:x,y:y};
},
_rgba(hex,a){
hex=String(hex||"#ffffff");
a=this._clamp01(a);
var h=hex.replace("#","").trim();
if(h.length===3)h=h[0]+h[0]+h[1]+h[1]+h[2]+h[2];
var r=parseInt(h.substring(0,2),16);
var g=parseInt(h.substring(2,4),16);
var b=parseInt(h.substring(4,6),16);
if(!isFinite(r))r=255;if(!isFinite(g))g=255;if(!isFinite(b))b=255;
return "rgba("+r+","+g+","+b+","+a+")";
},
_n(v,a,b){
v=Number(v);
if(!isFinite(v))v=a;
if(v<a)v=a;
if(v>b)v=b;
return v;
},
_clamp01(v){return this._n(v,0,1);},
_clone(o){try{return JSON.parse(JSON.stringify(o));}catch(e){return o;}},
api:{
mount:function(p){return Engine_CHESS_CAPTURE_FX.mount(p);},
start:function(){return Engine_CHESS_CAPTURE_FX.start();},
stop:function(){return Engine_CHESS_CAPTURE_FX.stop();},
enable:function(){return Engine_CHESS_CAPTURE_FX.enable();},
disable:function(){return Engine_CHESS_CAPTURE_FX.disable();},
setCfg:function(p){return Engine_CHESS_CAPTURE_FX.setCfg(p);},
trigger:function(p){return Engine_CHESS_CAPTURE_FX.trigger(p);},
clear:function(){return Engine_CHESS_CAPTURE_FX.clear();},
status:function(){return {id:Engine_CHESS_CAPTURE_FX.id,state:Engine_CHESS_CAPTURE_FX._state,ts:Date.now()};}
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_CHESS_CAPTURE_FX.id]=Engine_CHESS_CAPTURE_FX;
/*-- üí•‚ôüÔ∏è-(14B)-(E)-(CAPTURE-FX-ENGINE)-(ANIM/FLASH)-(E)-(14B)-‚ôüÔ∏èüí• --*/
/*-- üå©Ô∏èüì≥-(15B)-(S)-(MAJOR-PIECE-IMPACT)-(SHAKE+WEATHER)-(S)-(15B)-üì≥üå©Ô∏è --*/
const Engine_CHESS_MAJOR_IMPACT={
id:"CHESS_MAJOR_IMPACT",
_ctx:null,
_state:{
mounted:false,started:false,enabled:true,lastError:null,ts0:0,
root:null,
layer:null,
canvas:null,
ctx2d:null,
cfg:{
zIndex:70,
useBlend:true,
shakeOn:true,
shakeMs:420,
shakeAmp:10,
shakeFreq:18,
flashOn:true,
flashMs:180,
stormOn:true,
stormMs:900,
stormDensity:42,
stormSpeed:0.85,
stormTilt:0.28,
rainLen:0.55,
rainWidth:0.08,
sparkN:18,
sparkMs:360,
sparkSize:0.18,
opacity:0.92,
fadePow:1.9
},
theme:{
glow:"#00ffcc",
enemy:"#ff3366",
ally:"#00aaff",
rain:"#a8f6ff",
spark:"#ffffff"
},
layout:{
boardRect:{x:0,y:0,w:0,h:0},
cellSize:0
},
fx:{
running:false,
queue:[],
active:[],
tLast:0,
shake:{on:false,t0:0,dur:0,amp:0,freq:0,dx:0,dy:0},
storm:{on:false,t0:0,dur:0,density:0,speed:0,tilt:0,drop:[]}
}
},
init(ctx){
this._ctx=ctx||null;
this._state.ts0=Date.now();
if(!this._ctx||!this._ctx.bus)return this._error("init","missing_ctx_bus");
this._wire();
this._emit("EVT:CHESS_MAJOR_IMPACT:READY",{id:this.id,ts:Date.now()});
return this;
},
_wire(){
var b=this._ctx.bus,me=this;
b.on("REQ:CHESS_MAJOR_IMPACT:MOUNT",function(p){me.mount(p);});
b.on("REQ:CHESS_MAJOR_IMPACT:START",function(){me.start();});
b.on("REQ:CHESS_MAJOR_IMPACT:STOP",function(){me.stop();});
b.on("REQ:CHESS_MAJOR_IMPACT:ENABLE",function(){me.enable();});
b.on("REQ:CHESS_MAJOR_IMPACT:DISABLE",function(){me.disable();});
b.on("REQ:CHESS_MAJOR_IMPACT:SET_CFG",function(p){me.setCfg(p);});
b.on("EVT:CHESS_THEME:SYNC",function(p){me.onTheme(p);});
b.on("EVT:CHESS_BOARD:LAYOUT",function(p){me.onLayout(p);});
b.on("EVT:CHESS_GAME:CAPTURE",function(p){me.onCapture(p);});
b.on("EVT:CHESS_MAJOR_IMPACT:TRIGGER",function(p){me.trigger(p);});
b.on("EVT:CHESS_MAJOR_IMPACT:CLEAR",function(){me.clear();});
},
_emit(ev,p){try{this._ctx&&this._ctx.bus&&this._ctx.bus.emit(ev,p);}catch(e){this._error("_emit",e);}},
_error(where,err){
var msg=(err&&err.message)?err.message:String(err||"error");
this._state.lastError=msg;
this._emit("EVT:CHESS_MAJOR_IMPACT:ERROR",{id:this.id,where:String(where||"unknown"),error:msg,ts:Date.now()});
return null;
},
mount(p){
try{
p=p||{};
if(this._state.mounted)return;
this._buildDOM(p.mountEl||null);
this._state.mounted=true;
this._emit("EVT:CHESS_MAJOR_IMPACT:MOUNTED",{id:this.id,ts:Date.now()});
}catch(e){this._error("mount",e);}
},
start(){
try{
if(!this._state.mounted)this.mount({});
this._state.started=true;
this._applyCfg();
this._tickStart();
this._emit("EVT:CHESS_MAJOR_IMPACT:STARTED",{id:this.id,ts:Date.now()});
}catch(e){this._error("start",e);}
},
stop(){
try{
this._state.started=false;
this.clear();
this._emit("EVT:CHESS_MAJOR_IMPACT:STOPPED",{id:this.id,ts:Date.now()});
}catch(e){this._error("stop",e);}
},
enable(){this._state.enabled=true;this._applyCfg();this._emitState();},
disable(){this._state.enabled=false;this._applyCfg();this.clear();this._emitState();},
_emitState(){
this._emit("EVT:CHESS_MAJOR_IMPACT:STATE",{id:this.id,state:{mounted:this._state.mounted,started:this._state.started,enabled:this._state.enabled},ts:Date.now()});
},
setCfg(partial){
try{
partial=partial||{};
var c=this._state.cfg;
if(partial.zIndex!=null)c.zIndex=this._n(partial.zIndex,0,9999);
if(partial.useBlend!=null)c.useBlend=!!partial.useBlend;
if(partial.shakeOn!=null)c.shakeOn=!!partial.shakeOn;
if(partial.shakeMs!=null)c.shakeMs=this._n(partial.shakeMs,0,3000);
if(partial.shakeAmp!=null)c.shakeAmp=this._n(partial.shakeAmp,0,40);
if(partial.shakeFreq!=null)c.shakeFreq=this._n(partial.shakeFreq,1,60);
if(partial.flashOn!=null)c.flashOn=!!partial.flashOn;
if(partial.flashMs!=null)c.flashMs=this._n(partial.flashMs,0,1200);
if(partial.stormOn!=null)c.stormOn=!!partial.stormOn;
if(partial.stormMs!=null)c.stormMs=this._n(partial.stormMs,0,6000);
if(partial.stormDensity!=null)c.stormDensity=this._n(partial.stormDensity,0,240);
if(partial.stormSpeed!=null)c.stormSpeed=this._n(partial.stormSpeed,0,6);
if(partial.stormTilt!=null)c.stormTilt=this._n(partial.stormTilt,-2,2);
if(partial.rainLen!=null)c.rainLen=this._n(partial.rainLen,0.1,1.6);
if(partial.rainWidth!=null)c.rainWidth=this._n(partial.rainWidth,0.02,0.5);
if(partial.sparkN!=null)c.sparkN=this._n(partial.sparkN,0,120);
if(partial.sparkMs!=null)c.sparkMs=this._n(partial.sparkMs,0,2000);
if(partial.sparkSize!=null)c.sparkSize=this._n(partial.sparkSize,0.05,0.8);
if(partial.opacity!=null)c.opacity=this._n(partial.opacity,0,1);
if(partial.fadePow!=null)c.fadePow=this._n(partial.fadePow,0.8,5);
this._applyCfg();
this._emit("EVT:CHESS_MAJOR_IMPACT:CFG",{id:this.id,cfg:this._clone(c),ts:Date.now()});
}catch(e){this._error("setCfg",e);}
},
onTheme(p){
try{
p=p||{};
if(p.glow!=null)this._state.theme.glow=String(p.glow);
if(p.enemy!=null)this._state.theme.enemy=String(p.enemy);
if(p.ally!=null)this._state.theme.ally=String(p.ally);
if(p.rain!=null)this._state.theme.rain=String(p.rain);
if(p.spark!=null)this._state.theme.spark=String(p.spark);
this._applyCfg();
}catch(e){this._error("onTheme",e);}
},
onLayout(p){
try{
p=p||{};
if(!p.boardRect)return;
this._state.layout.boardRect={x:Number(p.boardRect.x||0),y:Number(p.boardRect.y||0),w:Number(p.boardRect.w||0),h:Number(p.boardRect.h||0)};
this._state.layout.cellSize=Number(p.cellSize||0);
this._reposition();
}catch(e){this._error("onLayout",e);}
},
onCapture(p){
p=p||{};
var major=!!p.major;
var victim=(p.victimColor!=null)?String(p.victimColor):"enemy";
if(!major)return;
this.trigger({sq:(p.captureSq!=null)?p.captureSq:p.toSq,victim:victim});
},
trigger(p){
if(!this._ok())return;
p=p||{};
var sq=(p.sq==null)?-1:Number(p.sq);
var victim=(p.victim!=null)?String(p.victim):"enemy";
if(sq<0||sq>63)return;
this._enqueue({sq:sq,victim:victim,ts:Date.now()});
},
clear(){
this._state.fx.queue.length=0;
this._state.fx.active.length=0;
this._state.fx.shake.on=false;
this._state.fx.storm.on=false;
this._state.fx.storm.drop.length=0;
this._applyShake(0,0);
this._clearCanvas();
},
_ok(){return !!(this._state.enabled&&this._state.started&&this._state.canvas&&this._state.ctx2d);},
_buildDOM(mountEl){
var host=mountEl||document.body;
var r=document.createElement("div");
r.id="kog_chess_majorimpact_root";
r.style.position="fixed";
r.style.left="0px";
r.style.top="0px";
r.style.width="0px";
r.style.height="0px";
r.style.pointerEvents="none";
r.style.zIndex=String(this._state.cfg.zIndex);
var layer=document.createElement("div");
layer.id="kog_chess_majorimpact_layer";
layer.style.position="absolute";
layer.style.left="0px";
layer.style.top="0px";
layer.style.width="0px";
layer.style.height="0px";
layer.style.pointerEvents="none";
layer.style.transformOrigin="0 0";
var cv=document.createElement("canvas");
cv.id="kog_chess_majorimpact_canvas";
cv.width=8;
cv.height=8;
cv.style.position="absolute";
cv.style.left="0px";
cv.style.top="0px";
cv.style.width="0px";
cv.style.height="0px";
cv.style.pointerEvents="none";
layer.appendChild(cv);
r.appendChild(layer);
host.appendChild(r);
this._state.root=r;
this._state.layer=layer;
this._state.canvas=cv;
this._state.ctx2d=cv.getContext("2d");
this._applyCfg();
this._reposition();
},
_applyCfg(){
if(!this._state.root)return;
var c=this._state.cfg;
this._state.root.style.zIndex=String(c.zIndex);
this._state.layer.style.mixBlendMode=c.useBlend?"screen":"normal";
},
_reposition(){
if(!this._state.layer)return;
var br=this._state.layout.boardRect;
if(!br||br.w<=0||br.h<=0)return;
this._state.layer.style.left=br.x+"px";
this._state.layer.style.top=br.y+"px";
this._state.layer.style.width=br.w+"px";
this._state.layer.style.height=br.h+"px";
this._resizeCanvas(this._state.canvas,br.w,br.h);
},
_resizeCanvas(cv,w,h){
w=Math.max(1,Math.floor(Number(w)||1));
h=Math.max(1,Math.floor(Number(h)||1));
if(cv.width!==w)cv.width=w;
if(cv.height!==h)cv.height=h;
cv.style.width=w+"px";
cv.style.height=h+"px";
},
_clearCanvas(){
var cv=this._state.canvas,ctx=this._state.ctx2d;
if(!cv||!ctx)return;
ctx.clearRect(0,0,cv.width,cv.height);
},
_enqueue(ev){
this._state.fx.queue.push(ev);
this._tickStart();
},
_tickStart(){
if(this._state.fx.running)return;
this._state.fx.running=true;
this._state.fx.tLast=performance.now();
this._raf();
},
_raf(){
var me=this;
requestAnimationFrame(function(t){me._tick(t);});
},
_tick(t){
if(!this._state.started||!this._state.enabled){this._state.fx.running=false;return;}
var fx=this._state.fx;
var dt=Math.min(48,Math.max(0,t-fx.tLast));
fx.tLast=t;
this._stepQueue(t);
this._update(dt,t);
this._render(t);
if(fx.active.length||fx.queue.length||fx.shake.on||fx.storm.on){this._raf();return;}
fx.running=false;
},
_stepQueue(t){
var q=this._state.fx.queue;
if(!q.length)return;
var ev=q.shift();
this._spawn(ev,t);
},
_spawn(ev,t){
var c=this._state.cfg;
var cs=this._state.layout.cellSize;
if(!cs)return;
var victim=String(ev.victim||"enemy");
var col=(victim==="ally")?this._state.theme.ally:this._state.theme.enemy;
var center=this._sqCenter(ev.sq);
if(c.flashOn)this._state.fx.active.push({kind:"flash",x:center.x,y:center.y,t0:t,dur:c.flashMs,alpha:c.opacity,clr:this._rgba(col,1)});
if(c.shakeOn)this._startShake(t,c.shakeMs,c.shakeAmp,c.shakeFreq);
if(c.stormOn)this._startStorm(t,c.stormMs,c.stormDensity,c.stormSpeed,c.stormTilt);
this._spawnSparks(center.x,center.y,col,t);
this._emit("EVT:CHESS_MAJOR_IMPACT:FIRED",{id:this.id,sq:ev.sq,victim:victim,ts:Date.now()});
},
_startShake(t,ms,amp,freq){
var s=this._state.fx.shake;
s.on=true;
s.t0=t;
s.dur=ms;
s.amp=amp;
s.freq=freq;
s.dx=0;
s.dy=0;
},
_startStorm(t,ms,density,speed,tilt){
var st=this._state.fx.storm;
st.on=true;
st.t0=t;
st.dur=ms;
st.density=density;
st.speed=speed;
st.tilt=tilt;
st.drop.length=0;
this._seedStormDrops(density);
},
_seedStormDrops(n){
var st=this._state.fx.storm;
var br=this._state.layout.boardRect;
var w=Math.max(1,br.w),h=Math.max(1,br.h);
var i=0;
for(i=0;i<n;i++){
st.drop.push({x:Math.random()*w,y:Math.random()*h,spd:(0.5+Math.random()*1.2),ph:Math.random()*Math.PI*2});
}
},
_spawnSparks(x,y,col,t){
var c=this._state.cfg,cs=this._state.layout.cellSize;
var n=c.sparkN;
var i=0,ang=0,spd=0;
for(i=0;i<n;i++){
ang=Math.random()*Math.PI*2;
spd=(0.6+Math.random()*0.9)*cs*(0.012+0.01*Math.random());
this._state.fx.active.push({kind:"spark",x:x,y:y,vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd,drag:0.985,t0:t,dur:c.sparkMs*(0.75+Math.random()*0.6),alpha:c.opacity,clr:this._rgba(this._state.theme.spark,1),size:cs*c.sparkSize*(0.55+Math.random()*0.8)});
}
},
_update(dt,t){
this._updateActive(dt,t);
this._updateShake(t);
this._updateStorm(dt,t);
},
_updateActive(dt,t){
var a=this._state.fx.active;
var i=a.length-1,o=null,age=0;
for(i=a.length-1;i>=0;i--){
o=a[i];
age=t-o.t0;
if(age>=o.dur){a.splice(i,1);continue;}
if(o.kind==="spark"){
o.vx*=o.drag;
o.vy*=o.drag;
o.x+=o.vx*dt;
o.y+=o.vy*dt;
o.vy+=0.0012*dt*(this._state.layout.cellSize||1);
}
}
},
_updateShake(t){
var s=this._state.fx.shake;
if(!s.on)return;
var k=(t-s.t0)/s.dur;
if(k>=1){s.on=false;this._applyShake(0,0);return;}
var fade=Math.pow(1-k,2.1);
var a=s.amp*fade;
var w=(t-s.t0)*0.001*s.freq*Math.PI*2;
var dx=Math.sin(w*1.13+1.7)*a;
var dy=Math.sin(w*0.97+3.1)*a;
this._applyShake(dx,dy);
},
_applyShake(dx,dy){
if(!this._state.layer)return;
this._state.layer.style.transform="translate("+dx.toFixed(2)+"px,"+dy.toFixed(2)+"px)";
},
_updateStorm(dt,t){
var st=this._state.fx.storm;
if(!st.on)return;
var k=(t-st.t0)/st.dur;
if(k>=1){st.on=false;st.drop.length=0;return;}
var br=this._state.layout.boardRect;
var w=Math.max(1,br.w),h=Math.max(1,br.h);
var i=0,d=null;
var base=st.speed*(0.06+0.07*(1-k));
var vx=st.tilt*base*w*0.02;
var vy=base*h*0.02;
for(i=0;i<st.drop.length;i++){
d=st.drop[i];
d.x+=vx*dt*(0.7+d.spd);
d.y+=vy*dt*(0.7+d.spd);
if(d.y>h+24||d.x>w+24){d.x=Math.random()*w;d.y=-Math.random()*48;}
if(d.x<-24){d.x=w+Math.random()*48;}
}
},
_render(t){
var cv=this._state.canvas,ctx=this._state.ctx2d;
if(!cv||!ctx)return;
ctx.clearRect(0,0,cv.width,cv.height);
var c=this._state.cfg;
ctx.save();
ctx.globalCompositeOperation="lighter";
this._drawStorm(ctx,t);
this._drawActive(ctx,t);
ctx.restore();
},
_drawStorm(ctx,t){
var st=this._state.fx.storm;
if(!st.on||!st.drop.length)return;
var k=(t-st.t0)/st.dur;
var a=this._easeOutPow(1-k,this._state.cfg.fadePow)*this._state.cfg.opacity*0.55;
var cs=this._state.layout.cellSize||1;
var len=Math.max(6,cs*this._state.cfg.rainLen);
var lw=Math.max(1,cs*this._state.cfg.rainWidth);
var col=this._rgba(this._state.theme.rain,1);
ctx.save();
ctx.globalAlpha=a;
ctx.strokeStyle=col;
ctx.lineWidth=lw;
var i=0,d=null;
var dx=len*this._state.cfg.stormTilt*0.6;
for(i=0;i<st.drop.length;i++){
d=st.drop[i];
ctx.beginPath();
ctx.moveTo(d.x,d.y);
ctx.lineTo(d.x-dx,d.y-len);
ctx.stroke();
}
ctx.restore();
},
_drawActive(ctx,t){
var a=this._state.fx.active;
if(!a.length)return;
var i=0,o=null;
for(i=0;i<a.length;i++){
o=a[i];
if(o.kind==="flash")this._drawFlash(ctx,o,t);
if(o.kind==="spark")this._drawSpark(ctx,o,t);
}
},
_drawFlash(ctx,o,t){
var k=(t-o.t0)/o.dur;
var a=this._easeOutPow(1-k,2.2)*o.alpha;
ctx.save();
ctx.globalAlpha=a;
ctx.fillStyle=o.clr;
ctx.beginPath();
ctx.arc(o.x,o.y,Math.max(10,(this._state.layout.cellSize||1)*0.72*(0.7+0.5*(1-k))),0,Math.PI*2);
ctx.fill();
ctx.restore();
},
_drawSpark(ctx,o,t){
var k=(t-o.t0)/o.dur;
var a=this._easeOutPow(1-k,2.0)*o.alpha;
ctx.save();
ctx.globalAlpha=a;
ctx.fillStyle=o.clr;
ctx.beginPath();
ctx.arc(o.x,o.y,Math.max(1,o.size*(0.55+0.85*a)),0,Math.PI*2);
ctx.fill();
ctx.restore();
},
_sqCenter(sq){
var cs=this._state.layout.cellSize;
var x=(sq&7)*cs+cs/2;
var y=((sq>>3)&7)*cs+cs/2;
return {x:x,y:y};
},
_rgba(hex,a){
hex=String(hex||"#ffffff");
a=this._clamp01(a);
var h=hex.replace("#","").trim();
if(h.length===3)h=h[0]+h[0]+h[1]+h[1]+h[2]+h[2];
var r=parseInt(h.substring(0,2),16);
var g=parseInt(h.substring(2,4),16);
var b=parseInt(h.substring(4,6),16);
if(!isFinite(r))r=255;if(!isFinite(g))g=255;if(!isFinite(b))b=255;
return "rgba("+r+","+g+","+b+","+a+")";
},
_n(v,a,b){
v=Number(v);
if(!isFinite(v))v=a;
if(v<a)v=a;
if(v>b)v=b;
return v;
},
_clamp01(v){return this._n(v,0,1);},
_easeOutPow(v,p){v=this._n(v,0,1);return Math.pow(v,p);},
_clone(o){try{return JSON.parse(JSON.stringify(o));}catch(e){return o;}},
api:{
mount:function(p){return Engine_CHESS_MAJOR_IMPACT.mount(p);},
start:function(){return Engine_CHESS_MAJOR_IMPACT.start();},
stop:function(){return Engine_CHESS_MAJOR_IMPACT.stop();},
enable:function(){return Engine_CHESS_MAJOR_IMPACT.enable();},
disable:function(){return Engine_CHESS_MAJOR_IMPACT.disable();},
setCfg:function(p){return Engine_CHESS_MAJOR_IMPACT.setCfg(p);},
trigger:function(p){return Engine_CHESS_MAJOR_IMPACT.trigger(p);},
clear:function(){return Engine_CHESS_MAJOR_IMPACT.clear();},
status:function(){return {id:Engine_CHESS_MAJOR_IMPACT.id,state:Engine_CHESS_MAJOR_IMPACT._state,ts:Date.now()};}
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_CHESS_MAJOR_IMPACT.id]=Engine_CHESS_MAJOR_IMPACT;
/*-- üå©Ô∏èüì≥-(15B)-(E)-(MAJOR-PIECE-IMPACT)-(SHAKE+WEATHER)-(E)-(15B)-üì≥üå©Ô∏è --*/
/*-- üîä‚ôüÔ∏è-(16B)-(S)-(CHESS-SFX-PACK)-(MOVES/CAPTURE/CHECK)-(S)-(16B)-‚ôüÔ∏èüîä --*/
const Engine_CHESS_SFX_PACK={
id:"CHESS_SFX_PACK",
_ctx:null,
_state:{
mounted:false,started:false,enabled:true,lastError:null,ts0:0,
cfg:{
volumeMaster:0.85,
volumeMove:0.70,
volumeCapture:0.85,
volumeCheck:0.95,
volumeUi:0.65,
rateMin:0.94,
rateMax:1.06,
polyphony:6,
softLimiter:true,
cooldowns:{move:60,capture:90,check:260,ui:40},
preferWebAudio:true
},
theme:{
move:"sine",
capture:"square",
check:"sawtooth",
ui:"triangle"
},
cache:{
useWebAudio:false,
ac:null,
master:null,
gain:null,
lastPlay:{move:0,capture:0,check:0,ui:0},
voices:[],
voiceIndex:0
}
},
init(ctx){
this._ctx=ctx||null;
this._state.ts0=Date.now();
if(!this._ctx||!this._ctx.bus)return this._error("init","missing_ctx_bus");
this._wire();
this._emit("EVT:CHESS_SFX:READY",{id:this.id,ts:Date.now()});
return this;
},
_wire(){
var b=this._ctx.bus,me=this;
b.on("REQ:CHESS_SFX:MOUNT",function(p){me.mount(p);});
b.on("REQ:CHESS_SFX:START",function(){me.start();});
b.on("REQ:CHESS_SFX:STOP",function(){me.stop();});
b.on("REQ:CHESS_SFX:ENABLE",function(){me.enable();});
b.on("REQ:CHESS_SFX:DISABLE",function(){me.disable();});
b.on("REQ:CHESS_SFX:SET_CFG",function(p){me.setCfg(p);});
b.on("EVT:CHESS_THEME:SYNC",function(p){me.onTheme(p);});
b.on("EVT:CHESS_GAME:MOVE",function(p){me.onMove(p);});
b.on("EVT:CHESS_GAME:CAPTURE",function(p){me.onCapture(p);});
b.on("EVT:CHESS_GAME:CHECK",function(p){me.onCheck(p);});
b.on("EVT:CHESS_SFX:PLAY",function(p){me.play(p);});
},
_emit(ev,p){try{this._ctx&&this._ctx.bus&&this._ctx.bus.emit(ev,p);}catch(e){this._error("_emit",e);}},
_error(where,err){
var msg=(err&&err.message)?err.message:String(err||"error");
this._state.lastError=msg;
this._emit("EVT:CHESS_SFX:ERROR",{id:this.id,where:String(where||"unknown"),error:msg,ts:Date.now()});
return null;
},
mount(p){
try{
if(this._state.mounted)return;
this._state.mounted=true;
this._emit("EVT:CHESS_SFX:MOUNTED",{id:this.id,ts:Date.now()});
}catch(e){this._error("mount",e);}
},
start(){
try{
if(!this._state.mounted)this.mount({});
this._state.started=true;
this._audioInit();
this._emit("EVT:CHESS_SFX:STARTED",{id:this.id,ts:Date.now()});
}catch(e){this._error("start",e);}
},
stop(){
try{
this._state.started=false;
this._emit("EVT:CHESS_SFX:STOPPED",{id:this.id,ts:Date.now()});
}catch(e){this._error("stop",e);}
},
enable(){this._state.enabled=true;this._emitState();},
disable(){this._state.enabled=false;this._emitState();},
_emitState(){
this._emit("EVT:CHESS_SFX:STATE",{id:this.id,state:{mounted:this._state.mounted,started:this._state.started,enabled:this._state.enabled},ts:Date.now()});
},
setCfg(p){
try{
p=p||{};
var c=this._state.cfg;
if(p.volumeMaster!=null)c.volumeMaster=this._n(p.volumeMaster,0,1);
if(p.volumeMove!=null)c.volumeMove=this._n(p.volumeMove,0,1);
if(p.volumeCapture!=null)c.volumeCapture=this._n(p.volumeCapture,0,1);
if(p.volumeCheck!=null)c.volumeCheck=this._n(p.volumeCheck,0,1);
if(p.volumeUi!=null)c.volumeUi=this._n(p.volumeUi,0,1);
if(p.rateMin!=null)c.rateMin=this._n(p.rateMin,0.5,2);
if(p.rateMax!=null)c.rateMax=this._n(p.rateMax,0.5,2);
if(c.rateMax<c.rateMin){var tmp=c.rateMin;c.rateMin=c.rateMax;c.rateMax=tmp;}
if(p.polyphony!=null)c.polyphony=this._n(p.polyphony,1,16);
if(p.softLimiter!=null)c.softLimiter=!!p.softLimiter;
if(p.cooldowns!=null){
if(p.cooldowns.move!=null)c.cooldowns.move=this._n(p.cooldowns.move,0,1000);
if(p.cooldowns.capture!=null)c.cooldowns.capture=this._n(p.cooldowns.capture,0,2000);
if(p.cooldowns.check!=null)c.cooldowns.check=this._n(p.cooldowns.check,0,4000);
if(p.cooldowns.ui!=null)c.cooldowns.ui=this._n(p.cooldowns.ui,0,1000);
}
if(p.preferWebAudio!=null)c.preferWebAudio=!!p.preferWebAudio;
this._audioInit(true);
this._emit("EVT:CHESS_SFX:CFG",{id:this.id,cfg:this._clone(c),ts:Date.now()});
}catch(e){this._error("setCfg",e);}
},
onTheme(p){
try{
p=p||{};
if(p.sfxMoveWave!=null)this._state.theme.move=String(p.sfxMoveWave);
if(p.sfxCaptureWave!=null)this._state.theme.capture=String(p.sfxCaptureWave);
if(p.sfxCheckWave!=null)this._state.theme.check=String(p.sfxCheckWave);
if(p.sfxUiWave!=null)this._state.theme.ui=String(p.sfxUiWave);
}catch(e){this._error("onTheme",e);}
},
onMove(p){
p=p||{};
this.play({type:"move",meta:p});
},
onCapture(p){
p=p||{};
this.play({type:"capture",meta:p,major:!!p.major});
},
onCheck(p){
p=p||{};
this.play({type:"check",meta:p});
},
play(p){
try{
if(!this._ok())return;
p=p||{};
var type=String(p.type||"move");
if(type!=="move"&&type!=="capture"&&type!=="check"&&type!=="ui")type="move";
if(!this._coolOK(type))return;
this._ensureUnlocked();
if(this._state.cache.useWebAudio)this._playWebAudio(type,p);
else this._playFallback(type,p);
this._emit("EVT:CHESS_SFX:PLAYED",{id:this.id,type:type,ts:Date.now()});
}catch(e){this._error("play",e);}
},
_ok(){return !!(this._state.enabled&&this._state.started);},
_coolOK(type){
var now=performance.now();
var last=this._state.cache.lastPlay[type]||0;
var cd=this._state.cfg.cooldowns[type]||0;
if(now-last<cd)return false;
this._state.cache.lastPlay[type]=now;
return true;
},
_audioInit(reinit){
var c=this._state.cfg,cc=this._state.cache;
if(!c.preferWebAudio){cc.useWebAudio=false;return;}
var AC=window.AudioContext||window.webkitAudioContext;
if(!AC){cc.useWebAudio=false;return;}
if(cc.ac&&!reinit){cc.useWebAudio=true;return;}
try{
if(!cc.ac)cc.ac=new AC();
if(!cc.master)cc.master=cc.ac.createGain();
if(!cc.gain)cc.gain=cc.ac.createGain();
cc.master.gain.value=this._state.cfg.volumeMaster;
cc.gain.gain.value=1;
cc.gain.disconnect&&cc.gain.disconnect();
cc.master.disconnect&&cc.master.disconnect();
if(this._state.cfg.softLimiter&&cc.ac.createDynamicsCompressor){
var comp=cc.ac.createDynamicsCompressor();
comp.threshold.value=-18;
comp.knee.value=18;
comp.ratio.value=8;
comp.attack.value=0.004;
comp.release.value=0.18;
cc.gain.connect(comp);
comp.connect(cc.master);
}else{
cc.gain.connect(cc.master);
}
cc.master.connect(cc.ac.destination);
this._voicesInit();
cc.useWebAudio=true;
}catch(e){
cc.useWebAudio=false;
}
},
_voicesInit(){
var cc=this._state.cache,c=this._state.cfg;
cc.voices.length=0;
cc.voiceIndex=0;
var i=0;
for(i=0;i<c.polyphony;i++)cc.voices.push({busy:false});
},
_voice(){
var cc=this._state.cache;
var v=cc.voices[cc.voiceIndex%cc.voices.length];
cc.voiceIndex=(cc.voiceIndex+1)%cc.voices.length;
return v;
},
_ensureUnlocked(){
var cc=this._state.cache;
if(!cc.useWebAudio||!cc.ac)return;
if(cc.ac.state==="suspended")cc.ac.resume&&cc.ac.resume();
},
_playWebAudio(type,p){
var cc=this._state.cache,ac=cc.ac;
if(!ac)return;
var c=this._state.cfg;
var v=this._voice();
var now=ac.currentTime;
var rate=this._rand(c.rateMin,c.rateMax);
var masterVol=c.volumeMaster;
var vol=masterVol;
var wave=this._state.theme[type]||"sine";
var f0=220;
var dur=0.12;
var envA=0.005,envD=0.06,envR=0.08;
var accent=0;
if(type==="move"){f0=440;dur=0.085;envD=0.045;vol*=c.volumeMove;accent=0.0;}
if(type==="capture"){f0=180;dur=(p&&p.major)?0.22:0.14;envD=0.09;envR=0.12;vol*=c.volumeCapture;accent=(p&&p.major)?0.25:0.12;}
if(type==="check"){f0=640;dur=0.26;envD=0.12;envR=0.16;vol*=c.volumeCheck;accent=0.22;}
if(type==="ui"){f0=520;dur=0.09;envD=0.05;vol*=c.volumeUi;accent=0.06;}
var g=ac.createGain();
g.gain.setValueAtTime(0.0001,now);
g.gain.exponentialRampToValueAtTime(Math.max(0.0002,vol),now+envA);
g.gain.exponentialRampToValueAtTime(Math.max(0.0002,vol*0.35),now+envA+envD);
g.gain.exponentialRampToValueAtTime(0.0001,now+dur+envR);
g.connect(cc.gain);
var o1=ac.createOscillator();
o1.type=wave;
o1.frequency.setValueAtTime(f0,now);
o1.frequency.exponentialRampToValueAtTime(f0*(1.08+accent),now+0.03);
o1.frequency.exponentialRampToValueAtTime(f0*(0.92),now+dur);
o1.detune.setValueAtTime((rate-1)*1200,now);
o1.connect(g);
o1.start(now);
o1.stop(now+dur+envR+0.02);
if(type==="capture"||type==="check"){
var o2=ac.createOscillator();
o2.type=(type==="check")?"square":"sawtooth";
o2.frequency.setValueAtTime(f0*2.01,now);
o2.detune.setValueAtTime((rate-1)*1200*0.6,now);
var g2=ac.createGain();
g2.gain.setValueAtTime(0.0001,now);
g2.gain.exponentialRampToValueAtTime(Math.max(0.0002,vol*0.35),now+0.01);
g2.gain.exponentialRampToValueAtTime(0.0001,now+dur*0.7);
o2.connect(g2);
g2.connect(cc.gain);
o2.start(now);
o2.stop(now+dur+0.05);
}
},
_playFallback(type,p){
var c=this._state.cfg;
var f=440,d=90;
if(type==="move"){f=520;d=65;}
if(type==="capture"){f=(p&&p.major)?140:180;d=(p&&p.major)?180:120;}
if(type==="check"){f=740;d=220;}
if(type==="ui"){f=620;d=70;}
this._beep(f,d,this._volFor(type,p));
},
_volFor(type,p){
var c=this._state.cfg;
var v=c.volumeMaster;
if(type==="move")v*=c.volumeMove;
if(type==="capture")v*=c.volumeCapture;
if(type==="check")v*=c.volumeCheck;
if(type==="ui")v*=c.volumeUi;
return this._n(v,0,1);
},
_beep(freq,ms,vol){
try{
var AC=window.AudioContext||window.webkitAudioContext;
if(!AC)return;
var ac=this._state.cache.ac;
if(!ac)this._state.cache.ac=new AC();
ac=this._state.cache.ac;
if(ac.state==="suspended")ac.resume&&ac.resume();
var o=ac.createOscillator();
var g=ac.createGain();
o.type="sine";
o.frequency.value=freq;
g.gain.value=Math.max(0.0002,vol);
o.connect(g);
g.connect(ac.destination);
var t0=ac.currentTime;
o.start(t0);
o.stop(t0+ms/1000);
}catch(e){}
},
_rand(a,b){return a+(b-a)*Math.random();},
_n(v,a,b){
v=Number(v);
if(!isFinite(v))v=a;
if(v<a)v=a;
if(v>b)v=b;
return v;
},
_clone(o){try{return JSON.parse(JSON.stringify(o));}catch(e){return o;}},
api:{
mount:function(p){return Engine_CHESS_SFX_PACK.mount(p);},
start:function(){return Engine_CHESS_SFX_PACK.start();},
stop:function(){return Engine_CHESS_SFX_PACK.stop();},
enable:function(){return Engine_CHESS_SFX_PACK.enable();},
disable:function(){return Engine_CHESS_SFX_PACK.disable();},
setCfg:function(p){return Engine_CHESS_SFX_PACK.setCfg(p);},
play:function(p){return Engine_CHESS_SFX_PACK.play(p);},
status:function(){return {id:Engine_CHESS_SFX_PACK.id,state:Engine_CHESS_SFX_PACK._state,ts:Date.now()};}
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_CHESS_SFX_PACK.id]=Engine_CHESS_SFX_PACK;
/*-- üîä‚ôüÔ∏è-(16B)-(E)-(CHESS-SFX-PACK)-(MOVES/CAPTURE/CHECK)-(E)-(16B)-‚ôüÔ∏èüîä --*/
/*-- üéöÔ∏èüå´Ô∏è-(17B)-(S)-(BOARD-PARTICLE-LAYER)-(ON/OFF/DIM)-(S)-(17B)-üå´Ô∏èüéöÔ∏è --*/
const Engine_BOARD_PARTICLE_LAYER={
id:"BOARD_PARTICLE_LAYER",
_ctx:null,
_state:{
mounted:false,started:false,enabled:true,dim:0.55,mode:"dim",lastError:null,
canvas:null,g:null,w:0,h:0,dpr:1,
anim:0,lastT:0,
budget:{maxParticles:120,spawnPerSec:28},
particles:[],
theme:{
bgFade:0.12,
sparkleAlpha:0.10,
mistAlpha:0.08
},
mask:{
enabled:false,
getRect:null
}
},
init(ctx){
this._ctx=ctx||null;
if(!this._ctx||!this._ctx.bus)return this._error("init","missing_ctx_bus");
this._wire();
this._emit("EVT:BOARD_PARTICLE_LAYER:READY",{id:this.id,ts:Date.now()});
return this;
},
_wire(){
var b=this._ctx.bus,me=this;
b.on("REQ:BOARD_PARTICLE_LAYER:MOUNT",function(p){me.mount(p);});
b.on("REQ:BOARD_PARTICLE_LAYER:START",function(){me.start();});
b.on("REQ:BOARD_PARTICLE_LAYER:STOP",function(){me.stop();});
b.on("REQ:BOARD_PARTICLE_LAYER:ENABLE",function(){me.enable();});
b.on("REQ:BOARD_PARTICLE_LAYER:DISABLE",function(){me.disable();});
b.on("REQ:BOARD_PARTICLE_LAYER:SET_MODE",function(p){me.setMode(p);});
b.on("REQ:BOARD_PARTICLE_LAYER:SET_DIM",function(p){me.setDim(p);});
b.on("REQ:BOARD_PARTICLE_LAYER:SET_MASK",function(p){me.setMask(p);});
b.on("EVT:CHESS_THEME:SYNC",function(p){me.onTheme(p);});
b.on("EVT:BOARD_LAYOUT:RECT",function(p){me.onBoardRect(p);});
b.on("EVT:BOARD_RENDER:TICK",function(p){me.onExternalTick(p);});
},
_emit(ev,p){try{this._ctx&&this._ctx.bus&&this._ctx.bus.emit(ev,p);}catch(e){this._error("_emit",e);}},
_error(where,err){
var msg=(err&&err.message)?err.message:String(err||"error");
this._state.lastError=msg;
this._emit("EVT:BOARD_PARTICLE_LAYER:ERROR",{id:this.id,where:String(where||"unknown"),error:msg,ts:Date.now()});
return null;
},
mount(p){
try{
if(this._state.mounted)return;
p=p||{};
this._ensureCanvas(p);
this._state.mounted=true;
this._resize();
this._emit("EVT:BOARD_PARTICLE_LAYER:MOUNTED",{id:this.id,ts:Date.now()});
}catch(e){this._error("mount",e);}
},
start(){
try{
if(!this._state.mounted)this.mount({});
this._state.started=true;
this._kick();
this._emit("EVT:BOARD_PARTICLE_LAYER:STARTED",{id:this.id,ts:Date.now()});
}catch(e){this._error("start",e);}
},
stop(){
try{
this._state.started=false;
if(this._state.anim)cancelAnimationFrame(this._state.anim);
this._state.anim=0;
this._emit("EVT:BOARD_PARTICLE_LAYER:STOPPED",{id:this.id,ts:Date.now()});
}catch(e){this._error("stop",e);}
},
enable(){this._state.enabled=true;this._emitState();this._kick();},
disable(){this._state.enabled=false;this._emitState();this._clear();},
_emitState(){
this._emit("EVT:BOARD_PARTICLE_LAYER:STATE",{id:this.id,state:{mounted:this._state.mounted,started:this._state.started,enabled:this._state.enabled,mode:this._state.mode,dim:this._state.dim},ts:Date.now()});
},
setMode(p){
p=p||{};
var m=String(p.mode||p||"dim");
if(m!=="off"&&m!=="dim"&&m!=="on")m="dim";
this._state.mode=m;
this._emitState();
},
setDim(p){
p=p||{};
var v=(p.dim!=null)?p.dim:p;
v=this._n(v,0,1);
this._state.dim=v;
this._emitState();
},
setMask(p){
p=p||{};
this._state.mask.enabled=!!p.enabled;
this._state.mask.getRect=(typeof p.getRect==="function")?p.getRect:null;
this._emit("EVT:BOARD_PARTICLE_LAYER:MASK",{id:this.id,mask:{enabled:this._state.mask.enabled,hasGetter:!!this._state.mask.getRect},ts:Date.now()});
},
onTheme(p){
try{
p=p||{};
if(p.particlesMax!=null)this._state.budget.maxParticles=this._n(p.particlesMax,0,800);
if(p.particlesSpawnPerSec!=null)this._state.budget.spawnPerSec=this._n(p.particlesSpawnPerSec,0,200);
if(p.particlesBgFade!=null)this._state.theme.bgFade=this._n(p.particlesBgFade,0,1);
if(p.particlesSparkleAlpha!=null)this._state.theme.sparkleAlpha=this._n(p.particlesSparkleAlpha,0,1);
if(p.particlesMistAlpha!=null)this._state.theme.mistAlpha=this._n(p.particlesMistAlpha,0,1);
}catch(e){this._error("onTheme",e);}
},
onBoardRect(p){
p=p||{};
if(p.getRect&&typeof p.getRect==="function"){this.setMask({enabled:true,getRect:p.getRect});return;}
if(p.rect){var r=p.rect;this.setMask({enabled:true,getRect:function(){return r;}});return;}
},
onExternalTick(p){
p=p||{};
if(p.resize)this._resize();
},
_ensureCanvas(p){
var host=null;
if(p.host)host=(typeof p.host==="string")?document.querySelector(p.host):p.host;
if(!host)host=document.body;
var c=document.createElement("canvas");
c.setAttribute("data-kog","BOARD_PARTICLE_LAYER");
c.style.position="absolute";
c.style.left="0";
c.style.top="0";
c.style.width="100%";
c.style.height="100%";
c.style.pointerEvents="none";
c.style.zIndex=String(p.zIndex!=null?p.zIndex:40);
c.style.mixBlendMode=String(p.blend||"screen");
c.style.opacity="1";
var cs=window.getComputedStyle(host);
if(cs.position==="static")host.style.position="relative";
host.appendChild(c);
this._state.canvas=c;
this._state.g=c.getContext("2d",{alpha:true,desynchronized:true});
},
_kick(){
if(!this._state.started||!this._state.enabled)return;
if(this._state.anim)return;
this._state.lastT=performance.now();
this._loop();
},
_loop(){
var me=this;
this._state.anim=requestAnimationFrame(function(t){me._tick(t);});
},
_tick(t){
try{
if(!this._state.started||!this._state.enabled){this._state.anim=0;return;}
var dt=Math.min(0.05,Math.max(0.001,(t-this._state.lastT)/1000));
this._state.lastT=t;
this._resizeIfNeeded();
this._spawn(dt);
this._step(dt);
this._draw(dt);
this._loop();
}catch(e){this._state.anim=0;this._error("_tick",e);}
},
_resizeIfNeeded(){
var c=this._state.canvas;
if(!c)return;
var dpr=Math.max(1,Math.min(3,window.devicePixelRatio||1));
var w=c.clientWidth||this._state.w;
var h=c.clientHeight||this._state.h;
if(w!==this._state.w||h!==this._state.h||dpr!==this._state.dpr)this._resize();
},
_resize(){
var c=this._state.canvas;
if(!c)return;
this._state.dpr=Math.max(1,Math.min(3,window.devicePixelRatio||1));
this._state.w=c.clientWidth||window.innerWidth;
this._state.h=c.clientHeight||window.innerHeight;
c.width=Math.max(1,Math.floor(this._state.w*this._state.dpr));
c.height=Math.max(1,Math.floor(this._state.h*this._state.dpr));
this._emit("EVT:BOARD_PARTICLE_LAYER:RESIZE",{id:this.id,w:this._state.w,h:this._state.h,dpr:this._state.dpr,ts:Date.now()});
},
_spawn(dt){
var s=this._state,cap=s.budget.maxParticles|0;
if(s.mode==="off")return;
if(s.particles.length>=cap)return;
var want=s.budget.spawnPerSec*dt;
var n=Math.floor(want);
if(Math.random()<(want-n))n++;
if(!n)return;
var i=0;
for(i=0;i<n;i++){
if(s.particles.length>=cap)break;
s.particles.push(this._makeParticle());
}
},
_makeParticle(){
var s=this._state;
var r=this._maskRect();
var x=this._rand(r.x,r.x+r.w);
var y=this._rand(r.y,r.y+r.h);
var kind=(Math.random()<0.65)?"mist":"spark";
var sp=kind==="mist"?this._rand(6,16):this._rand(22,55);
var ang=this._rand(0,Math.PI*2);
var vx=Math.cos(ang)*sp;
var vy=Math.sin(ang)*sp*0.55;
var life=kind==="mist"?this._rand(2.5,4.8):this._rand(0.9,1.8);
var sz=kind==="mist"?this._rand(14,34):this._rand(1.2,2.8);
return {k:kind,x:x,y:y,vx:vx,vy:vy,life:life,t:0,sz:sz,tw:this._rand(1.5,3.5),ph:this._rand(0,Math.PI*2)};
},
_step(dt){
var s=this._state,ps=s.particles;
var i=ps.length-1,p;
var r=this._maskRect();
for(i=ps.length-1;i>=0;i--){
p=ps[i];
p.t+=dt;
p.x+=p.vx*dt;
p.y+=p.vy*dt;
if(p.k==="mist"){
p.vx*=Math.pow(0.93,dt*60);
p.vy*=Math.pow(0.93,dt*60);
p.vx+=Math.sin(p.ph+p.t*p.tw)*2.2;
p.vy+=Math.cos(p.ph+p.t*p.tw)*1.4;
}else{
p.vx*=Math.pow(0.90,dt*60);
p.vy*=Math.pow(0.90,dt*60);
}
if(p.t>=p.life){ps.splice(i,1);continue;}
if(p.x<r.x-60||p.x>r.x+r.w+60||p.y<r.y-60||p.y>r.y+r.h+60){ps.splice(i,1);continue;}
}
},
_draw(dt){
var s=this._state,g=s.g,c=s.canvas;
if(!g||!c)return;
var mode=s.mode;
var alpha=1;
if(mode==="off"){this._clear();return;}
if(mode==="dim")alpha=s.dim;
g.setTransform(s.dpr,0,0,s.dpr,0,0);
g.globalCompositeOperation="source-over";
g.fillStyle="rgba(0,0,0,"+this._n(s.theme.bgFade*alpha,0,1)+")";
g.fillRect(0,0,s.w,s.h);
var r=this._maskRect();
if(s.mask.enabled){
g.save();
g.beginPath();
g.rect(r.x,r.y,r.w,r.h);
g.clip();
}
g.globalCompositeOperation="lighter";
this._drawParticles(alpha);
if(s.mask.enabled)g.restore();
},
_drawParticles(alpha){
var s=this._state,g=s.g,ps=s.particles;
var i=0,p,a,t,tw,sc;
for(i=0;i<ps.length;i++){
p=ps[i];
t=p.t/p.life;
if(p.k==="mist"){
a=(1-t)*s.theme.mistAlpha*alpha;
if(a<=0.001)continue;
sc=1+(t*0.25);
g.beginPath();
g.fillStyle="rgba(255,255,255,"+a+")";
g.arc(p.x,p.y,p.sz*sc,0,Math.PI*2);
g.fill();
}else{
tw=0.5+0.5*Math.sin(p.ph+p.t*p.tw*6.2);
a=(0.25+0.75*tw)*s.theme.sparkleAlpha*alpha*(1-t);
if(a<=0.001)continue;
g.fillStyle="rgba(255,255,255,"+a+")";
g.fillRect(p.x,p.y,p.sz,p.sz);
if(Math.random()<0.10){
g.fillStyle="rgba(255,255,255,"+(a*0.55)+")";
g.fillRect(p.x-p.sz*2,p.y,p.sz*4,p.sz*0.6);
}
}
}
},
_maskRect(){
var s=this._state;
if(s.mask.enabled&&s.mask.getRect){
try{
var r=s.mask.getRect();
if(r&&isFinite(r.x)&&isFinite(r.y)&&isFinite(r.w)&&isFinite(r.h))return {x:r.x,y:r.y,w:r.w,h:r.h};
}catch(e){}
}
return {x:0,y:0,w:s.w||window.innerWidth,h:s.h||window.innerHeight};
},
_clear(){
var s=this._state,g=s.g;
if(!g)return;
g.setTransform(s.dpr,0,0,s.dpr,0,0);
g.clearRect(0,0,s.w,s.h);
},
_rand(a,b){return a+(b-a)*Math.random();},
_n(v,a,b){
v=Number(v);
if(!isFinite(v))v=a;
if(v<a)v=a;
if(v>b)v=b;
return v;
},
api:{
mount:function(p){return Engine_BOARD_PARTICLE_LAYER.mount(p);},
start:function(){return Engine_BOARD_PARTICLE_LAYER.start();},
stop:function(){return Engine_BOARD_PARTICLE_LAYER.stop();},
enable:function(){return Engine_BOARD_PARTICLE_LAYER.enable();},
disable:function(){return Engine_BOARD_PARTICLE_LAYER.disable();},
setMode:function(p){return Engine_BOARD_PARTICLE_LAYER.setMode(p);},
setDim:function(p){return Engine_BOARD_PARTICLE_LAYER.setDim(p);},
setMask:function(p){return Engine_BOARD_PARTICLE_LAYER.setMask(p);},
play:function(p){return Engine_BOARD_PARTICLE_LAYER._emit("EVT:BOARD_PARTICLE_LAYER:PLAY",p||{});},
status:function(){return {id:Engine_BOARD_PARTICLE_LAYER.id,state:Engine_BOARD_PARTICLE_LAYER._state,ts:Date.now()};}
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_BOARD_PARTICLE_LAYER.id]=Engine_BOARD_PARTICLE_LAYER;
/*-- üéöÔ∏èüå´Ô∏è-(17B)-(E)-(BOARD-PARTICLE-LAYER)-(ON/OFF/DIM)-(E)-(17B)-üå´Ô∏èüéöÔ∏è --*/
/*-- üß≤üõ°Ô∏è-(18B)-(S)-(PARTICLE-ISOLATION-MASK)-(BOARD-ONLY)-(S)-(18B)-üõ°Ô∏èüß≤ --*/
const Engine_PARTICLE_ISOLATION_MASK={
id:"PARTICLE_ISOLATION_MASK",
_ctx:null,
_state:{
ready:false,
enabled:true,
rect:{x:0,y:0,w:0,h:0},
source:"none",
lastError:null
},
init(ctx){
this._ctx=ctx||null;
if(!this._ctx||!this._ctx.bus)return this._error("init","missing_ctx_bus");
this._wire();
this._state.ready=true;
this._emit("EVT:PARTICLE_ISOLATION_MASK:READY",{id:this.id,ts:Date.now()});
this._syncToParticles();
return this;
},
_wire(){
var b=this._ctx.bus,me=this;
b.on("REQ:PARTICLE_ISOLATION_MASK:ENABLE",function(){me.enable();});
b.on("REQ:PARTICLE_ISOLATION_MASK:DISABLE",function(){me.disable();});
b.on("REQ:PARTICLE_ISOLATION_MASK:SET_RECT",function(p){me.setRect(p);});
b.on("REQ:PARTICLE_ISOLATION_MASK:SET_SOURCE",function(p){me.setSource(p);});
b.on("EVT:BOARD_LAYOUT:RECT",function(p){me.onBoardRect(p);});
b.on("EVT:RESPONSIVE_BOARD_LAYOUT:RECT",function(p){me.onBoardRect(p);});
b.on("EVT:RENDER_BOARD_ENGINE:RECT",function(p){me.onBoardRect(p);});
b.on("EVT:BOARD_PARTICLE_LAYER:READY",function(){me._syncToParticles();});
b.on("EVT:BOARD_PARTICLE_LAYER:MOUNTED",function(){me._syncToParticles();});
},
_emit(ev,p){try{this._ctx&&this._ctx.bus&&this._ctx.bus.emit(ev,p);}catch(e){this._error("_emit",e);}},
_error(where,err){
var msg=(err&&err.message)?err.message:String(err||"error");
this._state.lastError=msg;
this._emit("EVT:PARTICLE_ISOLATION_MASK:ERROR",{id:this.id,where:String(where||"unknown"),error:msg,ts:Date.now()});
return null;
},
enable(){
this._state.enabled=true;
this._emitState();
this._syncToParticles();
},
disable(){
this._state.enabled=false;
this._emitState();
this._syncToParticles();
},
setRect(p){
p=p||{};
var r=p.rect||p;
if(!r)return;
this._state.rect.x=this._n(r.x,0,1e9);
this._state.rect.y=this._n(r.y,0,1e9);
this._state.rect.w=this._n(r.w,0,1e9);
this._state.rect.h=this._n(r.h,0,1e9);
this._state.source=String(p.source||this._state.source||"manual");
this._emit("EVT:PARTICLE_ISOLATION_MASK:RECT",{id:this.id,rect:this._copyRect(),source:this._state.source,ts:Date.now()});
this._syncToParticles();
},
setSource(p){
p=p||{};
this._state.source=String(p.source||p||"manual");
this._emitState();
},
onBoardRect(p){
try{
p=p||{};
var r=null;
if(p.getRect&&typeof p.getRect==="function"){r=p.getRect();}
else if(p.rect)r=p.rect;
else if(p.boardRect)r=p.boardRect;
if(!r||!isFinite(r.x)||!isFinite(r.y)||!isFinite(r.w)||!isFinite(r.h))return;
this.setRect({rect:r,source:String(p.source||"board")});
}catch(e){this._error("onBoardRect",e);}
},
_copyRect(){
var r=this._state.rect;
return {x:r.x,y:r.y,w:r.w,h:r.h};
},
_emitState(){
this._emit("EVT:PARTICLE_ISOLATION_MASK:STATE",{id:this.id,state:{ready:this._state.ready,enabled:this._state.enabled,rect:this._copyRect(),source:this._state.source},ts:Date.now()});
},
_syncToParticles(){
try{
var particles=window.KOG&&window.KOG.BOARD_PARTICLE_LAYER;
if(!particles||!particles.api||!particles.api.setMask)return;
var enabled=this._state.enabled;
var r=this._copyRect();
if(!enabled){particles.api.setMask({enabled:false,getRect:null});return;}
particles.api.setMask({enabled:true,getRect:function(){return r;}});
}catch(e){this._error("_syncToParticles",e);}
},
_n(v,a,b){
v=Number(v);
if(!isFinite(v))v=a;
if(v<a)v=a;
if(v>b)v=b;
return v;
},
api:{
enable:function(){return Engine_PARTICLE_ISOLATION_MASK.enable();},
disable:function(){return Engine_PARTICLE_ISOLATION_MASK.disable();},
setRect:function(p){return Engine_PARTICLE_ISOLATION_MASK.setRect(p);},
status:function(){return {id:Engine_PARTICLE_ISOLATION_MASK.id,state:Engine_PARTICLE_ISOLATION_MASK._state,ts:Date.now()};}
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_PARTICLE_ISOLATION_MASK.id]=Engine_PARTICLE_ISOLATION_MASK;
/*-- üß≤üõ°Ô∏è-(18B)-(E)-(PARTICLE-ISOLATION-MASK)-(BOARD-ONLY)-(E)-(18B)-üõ°Ô∏èüß≤ --*/
/-- üß†üìú-(19B)-(S)-(STATE-MEMORY-PROFILE)-(PERSIST-SETTINGS)-(S)-(19B)-üìúüß† --/
const Engine_STATE_MEMORY_PROFILE={
id:"STATE_MEMORY_PROFILE",
_ctx:null,
_key:"LEGION_CHESS::STATE_MEMORY_PROFILE",
_state:{
ready:false,
enabled:true,
version:1,
data:{
theme:{},
ui:{},
board:{},
particles:{},
audio:{},
game:{},
last:{}
},
lastSave:0,
lastLoad:0,
lastError:null
},
init(ctx){
this._ctx=ctx||null;
if(!this._ctx||!this._ctx.bus)return this._error("init","missing_ctx_bus");
this._wire();
this.load({silent:true});
this._state.ready=true;
this._emit("EVT:STATE_MEMORY_PROFILE:READY",{id:this.id,ts:Date.now()});
return this;
},
_wire(){
var b=this._ctx.bus,me=this;
b.on("REQ:STATE_MEMORY_PROFILE:ENABLE",function(){me.enable();});
b.on("REQ:STATE_MEMORY_PROFILE:DISABLE",function(){me.disable();});
b.on("REQ:STATE_MEMORY_PROFILE:LOAD",function(p){me.load(p);});
b.on("REQ:STATE_MEMORY_PROFILE:SAVE",function(p){me.save(p);});
b.on("REQ:STATE_MEMORY_PROFILE:RESET",function(p){me.reset(p);});
b.on("REQ:STATE_MEMORY_PROFILE:SET",function(p){me.set(p);});
b.on("REQ:STATE_MEMORY_PROFILE:GET",function(p){me.get(p);});
b.on("REQ:STATE_MEMORY_PROFILE:SET_KEY",function(p){me.setKey(p);});
b.on("EVT:THEME_INHERIT_BRIDGE:STATE",function(p){me._ingest("theme",p);});
b.on("EVT:SETTINGS_MENU_HOOK:STATE",function(p){me._ingest("ui",p);});
b.on("EVT:GAME_OVERRIDE_PROFILE:STATE",function(p){me._ingest("game",p);});
b.on("EVT:RESPONSIVE_BOARD_LAYOUT:STATE",function(p){me._ingest("board",p);});
b.on("EVT:BOARD_PARTICLE_LAYER:STATE",function(p){me._ingest("particles",p);});
b.on("EVT:CHESS_SFX_PACK:STATE",function(p){me._ingest("audio",p);});
},
_emit(ev,p){try{this._ctx&&this._ctx.bus&&this._ctx.bus.emit(ev,p);}catch(e){this._error("_emit",e);}},
_error(where,err){
var msg=(err&&err.message)?err.message:String(err||"error");
this._state.lastError=msg;
this._emit("EVT:STATE_MEMORY_PROFILE:ERROR",{id:this.id,where:String(where||"unknown"),error:msg,ts:Date.now()});
return null;
},
enable(){this._state.enabled=true;this._emitState();},
disable(){this._state.enabled=false;this._emitState();},
setKey(p){
p=p||{};
var k=String(p.key||p||"").trim();
if(!k)return;
this._key=k;
this._emit("EVT:STATE_MEMORY_PROFILE:KEY",{id:this.id,key:this._key,ts:Date.now()});
},
_ingest(bucket,p){
if(!this._state.enabled)return;
bucket=String(bucket||"misc");
if(!this._state.data[bucket])this._state.data[bucket]={};
this._state.data[bucket]=this._safeClone(p);
this._state.data.last={bucket:bucket,ts:Date.now()};
this._emit("EVT:STATE_MEMORY_PROFILE:INGEST",{id:this.id,bucket:bucket,ts:Date.now()});
},
set(p){
p=p||{};
if(!this._state.enabled)return;
var path=String(p.path||"").trim();
var val=("value" in p)?p.value:null;
if(!path)return;
this._setPath(this._state.data,path,val);
this._state.data.last={bucket:"manual",path:path,ts:Date.now()};
this._emit("EVT:STATE_MEMORY_PROFILE:SET",{id:this.id,path:path,ts:Date.now()});
},
get(p){
p=p||{};
var path=String(p.path||"").trim();
var out=path?this._getPath(this._state.data,path):this._safeClone(this._state.data);
this._emit("EVT:STATE_MEMORY_PROFILE:GET",{id:this.id,path:path||"*",value:this._safeClone(out),ts:Date.now()});
return out;
},
load(p){
p=p||{};
if(!this._state.enabled&&!p.force)return;
var raw=null,obj=null;
try{
raw=localStorage.getItem(this._key);
if(!raw){this._state.lastLoad=Date.now();if(!p.silent)this._emitState();return;}
obj=JSON.parse(raw);
if(!obj||typeof obj!=="object")return;
if(obj.v!==this._state.version&&typeof obj.v==="number")this._state.version=obj.v;
if(obj.data&&typeof obj.data==="object")this._state.data=this._mergeDefaults(this._state.data,obj.data);
this._state.lastLoad=Date.now();
if(!p.silent)this._emit("EVT:STATE_MEMORY_PROFILE:LOADED",{id:this.id,key:this._key,ts:this._state.lastLoad});
if(!p.silent)this._emitState();
this._rehydrate();
}catch(e){this._error("load",e);}
},
save(p){
p=p||{};
if(!this._state.enabled&&!p.force)return;
try{
var payload={v:this._state.version,ts:Date.now(),data:this._safeClone(this._state.data)};
localStorage.setItem(this._key,JSON.stringify(payload));
this._state.lastSave=payload.ts;
if(!p.silent)this._emit("EVT:STATE_MEMORY_PROFILE:SAVED",{id:this.id,key:this._key,ts:this._state.lastSave});
if(!p.silent)this._emitState();
}catch(e){this._error("save",e);}
},
reset(p){
p=p||{};
try{
if(p.hard){localStorage.removeItem(this._key);}
this._state.data={theme:{},ui:{},board:{},particles:{},audio:{},game:{},last:{}};
this._state.lastSave=0;
this._state.lastLoad=0;
this._emit("EVT:STATE_MEMORY_PROFILE:RESET",{id:this.id,hard:!!p.hard,ts:Date.now()});
this._emitState();
if(p.apply)this._rehydrate();
}catch(e){this._error("reset",e);}
},
_rehydrate(){
try{
var d=this._state.data,b=this._ctx.bus;
if(d.theme)b.emit("REQ:THEME_INHERIT_BRIDGE:APPLY_STATE",{state:this._safeClone(d.theme)});
if(d.ui)b.emit("REQ:SETTINGS_MENU_HOOK:APPLY_STATE",{state:this._safeClone(d.ui)});
if(d.board)b.emit("REQ:RESPONSIVE_BOARD_LAYOUT:APPLY_STATE",{state:this._safeClone(d.board)});
if(d.particles)b.emit("REQ:BOARD_PARTICLE_LAYER:APPLY_STATE",{state:this._safeClone(d.particles)});
if(d.audio)b.emit("REQ:CHESS_SFX_PACK:APPLY_STATE",{state:this._safeClone(d.audio)});
if(d.game)b.emit("REQ:GAME_OVERRIDE_PROFILE:APPLY_STATE",{state:this._safeClone(d.game)});
this._emit("EVT:STATE_MEMORY_PROFILE:APPLIED",{id:this.id,ts:Date.now()});
}catch(e){this._error("_rehydrate",e);}
},
_emitState(){
this._emit("EVT:STATE_MEMORY_PROFILE:STATE",{id:this.id,state:{ready:this._state.ready,enabled:this._state.enabled,version:this._state.version,key:this._key,lastSave:this._state.lastSave,lastLoad:this._state.lastLoad},ts:Date.now()});
},
_mergeDefaults(base,incoming){
var out=this._safeClone(base);
this._deepMerge(out,incoming);
return out;
},
_deepMerge(t,s){
if(!s||typeof s!=="object")return;
var k;
for(k in s){
if(!Object.prototype.hasOwnProperty.call(s,k))continue;
if(s[k]&&typeof s[k]==="object"&&!Array.isArray(s[k])){
if(!t[k]||typeof t[k]!=="object"||Array.isArray(t[k]))t[k]={};
this._deepMerge(t[k],s[k]);
}else{
t[k]=s[k];
}
}
},
_safeClone(v){
try{return JSON.parse(JSON.stringify(v||null));}catch(e){return null;}
},
_getPath(o,path){
var parts=path.split("."),cur=o,i=0;
for(i=0;i<parts.length;i++){
if(!cur||typeof cur!=="object")return null;
cur=cur[parts[i]];
}
return cur;
},
_setPath(o,path,val){
var parts=path.split("."),cur=o,i=0;
for(i=0;i<parts.length-1;i++){
if(!cur[parts[i]]||typeof cur[parts[i]]!=="object")cur[parts[i]]={};
cur=cur[parts[i]];
}
cur[parts[parts.length-1]]=val;
},
api:{
enable:function(){return Engine_STATE_MEMORY_PROFILE.enable();},
disable:function(){return Engine_STATE_MEMORY_PROFILE.disable();},
load:function(p){return Engine_STATE_MEMORY_PROFILE.load(p);},
save:function(p){return Engine_STATE_MEMORY_PROFILE.save(p);},
reset:function(p){return Engine_STATE_MEMORY_PROFILE.reset(p);},
set:function(p){return Engine_STATE_MEMORY_PROFILE.set(p);},
get:function(p){return Engine_STATE_MEMORY_PROFILE.get(p);},
setKey:function(p){return Engine_STATE_MEMORY_PROFILE.setKey(p);},
status:function(){return {id:Engine_STATE_MEMORY_PROFILE.id,key:Engine_STATE_MEMORY_PROFILE._key,state:Engine_STATE_MEMORY_PROFILE._state,ts:Date.now()};}
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_STATE_MEMORY_PROFILE.id]=Engine_STATE_MEMORY_PROFILE;
/-- üß†üìú-(19B)-(E)-(STATE-MEMORY-PROFILE)-(PERSIST-SETTINGS)-(E)-(19B)-üìúüß† --/
/-- üéõÔ∏èüßæ-(20B)-(S)-(IN-GAME-SETTINGS-UI)-(ACCORDION)-(S)-(20B)-üßæüéõÔ∏è --/
const Engine_IN_GAME_SETTINGS_UI={
id:"IN_GAME_SETTINGS_UI",
_ctx:null,
_root:null,
_panel:null,
_btn:null,
_sections:[],
_open:null,
_state:{
ready:false,
enabled:true,
visible:false,
x:12,
y:12,
w:320,
maxH:420,
dock:"TR",
opacity:0.96,
z:9999,
autoSave:true,
lastAction:0
},
init(ctx){
this._ctx=ctx||null;
if(!this._ctx||!this._ctx.bus)return this._error("init","missing_ctx_bus");
this._mount();
this._wire();
this._applyDock();
this._syncUI();
this._state.ready=true;
this._emit("EVT:IN_GAME_SETTINGS_UI:READY",{id:this.id,ts:Date.now()});
return this;
},
_wire(){
var b=this._ctx.bus,me=this;
b.on("REQ:IN_GAME_SETTINGS_UI:SHOW",function(p){me.show(p);});
b.on("REQ:IN_GAME_SETTINGS_UI:HIDE",function(p){me.hide(p);});
b.on("REQ:IN_GAME_SETTINGS_UI:TOGGLE",function(p){me.toggle(p);});
b.on("REQ:IN_GAME_SETTINGS_UI:APPLY_STATE",function(p){me.applyState(p);});
b.on("REQ:IN_GAME_SETTINGS_UI:GET_STATE",function(){me._emitState();});
b.on("REQ:IN_GAME_SETTINGS_UI:SET",function(p){me.set(p);});
b.on("EVT:STATE_MEMORY_PROFILE:READY",function(){me._announceStateToMemory();});
b.on("REQ:IN_GAME_SETTINGS_UI:BUILD_DEFAULTS",function(){me.buildDefaults();});
},
_mount(){
var root=document.createElement("div");
root.id="KOG_IN_GAME_SETTINGS_UI";
root.style.position="fixed";
root.style.left="0px";
root.style.top="0px";
root.style.width="0px";
root.style.height="0px";
root.style.zIndex=String(this._state.z);
root.style.pointerEvents="none";
document.body.appendChild(root);
this._root=root;

var panel=document.createElement("div");
panel.style.position="absolute";
panel.style.minWidth="260px";
panel.style.width=this._state.w+"px";
panel.style.maxWidth="92vw";
panel.style.maxHeight=this._state.maxH+"px";
panel.style.overflow="hidden";
panel.style.borderRadius="14px";
panel.style.border="1px solid rgba(255,255,255,0.18)";
panel.style.background="rgba(10,10,12,0.72)";
panel.style.backdropFilter="blur(10px)";
panel.style.boxShadow="0 10px 40px rgba(0,0,0,0.45)";
panel.style.opacity=String(this._state.opacity);
panel.style.pointerEvents="auto";
panel.style.display="none";
panel.setAttribute("data-open","0");
this._panel=panel;
root.appendChild(panel);

var header=document.createElement("div");
header.style.display="flex";
header.style.alignItems="center";
header.style.justifyContent="space-between";
header.style.gap="10px";
header.style.padding="10px 12px";
header.style.userSelect="none";
header.style.borderBottom="1px solid rgba(255,255,255,0.10)";
panel.appendChild(header);

var title=document.createElement("div");
title.textContent="SETTINGS";
title.style.fontFamily="system-ui,Segoe UI,Arial";
title.style.fontWeight="800";
title.style.letterSpacing="1px";
title.style.fontSize="12px";
title.style.color="rgba(255,255,255,0.92)";
header.appendChild(title);

var controls=document.createElement("div");
controls.style.display="flex";
controls.style.alignItems="center";
controls.style.gap="8px";
header.appendChild(controls);

var drag=document.createElement("div");
drag.textContent="‚†ø";
drag.title="Drag";
drag.style.width="28px";
drag.style.height="28px";
drag.style.display="grid";
drag.style.placeItems="center";
drag.style.borderRadius="10px";
drag.style.border="1px solid rgba(255,255,255,0.16)";
drag.style.background="rgba(255,255,255,0.06)";
drag.style.color="rgba(255,255,255,0.85)";
drag.style.cursor="grab";
controls.appendChild(drag);

var close=document.createElement("div");
close.textContent="‚úï";
close.title="Close";
close.style.width="28px";
close.style.height="28px";
close.style.display="grid";
close.style.placeItems="center";
close.style.borderRadius="10px";
close.style.border="1px solid rgba(255,255,255,0.16)";
close.style.background="rgba(255,255,255,0.06)";
close.style.color="rgba(255,255,255,0.85)";
close.style.cursor="pointer";
controls.appendChild(close);

var body=document.createElement("div");
body.style.maxHeight=(this._state.maxH-44)+"px";
body.style.overflow="auto";
body.style.padding="8px";
body.style.webkitOverflowScrolling="touch";
panel.appendChild(body);

this._btn=this._makeFloatingButton();
root.appendChild(this._btn);

var me=this;
close.onclick=function(){me.hide({src:"ui_close"});};
this._enableDrag(drag,panel);

this._body=body;

this.buildDefaults();
},
_makeFloatingButton(){
var btn=document.createElement("div");
btn.textContent="‚öôÔ∏è";
btn.title="Settings";
btn.style.position="absolute";
btn.style.width="44px";
btn.style.height="44px";
btn.style.display="grid";
btn.style.placeItems="center";
btn.style.borderRadius="16px";
btn.style.border="1px solid rgba(255,255,255,0.18)";
btn.style.background="rgba(10,10,12,0.62)";
btn.style.backdropFilter="blur(10px)";
btn.style.boxShadow="0 10px 26px rgba(0,0,0,0.45)";
btn.style.cursor="pointer";
btn.style.userSelect="none";
btn.style.pointerEvents="auto";
btn.style.color="rgba(255,255,255,0.92)";
btn.style.transform="translateZ(0)";
var me=this;
btn.onclick=function(){me.toggle({src:"fab"});};
return btn;
},
_enableDrag(handle,panel){
var me=this,dragging=false,sx=0,sy=0,ox=0,oy=0;
handle.addEventListener("pointerdown",function(e){
dragging=true;
handle.setPointerCapture(e.pointerId);
handle.style.cursor="grabbing";
sx=e.clientX;sy=e.clientY;
ox=me._state.x;oy=me._state.y;
me._state.dock="FREE";
me._applyDock();
});
handle.addEventListener("pointermove",function(e){
if(!dragging)return;
var dx=e.clientX-sx,dy=e.clientY-sy;
me._state.x=Math.max(6,Math.min(window.innerWidth-60,ox+dx));
me._state.y=Math.max(6,Math.min(window.innerHeight-60,oy+dy));
me._applyDock();
me._touch("drag");
});
handle.addEventListener("pointerup",function(e){
dragging=false;
handle.style.cursor="grab";
me._snapDock();
me._applyDock();
me._touch("drag_end");
if(me._state.autoSave)me._persist();
});
},
_snapDock(){
var w=window.innerWidth,h=window.innerHeight;
var x=this._state.x,y=this._state.y;
var horiz=(x>w*0.5)?"R":"L";
var vert=(y>h*0.5)?"B":"T";
if(this._state.dock==="FREE")this._state.dock=vert+horiz;
},
_applyDock(){
var dock=this._state.dock;
var pad=8;
if(dock==="TR"){this._panel.style.top=pad+"px";this._panel.style.right=pad+"px";this._panel.style.left="";this._panel.style.bottom="";}
if(dock==="TL"){this._panel.style.top=pad+"px";this._panel.style.left=pad+"px";this._panel.style.right="";this._panel.style.bottom="";}
if(dock==="BR"){this._panel.style.bottom=pad+"px";this._panel.style.right=pad+"px";this._panel.style.left="";this._panel.style.top="";}
if(dock==="BL"){this._panel.style.bottom=pad+"px";this._panel.style.left=pad+"px";this._panel.style.right="";this._panel.style.top="";}
if(dock==="FREE"){
this._panel.style.left=Math.round(this._state.x)+"px";
this._panel.style.top=Math.round(this._state.y)+"px";
this._panel.style.right="";
this._panel.style.bottom="";
}
this._btn.style.right=(dock==="TL"||dock==="BL")?"":"10px";
this._btn.style.left=(dock==="TL"||dock==="BL")?"10px":"";
this._btn.style.bottom=(dock==="TR"||dock==="TL")?"":"10px";
this._btn.style.top=(dock==="TR"||dock==="TL")?"10px":"";
},
buildDefaults(){
this._sections=[];
this._body.innerHTML="";
this._addSection("THEME",[
this._toggleRow("Text Glow","REQ:THEME_INHERIT_BRIDGE:SET",{path:"glow.enabled"},true),
this._rangeRow("Glow Strength","REQ:THEME_INHERIT_BRIDGE:SET",{path:"glow.strength"},0,100,65),
this._buttonRow("Apply Theme","REQ:THEME_INHERIT_BRIDGE:APPLY",{})
]);
this._addSection("AUDIO",[
this._toggleRow("SFX Enabled","REQ:CHESS_SFX_PACK:SET",{path:"enabled"},true),
this._rangeRow("SFX Volume","REQ:CHESS_SFX_PACK:SET",{path:"volume"},0,100,85),
this._buttonRow("Test SFX","REQ:CHESS_SFX_PACK:TEST",{})
]);
this._addSection("PARTICLES",[
this._toggleRow("Board Particles","REQ:BOARD_PARTICLE_LAYER:SET",{path:"enabled"},true),
this._rangeRow("Particle Dim","REQ:BOARD_PARTICLE_LAYER:SET",{path:"dim"},0,100,35),
this._buttonRow("Re-seed","REQ:BOARD_PARTICLE_LAYER:RESEED",{})
]);
this._addSection("BOARD",[
this._toggleRow("Fit Max","REQ:RESPONSIVE_BOARD_LAYOUT:SET",{path:"maxFit"},true),
this._rangeRow("Board Scale","REQ:RESPONSIVE_BOARD_LAYOUT:SET",{path:"scale"},50,140,100)
]);
this._addSection("PROFILE",[
this._toggleRow("Auto Save","REQ:IN_GAME_SETTINGS_UI:SET",{path:"autoSave"},true),
this._buttonRow("Save Now","REQ:STATE_MEMORY_PROFILE:SAVE",{}),
this._buttonRow("Load Now","REQ:STATE_MEMORY_PROFILE:LOAD",{}),
this._buttonRow("Reset Saved","REQ:STATE_MEMORY_PROFILE:RESET",{hard:true,apply:true})
]);
this._openFirst();
this._emit("EVT:IN_GAME_SETTINGS_UI:BUILT",{id:this.id,sections:this._sections.length,ts:Date.now()});
},
_openFirst(){
if(!this._sections.length)return;
this._setOpen(this._sections[0].key);
},
_addSection(title,rows){
var key=String(title||"SECTION");
var wrap=document.createElement("div");
wrap.style.margin="0 0 8px 0";
wrap.style.border="1px solid rgba(255,255,255,0.12)";
wrap.style.borderRadius="14px";
wrap.style.overflow="hidden";
wrap.style.background="rgba(255,255,255,0.04)";

var head=document.createElement("div");
head.style.display="flex";
head.style.alignItems="center";
head.style.justifyContent="space-between";
head.style.padding="10px 10px";
head.style.cursor="pointer";
head.style.userSelect="none";
head.style.borderBottom="1px solid rgba(255,255,255,0.10)";
wrap.appendChild(head);

var label=document.createElement("div");
label.textContent=key;
label.style.fontFamily="system-ui,Segoe UI,Arial";
label.style.fontWeight="800";
label.style.fontSize="12px";
label.style.letterSpacing="0.8px";
label.style.color="rgba(255,255,255,0.92)";
head.appendChild(label);

var chev=document.createElement("div");
chev.textContent="‚ñæ";
chev.style.color="rgba(255,255,255,0.75)";
chev.style.fontSize="14px";
chev.style.transform="rotate(0deg)";
chev.setAttribute("data-chev","1");
head.appendChild(chev);

var body=document.createElement("div");
body.style.display="none";
body.style.padding="8px";
wrap.appendChild(body);

var i=0;
for(i=0;i<rows.length;i++)body.appendChild(rows[i]);

this._body.appendChild(wrap);

var me=this;
head.onclick=function(){me._toggleOpen(key);};

this._sections.push({key:key,wrap:wrap,head:head,body:body,chev:chev});
},
_toggleOpen(key){
if(this._open===key){this._setOpen(null);return;}
this._setOpen(key);
},
_setOpen(key){
var i=0,s=null;
this._open=key||null;
for(i=0;i<this._sections.length;i++){
s=this._sections[i];
var open=(s.key===this._open);
s.body.style.display=open?"block":"none";
s.wrap.setAttribute("data-open",open?"1":"0");
s.chev.style.transform=open?"rotate(180deg)":"rotate(0deg)";
}
this._touch("accordion");
if(this._state.autoSave)this._persist();
this._emit("EVT:IN_GAME_SETTINGS_UI:OPEN",{id:this.id,open:this._open,ts:Date.now()});
},
_rowBase(){
var row=document.createElement("div");
row.style.display="flex";
row.style.alignItems="center";
row.style.justifyContent="space-between";
row.style.gap="10px";
row.style.padding="10px 10px";
row.style.borderRadius="12px";
row.style.border="1px solid rgba(255,255,255,0.10)";
row.style.background="rgba(0,0,0,0.18)";
row.style.margin="0 0 8px 0";
return row;
},
_toggleRow(name,emitReq,emitPayload,def){
var row=this._rowBase();
var left=document.createElement("div");
left.textContent=String(name||"Toggle");
left.style.fontFamily="system-ui,Segoe UI,Arial";
left.style.fontSize="12px";
left.style.fontWeight="700";
left.style.color="rgba(255,255,255,0.90)";
row.appendChild(left);

var sw=document.createElement("div");
sw.style.width="52px";
sw.style.height="28px";
sw.style.borderRadius="999px";
sw.style.border="1px solid rgba(255,255,255,0.16)";
sw.style.background="rgba(255,255,255,0.10)";
sw.style.position="relative";
sw.style.cursor="pointer";
sw.setAttribute("data-on",def?"1":"0");
row.appendChild(sw);

var knob=document.createElement("div");
knob.style.width="22px";
knob.style.height="22px";
knob.style.borderRadius="999px";
knob.style.background="rgba(255,255,255,0.92)";
knob.style.position="absolute";
knob.style.top="2px";
knob.style.left=def?"28px":"2px";
knob.style.transition="left 120ms ease";
sw.appendChild(knob);

var me=this;
sw.onclick=function(){
var on=(sw.getAttribute("data-on")==="1")?false:true;
sw.setAttribute("data-on",on?"1":"0");
knob.style.left=on?"28px":"2px";
me._emit(emitReq,Object.assign({},emitPayload||{},{"value":on}));
me._touch("toggle");
if(me._state.autoSave)me._persist();
me._announceStateToMemory();
};
return row;
},
_rangeRow(name,emitReq,emitPayload,min,max,def){
var row=this._rowBase();
row.style.flexDirection="column";
row.style.alignItems="stretch";

var top=document.createElement("div");
top.style.display="flex";
top.style.alignItems="center";
top.style.justifyContent="space-between";
top.style.gap="10px";
row.appendChild(top);

var left=document.createElement("div");
left.textContent=String(name||"Range");
left.style.fontFamily="system-ui,Segoe UI,Arial";
left.style.fontSize="12px";
left.style.fontWeight="700";
left.style.color="rgba(255,255,255,0.90)";
top.appendChild(left);

var val=document.createElement("div");
val.textContent=String(def);
val.style.fontFamily="system-ui,Segoe UI,Arial";
val.style.fontSize="12px";
val.style.fontWeight="800";
val.style.color="rgba(255,255,255,0.85)";
top.appendChild(val);

var input=document.createElement("input");
input.type="range";
input.min=String(min);
input.max=String(max);
input.value=String(def);
input.style.width="100%";
input.style.margin="8px 0 0 0";
row.appendChild(input);

var me=this,raf=0;
input.oninput=function(){
val.textContent=String(input.value);
if(raf)cancelAnimationFrame(raf);
raf=requestAnimationFrame(function(){
me._emit(emitReq,Object.assign({},emitPayload||{},{"value":Number(input.value)}));
me._touch("range");
});
};
input.onchange=function(){
if(me._state.autoSave)me._persist();
me._announceStateToMemory();
};
return row;
},
_buttonRow(name,emitReq,emitPayload){
var row=this._rowBase();
var left=document.createElement("div");
left.textContent=String(name||"Button");
left.style.fontFamily="system-ui,Segoe UI,Arial";
left.style.fontSize="12px";
left.style.fontWeight="800";
left.style.color="rgba(255,255,255,0.92)";
row.appendChild(left);

var btn=document.createElement("div");
btn.textContent="RUN";
btn.style.padding="8px 12px";
btn.style.borderRadius="12px";
btn.style.border="1px solid rgba(255,255,255,0.16)";
btn.style.background="rgba(255,255,255,0.08)";
btn.style.color="rgba(255,255,255,0.90)";
btn.style.fontFamily="system-ui,Segoe UI,Arial";
btn.style.fontSize="12px";
btn.style.fontWeight="900";
btn.style.cursor="pointer";
btn.style.userSelect="none";
row.appendChild(btn);

var me=this;
btn.onclick=function(){
me._emit(emitReq,emitPayload||{});
me._touch("button");
if(me._state.autoSave)me._persist();
me._announceStateToMemory();
};
return row;
},
show(p){
p=p||{};
if(!this._state.enabled)return;
this._state.visible=true;
this._panel.style.display="block";
this._btn.style.display="none";
this._touch(p.src||"show");
this._applyDock();
this._syncUI();
if(this._state.autoSave)this._persist();
this._announceStateToMemory();
this._emit("EVT:IN_GAME_SETTINGS_UI:VISIBLE",{id:this.id,visible:true,ts:Date.now()});
},
hide(p){
p=p||{};
this._state.visible=false;
this._panel.style.display="none";
this._btn.style.display="grid";
this._touch(p.src||"hide");
if(this._state.autoSave)this._persist();
this._announceStateToMemory();
this._emit("EVT:IN_GAME_SETTINGS_UI:VISIBLE",{id:this.id,visible:false,ts:Date.now()});
},
toggle(p){
p=p||{};
if(this._state.visible)this.hide(p);else this.show(p);
},
set(p){
p=p||{};
var path=String(p.path||"").trim();
var v=("value" in p)?p.value:null;
if(!path)return;
this._setPath(this._state,path,v);
this._syncUI();
this._touch("set");
if(this._state.autoSave)this._persist();
this._announceStateToMemory();
},
applyState(p){
p=p||{};
var s=p.state||p||{};
if(typeof s!=="object")return;
if("visible" in s)this._state.visible=!!s.visible;
if("dock" in s)this._state.dock=String(s.dock||this._state.dock);
if("x" in s)this._state.x=Number(s.x)||this._state.x;
if("y" in s)this._state.y=Number(s.y)||this._state.y;
if("w" in s)this._state.w=Number(s.w)||this._state.w;
if("maxH" in s)this._state.maxH=Number(s.maxH)||this._state.maxH;
if("opacity" in s)this._state.opacity=Number(s.opacity)||this._state.opacity;
if("autoSave" in s)this._state.autoSave=!!s.autoSave;
if("open" in s)this._open=s.open||this._open;
this._panel.style.width=this._state.w+"px";
this._panel.style.maxHeight=this._state.maxH+"px";
this._panel.style.opacity=String(this._state.opacity);
this._applyDock();
this._syncUI();
if(this._state.visible){this._panel.style.display="block";this._btn.style.display="none";}else{this._panel.style.display="none";this._btn.style.display="grid";}
if(this._open)this._setOpen(this._open);
this._touch("apply_state");
this._emit("EVT:IN_GAME_SETTINGS_UI:APPLIED",{id:this.id,ts:Date.now()});
},
_persist(){
this._emit("REQ:STATE_MEMORY_PROFILE:SET",{path:"ui.inGameSettings",value:this._exportState()});
this._emit("REQ:STATE_MEMORY_PROFILE:SAVE",{silent:true});
},
_announceStateToMemory(){
this._emit("EVT:SETTINGS_MENU_HOOK:STATE",{inGameSettings:this._exportState()});
},
_exportState(){
return {visible:this._state.visible,dock:this._state.dock,x:this._state.x,y:this._state.y,w:this._state.w,maxH:this._state.maxH,opacity:this._state.opacity,autoSave:this._state.autoSave,open:this._open||null,z:this._state.z};
},
_syncUI(){
this._root.style.zIndex=String(this._state.z);
this._panel.style.zIndex=String(this._state.z);
this._btn.style.zIndex=String(this._state.z);
},
_emitState(){
this._emit("EVT:IN_GAME_SETTINGS_UI:STATE",{id:this.id,state:this._exportState(),ts:Date.now()});
},
_touch(tag){
this._state.lastAction=Date.now();
},
_setPath(o,path,val){
var parts=path.split("."),cur=o,i=0;
for(i=0;i<parts.length-1;i++){
if(!cur[parts[i]]||typeof cur[parts[i]]!=="object")cur[parts[i]]={};
cur=cur[parts[i]];
}
cur[parts[parts.length-1]]=val;
},
_error(where,err){
var msg=(err&&err.message)?err.message:String(err||"error");
this._emit("EVT:IN_GAME_SETTINGS_UI:ERROR",{id:this.id,where:String(where||"unknown"),error:msg,ts:Date.now()});
return null;
},
api:{
show:function(p){return Engine_IN_GAME_SETTINGS_UI.show(p);},
hide:function(p){return Engine_IN_GAME_SETTINGS_UI.hide(p);},
toggle:function(p){return Engine_IN_GAME_SETTINGS_UI.toggle(p);},
applyState:function(p){return Engine_IN_GAME_SETTINGS_UI.applyState(p);},
getState:function(){return Engine_IN_GAME_SETTINGS_UI._exportState();},
buildDefaults:function(){return Engine_IN_GAME_SETTINGS_UI.buildDefaults();}
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_IN_GAME_SETTINGS_UI.id]=Engine_IN_GAME_SETTINGS_UI;
/-- üéõÔ∏èüßæ-(20B)-(E)-(IN-GAME-SETTINGS-UI)-(ACCORDION)-(E)-(20B)-üßæüéõÔ∏è --/
/-- üî§üß™-(21B)-(S)-(FONT-OVERRIDE-ENGINE)-(AUTO-SIZE)-(S)-(21B)-üß™üî§ --/
const Engine_FONT_OVERRIDE_ENGINE={
id:"FONT_OVERRIDE_ENGINE",
_ctx:null,
_state:{
ready:false,
enabled:true,
familyBase:"system-ui,Segoe UI,Arial",
familyAlt:"Arial Black,Impact,system-ui",
weightBase:800,
minPx:8,
maxPx:42,
padX:0,
padY:0,
lineH:1.05,
letter:0.5,
glow:true,
glowStrength:0.7,
clampMode:"FIT",
debug:false,
z:0
},
_cache:new Map(),
_ro:null,
init(ctx){
this._ctx=ctx||null;
if(!this._ctx||!this._ctx.bus)return this._error("init","missing_ctx_bus");
this._wire();
this._install();
this._state.ready=true;
this._emit("EVT:FONT_OVERRIDE_ENGINE:READY",{id:this.id,ts:Date.now()});
return this;
},
_wire(){
var b=this._ctx.bus,me=this;
b.on("REQ:FONT_OVERRIDE_ENGINE:SET",function(p){me.set(p);});
b.on("REQ:FONT_OVERRIDE_ENGINE:APPLY",function(p){me.apply(p);});
b.on("REQ:FONT_OVERRIDE_ENGINE:MEASURE",function(p){me.measure(p);});
b.on("REQ:FONT_OVERRIDE_ENGINE:GET_STATE",function(){me._emitState();});
b.on("REQ:FONT_OVERRIDE_ENGINE:ENABLE",function(){me.enable();});
b.on("REQ:FONT_OVERRIDE_ENGINE:DISABLE",function(){me.disable();});
},
_install(){
var me=this;
if(this._ro)this._ro.disconnect();
this._ro=new ResizeObserver(function(entries){
if(!me._state.enabled)return;
var i=0,el=null;
for(i=0;i<entries.length;i++){
el=entries[i].target;
if(!el||!el.hasAttribute||!el.hasAttribute("data-font-fit"))continue;
me._fitEl(el);
}
});
},
enable(){
this._state.enabled=true;
this._emit("EVT:FONT_OVERRIDE_ENGINE:ENABLED",{id:this.id,enabled:true,ts:Date.now()});
},
disable(){
this._state.enabled=false;
this._emit("EVT:FONT_OVERRIDE_ENGINE:ENABLED",{id:this.id,enabled:false,ts:Date.now()});
},
set(p){
p=p||{};
var path=String(p.path||"").trim();
if(!path)return;
this._setPath(this._state,path,("value" in p)?p.value:null);
this._emit("EVT:FONT_OVERRIDE_ENGINE:SET",{id:this.id,path:path,ts:Date.now()});
},
apply(p){
p=p||{};
if(!this._state.enabled)return;
var el=p.el||null;
var selector=p.selector||null;
var force=!!p.force;
var list=[];
if(el)list=[el];
if(!el&&selector)list=[].slice.call(document.querySelectorAll(selector));
if(!list.length)list=[].slice.call(document.querySelectorAll("[data-font-fit]"));
var i=0;
for(i=0;i<list.length;i++)this._fitEl(list[i],force);
this._emit("EVT:FONT_OVERRIDE_ENGINE:APPLIED",{id:this.id,count:list.length,ts:Date.now()});
},
measure(p){
p=p||{};
var text=String(p.text||"");
var w=Number(p.w||0)||0;
var h=Number(p.h||0)||0;
var key=text+"|"+w+"|"+h+"|"+this._state.familyBase+"|"+this._state.weightBase+"|"+this._state.minPx+"|"+this._state.maxPx+"|"+this._state.lineH+"|"+this._state.letter;
if(this._cache.has(key)){this._emit("EVT:FONT_OVERRIDE_ENGINE:MEASURED",{id:this.id,req:p,result:this._cache.get(key),cached:true,ts:Date.now()});return this._cache.get(key);}
var res=this._fitText(text,w,h,this._state);
this._cache.set(key,res);
this._emit("EVT:FONT_OVERRIDE_ENGINE:MEASURED",{id:this.id,req:p,result:res,cached:false,ts:Date.now()});
return res;
},
register(el,opts){
if(!el||!el.setAttribute)return null;
el.setAttribute("data-font-fit","1");
if(opts&&opts.mode)el.setAttribute("data-font-mode",String(opts.mode));
if(opts&&opts.family)el.setAttribute("data-font-family",String(opts.family));
if(opts&&opts.weight)el.setAttribute("data-font-weight",String(opts.weight));
if(opts&&opts.min)el.setAttribute("data-font-min",String(opts.min));
if(opts&&opts.max)el.setAttribute("data-font-max",String(opts.max));
if(opts&&opts.padX!=null)el.setAttribute("data-font-pad-x",String(opts.padX));
if(opts&&opts.padY!=null)el.setAttribute("data-font-pad-y",String(opts.padY));
if(opts&&opts.lineH!=null)el.setAttribute("data-font-lineh",String(opts.lineH));
if(opts&&opts.letter!=null)el.setAttribute("data-font-letter",String(opts.letter));
if(opts&&opts.glow!=null)el.setAttribute("data-font-glow",opts.glow?"1":"0");
if(opts&&opts.glowStrength!=null)el.setAttribute("data-font-glowstr",String(opts.glowStrength));
this._watch(el);
this._fitEl(el,true);
return el;
},
unregister(el){
if(!el||!el.removeAttribute)return;
el.removeAttribute("data-font-fit");
this._unwatch(el);
},
_watch(el){
if(!this._ro||!el)return;
this._ro.observe(el);
},
_unwatch(el){
if(!this._ro||!el)return;
try{this._ro.unobserve(el);}catch(e){}
},
_fitEl(el,force){
if(!el||!el.getBoundingClientRect)return;
if(!force&&el.getAttribute("data-font-fit-applied")==="1")return;
var r=el.getBoundingClientRect();
var st=this._mergeState(el);
var padX=st.padX||0,padY=st.padY||0;
var w=Math.max(1,Math.floor(r.width-(padX*2)));
var h=Math.max(1,Math.floor(r.height-(padY*2)));
var text=this._getText(el);
var res=this._fitText(text,w,h,st);
this._applyStyle(el,res,st,w,h);
el.setAttribute("data-font-fit-applied","1");
if(st.debug)this._dbg(el,res,w,h,st);
},
_mergeState(el){
var st=Object.assign({},this._state);
var mode=el.getAttribute("data-font-mode");if(mode)st.clampMode=mode;
var fam=el.getAttribute("data-font-family");if(fam)st.familyBase=fam;
var wt=el.getAttribute("data-font-weight");if(wt)st.weightBase=Number(wt)||st.weightBase;
var mn=el.getAttribute("data-font-min");if(mn)st.minPx=Number(mn)||st.minPx;
var mx=el.getAttribute("data-font-max");if(mx)st.maxPx=Number(mx)||st.maxPx;
var px=el.getAttribute("data-font-pad-x");if(px!=null&&px!=="")st.padX=Number(px)||0;
var py=el.getAttribute("data-font-pad-y");if(py!=null&&py!=="")st.padY=Number(py)||0;
var lh=el.getAttribute("data-font-lineh");if(lh)st.lineH=Number(lh)||st.lineH;
var lt=el.getAttribute("data-font-letter");if(lt)st.letter=Number(lt)||st.letter;
var g=el.getAttribute("data-font-glow");if(g!=null&&g!=="")st.glow=(g==="1");
var gs=el.getAttribute("data-font-glowstr");if(gs)st.glowStrength=Number(gs)||st.glowStrength;
return st;
},
_getText(el){
if(!el)return "";
var t="";
if(el.getAttribute&&el.getAttribute("data-font-text")!=null)t=String(el.getAttribute("data-font-text")||"");
else t=String(el.textContent||"");
t=t.replace(/\s+/g," ").trim();
return t;
},
_fitText(text,w,h,st){
var min=st.minPx,max=st.maxPx;
if(!text)return {px:min,lines:1,overflow:true};
var key=text+"|"+w+"|"+h+"|"+st.familyBase+"|"+st.weightBase+"|"+min+"|"+max+"|"+st.lineH+"|"+st.letter+"|"+st.clampMode;
if(this._cache.has(key))return this._cache.get(key);
var lo=min,hi=max,best=min,bestLines=1,bestOver=true;
var i=0;
for(i=0;i<18;i++){
var mid=(lo+hi)/2;
var px=Math.floor(mid);
var m=this._measure(text,px,st);
var fits=(m.w<=w&&m.h<=h);
if(fits){best=px;bestLines=m.lines;bestOver=false;lo=mid+0.5;}
else{bestOver=true;hi=mid-0.5;}
if(lo>hi)break;
}
var res={px:best,lines:bestLines,overflow:bestOver};
if(st.clampMode==="CLAMP"){if(res.px<min)res.px=min;if(res.px>max)res.px=max;res.overflow=false;}
this._cache.set(key,res);
return res;
},
_measure(text,px,st){
var meas=this._getMeasurer();
meas.style.fontFamily=st.familyBase;
meas.style.fontWeight=String(st.weightBase);
meas.style.fontSize=px+"px";
meas.style.lineHeight=String(st.lineH);
meas.style.letterSpacing=st.letter+"px";
meas.style.width="auto";
meas.style.whiteSpace="pre-wrap";
meas.style.wordBreak="break-word";
meas.textContent=text;
var rect=meas.getBoundingClientRect();
var w=Math.ceil(rect.width);
var h=Math.ceil(rect.height);
var lines=Math.max(1,Math.round(h/(px*st.lineH)));
return {w:w,h:h,lines:lines};
},
_getMeasurer(){
var el=document.getElementById("KOG_FONT_MEASURE");
if(el)return el;
el=document.createElement("div");
el.id="KOG_FONT_MEASURE";
el.style.position="fixed";
el.style.left="-9999px";
el.style.top="-9999px";
el.style.visibility="hidden";
el.style.pointerEvents="none";
el.style.padding="0";
el.style.margin="0";
el.style.border="0";
document.body.appendChild(el);
return el;
},
_applyStyle(el,res,st,w,h){
el.style.fontFamily=st.familyBase;
el.style.fontWeight=String(st.weightBase);
el.style.fontSize=res.px+"px";
el.style.lineHeight=String(st.lineH);
el.style.letterSpacing=st.letter+"px";
el.style.textRendering="geometricPrecision";
el.style.webkitFontSmoothing="antialiased";
el.style.mozOsxFontSmoothing="grayscale";
if(st.glow)this._applyGlow(el,st);
else this._clearGlow(el);
el.setAttribute("data-font-px",String(res.px));
el.setAttribute("data-font-lines",String(res.lines));
el.setAttribute("data-font-overflow",res.overflow?"1":"0");
},
_applyGlow(el,st){
var k=Math.max(0,Math.min(1,Number(st.glowStrength)||0));
var a1=(0.30+0.45*k).toFixed(3);
var a2=(0.12+0.28*k).toFixed(3);
var a3=(0.06+0.18*k).toFixed(3);
el.style.textShadow="0 0 6px rgba(255,255,255,"+a1+"),0 0 14px rgba(255,255,255,"+a2+"),0 0 26px rgba(255,255,255,"+a3+")";
},
_clearGlow(el){
el.style.textShadow="";
},
_dbg(el,res,w,h,st){
el.style.outline="1px dashed rgba(0,255,255,0.45)";
el.title="fit:"+w+"x"+h+" px:"+res.px+" lines:"+res.lines+" over:"+(res.overflow?"1":"0");
},
_emit(name,p){
try{this._ctx.bus.emit(name,p||{});}catch(e){}
},
_emitState(){
this._emit("EVT:FONT_OVERRIDE_ENGINE:STATE",{id:this.id,state:Object.assign({},this._state),ts:Date.now()});
},
_setPath(o,path,val){
var parts=path.split("."),cur=o,i=0;
for(i=0;i<parts.length-1;i++){
if(!cur[parts[i]]||typeof cur[parts[i]]!=="object")cur[parts[i]]={};
cur=cur[parts[i]];
}
cur[parts[parts.length-1]]=val;
},
_error(where,err){
var msg=(err&&err.message)?err.message:String(err||"error");
this._emit("EVT:FONT_OVERRIDE_ENGINE:ERROR",{id:this.id,where:String(where||"unknown"),error:msg,ts:Date.now()});
return null;
},
api:{
register:function(el,opts){return Engine_FONT_OVERRIDE_ENGINE.register(el,opts);},
unregister:function(el){return Engine_FONT_OVERRIDE_ENGINE.unregister(el);},
apply:function(p){return Engine_FONT_OVERRIDE_ENGINE.apply(p);},
measure:function(p){return Engine_FONT_OVERRIDE_ENGINE.measure(p);},
set:function(p){return Engine_FONT_OVERRIDE_ENGINE.set(p);},
getState:function(){return Object.assign({},Engine_FONT_OVERRIDE_ENGINE._state);}
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_FONT_OVERRIDE_ENGINE.id]=Engine_FONT_OVERRIDE_ENGINE;
/-- üî§üß™-(21B)-(E)-(FONT-OVERRIDE-ENGINE)-(AUTO-SIZE)-(E)-(21B)-üß™üî§ --/
/-- üßæüñäÔ∏è-(22B)-(S)-(HUD-TEXT-ENGINE)-(STATUS/TURNS/CHECK)-(S)-(22B)-üñäÔ∏èüßæ --/
const Engine_HUD_TEXT_ENGINE={
id:"HUD_TEXT_ENGINE",
_ctx:null,
_state:{
ready:false,
enabled:true,
defaultSelector:"[data-hud-text]",
defaultFamily:"inherit",
defaultWeight:800,
defaultGlow:true,
defaultGlowStrength:0.65,
defaultAlign:"center",
defaultVAlign:"middle",
defaultLineH:1.05,
defaultLetter:0.5,
defaultPadX:6,
defaultPadY:4,
autoFit:true,
autoFitMin:8,
autoFitMax:40,
debug:false,
z:0
},
_nodes:new Map(),
_ro:null,
_tick:0,
init(ctx){
this._ctx=ctx||null;
if(!this._ctx||!this._ctx.bus)return this._error("init","missing_ctx_bus");
this._wire();
this._install();
this.scan();
this._state.ready=true;
this._emit("EVT:HUD_TEXT_ENGINE:READY",{id:this.id,ts:Date.now()});
return this;
},
_wire(){
var b=this._ctx.bus,me=this;
b.on("REQ:HUD_TEXT_ENGINE:SCAN",function(){me.scan();});
b.on("REQ:HUD_TEXT_ENGINE:REGISTER",function(p){me.register(p);});
b.on("REQ:HUD_TEXT_ENGINE:UNREGISTER",function(p){me.unregister(p);});
b.on("REQ:HUD_TEXT_ENGINE:SET_TEXT",function(p){me.setText(p);});
b.on("REQ:HUD_TEXT_ENGINE:SET_STATUS",function(p){me.setStatus(p);});
b.on("REQ:HUD_TEXT_ENGINE:SET_TURN",function(p){me.setTurn(p);});
b.on("REQ:HUD_TEXT_ENGINE:SET_CHECK",function(p){me.setCheck(p);});
b.on("REQ:HUD_TEXT_ENGINE:SET_MODE",function(p){me.setMode(p);});
b.on("REQ:HUD_TEXT_ENGINE:APPLY",function(p){me.apply(p);});
b.on("REQ:HUD_TEXT_ENGINE:ENABLE",function(){me.enable();});
b.on("REQ:HUD_TEXT_ENGINE:DISABLE",function(){me.disable();});
b.on("REQ:HUD_TEXT_ENGINE:GET_STATE",function(){me._emitState();});
},
_install(){
var me=this;
if(this._ro)this._ro.disconnect();
this._ro=new ResizeObserver(function(entries){
if(!me._state.enabled)return;
var i=0,el=null;
for(i=0;i<entries.length;i++){
el=entries[i].target;
if(!el||!el.getAttribute)return;
if(el.getAttribute("data-hud-text")!=="1")continue;
me._applyToEl(el,true);
}
});
},
enable(){
this._state.enabled=true;
this._emit("EVT:HUD_TEXT_ENGINE:ENABLED",{id:this.id,enabled:true,ts:Date.now()});
this.apply({selector:this._state.defaultSelector,force:true});
},
disable(){
this._state.enabled=false;
this._emit("EVT:HUD_TEXT_ENGINE:ENABLED",{id:this.id,enabled:false,ts:Date.now()});
},
scan(){
var list=[].slice.call(document.querySelectorAll(this._state.defaultSelector));
var i=0;
for(i=0;i<list.length;i++)this._ensureNode(list[i],null,true);
this._emit("EVT:HUD_TEXT_ENGINE:SCANNED",{id:this.id,count:list.length,ts:Date.now()});
return list.length;
},
register(p){
p=p||{};
var el=p.el||null;
var selector=p.selector||null;
var opts=p.opts||null;
var list=[];
if(el)list=[el];
if(!el&&selector)list=[].slice.call(document.querySelectorAll(selector));
if(!list.length)return 0;
var i=0;
for(i=0;i<list.length;i++)this._ensureNode(list[i],opts,true);
this._emit("EVT:HUD_TEXT_ENGINE:REGISTERED",{id:this.id,count:list.length,ts:Date.now()});
return list.length;
},
unregister(p){
p=p||{};
var el=p.el||null;
var selector=p.selector||null;
var list=[];
if(el)list=[el];
if(!el&&selector)list=[].slice.call(document.querySelectorAll(selector));
if(!list.length)return 0;
var i=0,n=0,node=null;
for(i=0;i<list.length;i++){
node=list[i];
if(!node||!node.getAttribute)continue;
node.removeAttribute("data-hud-text");
node.removeAttribute("data-hud-key");
node.removeAttribute("data-hud-kind");
node.removeAttribute("data-hud-mode");
this._unwatch(node);
this._nodes.delete(node);
n++;
}
this._emit("EVT:HUD_TEXT_ENGINE:UNREGISTERED",{id:this.id,count:n,ts:Date.now()});
return n;
},
setText(p){
p=p||{};
if(!this._state.enabled)return;
var key=String(p.key||"").trim();
var text=("text" in p)?String(p.text||""):"";
if(!key)return;
this._setByKey(key,text,p);
},
setStatus(p){
p=p||{};
p.key=p.key||"status";
p.kind=p.kind||"status";
this.setText(p);
},
setTurn(p){
p=p||{};
p.key=p.key||"turn";
p.kind=p.kind||"turn";
var t=("text" in p)?p.text:null;
if(t==null&&("turn" in p))t="TURN: "+String(p.turn);
p.text=t;
this.setText(p);
},
setCheck(p){
p=p||{};
p.key=p.key||"check";
p.kind=p.kind||"check";
var s=("state" in p)?String(p.state||""):"";
if(!("text" in p)){
if(s==="check")p.text="CHECK";
else if(s==="mate")p.text="CHECKMATE";
else if(s==="stalemate")p.text="STALEMATE";
else p.text="";
}
this.setText(p);
},
setMode(p){
p=p||{};
var key=String(p.key||"").trim();
var mode=String(p.mode||"").trim();
if(!key||!mode)return;
var list=this._findByKey(key);
var i=0;
for(i=0;i<list.length;i++){
list[i].setAttribute("data-hud-mode",mode);
this._applyToEl(list[i],true,p);
}
this._emit("EVT:HUD_TEXT_ENGINE:MODE",{id:this.id,key:key,mode:mode,count:list.length,ts:Date.now()});
},
apply(p){
p=p||{};
if(!this._state.enabled)return;
var el=p.el||null;
var selector=p.selector||null;
var force=!!p.force;
var list=[];
if(el)list=[el];
if(!el&&selector)list=[].slice.call(document.querySelectorAll(selector));
if(!list.length)list=[].slice.call(document.querySelectorAll(this._state.defaultSelector));
var i=0;
for(i=0;i<list.length;i++)this._applyToEl(list[i],force,p);
this._emit("EVT:HUD_TEXT_ENGINE:APPLIED",{id:this.id,count:list.length,ts:Date.now()});
},
_setByKey(key,text,p){
var list=this._findByKey(key);
if(!list.length){
var el=this._findFirstAutoSlot();
if(el)this._ensureNode(el,{key:key,kind:(p&&p.kind)||key},true);
list=this._findByKey(key);
}
var i=0,el2=null;
for(i=0;i<list.length;i++){
el2=list[i];
el2.textContent=text;
el2.setAttribute("data-hud-last",String(Date.now()));
this._applyToEl(el2,true,p);
}
this._emit("EVT:HUD_TEXT_ENGINE:TEXT",{id:this.id,key:key,text:text,count:list.length,ts:Date.now()});
},
_findByKey(key){
var out=[],it=null;
this._nodes.forEach(function(v,k){
try{if(k&&k.getAttribute&&k.getAttribute("data-hud-key")===key)out.push(k);}catch(e){}
});
return out;
},
_findFirstAutoSlot(){
var el=document.querySelector(this._state.defaultSelector+"[data-hud-key='']")||null;
if(el)return el;
el=document.querySelector(this._state.defaultSelector+":not([data-hud-key])")||null;
return el;
},
_ensureNode(el,opts,applyNow){
if(!el||!el.setAttribute)return null;
opts=opts||{};
if(el.getAttribute("data-hud-text")!=="1")el.setAttribute("data-hud-text","1");
if(opts.key!=null)el.setAttribute("data-hud-key",String(opts.key));
else if(!el.hasAttribute("data-hud-key"))el.setAttribute("data-hud-key","");
if(opts.kind!=null)el.setAttribute("data-hud-kind",String(opts.kind));
else if(!el.hasAttribute("data-hud-kind"))el.setAttribute("data-hud-kind",String(el.getAttribute("data-hud-key")||""));
if(opts.mode!=null)el.setAttribute("data-hud-mode",String(opts.mode));
else if(!el.hasAttribute("data-hud-mode"))el.setAttribute("data-hud-mode","auto");
if(opts.align!=null)el.setAttribute("data-hud-align",String(opts.align));
if(opts.valign!=null)el.setAttribute("data-hud-valign",String(opts.valign));
if(opts.glow!=null)el.setAttribute("data-hud-glow",opts.glow?"1":"0");
if(opts.glowStrength!=null)el.setAttribute("data-hud-glowstr",String(opts.glowStrength));
if(opts.family!=null)el.setAttribute("data-hud-family",String(opts.family));
if(opts.weight!=null)el.setAttribute("data-hud-weight",String(opts.weight));
if(opts.lineH!=null)el.setAttribute("data-hud-lineh",String(opts.lineH));
if(opts.letter!=null)el.setAttribute("data-hud-letter",String(opts.letter));
if(opts.padX!=null)el.setAttribute("data-hud-pad-x",String(opts.padX));
if(opts.padY!=null)el.setAttribute("data-hud-pad-y",String(opts.padY));
if(opts.fit!=null)el.setAttribute("data-hud-fit",opts.fit?"1":"0");
if(opts.fitMin!=null)el.setAttribute("data-hud-fit-min",String(opts.fitMin));
if(opts.fitMax!=null)el.setAttribute("data-hud-fit-max",String(opts.fitMax));
this._nodes.set(el,{ts:Date.now()});
this._watch(el);
if(applyNow)this._applyToEl(el,true,{});
return el;
},
_watch(el){
if(!this._ro||!el)return;
this._ro.observe(el);
},
_unwatch(el){
if(!this._ro||!el)return;
try{this._ro.unobserve(el);}catch(e){}
},
_applyToEl(el,force,p){
if(!el||!el.getBoundingClientRect)return;
if(!force&&el.getAttribute("data-hud-applied")==="1")return;
var st=this._readEl(el);
this._styleEl(el,st);
if(st.fit)this._fit(el,st);
el.setAttribute("data-hud-applied","1");
if(st.debug)this._dbg(el,st);
},
_readEl(el){
var st={};
st.key=String(el.getAttribute("data-hud-key")||"");
st.kind=String(el.getAttribute("data-hud-kind")||st.key);
st.mode=String(el.getAttribute("data-hud-mode")||"auto");
st.align=String(el.getAttribute("data-hud-align")||this._state.defaultAlign);
st.valign=String(el.getAttribute("data-hud-valign")||this._state.defaultVAlign);
st.family=String(el.getAttribute("data-hud-family")||this._state.defaultFamily);
st.weight=Number(el.getAttribute("data-hud-weight")||this._state.defaultWeight)||this._state.defaultWeight;
var g=el.getAttribute("data-hud-glow");st.glow=(g==null)?this._state.defaultGlow:(g==="1");
st.glowStrength=Number(el.getAttribute("data-hud-glowstr")||this._state.defaultGlowStrength)||this._state.defaultGlowStrength;
st.lineH=Number(el.getAttribute("data-hud-lineh")||this._state.defaultLineH)||this._state.defaultLineH;
st.letter=Number(el.getAttribute("data-hud-letter")||this._state.defaultLetter)||this._state.defaultLetter;
st.padX=Number(el.getAttribute("data-hud-pad-x")||this._state.defaultPadX)||0;
st.padY=Number(el.getAttribute("data-hud-pad-y")||this._state.defaultPadY)||0;
var f=el.getAttribute("data-hud-fit");
st.fit=(f==null)?this._state.autoFit:(f==="1");
st.fitMin=Number(el.getAttribute("data-hud-fit-min")||this._state.autoFitMin)||this._state.autoFitMin;
st.fitMax=Number(el.getAttribute("data-hud-fit-max")||this._state.autoFitMax)||this._state.autoFitMax;
st.debug=this._state.debug||el.getAttribute("data-hud-debug")==="1";
return st;
},
_styleEl(el,st){
el.style.display="flex";
el.style.alignItems=(st.valign==="top")?"flex-start":(st.valign==="bottom")?"flex-end":"center";
el.style.justifyContent=(st.align==="left")?"flex-start":(st.align==="right")?"flex-end":"center";
el.style.textAlign=st.align;
el.style.padding=st.padY+"px "+st.padX+"px";
el.style.fontFamily=st.family;
el.style.fontWeight=String(st.weight);
el.style.lineHeight=String(st.lineH);
el.style.letterSpacing=st.letter+"px";
el.style.userSelect="none";
el.style.whiteSpace="pre-wrap";
el.style.wordBreak="break-word";
el.style.textRendering="geometricPrecision";
el.style.webkitFontSmoothing="antialiased";
el.style.mozOsxFontSmoothing="grayscale";
if(st.glow)this._applyGlow(el,st);
else el.style.textShadow="";
},
_applyGlow(el,st){
var k=Math.max(0,Math.min(1,Number(st.glowStrength)||0));
var a1=(0.30+0.45*k).toFixed(3);
var a2=(0.12+0.28*k).toFixed(3);
var a3=(0.06+0.18*k).toFixed(3);
el.style.textShadow="0 0 6px rgba(255,255,255,"+a1+"),0 0 14px rgba(255,255,255,"+a2+"),0 0 26px rgba(255,255,255,"+a3+")";
},
_fit(el,st){
var r=el.getBoundingClientRect();
var w=Math.max(1,Math.floor(r.width-(st.padX*2)));
var h=Math.max(1,Math.floor(r.height-(st.padY*2)));
var text=String(el.textContent||"").replace(/\s+/g," ").trim();
var fontTool=(window.KOG&&window.KOG.FONT_OVERRIDE_ENGINE&&window.KOG.FONT_OVERRIDE_ENGINE.api)?window.KOG.FONT_OVERRIDE_ENGINE.api:null;
if(fontTool){
var res=fontTool.measure({text:text,w:w,h:h});
el.style.fontSize=res.px+"px";
el.setAttribute("data-hud-px",String(res.px));
el.setAttribute("data-hud-lines",String(res.lines));
el.setAttribute("data-hud-overflow",res.overflow?"1":"0");
return;
}
var res2=this._fitLocal(text,w,h,st);
el.style.fontSize=res2.px+"px";
el.setAttribute("data-hud-px",String(res2.px));
el.setAttribute("data-hud-lines",String(res2.lines));
el.setAttribute("data-hud-overflow",res2.overflow?"1":"0");
},
_fitLocal(text,w,h,st){
var min=st.fitMin,max=st.fitMax;
if(!text)return {px:min,lines:1,overflow:false};
var meas=this._getMeasurer();
meas.style.fontFamily=st.family;
meas.style.fontWeight=String(st.weight);
meas.style.lineHeight=String(st.lineH);
meas.style.letterSpacing=st.letter+"px";
meas.style.whiteSpace="pre-wrap";
meas.style.wordBreak="break-word";
meas.textContent=text;
var lo=min,hi=max,best=min,bestLines=1,bestOver=true,i=0;
for(i=0;i<18;i++){
var mid=(lo+hi)/2;
var px=Math.floor(mid);
meas.style.fontSize=px+"px";
var rect=meas.getBoundingClientRect();
var mw=Math.ceil(rect.width),mh=Math.ceil(rect.height);
var fits=(mw<=w&&mh<=h);
if(fits){best=px;bestLines=Math.max(1,Math.round(mh/(px*st.lineH)));bestOver=false;lo=mid+0.5;}
else{bestOver=true;hi=mid-0.5;}
if(lo>hi)break;
}
return {px:best,lines:bestLines,overflow:bestOver};
},
_getMeasurer(){
var el=document.getElementById("KOG_HUD_MEASURE");
if(el)return el;
el=document.createElement("div");
el.id="KOG_HUD_MEASURE";
el.style.position="fixed";
el.style.left="-9999px";
el.style.top="-9999px";
el.style.visibility="hidden";
el.style.pointerEvents="none";
el.style.padding="0";
el.style.margin="0";
el.style.border="0";
document.body.appendChild(el);
return el;
},
_dbg(el,st){
el.style.outline="1px dashed rgba(255,0,255,0.45)";
el.title="hud key:"+st.key+" kind:"+st.kind+" px:"+(el.getAttribute("data-hud-px")||"")+" lines:"+(el.getAttribute("data-hud-lines")||"");
},
_emit(name,p){
try{this._ctx.bus.emit(name,p||{});}catch(e){}
},
_emitState(){
this._emit("EVT:HUD_TEXT_ENGINE:STATE",{id:this.id,state:Object.assign({},this._state),ts:Date.now()});
},
_error(where,err){
var msg=(err&&err.message)?err.message:String(err||"error");
this._emit("EVT:HUD_TEXT_ENGINE:ERROR",{id:this.id,where:String(where||"unknown"),error:msg,ts:Date.now()});
return null;
},
api:{
scan:function(){return Engine_HUD_TEXT_ENGINE.scan();},
register:function(p){return Engine_HUD_TEXT_ENGINE.register(p);},
unregister:function(p){return Engine_HUD_TEXT_ENGINE.unregister(p);},
setText:function(p){return Engine_HUD_TEXT_ENGINE.setText(p);},
setStatus:function(p){return Engine_HUD_TEXT_ENGINE.setStatus(p);},
setTurn:function(p){return Engine_HUD_TEXT_ENGINE.setTurn(p);},
setCheck:function(p){return Engine_HUD_TEXT_ENGINE.setCheck(p);},
setMode:function(p){return Engine_HUD_TEXT_ENGINE.setMode(p);},
apply:function(p){return Engine_HUD_TEXT_ENGINE.apply(p);},
getState:function(){return Object.assign({},Engine_HUD_TEXT_ENGINE._state);}
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_HUD_TEXT_ENGINE.id]=Engine_HUD_TEXT_ENGINE;
/-- üßæüñäÔ∏è-(22B)-(E)-(HUD-TEXT-ENGINE)-(STATUS/TURNS/CHECK)-(E)-(22B)-üñäÔ∏èüßæ --/
/-- ‚è±Ô∏è‚ôüÔ∏è-(23B)-(S)-(GAME-MODES-MENU)-(AI/PVP)-(S)-(23B)-‚ôüÔ∏è‚è±Ô∏è --/
const Engine_GAME_MODES_MENU={
id:"GAME_MODES_MENU",
_ctx:null,
_state:{
ready:false,
enabled:true,
open:false,
mode:"none",
lastMode:"none",
defaultSelector:"[data-game-modes-menu]",
btnAI:"[data-gm-ai]",
btnPVP:"[data-gm-pvp]",
btnClose:"[data-gm-close]",
title:"GAME MODE",
sub:"CHOOSE YOUR PATH",
aiLabel:"AI",
pvpLabel:"PVP",
closeLabel:"CLOSE",
glow:true,
lockDuringGame:true,
z:9999
},
_nodes:{
root:null,
panel:null,
title:null,
sub:null,
btnAI:null,
btnPVP:null,
btnClose:null
},
_installDone:false,
init(ctx){
this._ctx=ctx||null;
if(!this._ctx||!this._ctx.bus)return this._error("init","missing_ctx_bus");
this._wire();
this._ensureUI();
this._applyTheme();
this._state.ready=true;
this._emit("EVT:GAME_MODES_MENU:READY",{id:this.id,ts:Date.now()});
return this;
},
_wire(){
var b=this._ctx.bus,me=this;
b.on("REQ:GAME_MODES_MENU:OPEN",function(p){me.open(p);});
b.on("REQ:GAME_MODES_MENU:CLOSE",function(p){me.close(p);});
b.on("REQ:GAME_MODES_MENU:TOGGLE",function(p){me.toggle(p);});
b.on("REQ:GAME_MODES_MENU:SET_MODE",function(p){me.setMode(p);});
b.on("REQ:GAME_MODES_MENU:GET_STATE",function(){me._emitState();});
b.on("EVT:CARTRIDGE:BOOTED",function(){me._applyTheme();});
b.on("EVT:THEME:APPLIED",function(){me._applyTheme();});
b.on("EVT:GAME:START",function(){if(me._state.lockDuringGame)me.close({reason:"game_start"});});
},
open(p){
p=p||{};
if(!this._state.enabled)return;
if(this._state.open)return;
if(this._state.lockDuringGame&&this._isGameActive())return this._emit("EVT:GAME_MODES_MENU:BLOCKED",{id:this.id,why:"game_active",ts:Date.now()});
this._ensureUI();
this._state.open=true;
this._render();
this._emit("EVT:GAME_MODES_MENU:OPEN",{id:this.id,ts:Date.now(),reason:String(p.reason||"")});
},
close(p){
p=p||{};
if(!this._state.open)return;
this._state.open=false;
this._render();
this._emit("EVT:GAME_MODES_MENU:CLOSE",{id:this.id,ts:Date.now(),reason:String(p.reason||"")});
},
toggle(p){
p=p||{};
if(this._state.open)this.close({reason:p.reason||"toggle"});
else this.open({reason:p.reason||"toggle"});
},
setMode(p){
p=p||{};
var mode=String(p.mode||"").toLowerCase();
if(mode!=="ai"&&mode!=="pvp")return;
if(this._state.mode===mode)return;
this._state.lastMode=this._state.mode;
this._state.mode=mode;
this._syncButtons();
this._emit("EVT:GAME_MODES_MENU:MODE",{id:this.id,mode:mode,ts:Date.now()});
this._emit("EVT:GAME:MODE_SELECTED",{mode:mode,ts:Date.now()});
if(mode==="ai")this._emit("REQ:GAME:SET_MODE",{mode:"ai"});
if(mode==="pvp")this._emit("REQ:GAME:SET_MODE",{mode:"pvp"});
if(p.autoClose!==false)this.close({reason:"mode_selected"});
},
_enable(){
this._state.enabled=true;
this._emit("EVT:GAME_MODES_MENU:ENABLED",{id:this.id,enabled:true,ts:Date.now()});
},
_disable(){
this._state.enabled=false;
this.close({reason:"disabled"});
this._emit("EVT:GAME_MODES_MENU:ENABLED",{id:this.id,enabled:false,ts:Date.now()});
},
_ensureUI(){
if(this._installDone&&this._nodes.root&&document.body.contains(this._nodes.root))return;
var root=document.querySelector(this._state.defaultSelector);
if(!root)root=this._buildUI();
this._nodes.root=root;
this._nodes.panel=root.querySelector("[data-gm-panel]");
this._nodes.title=root.querySelector("[data-gm-title]");
this._nodes.sub=root.querySelector("[data-gm-sub]");
this._nodes.btnAI=root.querySelector(this._state.btnAI);
this._nodes.btnPVP=root.querySelector(this._state.btnPVP);
this._nodes.btnClose=root.querySelector(this._state.btnClose);
this._bindUI();
this._installDone=true;
this._render();
},
_buildUI(){
var root=document.createElement("div");
root.setAttribute("data-game-modes-menu","1");
root.style.position="fixed";
root.style.left="0";
root.style.top="0";
root.style.width="100vw";
root.style.height="100vh";
root.style.display="none";
root.style.alignItems="center";
root.style.justifyContent="center";
root.style.zIndex=String(this._state.z);
root.style.background="rgba(0,0,0,0.55)";
root.style.backdropFilter="blur(6px)";
root.style.webkitBackdropFilter="blur(6px)";
var panel=document.createElement("div");
panel.setAttribute("data-gm-panel","1");
panel.style.minWidth="280px";
panel.style.maxWidth="520px";
panel.style.width="min(86vw,520px)";
panel.style.borderRadius="16px";
panel.style.padding="18px 16px 14px 16px";
panel.style.border="1px solid rgba(255,255,255,0.18)";
panel.style.background="rgba(10,10,12,0.72)";
panel.style.boxShadow="0 10px 40px rgba(0,0,0,0.55)";
panel.style.display="flex";
panel.style.flexDirection="column";
panel.style.gap="10px";
var title=document.createElement("div");
title.setAttribute("data-gm-title","1");
title.textContent=this._state.title;
title.style.fontSize="18px";
title.style.fontWeight="900";
title.style.letterSpacing="1px";
title.style.textAlign="center";
var sub=document.createElement("div");
sub.setAttribute("data-gm-sub","1");
sub.textContent=this._state.sub;
sub.style.fontSize="12px";
sub.style.fontWeight="800";
sub.style.opacity="0.85";
sub.style.letterSpacing="1px";
sub.style.textAlign="center";
var row=document.createElement("div");
row.style.display="flex";
row.style.gap="10px";
row.style.marginTop="8px";
var btnAI=this._btn(this._state.aiLabel,"data-gm-ai");
var btnPVP=this._btn(this._state.pvpLabel,"data-gm-pvp");
row.appendChild(btnAI);
row.appendChild(btnPVP);
var foot=document.createElement("div");
foot.style.display="flex";
foot.style.justifyContent="center";
foot.style.marginTop="10px";
var btnClose=this._btn(this._state.closeLabel,"data-gm-close");
btnClose.style.width="min(60%,260px)";
foot.appendChild(btnClose);
panel.appendChild(title);
panel.appendChild(sub);
panel.appendChild(row);
panel.appendChild(foot);
root.appendChild(panel);
document.body.appendChild(root);
return root;
},
_btn(label,attr){
var b=document.createElement("button");
b.type="button";
b.textContent=label;
b.setAttribute(attr,"1");
b.style.flex="1";
b.style.padding="12px 10px";
b.style.borderRadius="12px";
b.style.border="1px solid rgba(255,255,255,0.22)";
b.style.background="rgba(255,255,255,0.06)";
b.style.color="inherit";
b.style.fontWeight="900";
b.style.letterSpacing="1px";
b.style.cursor="pointer";
b.style.userSelect="none";
b.style.webkitTapHighlightColor="transparent";
b.onmouseenter=function(){b.style.background="rgba(255,255,255,0.10)";};
b.onmouseleave=function(){b.style.background="rgba(255,255,255,0.06)";};
b.onmousedown=function(){b.style.transform="translateY(1px)";};
b.onmouseup=function(){b.style.transform="translateY(0px)";};
return b;
},
_bindUI(){
var me=this;
var root=this._nodes.root;
var btnAI=this._nodes.btnAI;
var btnPVP=this._nodes.btnPVP;
var btnClose=this._nodes.btnClose;
root.onclick=function(e){
if(e&&e.target===root)me.close({reason:"backdrop"});
};
document.addEventListener("keydown",function(e){
if(!me._state.open)return;
if(e.key==="Escape")me.close({reason:"escape"});
});
if(btnAI)btnAI.onclick=function(){me.setMode({mode:"ai"});};
if(btnPVP)btnPVP.onclick=function(){me.setMode({mode:"pvp"});};
if(btnClose)btnClose.onclick=function(){me.close({reason:"close_btn"});};
},
_render(){
var root=this._nodes.root;
if(!root)return;
root.style.display=this._state.open?"flex":"none";
this._syncButtons();
this._applyTheme();
},
_syncButtons(){
var a=this._nodes.btnAI,p=this._nodes.btnPVP;
if(a)this._mark(a,this._state.mode==="ai");
if(p)this._mark(p,this._state.mode==="pvp");
},
_mark(btn,on){
btn.style.border=on?"1px solid rgba(255,255,255,0.75)":"1px solid rgba(255,255,255,0.22)";
btn.style.background=on?"rgba(255,255,255,0.16)":"rgba(255,255,255,0.06)";
btn.style.boxShadow=on?"0 0 18px rgba(255,255,255,0.18)":"";
},
_applyTheme(){
var root=this._nodes.root;
var panel=this._nodes.panel;
var title=this._nodes.title;
if(!root||!panel||!title)return;
var theme=(window.KOG&&window.KOG.THEME_INHERIT_BRIDGE&&window.KOG.THEME_INHERIT_BRIDGE.api&&window.KOG.THEME_INHERIT_BRIDGE.api.getTheme)?window.KOG.THEME_INHERIT_BRIDGE.api.getTheme():null;
var fg=(theme&&theme.fg)?theme.fg:null;
var glow=(theme&&("glow" in theme))?!!theme.glow:this._state.glow;
if(fg){panel.style.color=fg;root.style.color=fg;}
if(glow)title.style.textShadow="0 0 10px rgba(255,255,255,0.35),0 0 22px rgba(255,255,255,0.18)";
else title.style.textShadow="";
},
_isGameActive(){
try{
if(this._ctx&&this._ctx.state&&this._ctx.state.game&&this._ctx.state.game.active)return !!this._ctx.state.game.active;
if(window.KOG&&window.KOG.TURN_SYSTEM_ENGINE&&window.KOG.TURN_SYSTEM_ENGINE.api&&window.KOG.TURN_SYSTEM_ENGINE.api.getState){
var s=window.KOG.TURN_SYSTEM_ENGINE.api.getState();
if(s&&("active" in s))return !!s.active;
}
}catch(e){}
return false;
},
_emit(name,p){
try{this._ctx.bus.emit(name,p||{});}catch(e){}
},
_emitState(){
this._emit("EVT:GAME_MODES_MENU:STATE",{id:this.id,state:Object.assign({},this._state),ts:Date.now()});
},
_error(where,err){
var msg=(err&&err.message)?err.message:String(err||"error");
this._emit("EVT:GAME_MODES_MENU:ERROR",{id:this.id,where:String(where||"unknown"),error:msg,ts:Date.now()});
return null;
},
api:{
open:function(p){return Engine_GAME_MODES_MENU.open(p);},
close:function(p){return Engine_GAME_MODES_MENU.close(p);},
toggle:function(p){return Engine_GAME_MODES_MENU.toggle(p);},
setMode:function(p){return Engine_GAME_MODES_MENU.setMode(p);},
getState:function(){return Object.assign({},Engine_GAME_MODES_MENU._state);}
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_GAME_MODES_MENU.id]=Engine_GAME_MODES_MENU;
/-- ‚è±Ô∏è‚ôüÔ∏è-(23B)-(E)-(GAME-MODES-MENU)-(AI/PVP)-(E)-(23B)-‚ôüÔ∏è‚è±Ô∏è --/
/-- üîÅüß†-(24B)-(S)-(TURN-SYSTEM-ENGINE)-(CLOCKWORK)-(S)-(24B)-üß†üîÅ --/
const Engine_TURN_SYSTEM_ENGINE={
id:"TURN_SYSTEM_ENGINE",
_ctx:null,
_state:{
ready:false,
enabled:true,
active:false,
turn:0,
ply:0,
side:"w",
phase:"idle",
lock:false,
clock:{
enabled:false,
mode:"none",
w:{ms:0,inc:0,delay:0},
b:{ms:0,inc:0,delay:0},
lastTick:0,
running:false
},
meta:{
lastMove:null,
lastEvent:"",
reason:""
}
},
_wireDone:false,
init(ctx){
this._ctx=ctx||null;
if(!this._ctx||!this._ctx.bus)return this._error("init","missing_ctx_bus");
if(this._wireDone)return this;
this._wire();
this._wireDone=true;
this._state.ready=true;
this._emit("EVT:TURN_SYSTEM:READY",{id:this.id,ts:Date.now()});
this._emitState("ready");
return this;
},
_wire(){
var b=this._ctx.bus,me=this;
b.on("REQ:TURN_SYSTEM:RESET",function(p){me.reset(p);});
b.on("REQ:TURN_SYSTEM:START",function(p){me.start(p);});
b.on("REQ:TURN_SYSTEM:STOP",function(p){me.stop(p);});
b.on("REQ:TURN_SYSTEM:PAUSE",function(p){me.pause(p);});
b.on("REQ:TURN_SYSTEM:RESUME",function(p){me.resume(p);});
b.on("REQ:TURN_SYSTEM:SET_SIDE",function(p){me.setSide(p);});
b.on("REQ:TURN_SYSTEM:NEXT_TURN",function(p){me.nextTurn(p);});
b.on("REQ:TURN_SYSTEM:LOCK",function(p){me.lock(p);});
b.on("REQ:TURN_SYSTEM:UNLOCK",function(p){me.unlock(p);});
b.on("REQ:TURN_SYSTEM:SET_CLOCK",function(p){me.setClock(p);});
b.on("REQ:TURN_SYSTEM:GET_STATE",function(){me._emitState("get_state");});
b.on("EVT:GAME:MODE_SELECTED",function(p){me._onMode(p);});
b.on("EVT:MOVE:COMMITTED",function(p){me.onMoveCommitted(p);});
b.on("EVT:MOVE:UNDONE",function(p){me.onMoveUndone(p);});
b.on("EVT:GAME:END",function(p){me._onGameEnd(p);});
b.on("EVT:GAME:START",function(p){me._onGameStart(p);});
},
reset(p){
p=p||{};
this._state.active=false;
this._state.turn=0;
this._state.ply=0;
this._state.side=String(p.side||"w")==="b"?"b":"w";
this._state.phase="idle";
this._state.lock=false;
this._state.meta.lastMove=null;
this._state.meta.lastEvent="reset";
this._state.meta.reason=String(p.reason||"");
this._clockStop();
this._applyClockPreset(p.clock||null);
this._emit("EVT:TURN_SYSTEM:RESET",{id:this.id,ts:Date.now(),side:this._state.side,reason:this._state.meta.reason});
this._emitState("reset");
},
start(p){
p=p||{};
if(!this._state.enabled)return;
if(this._state.active)return;
this._state.active=true;
this._state.phase="running";
this._state.meta.lastEvent="start";
this._state.meta.reason=String(p.reason||"");
if(p.side)this._state.side=String(p.side)==="b"?"b":"w";
this._emit("EVT:TURN_SYSTEM:START",{id:this.id,ts:Date.now(),side:this._state.side,reason:this._state.meta.reason});
this._emit("EVT:TURN_SYSTEM:TURN",{id:this.id,ts:Date.now(),turn:this._state.turn,ply:this._state.ply,side:this._state.side,phase:this._state.phase});
this._clockStart();
this._emitState("start");
},
stop(p){
p=p||{};
if(!this._state.active&&this._state.phase==="idle")return;
this._state.active=false;
this._state.phase="idle";
this._state.meta.lastEvent="stop";
this._state.meta.reason=String(p.reason||"");
this._clockStop();
this._emit("EVT:TURN_SYSTEM:STOP",{id:this.id,ts:Date.now(),reason:this._state.meta.reason});
this._emitState("stop");
},
pause(p){
p=p||{};
if(!this._state.active)return;
if(this._state.phase==="paused")return;
this._state.phase="paused";
this._state.meta.lastEvent="pause";
this._state.meta.reason=String(p.reason||"");
this._clockStop();
this._emit("EVT:TURN_SYSTEM:PAUSE",{id:this.id,ts:Date.now(),reason:this._state.meta.reason});
this._emitState("pause");
},
resume(p){
p=p||{};
if(!this._state.active)return;
if(this._state.phase!=="paused")return;
this._state.phase="running";
this._state.meta.lastEvent="resume";
this._state.meta.reason=String(p.reason||"");
this._emit("EVT:TURN_SYSTEM:RESUME",{id:this.id,ts:Date.now(),reason:this._state.meta.reason});
this._clockStart();
this._emitState("resume");
},
setSide(p){
p=p||{};
var s=String(p.side||"w")==="b"?"b":"w";
if(this._state.side===s)return;
this._state.side=s;
this._state.meta.lastEvent="set_side";
this._state.meta.reason=String(p.reason||"");
this._emit("EVT:TURN_SYSTEM:SIDE",{id:this.id,ts:Date.now(),side:this._state.side,reason:this._state.meta.reason});
this._emitState("set_side");
},
nextTurn(p){
p=p||{};
if(!this._state.active)return;
if(this._state.lock)return this._emit("EVT:TURN_SYSTEM:BLOCKED",{id:this.id,ts:Date.now(),why:"locked"});
if(this._state.phase!=="running")return;
var mv=p.move||null;
this._state.meta.lastMove=mv;
this._state.meta.lastEvent="next_turn";
this._state.meta.reason=String(p.reason||"");
this._clockApplyIncrement(this._state.side);
this._state.ply++;
if(this._state.side==="b")this._state.turn++;
this._state.side=this._state.side==="w"?"b":"w";
this._emit("EVT:TURN_SYSTEM:TURN",{id:this.id,ts:Date.now(),turn:this._state.turn,ply:this._state.ply,side:this._state.side,move:mv,reason:this._state.meta.reason});
this._clockMarkSwitch();
this._emitState("next_turn");
},
lock(p){
p=p||{};
this._state.lock=true;
this._state.meta.lastEvent="lock";
this._state.meta.reason=String(p.reason||"");
this._emit("EVT:TURN_SYSTEM:LOCK",{id:this.id,ts:Date.now(),locked:true,reason:this._state.meta.reason});
this._emitState("lock");
},
unlock(p){
p=p||{};
this._state.lock=false;
this._state.meta.lastEvent="unlock";
this._state.meta.reason=String(p.reason||"");
this._emit("EVT:TURN_SYSTEM:LOCK",{id:this.id,ts:Date.now(),locked:false,reason:this._state.meta.reason});
this._emitState("unlock");
},
onMoveCommitted(p){
p=p||{};
if(!this._state.active)return;
if(p&&p.meta&&p.meta.noTurnAdvance)return;
this.nextTurn({move:p,reason:"move_committed"});
},
onMoveUndone(p){
p=p||{};
this._state.meta.lastEvent="move_undone";
this._state.meta.reason="move_undone";
this._emit("EVT:TURN_SYSTEM:NOTE",{id:this.id,ts:Date.now(),note:"move_undone"});
this._emitState("move_undone");
},
setClock(p){
p=p||{};
var en=!!p.enabled;
this._state.clock.enabled=en;
this._state.clock.mode=String(p.mode||this._state.clock.mode||"none");
if(p.w&&("ms" in p.w))this._state.clock.w.ms=this._clampMs(p.w.ms);
if(p.b&&("ms" in p.b))this._state.clock.b.ms=this._clampMs(p.b.ms);
if(p.w&&("inc" in p.w))this._state.clock.w.inc=this._clampMs(p.w.inc);
if(p.b&&("inc" in p.b))this._state.clock.b.inc=this._clampMs(p.b.inc);
if(p.w&&("delay" in p.w))this._state.clock.w.delay=this._clampMs(p.w.delay);
if(p.b&&("delay" in p.b))this._state.clock.b.delay=this._clampMs(p.b.delay);
this._state.meta.lastEvent="set_clock";
this._state.meta.reason=String(p.reason||"");
this._emit("EVT:TURN_SYSTEM:CLOCK",{id:this.id,ts:Date.now(),clock:this._safeClock()});
this._emitState("set_clock");
},
_applyClockPreset(clock){
if(!clock)return;
this.setClock({enabled:!!clock.enabled,mode:clock.mode||"none",w:clock.w||{},b:clock.b||{},reason:"preset"});
},
_clockStart(){
if(!this._state.clock.enabled)return;
this._state.clock.lastTick=Date.now();
if(this._state.clock.running)return;
this._state.clock.running=true;
this._tickLoop();
},
_clockStop(){
this._state.clock.running=false;
},
_tickLoop(){
var me=this;
if(!me._state.clock.running)return;
requestAnimationFrame(function(){me._tick();me._tickLoop();});
},
_tick(){
if(!this._state.active)return;
if(!this._state.clock.enabled)return;
if(this._state.phase!=="running")return;
var now=Date.now();
var dt=now-(this._state.clock.lastTick||now);
this._state.clock.lastTick=now;
if(dt<=0)return;
var s=this._state.side;
var delay=(s==="w"?this._state.clock.w.delay:this._state.clock.b.delay)||0;
if(delay>0){
if(dt<=delay)return;
dt=dt-delay;
if(s==="w")this._state.clock.w.delay=0;
if(s==="b")this._state.clock.b.delay=0;
}
if(s==="w")this._state.clock.w.ms=this._clampMs(this._state.clock.w.ms-dt);
else this._state.clock.b.ms=this._clampMs(this._state.clock.b.ms-dt);
this._emit("EVT:TURN_SYSTEM:TICK",{id:this.id,ts:now,side:s,clock:this._safeClock()});
if(this._state.clock.w.ms<=0||this._state.clock.b.ms<=0)this._onFlagFall();
},
_clockApplyIncrement(side){
if(!this._state.clock.enabled)return;
if(side==="w")this._state.clock.w.ms=this._clampMs(this._state.clock.w.ms+this._state.clock.w.inc);
else this._state.clock.b.ms=this._clampMs(this._state.clock.b.ms+this._state.clock.b.inc);
},
_clockMarkSwitch(){
if(!this._state.clock.enabled)return;
this._state.clock.lastTick=Date.now();
},
_onFlagFall(){
this._state.meta.lastEvent="flag_fall";
this._state.meta.reason="clock_zero";
this._clockStop();
this._emit("EVT:TURN_SYSTEM:FLAG_FALL",{id:this.id,ts:Date.now(),clock:this._safeClock(),side:this._state.side});
this._emit("REQ:GAME:END",{reason:"clock_zero",loser:this._state.side});
},
_onMode(p){
p=p||{};
var mode=String(p.mode||"");
this._emit("EVT:TURN_SYSTEM:NOTE",{id:this.id,ts:Date.now(),note:"mode_"+mode});
},
_onGameStart(p){
p=p||{};
this.start({reason:"game_start",side:(p.side||this._state.side)});
},
_onGameEnd(p){
p=p||{};
this.stop({reason:String(p.reason||"game_end")});
},
_clampMs(v){
v=Number(v||0);
if(!isFinite(v))v=0;
if(v<0)v=0;
return Math.floor(v);
},
_safeClock(){
return{
enabled:!!this._state.clock.enabled,
mode:String(this._state.clock.mode||"none"),
w:{ms:this._state.clock.w.ms,inc:this._state.clock.w.inc,delay:this._state.clock.w.delay},
b:{ms:this._state.clock.b.ms,inc:this._state.clock.b.inc,delay:this._state.clock.b.delay},
running:!!this._state.clock.running
};
},
_emit(name,p){
try{this._ctx.bus.emit(name,p||{});}catch(e){}
},
_emitState(tag){
this._emit("EVT:TURN_SYSTEM:STATE",{id:this.id,ts:Date.now(),tag:String(tag||""),state:this.getState()});
},
getState(){
return{
ready:!!this._state.ready,
enabled:!!this._state.enabled,
active:!!this._state.active,
turn:this._state.turn,
ply:this._state.ply,
side:this._state.side,
phase:this._state.phase,
lock:!!this._state.lock,
clock:this._safeClock(),
meta:Object.assign({},this._state.meta)
};
},
_error(where,err){
var msg=(err&&err.message)?err.message:String(err||"error");
this._emit("EVT:TURN_SYSTEM:ERROR",{id:this.id,ts:Date.now(),where:String(where||"unknown"),error:msg});
return null;
},
api:{
reset:function(p){return Engine_TURN_SYSTEM_ENGINE.reset(p);},
start:function(p){return Engine_TURN_SYSTEM_ENGINE.start(p);},
stop:function(p){return Engine_TURN_SYSTEM_ENGINE.stop(p);},
pause:function(p){return Engine_TURN_SYSTEM_ENGINE.pause(p);},
resume:function(p){return Engine_TURN_SYSTEM_ENGINE.resume(p);},
setSide:function(p){return Engine_TURN_SYSTEM_ENGINE.setSide(p);},
nextTurn:function(p){return Engine_TURN_SYSTEM_ENGINE.nextTurn(p);},
lock:function(p){return Engine_TURN_SYSTEM_ENGINE.lock(p);},
unlock:function(p){return Engine_TURN_SYSTEM_ENGINE.unlock(p);},
setClock:function(p){return Engine_TURN_SYSTEM_ENGINE.setClock(p);},
getState:function(){return Engine_TURN_SYSTEM_ENGINE.getState();}
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_TURN_SYSTEM_ENGINE.id]=Engine_TURN_SYSTEM_ENGINE;
/-- üîÅüß†-(24B)-(E)-(TURN-SYSTEM-ENGINE)-(CLOCKWORK)-(E)-(24B)-üß†üîÅ --/
/-- ‚úÖ‚ö†Ô∏è-(25B)-(S)-(CHECK-CHECKMATE-ENGINE)-(ENDGAME)-(S)-(25B)-‚ö†Ô∏è‚úÖ --/
const Engine_CHECK_CHECKMATE_ENGINE={
id:"CHECK_CHECKMATE_ENGINE",
_ctx:null,
_state:{
ready:false,
enabled:true,
status:{
inCheck:false,
inCheckSide:null,
checkers:[],
legalCount:0,
mate:false,
stalemate:false,
draw:false,
winner:null,
reason:""
},
last:{
fen:"",
side:"w",
ts:0
}
},
_wireDone:false,
init(ctx){
this._ctx=ctx||null;
if(!this._ctx||!this._ctx.bus)return this._error("init","missing_ctx_bus");
if(this._wireDone)return this;
this._wire();
this._wireDone=true;
this._state.ready=true;
this._emit("EVT:ENDGAME:READY",{id:this.id,ts:Date.now()});
this._emitState("ready");
return this;
},
_wire(){
var b=this._ctx.bus,me=this;
b.on("REQ:ENDGAME:EVALUATE",function(p){me.evaluate(p);});
b.on("REQ:ENDGAME:RESET",function(){me.reset();});
b.on("REQ:ENDGAME:GET_STATE",function(){me._emitState("get_state");});
b.on("EVT:BOARD:CHANGED",function(p){me.evaluate({reason:"board_changed",payload:p});});
b.on("EVT:MOVE:COMMITTED",function(p){me.evaluate({reason:"move_committed",payload:p});});
b.on("EVT:TURN_SYSTEM:TURN",function(p){me.evaluate({reason:"turn_tick",payload:p});});
},
reset(){
this._state.status.inCheck=false;
this._state.status.inCheckSide=null;
this._state.status.checkers=[];
this._state.status.legalCount=0;
this._state.status.mate=false;
this._state.status.stalemate=false;
this._state.status.draw=false;
this._state.status.winner=null;
this._state.status.reason="";
this._state.last.fen="";
this._state.last.side="w";
this._state.last.ts=0;
this._emit("EVT:ENDGAME:RESET",{id:this.id,ts:Date.now()});
this._emitState("reset");
},
evaluate(p){
p=p||{};
if(!this._state.enabled)return;
var snap=this._snapshot(p);
if(!snap)return;
var side=snap.side;
var info=this._computeStatus(snap,side);
this._state.status=info;
this._state.last.fen=snap.fen||"";
this._state.last.side=side;
this._state.last.ts=Date.now();
this._emit("EVT:ENDGAME:STATUS",{id:this.id,ts:this._state.last.ts,side:side,status:this._safeStatus(),reason:String(p.reason||"")});
this._emitState("evaluate");
if(info.mate||info.stalemate||info.draw)this._emitEnd(info,side,p);
},
_snapshot(p){
var b=this._ctx.board||null;
var r=this._ctx.rules||null;
var t=this._ctx.turn||null;
var fen="",side="w";
if(p&&p.fen)fen=String(p.fen||"");
if(p&&p.side)side=String(p.side)==="b"?"b":"w";
if(!side&&t&&t.getState)side=(t.getState().side||"w");
if(!fen){
if(b&&b.getFEN)fen=b.getFEN();
else if(r&&r.getFEN)fen=r.getFEN();
else fen="";
}
if(!side){
if(r&&r.getSideToMove)side=(r.getSideToMove()==="b"?"b":"w");
else side="w";
}
return{fen:fen,side:side,board:b,rules:r,turn:t};
},
_computeStatus(snap,side){
var r=snap.rules||null;
var b=snap.board||null;
var out={
inCheck:false,
inCheckSide:side,
checkers:[],
legalCount:0,
mate:false,
stalemate:false,
draw:false,
winner:null,
reason:""
};
var inCheck=null,checkers=null,legals=null,legalCount=0;
if(r&&r.isKingInCheck){inCheck=!!r.isKingInCheck(side);}
if(r&&r.getCheckers){checkers=r.getCheckers(side)||[];}
if(!checkers)checkers=[];
if(r&&r.getLegalMoves){
legals=r.getLegalMoves(side)||[];
legalCount=legals.length||0;
}else if(r&&r.countLegalMoves){
legalCount=Number(r.countLegalMoves(side)||0);
}else if(b&&b.getLegalMoves){
legals=b.getLegalMoves(side)||[];
legalCount=legals.length||0;
}else legalCount=0;
if(inCheck===null){
inCheck=this._fallbackCheck(snap,side);
}
out.inCheck=!!inCheck;
out.checkers=this._normalizeCheckers(checkers);
out.legalCount=this._clampInt(legalCount);
if(out.legalCount<=0){
if(out.inCheck){
out.mate=true;
out.winner=(side==="w"?"b":"w");
out.reason="checkmate";
}else{
out.stalemate=true;
out.draw=true;
out.reason="stalemate";
}
}
var extra=this._extraDrawRules(snap);
if(extra.draw){
out.draw=true;
out.mate=false;
out.stalemate=false;
out.winner=null;
out.reason=extra.reason;
}
return out;
},
_fallbackCheck(snap,side){
var r=snap.rules||null;
if(r&&r.squareAttacked&&r.getKingSquare){
var k=r.getKingSquare(side);
if(!k)return false;
var opp=side==="w"?"b":"w";
return !!r.squareAttacked(k,opp);
}
return false;
},
_extraDrawRules(snap){
var r=snap.rules||null;
var b=snap.board||null;
if(r&&r.isDraw){
var d=r.isDraw();
if(d===true)return{draw:true,reason:"draw"};
if(d&&d.draw)return{draw:true,reason:String(d.reason||"draw")};
}
if(r&&r.halfmoveClock&&Number(r.halfmoveClock())>=100)return{draw:true,reason:"fifty_move_rule"};
if(r&&r.threefoldRepetition&&r.threefoldRepetition())return{draw:true,reason:"threefold_repetition"};
if(b&&b.hasInsufficientMaterial&&b.hasInsufficientMaterial())return{draw:true,reason:"insufficient_material"};
if(r&&r.hasInsufficientMaterial&&r.hasInsufficientMaterial())return{draw:true,reason:"insufficient_material"};
return{draw:false,reason:""};
},
_normalizeCheckers(arr){
if(!arr||!arr.length)return[];
var out=[],i=0;
for(i=0;i<arr.length;i++){
var c=arr[i];
if(!c)continue;
if(typeof c==="string")out.push({from:c});
else if(typeof c==="object")out.push({from:String(c.from||c.square||""),piece:String(c.piece||""),id:String(c.id||"")});
}
return out;
},
_emitEnd(info,side,p){
var payload={
id:this.id,
ts:Date.now(),
side:side,
status:this._safeStatus(),
trigger:String(p&&p.reason||"evaluate")
};
if(info.mate){
this._emit("EVT:ENDGAME:CHECKMATE",payload);
this._emit("REQ:GAME:END",{reason:"checkmate",winner:info.winner,loser:side,meta:payload});
return;
}
if(info.stalemate){
this._emit("EVT:ENDGAME:STALEMATE",payload);
this._emit("REQ:GAME:END",{reason:"stalemate",winner:null,loser:null,meta:payload});
return;
}
if(info.draw){
this._emit("EVT:ENDGAME:DRAW",payload);
this._emit("REQ:GAME:END",{reason:info.reason||"draw",winner:null,loser:null,meta:payload});
return;
}
},
_safeStatus(){
var s=this._state.status||{};
return{
inCheck:!!s.inCheck,
inCheckSide:s.inCheckSide||null,
checkers:(s.checkers||[]).slice(0,8),
legalCount:this._clampInt(s.legalCount||0),
mate:!!s.mate,
stalemate:!!s.stalemate,
draw:!!s.draw,
winner:s.winner||null,
reason:String(s.reason||"")
};
},
_emit(name,p){
try{this._ctx.bus.emit(name,p||{});}catch(e){}
},
_emitState(tag){
this._emit("EVT:ENDGAME:STATE",{id:this.id,ts:Date.now(),tag:String(tag||""),state:this.getState()});
},
getState(){
return{
ready:!!this._state.ready,
enabled:!!this._state.enabled,
status:this._safeStatus(),
last:Object.assign({},this._state.last)
};
},
_clampInt(v){
v=Number(v||0);
if(!isFinite(v))v=0;
v=Math.floor(v);
if(v<0)v=0;
return v;
},
_error(where,err){
var msg=(err&&err.message)?err.message:String(err||"error");
this._emit("EVT:ENDGAME:ERROR",{id:this.id,ts:Date.now(),where:String(where||"unknown"),error:msg});
return null;
},
api:{
evaluate:function(p){return Engine_CHECK_CHECKMATE_ENGINE.evaluate(p);},
reset:function(){return Engine_CHECK_CHECKMATE_ENGINE.reset();},
getState:function(){return Engine_CHECK_CHECKMATE_ENGINE.getState();}
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_CHECK_CHECKMATE_ENGINE.id]=Engine_CHECK_CHECKMATE_ENGINE;
/-- ‚úÖ‚ö†Ô∏è-(25B)-(E)-(CHECK-CHECKMATE-ENGINE)-(ENDGAME)-(E)-(25B)-‚ö†Ô∏è‚úÖ --/
/-- üß∑üîí-(26B)-(S)-(MOVE-VALIDATION-GUARD)-(NO-CHEAT)-(S)-(26B)-üîíüß∑ --/
const Engine_MOVE_VALIDATION_GUARD={
id:"MOVE_VALIDATION_GUARD",
_ctx:null,
_state:{
ready:false,
enabled:true,
strict:true,
lockOnTurn:true,
lockSide:"w",
activeSide:"w",
selected:null,
pending:null,
last:{
ok:true,
reason:"",
ts:0
}
},
_wireDone:false,
init(ctx){
this._ctx=ctx||null;
if(!this._ctx||!this._ctx.bus)return this._error("init","missing_ctx_bus");
if(this._wireDone)return this;
this._wire();
this._wireDone=true;
this._state.ready=true;
this._emit("EVT:GUARD:READY",{id:this.id,ts:Date.now()});
this._emitState("ready");
return this;
},
_wire(){
var b=this._ctx.bus,me=this;
b.on("REQ:GUARD:VALIDATE_MOVE",function(p){me.validateMove(p);});
b.on("REQ:GUARD:SET_STRICT",function(p){me.setStrict(p);});
b.on("REQ:GUARD:SET_ENABLED",function(p){me.setEnabled(p);});
b.on("REQ:GUARD:RESET",function(){me.reset();});
b.on("REQ:GUARD:GET_STATE",function(){me._emitState("get_state");});
b.on("EVT:TURN_SYSTEM:TURN",function(p){me._onTurn(p);});
b.on("EVT:INPUT:SELECT",function(p){me._onSelect(p);});
b.on("EVT:INPUT:INTENT_MOVE",function(p){me.validateMove({intent:p,source:"input_intent"});});
b.on("EVT:MOVE:REQUEST",function(p){me.validateMove({intent:p,source:"move_request"});});
},
reset(){
this._state.selected=null;
this._state.pending=null;
this._state.last.ok=true;
this._state.last.reason="";
this._state.last.ts=0;
this._emit("EVT:GUARD:RESET",{id:this.id,ts:Date.now()});
this._emitState("reset");
},
setEnabled(p){
p=p||{};
this._state.enabled=!!p.enabled;
this._emit("EVT:GUARD:ENABLED",{id:this.id,ts:Date.now(),enabled:!!this._state.enabled});
this._emitState("set_enabled");
},
setStrict(p){
p=p||{};
if("strict"in p)this._state.strict=!!p.strict;
if("lockOnTurn"in p)this._state.lockOnTurn=!!p.lockOnTurn;
if("lockSide"in p)this._state.lockSide=(String(p.lockSide||"w")==="b"?"b":"w");
this._emit("EVT:GUARD:STRICT",{id:this.id,ts:Date.now(),strict:!!this._state.strict,lockOnTurn:!!this._state.lockOnTurn,lockSide:this._state.lockSide});
this._emitState("set_strict");
},
_onTurn(p){
p=p||{};
var s=String(p.side||p.activeSide||"");
if(s!=="w"&&s!=="b")return;
this._state.activeSide=s;
if(this._state.lockOnTurn)this._state.lockSide=s;
this._emit("EVT:GUARD:TURN",{id:this.id,ts:Date.now(),activeSide:this._state.activeSide,lockSide:this._state.lockSide});
this._emitState("turn");
},
_onSelect(p){
p=p||{};
var sq=String(p.square||p.from||"");
var piece=p.piece||null;
if(!sq)return;
this._state.selected={square:sq,piece:piece,side:this._inferPieceSide(piece)};
this._emit("EVT:GUARD:SELECT",{id:this.id,ts:Date.now(),selected:this._state.selected});
},
validateMove(p){
p=p||{};
if(!this._state.enabled)return this._allow(p,"disabled");
var intent=(p.intent||p.move||p)||{};
var from=String(intent.from||intent.src||intent.squareFrom||"");
var to=String(intent.to||intent.dst||intent.squareTo||"");
var promo=intent.promo||intent.promotion||null;
var side=String(intent.side||intent.player||"");
if(!side)side=this._state.activeSide||"w";
if(side!=="w"&&side!=="b")side="w";
if(!from||!to)return this._deny(p,"missing_from_to");
if(from===to)return this._deny(p,"same_square");
var lock=this._state.lockSide||this._state.activeSide||"w";
if(this._state.strict&&lock&&side!==lock)return this._deny(p,"wrong_side");
var piece=this._getPieceAt(from);
if(!piece)return this._deny(p,"no_piece_at_from");
var pside=this._inferPieceSide(piece);
if(this._state.strict&&pside&&pside!==side)return this._deny(p,"piece_not_owned");
var legal=this._isLegal(from,to,side,promo);
if(!legal)return this._deny(p,"illegal_move");
var okPayload={id:this.id,ts:Date.now(),ok:true,from:from,to:to,side:side,promo:promo,source:String(p.source||""),intent:intent};
this._state.last.ok=true;
this._state.last.reason="ok";
this._state.last.ts=okPayload.ts;
this._state.pending={from:from,to:to,side:side,promo:promo};
this._emit("EVT:GUARD:ALLOW",okPayload);
this._emit("REQ:MOVE:COMMIT",intent);
this._emitState("allow");
return true;
},
_allow(p,reason){
var payload={id:this.id,ts:Date.now(),ok:true,reason:String(reason||"ok"),source:String(p.source||"")};
this._state.last.ok=true;
this._state.last.reason=payload.reason;
this._state.last.ts=payload.ts;
this._emit("EVT:GUARD:ALLOW",payload);
this._emitState("allow_bypass");
return true;
},
_deny(p,reason){
var intent=(p.intent||p.move||p)||{};
var payload={id:this.id,ts:Date.now(),ok:false,reason:String(reason||"denied"),source:String(p.source||""),intent:intent};
this._state.last.ok=false;
this._state.last.reason=payload.reason;
this._state.last.ts=payload.ts;
this._state.pending=null;
this._emit("EVT:GUARD:DENY",payload);
this._emit("EVT:INPUT:REJECT_MOVE",payload);
this._emitState("deny");
return false;
},
_isLegal(from,to,side,promo){
var r=this._ctx.rules||null;
var b=this._ctx.board||null;
if(r&&r.isLegalMove)return !!r.isLegalMove({from:from,to:to,side:side,promo:promo});
if(r&&r.getLegalMoves){
var ms=r.getLegalMoves(side)||[];
return this._scanLegal(ms,from,to,promo);
}
if(b&&b.getLegalMoves){
var ms2=b.getLegalMoves(side)||[];
return this._scanLegal(ms2,from,to,promo);
}
return true;
},
_scanLegal(ms,from,to,promo){
if(!ms||!ms.length)return false;
var i=0;
for(i=0;i<ms.length;i++){
var m=ms[i];
if(!m)continue;
var mf=String(m.from||m.src||"");
var mt=String(m.to||m.dst||"");
if(mf===from&&mt===to){
if(!promo)return true;
var mp=String(m.promo||m.promotion||"");
if(!mp||mp===String(promo))return true;
}
}
return false;
},
_getPieceAt(sq){
var b=this._ctx.board||null;
var r=this._ctx.rules||null;
if(b&&b.getPieceAt)return b.getPieceAt(sq);
if(r&&r.getPieceAt)return r.getPieceAt(sq);
if(b&&b.state&&b.state.pieces)return b.state.pieces[sq]||null;
return null;
},
_inferPieceSide(piece){
if(!piece)return null;
if(typeof piece==="string"){
var c=piece.charAt(0);
if(c>="A"&&c<="Z")return"w";
if(c>="a"&&c<="z")return"b";
}
if(typeof piece==="object"){
var s=String(piece.side||piece.color||"");
if(s==="w"||s==="white")return"w";
if(s==="b"||s==="black")return"b";
var n=String(piece.id||piece.name||"");
if(n.indexOf("white")>=0||n.indexOf("w_")===0)return"w";
if(n.indexOf("black")>=0||n.indexOf("b_")===0)return"b";
}
return null;
},
_emit(name,p){
try{this._ctx.bus.emit(name,p||{});}catch(e){}
},
_emitState(tag){
this._emit("EVT:GUARD:STATE",{id:this.id,ts:Date.now(),tag:String(tag||""),state:this.getState()});
},
getState(){
return{
ready:!!this._state.ready,
enabled:!!this._state.enabled,
strict:!!this._state.strict,
lockOnTurn:!!this._state.lockOnTurn,
lockSide:this._state.lockSide,
activeSide:this._state.activeSide,
selected:this._state.selected?Object.assign({},this._state.selected):null,
pending:this._state.pending?Object.assign({},this._state.pending):null,
last:Object.assign({},this._state.last)
};
},
_error(where,err){
var msg=(err&&err.message)?err.message:String(err||"error");
this._emit("EVT:GUARD:ERROR",{id:this.id,ts:Date.now(),where:String(where||"unknown"),error:msg});
return null;
},
api:{
validateMove:function(p){return Engine_MOVE_VALIDATION_GUARD.validateMove(p);},
setStrict:function(p){return Engine_MOVE_VALIDATION_GUARD.setStrict(p);},
setEnabled:function(p){return Engine_MOVE_VALIDATION_GUARD.setEnabled(p);},
reset:function(){return Engine_MOVE_VALIDATION_GUARD.reset();},
getState:function(){return Engine_MOVE_VALIDATION_GUARD.getState();}
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_MOVE_VALIDATION_GUARD.id]=Engine_MOVE_VALIDATION_GUARD;
/-- üß∑üîí-(26B)-(E)-(MOVE-VALIDATION-GUARD)-(NO-CHEAT)-(E)-(26B)-üîíüß∑ --/
/-- üß™üåÄ-(27B)-(S)-(PERF-ADAPTIVE-RENDER)-(MOBILE-SAFE)-(S)-(27B)-üåÄüß™ --/
const Engine_PERF_ADAPTIVE_RENDER={
id:"PERF_ADAPTIVE_RENDER",
_ctx:null,
_state:{
ready:false,
enabled:true,
mode:"auto",
tier:"high",
fpsTarget:60,
fpsNow:60,
quality:1,
scale:1,
capParticles:false,
capGlow:false,
capShadows:false,
capAnim:false,
frameBudget:16.67,
sampleWindow:60,
cooldownMs:1200,
lastTune:0,
lastDowngrade:0,
lastUpgrade:0,
stats:{
frames:0,
dtAvg:16.67,
dtMin:999,
dtMax:0,
fpsAvg:60,
drops:0
}
},
_wireDone:false,
_loopBound:false,
_lastT:0,
init(ctx){
this._ctx=ctx||null;
if(!this._ctx||!this._ctx.bus)return this._error("init","missing_ctx_bus");
if(this._wireDone)return this;
this._wire();
this._wireDone=true;
this._state.ready=true;
this._emit("EVT:PERF:READY",{id:this.id,ts:Date.now()});
this._emitState("ready");
this._startLoop();
return this;
},
_wire(){
var b=this._ctx.bus,me=this;
b.on("REQ:PERF:SET_ENABLED",function(p){me.setEnabled(p);});
b.on("REQ:PERF:SET_MODE",function(p){me.setMode(p);});
b.on("REQ:PERF:SET_TIER",function(p){me.setTier(p);});
b.on("REQ:PERF:SET_TARGET_FPS",function(p){me.setTargetFPS(p);});
b.on("REQ:PERF:RESET",function(){me.reset();});
b.on("REQ:PERF:GET_STATE",function(){me._emitState("get_state");});
b.on("EVT:SETTINGS:PERF_MODE",function(p){me.setMode(p);});
b.on("EVT:SETTINGS:PERF_TIER",function(p){me.setTier(p);});
},
_startLoop(){
if(this._loopBound)return;
this._loopBound=true;
this._lastT=performance.now();
this._tick();
},
_tick(){
var me=this;
requestAnimationFrame(function(t){
me._onFrame(t);
me._tick();
});
},
_onFrame(t){
if(!this._state.enabled)return;
var dt=t-this._lastT;
this._lastT=t;
if(dt<=0||dt>250)return;
this._accum(dt);
if(this._state.stats.frames%this._state.sampleWindow===0)this._tune();
},
_accum(dt){
var s=this._state.stats;
s.frames++;
if(dt<s.dtMin)s.dtMin=dt;
if(dt>s.dtMax)s.dtMax=dt;
s.dtAvg=this._lerp(s.dtAvg,dt,0.08);
var fps=1000/Math.max(1,dt);
this._state.fpsNow=fps;
s.fpsAvg=this._lerp(s.fpsAvg,fps,0.08);
if(dt>this._state.frameBudget*1.35)s.drops++;
},
_tune(){
var now=Date.now();
if(now-this._state.lastTune<this._state.cooldownMs)return;
this._state.lastTune=now;
if(this._state.mode!=="auto")return;
var fpsAvg=this._state.stats.fpsAvg;
var target=this._state.fpsTarget;
var low=target*0.86;
var high=target*0.97;
if(fpsAvg<low)this._downgrade("fps_low");
else if(fpsAvg>high)this._upgrade("fps_high");
},
_downgrade(reason){
var now=Date.now();
if(now-this._state.lastDowngrade<900)return;
this._state.lastDowngrade=now;
if(this._state.quality>0.55)this._state.quality=this._clamp(this._state.quality-0.10,0.45,1);
else if(this._state.scale>0.80)this._state.scale=this._clamp(this._state.scale-0.05,0.75,1);
else this._applyCaps("low");
this._recalcTierFromQuality();
this._broadcast(reason,"down");
},
_upgrade(reason){
var now=Date.now();
if(now-this._state.lastUpgrade<1400)return;
this._state.lastUpgrade=now;
if(this._state.scale<1)this._state.scale=this._clamp(this._state.scale+0.05,0.75,1);
else if(this._state.quality<1)this._state.quality=this._clamp(this._state.quality+0.08,0.45,1);
else this._applyCaps("high");
this._recalcTierFromQuality();
this._broadcast(reason,"up");
},
_applyCaps(level){
if(level==="low"){
this._state.capParticles=true;
this._state.capGlow=true;
this._state.capShadows=true;
this._state.capAnim=true;
}else{
this._state.capParticles=false;
this._state.capGlow=false;
this._state.capShadows=false;
this._state.capAnim=false;
}
},
_recalcTierFromQuality(){
var q=this._state.quality,sc=this._state.scale;
var tier="high";
if(q<0.62||sc<0.86)tier="low";
else if(q<0.82||sc<0.96)tier="med";
this._state.tier=tier;
},
setEnabled(p){
p=p||{};
this._state.enabled=!!p.enabled;
this._emit("EVT:PERF:ENABLED",{id:this.id,ts:Date.now(),enabled:!!this._state.enabled});
this._emitState("set_enabled");
},
setMode(p){
p=p||{};
var m=String(p.mode||p.value||"");
if(m!=="auto"&&m!=="manual")m="auto";
this._state.mode=m;
this._emit("EVT:PERF:MODE",{id:this.id,ts:Date.now(),mode:this._state.mode});
this._emitState("set_mode");
if(this._state.mode==="auto")this._tune();
},
setTier(p){
p=p||{};
var t=String(p.tier||p.value||"");
if(t!=="high"&&t!=="med"&&t!=="low")t="high";
this._state.tier=t;
this._state.mode="manual";
if(t==="high"){this._state.quality=1;this._state.scale=1;this._applyCaps("high");}
if(t==="med"){this._state.quality=0.78;this._state.scale=0.92;this._state.capParticles=false;this._state.capGlow=false;this._state.capShadows=true;this._state.capAnim=false;}
if(t==="low"){this._state.quality=0.58;this._state.scale=0.82;this._applyCaps("low");}
this._broadcast("manual_tier","set");
this._emit("EVT:PERF:TIER",{id:this.id,ts:Date.now(),tier:this._state.tier});
this._emitState("set_tier");
},
setTargetFPS(p){
p=p||{};
var n=Number(p.fps||p.target||p.value||60);
if(!isFinite(n))n=60;
n=this._clamp(n,30,120);
this._state.fpsTarget=n;
this._state.frameBudget=1000/n;
this._emit("EVT:PERF:TARGET",{id:this.id,ts:Date.now(),fpsTarget:this._state.fpsTarget,frameBudget:this._state.frameBudget});
this._emitState("set_target_fps");
},
reset(){
this._state.quality=1;
this._state.scale=1;
this._state.mode="auto";
this._state.tier="high";
this._applyCaps("high");
this._state.lastTune=0;
this._state.lastDowngrade=0;
this._state.lastUpgrade=0;
this._state.stats={frames:0,dtAvg:16.67,dtMin:999,dtMax:0,fpsAvg:60,drops:0};
this._emit("EVT:PERF:RESET",{id:this.id,ts:Date.now()});
this._broadcast("reset","set");
this._emitState("reset");
},
_broadcast(reason,dir){
var caps={particles:!!this._state.capParticles,glow:!!this._state.capGlow,shadows:!!this._state.capShadows,anim:!!this._state.capAnim};
var payload={id:this.id,ts:Date.now(),reason:String(reason||""),dir:String(dir||""),mode:this._state.mode,tier:this._state.tier,quality:this._state.quality,scale:this._state.scale,caps:caps,fpsAvg:this._state.stats.fpsAvg,fpsNow:this._state.fpsNow};
this._emit("EVT:PERF:PROFILE",payload);
this._emit("REQ:RENDER:SET_QUALITY",{quality:this._state.quality,scale:this._state.scale});
this._emit("REQ:FX:CAPS",caps);
},
_emit(name,p){
try{this._ctx.bus.emit(name,p||{});}catch(e){}
},
_emitState(tag){
this._emit("EVT:PERF:STATE",{id:this.id,ts:Date.now(),tag:String(tag||""),state:this.getState()});
},
getState(){
return{
ready:!!this._state.ready,
enabled:!!this._state.enabled,
mode:this._state.mode,
tier:this._state.tier,
fpsTarget:this._state.fpsTarget,
fpsNow:this._state.fpsNow,
quality:this._round(this._state.quality,3),
scale:this._round(this._state.scale,3),
caps:{particles:!!this._state.capParticles,glow:!!this._state.capGlow,shadows:!!this._state.capShadows,anim:!!this._state.capAnim},
stats:Object.assign({},this._state.stats)
};
},
_lerp(a,b,t){return a+(b-a)*t;},
_clamp(n,a,b){return Math.max(a,Math.min(b,n));},
_round(n,p){var m=Math.pow(10,p||0);return Math.round(n*m)/m;},
_error(where,err){
var msg=(err&&err.message)?err.message:String(err||"error");
this._emit("EVT:PERF:ERROR",{id:this.id,ts:Date.now(),where:String(where||"unknown"),error:msg});
return null;
},
api:{
setEnabled:function(p){return Engine_PERF_ADAPTIVE_RENDER.setEnabled(p);},
setMode:function(p){return Engine_PERF_ADAPTIVE_RENDER.setMode(p);},
setTier:function(p){return Engine_PERF_ADAPTIVE_RENDER.setTier(p);},
setTargetFPS:function(p){return Engine_PERF_ADAPTIVE_RENDER.setTargetFPS(p);},
reset:function(){return Engine_PERF_ADAPTIVE_RENDER.reset();},
getState:function(){return Engine_PERF_ADAPTIVE_RENDER.getState();}
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_PERF_ADAPTIVE_RENDER.id]=Engine_PERF_ADAPTIVE_RENDER;
/-- üß™üåÄ-(27B)-(E)-(PERF-ADAPTIVE-RENDER)-(MOBILE-SAFE)-(E)-(27B)-üåÄüß™ --/
/-- üîåüß†-(28B)-(S)-(GAME-ADAPTER-REGISTER)-(37A-HOOK)-(S)-(28B)-üß†üîå --/
const Engine_GAME_ADAPTER_REGISTER={
id:"GAME_ADAPTER_REGISTER",
_ctx:null,
_state:{
ready:false,
bootTs:0,
activeGame:"LEGION_CHESS",
adapters:{},
activeAdapterId:null,
lastEvent:"",
lastError:"",
hookName:"HOOK:37A",
hookEnabled:true
},
_wireDone:false,
init(ctx){
this._ctx=ctx||null;
if(!this._ctx||!this._ctx.bus)return this._error("init","missing_ctx_bus");
if(this._wireDone)return this;
this._state.bootTs=Date.now();
this._wire();
this._wireDone=true;
this._state.ready=true;
this._emit("EVT:ADAPTER:READY",{id:this.id,ts:Date.now(),hook:this._state.hookName});
this._emitState("ready");
this._autoAttachWindowHook();
return this;
},
_wire(){
var b=this._ctx.bus,me=this;
b.on("REQ:ADAPTER:REGISTER",function(p){me.register(p);});
b.on("REQ:ADAPTER:UNREGISTER",function(p){me.unregister(p);});
b.on("REQ:ADAPTER:SET_ACTIVE",function(p){me.setActive(p);});
b.on("REQ:ADAPTER:GET_ACTIVE",function(){me._emit("EVT:ADAPTER:ACTIVE",{id:me.id,ts:Date.now(),active:me.getActive()});});
b.on("REQ:ADAPTER:LIST",function(){me._emit("EVT:ADAPTER:LIST",{id:me.id,ts:Date.now(),list:me.list()});});
b.on("REQ:ADAPTER:CALL",function(p){me.call(p);});
b.on("REQ:ADAPTER:HOOK_ENABLE",function(p){me.setHookEnabled(p);});
b.on("REQ:ADAPTER:RESET",function(){me.reset();});
},
_autoAttachWindowHook(){
var me=this;
if(!window)return;
try{
window[this._state.hookName]=function(payload){
return me._on37A(payload);
};
this._emit("EVT:ADAPTER:HOOK_ATTACHED",{id:this.id,ts:Date.now(),hook:this._state.hookName});
}catch(e){
this._error("hook_attach",e);
}
},
_on37A(payload){
if(!this._state.hookEnabled)return null;
payload=payload||{};
var op=String(payload.op||payload.type||payload.cmd||"");
if(!op)op="dispatch";
if(op==="register")return this.register(payload);
if(op==="unregister")return this.unregister(payload);
if(op==="set_active")return this.setActive(payload);
if(op==="call")return this.call(payload);
if(op==="list")return this.list();
if(op==="get_active")return this.getActive();
return this.dispatch(payload);
},
register(p){
p=p||{};
var id=String(p.id||p.adapterId||p.name||"");
if(!id)return this._error("register","missing_id");
var adapter=p.adapter||p.value||p.fn||p;
var norm=this._normalizeAdapter(id,adapter,p);
if(!norm)return this._error("register","bad_adapter");
this._state.adapters[id]=norm;
this._state.lastEvent="register:"+id;
this._emit("EVT:ADAPTER:REGISTERED",{id:this.id,ts:Date.now(),adapterId:id,meta:norm.meta});
if(!this._state.activeAdapterId&&String(p.autoActive||"")==="true")this.setActive({id:id});
this._emitState("register");
return {ok:true,id:id};
},
unregister(p){
p=p||{};
var id=String(p.id||p.adapterId||p.name||"");
if(!id)return this._error("unregister","missing_id");
if(!this._state.adapters[id])return {ok:false,id:id,reason:"not_found"};
delete this._state.adapters[id];
if(this._state.activeAdapterId===id)this._state.activeAdapterId=null;
this._state.lastEvent="unregister:"+id;
this._emit("EVT:ADAPTER:UNREGISTERED",{id:this.id,ts:Date.now(),adapterId:id});
this._emitState("unregister");
return {ok:true,id:id};
},
setActive(p){
p=p||{};
var id=String(p.id||p.adapterId||p.name||"");
if(!id)return this._error("set_active","missing_id");
if(!this._state.adapters[id])return {ok:false,id:id,reason:"not_found"};
this._state.activeAdapterId=id;
this._state.lastEvent="set_active:"+id;
this._emit("EVT:ADAPTER:SET_ACTIVE",{id:this.id,ts:Date.now(),adapterId:id});
this._emit("REQ:GAME:ADAPTER_CHANGED",{adapterId:id,meta:this._state.adapters[id].meta});
this._emitState("set_active");
return {ok:true,id:id};
},
getActive(){
var id=this._state.activeAdapterId;
if(!id||!this._state.adapters[id])return null;
return {id:id,meta:this._state.adapters[id].meta};
},
list(){
var out=[],k;
for(k in this._state.adapters)out.push({id:k,meta:this._state.adapters[k].meta});
out.sort(function(a,b){return a.id<b.id?-1:a.id>b.id?1:0;});
return out;
},
dispatch(p){
p=p||{};
var id=String(p.adapterId||p.id||"")||this._state.activeAdapterId;
if(!id)return {ok:false,reason:"no_active_adapter"};
var a=this._state.adapters[id];
if(!a)return {ok:false,reason:"adapter_missing",id:id};
var evt=String(p.evt||p.event||"");
var data=p.data||p.payload||p;
this._state.lastEvent="dispatch:"+id+":"+evt;
try{
if(a.dispatch)return a.dispatch(evt,data,this._ctx);
if(a.on)return a.on(evt,data,this._ctx);
return {ok:false,reason:"no_dispatch",id:id};
}catch(e){
return this._error("dispatch",e);
}
},
call(p){
p=p||{};
var id=String(p.adapterId||p.id||"")||this._state.activeAdapterId;
if(!id)return {ok:false,reason:"no_active_adapter"};
var a=this._state.adapters[id];
if(!a)return {ok:false,reason:"adapter_missing",id:id};
var fn=String(p.fn||p.method||p.name||"");
if(!fn)return this._error("call","missing_fn");
var args=p.args||p.payload||[];
try{
if(typeof a[fn]==="function")return {ok:true,id:id,fn:fn,res:a[fn].apply(a,Array.isArray(args)?args:[args])};
if(a.api&&typeof a.api[fn]==="function")return {ok:true,id:id,fn:fn,res:a.api[fn].apply(a.api,Array.isArray(args)?args:[args])};
return {ok:false,reason:"fn_not_found",id:id,fn:fn};
}catch(e){
return this._error("call",e);
}
},
setHookEnabled(p){
p=p||{};
this._state.hookEnabled=!!(p.enabled!==undefined?p.enabled:p.value);
this._emit("EVT:ADAPTER:HOOK_ENABLED",{id:this.id,ts:Date.now(),hook:this._state.hookName,enabled:!!this._state.hookEnabled});
this._emitState("hook_enabled");
return {ok:true,enabled:!!this._state.hookEnabled};
},
reset(){
this._state.adapters={};
this._state.activeAdapterId=null;
this._state.lastEvent="reset";
this._state.lastError="";
this._emit("EVT:ADAPTER:RESET",{id:this.id,ts:Date.now()});
this._emitState("reset");
return {ok:true};
},
_normalizeAdapter(id,adapter,p){
p=p||{};
if(!adapter)return null;
var norm={id:id,meta:{},dispatch:null,on:null,api:null};
norm.meta={
id:id,
game:String(p.game||p.activeGame||this._state.activeGame||""),
label:String(p.label||id),
version:String(p.version||"1.0.0"),
author:String(p.author||"KOG"),
ts:Date.now()
};
if(typeof adapter==="function"){norm.dispatch=adapter;return norm;}
if(typeof adapter==="object"){
if(typeof adapter.dispatch==="function")norm.dispatch=adapter.dispatch.bind(adapter);
if(typeof adapter.on==="function")norm.on=adapter.on.bind(adapter);
if(adapter.api)norm.api=adapter.api;
var k;
for(k in adapter)if(typeof adapter[k]==="function"&&k!=="dispatch"&&k!=="on")norm[k]=adapter[k].bind(adapter);
if(!norm.dispatch&&!norm.on)return null;
return norm;
}
return null;
},
_emit(name,p){
try{this._ctx.bus.emit(name,p||{});}catch(e){}
},
_emitState(tag){
this._emit("EVT:ADAPTER:STATE",{id:this.id,ts:Date.now(),tag:String(tag||""),state:this.getState()});
},
getState(){
return{
ready:!!this._state.ready,
bootTs:this._state.bootTs,
activeGame:this._state.activeGame,
hook:{name:this._state.hookName,enabled:!!this._state.hookEnabled},
activeAdapterId:this._state.activeAdapterId,
adaptersCount:Object.keys(this._state.adapters).length,
lastEvent:this._state.lastEvent,
lastError:this._state.lastError
};
},
_error(where,err){
var msg=(err&&err.message)?err.message:String(err||"error");
this._state.lastError=msg;
this._emit("EVT:ADAPTER:ERROR",{id:this.id,ts:Date.now(),where:String(where||"unknown"),error:msg});
this._emitState("error");
return {ok:false,error:msg,where:String(where||"unknown")};
},
api:{
register:function(p){return Engine_GAME_ADAPTER_REGISTER.register(p);},
unregister:function(p){return Engine_GAME_ADAPTER_REGISTER.unregister(p);},
setActive:function(p){return Engine_GAME_ADAPTER_REGISTER.setActive(p);},
getActive:function(){return Engine_GAME_ADAPTER_REGISTER.getActive();},
list:function(){return Engine_GAME_ADAPTER_REGISTER.list();},
dispatch:function(p){return Engine_GAME_ADAPTER_REGISTER.dispatch(p);},
call:function(p){return Engine_GAME_ADAPTER_REGISTER.call(p);},
setHookEnabled:function(p){return Engine_GAME_ADAPTER_REGISTER.setHookEnabled(p);},
reset:function(){return Engine_GAME_ADAPTER_REGISTER.reset();},
getState:function(){return Engine_GAME_ADAPTER_REGISTER.getState();}
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_GAME_ADAPTER_REGISTER.id]=Engine_GAME_ADAPTER_REGISTER;
/-- üîåüß†-(28B)-(E)-(GAME-ADAPTER-REGISTER)-(37A-HOOK)-(E)-(28B)-üß†üîå --/
/-- üßπüßØ-(29B)-(S)-(CLEANUP-AND-UNMOUNT)-(SAFE-EXIT)-(S)-(29B)-üßØüßπ --/
const Engine_CLEANUP_AND_UNMOUNT={
id:"CLEANUP_AND_UNMOUNT",
_ctx:null,
_state:{
ready:false,
bootTs:0,
unmounted:false,
cleaning:false,
lastEvent:"",
lastError:"",
hooks:[],
timers:[],
rafIds:[],
listeners:[]
},
_wireDone:false,
init(ctx){
this._ctx=ctx||null;
if(!this._ctx||!this._ctx.bus)return this._error("init","missing_ctx_bus");
if(this._wireDone)return this;
this._state.bootTs=Date.now();
this._wire();
this._wireDone=true;
this._state.ready=true;
this._emit("EVT:CLEANUP:READY",{id:this.id,ts:Date.now()});
this._emitState("ready");
return this;
},
_wire(){
var b=this._ctx.bus,me=this;
b.on("REQ:CLEANUP:REGISTER_TIMER",function(p){me.registerTimer(p);});
b.on("REQ:CLEANUP:REGISTER_RAF",function(p){me.registerRAF(p);});
b.on("REQ:CLEANUP:REGISTER_LISTENER",function(p){me.registerListener(p);});
b.on("REQ:CLEANUP:REGISTER_HOOK",function(p){me.registerHook(p);});
b.on("REQ:CLEANUP:RUN",function(p){me.run(p);});
b.on("REQ:CLEANUP:UNMOUNT",function(p){me.unmount(p);});
b.on("REQ:CLEANUP:RESET",function(){me.reset();});
b.on("REQ:CLEANUP:STATE",function(){me._emit("EVT:CLEANUP:STATE",{id:me.id,ts:Date.now(),state:me.getState()});});
},
registerTimer(p){
p=p||{};
var tid=p.id||p.timerId||p.value;
if(tid===undefined||tid===null)return this._error("registerTimer","missing_timer_id");
this._state.timers.push(tid);
this._state.lastEvent="register_timer";
this._emit("EVT:CLEANUP:REGISTER_TIMER",{id:this.id,ts:Date.now(),timerId:tid});
return {ok:true,timerId:tid};
},
registerRAF(p){
p=p||{};
var rid=p.id||p.rafId||p.value;
if(rid===undefined||rid===null)return this._error("registerRAF","missing_raf_id");
this._state.rafIds.push(rid);
this._state.lastEvent="register_raf";
this._emit("EVT:CLEANUP:REGISTER_RAF",{id:this.id,ts:Date.now(),rafId:rid});
return {ok:true,rafId:rid};
},
registerListener(p){
p=p||{};
var target=p.target||window;
var type=String(p.type||"");
var handler=p.handler||p.fn;
var options=p.options;
if(!type||typeof handler!=="function")return this._error("registerListener","missing_type_or_handler");
this._state.listeners.push({target:target,type:type,handler:handler,options:options});
this._state.lastEvent="register_listener";
this._emit("EVT:CLEANUP:REGISTER_LISTENER",{id:this.id,ts:Date.now(),type:type});
return {ok:true,type:type};
},
registerHook(p){
p=p||{};
var fn=p.fn||p.hook||p.value;
var label=String(p.label||p.name||"hook");
if(typeof fn!=="function")return this._error("registerHook","missing_fn");
this._state.hooks.push({fn:fn,label:label});
this._state.lastEvent="register_hook";
this._emit("EVT:CLEANUP:REGISTER_HOOK",{id:this.id,ts:Date.now(),label:label});
return {ok:true,label:label};
},
run(p){
p=p||{};
if(this._state.cleaning)return {ok:false,reason:"already_cleaning"};
this._state.cleaning=true;
this._state.lastEvent="run";
this._emit("EVT:CLEANUP:RUN_START",{id:this.id,ts:Date.now()});
var out={ok:true,cleared:{timers:0,rafs:0,listeners:0,hooks:0},errors:[]};
out.cleared.timers+=this._clearTimers(out.errors);
out.cleared.rafs+=this._clearRAFs(out.errors);
out.cleared.listeners+=this._clearListeners(out.errors);
out.cleared.hooks+=this._runHooks(out.errors);
this._state.cleaning=false;
this._emit("EVT:CLEANUP:RUN_END",{id:this.id,ts:Date.now(),result:out});
this._emitState("run_end");
return out;
},
unmount(p){
p=p||{};
if(this._state.unmounted)return {ok:false,reason:"already_unmounted"};
var res=this.run(p);
this._state.unmounted=true;
this._state.lastEvent="unmount";
this._emit("EVT:CLEANUP:UNMOUNTED",{id:this.id,ts:Date.now(),result:res});
this._emit("REQ:GAME:UNMOUNTED",{by:this.id,ts:Date.now(),result:res});
this._emitState("unmounted");
this._detachGlobalHooks();
return {ok:true,result:res};
},
reset(){
this._state.hooks=[];
this._state.timers=[];
this._state.rafIds=[];
this._state.listeners=[];
this._state.unmounted=false;
this._state.cleaning=false;
this._state.lastEvent="reset";
this._state.lastError="";
this._emit("EVT:CLEANUP:RESET",{id:this.id,ts:Date.now()});
this._emitState("reset");
return {ok:true};
},
_clearTimers(errs){
var n=0,i,tid;
for(i=0;i<this._state.timers.length;i++){
tid=this._state.timers[i];
try{clearTimeout(tid);clearInterval(tid);n++;}catch(e){errs.push({where:"timer",error:(e&&e.message)?e.message:String(e)});}
}
this._state.timers=[];
return n;
},
_clearRAFs(errs){
var n=0,i,rid;
for(i=0;i<this._state.rafIds.length;i++){
rid=this._state.rafIds[i];
try{cancelAnimationFrame(rid);n++;}catch(e){errs.push({where:"raf",error:(e&&e.message)?e.message:String(e)});}
}
this._state.rafIds=[];
return n;
},
_clearListeners(errs){
var n=0,i,l;
for(i=0;i<this._state.listeners.length;i++){
l=this._state.listeners[i];
try{(l.target||window).removeEventListener(l.type,l.handler,l.options);n++;}catch(e){errs.push({where:"listener",type:l.type,error:(e&&e.message)?e.message:String(e)});}
}
this._state.listeners=[];
return n;
},
_runHooks(errs){
var n=0,i,h;
for(i=0;i<this._state.hooks.length;i++){
h=this._state.hooks[i];
try{h.fn();n++;}catch(e){errs.push({where:"hook",label:h.label,error:(e&&e.message)?e.message:String(e)});}
}
this._state.hooks=[];
return n;
},
_detachGlobalHooks(){
try{if(window&&window["HOOK:37A"])window["HOOK:37A"]=null;}catch(e){}
},
_emit(name,p){
try{this._ctx.bus.emit(name,p||{});}catch(e){}
},
_emitState(tag){
this._emit("EVT:CLEANUP:STATE",{id:this.id,ts:Date.now(),tag:String(tag||""),state:this.getState()});
},
getState(){
return{
ready:!!this._state.ready,
bootTs:this._state.bootTs,
unmounted:!!this._state.unmounted,
cleaning:!!this._state.cleaning,
counts:{hooks:this._state.hooks.length,timers:this._state.timers.length,rafs:this._state.rafIds.length,listeners:this._state.listeners.length},
lastEvent:this._state.lastEvent,
lastError:this._state.lastError
};
},
_error(where,err){
var msg=(err&&err.message)?err.message:String(err||"error");
this._state.lastError=msg;
this._emit("EVT:CLEANUP:ERROR",{id:this.id,ts:Date.now(),where:String(where||"unknown"),error:msg});
this._emitState("error");
return {ok:false,error:msg,where:String(where||"unknown")};
},
api:{
registerTimer:function(p){return Engine_CLEANUP_AND_UNMOUNT.registerTimer(p);},
registerRAF:function(p){return Engine_CLEANUP_AND_UNMOUNT.registerRAF(p);},
registerListener:function(p){return Engine_CLEANUP_AND_UNMOUNT.registerListener(p);},
registerHook:function(p){return Engine_CLEANUP_AND_UNMOUNT.registerHook(p);},
run:function(p){return Engine_CLEANUP_AND_UNMOUNT.run(p);},
unmount:function(p){return Engine_CLEANUP_AND_UNMOUNT.unmount(p);},
reset:function(){return Engine_CLEANUP_AND_UNMOUNT.reset();},
getState:function(){return Engine_CLEANUP_AND_UNMOUNT.getState();}
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_CLEANUP_AND_UNMOUNT.id]=Engine_CLEANUP_AND_UNMOUNT;
/-- üßπüßØ-(29B)-(E)-(CLEANUP-AND-UNMOUNT)-(SAFE-EXIT)-(E)-(29B)-üßØüßπ --/
/-- üöÄüéÆ-(30B)-(S)-(CARTRIDGE-LAUNCHER)-(LEGION-CHESS)-(S)-(30B)-üéÆüöÄ --/
const Engine_CARTRIDGE_LAUNCHER={
id:"CARTRIDGE_LAUNCHER",
_ctx:null,
_state:{
ready:false,
bootTs:0,
launched:false,
launching:false,
lastEvent:"",
lastError:"",
launchCount:0,
activeCartridge:"",
activeMeta:null
},
_wireDone:false,
init(ctx){
this._ctx=ctx||null;
if(!this._ctx||!this._ctx.bus)return this._error("init","missing_ctx_bus");
if(this._wireDone)return this;
this._state.bootTs=Date.now();
this._wire();
this._wireDone=true;
this._state.ready=true;
this._emit("EVT:LAUNCHER:READY",{id:this.id,ts:Date.now()});
this._emitState("ready");
return this;
},
_wire(){
var b=this._ctx.bus,me=this;
b.on("REQ:LAUNCHER:LAUNCH",function(p){me.launch(p);});
b.on("REQ:LAUNCHER:RELAUNCH",function(p){me.relaunch(p);});
b.on("REQ:LAUNCHER:STOP",function(p){me.stop(p);});
b.on("REQ:LAUNCHER:STATE",function(){me._emit("EVT:LAUNCHER:STATE",{id:me.id,ts:Date.now(),state:me.getState()});});
},
launch(p){
p=p||{};
if(this._state.launching)return {ok:false,reason:"already_launching"};
this._state.launching=true;
this._state.lastEvent="launch";
this._emit("EVT:LAUNCHER:LAUNCH_START",{id:this.id,ts:Date.now(),cartridge:String(p.cartridge||"LEGION-CHESS")});
var cart=String(p.cartridge||"LEGION-CHESS");
var meta=p.meta||{};
var out=this._doLaunch(cart,meta,p);
this._state.launching=false;
this._emit("EVT:LAUNCHER:LAUNCH_END",{id:this.id,ts:Date.now(),result:out});
this._emitState("launch_end");
return out;
},
_doLaunch(cart,meta,p){
var b=this._ctx.bus;
var now=Date.now();
this._state.launched=true;
this._state.launchCount++;
this._state.activeCartridge=cart;
this._state.activeMeta=meta||{};
this._emit("EVT:LAUNCHER:ACTIVE",{id:this.id,ts:now,cartridge:cart,meta:this._state.activeMeta,launchCount:this._state.launchCount});
this._emit("REQ:CLEANUP:RESET",{by:this.id,ts:now});
this._emit("REQ:THEME:APPLY",{by:this.id,ts:now,cartridge:cart});
this._emit("REQ:SETTINGS:ATTACH",{by:this.id,ts:now,cartridge:cart});
this._emit("REQ:BOARD:BUILD",{by:this.id,ts:now,cartridge:cart,meta:this._state.activeMeta});
this._emit("REQ:RENDER:START",{by:this.id,ts:now,cartridge:cart});
this._emit("REQ:INPUT:ENABLE",{by:this.id,ts:now,cartridge:cart});
this._emit("REQ:HUD:START",{by:this.id,ts:now,cartridge:cart});
this._emit("REQ:AUDIO:ARM",{by:this.id,ts:now,cartridge:cart});
this._emit("REQ:PARTICLES:ARM",{by:this.id,ts:now,cartridge:cart});
this._emit("EVT:CARTRIDGE:LAUNCHED",{by:this.id,ts:now,cartridge:cart,meta:this._state.activeMeta});
return {ok:true,cartridge:cart,launchCount:this._state.launchCount,ts:now};
},
relaunch(p){
p=p||{};
var cart=String(p.cartridge||this._state.activeCartridge||"LEGION-CHESS");
var meta=p.meta||this._state.activeMeta||{};
this._emit("EVT:LAUNCHER:RELAUNCH",{id:this.id,ts:Date.now(),cartridge:cart});
this.stop({reason:"relaunch"});
return this.launch({cartridge:cart,meta:meta,mode:"relaunch"});
},
stop(p){
p=p||{};
if(!this._state.launched){this._state.lastEvent="stop_noop";return {ok:true,noop:true};}
this._state.lastEvent="stop";
this._emit("EVT:LAUNCHER:STOP",{id:this.id,ts:Date.now(),reason:String(p.reason||"stop")});
this._emit("REQ:INPUT:DISABLE",{by:this.id,ts:Date.now()});
this._emit("REQ:RENDER:STOP",{by:this.id,ts:Date.now()});
this._emit("REQ:HUD:STOP",{by:this.id,ts:Date.now()});
this._emit("REQ:PARTICLES:DISARM",{by:this.id,ts:Date.now()});
this._emit("REQ:AUDIO:DISARM",{by:this.id,ts:Date.now()});
this._emit("REQ:CLEANUP:UNMOUNT",{by:this.id,ts:Date.now(),reason:String(p.reason||"stop")});
this._state.launched=false;
this._state.activeCartridge="";
this._state.activeMeta=null;
this._emitState("stopped");
return {ok:true,stopped:true};
},
_emit(name,p){
try{this._ctx.bus.emit(name,p||{});}catch(e){}
},
_emitState(tag){
this._emit("EVT:LAUNCHER:STATE",{id:this.id,ts:Date.now(),tag:String(tag||""),state:this.getState()});
},
getState(){
return{
ready:!!this._state.ready,
bootTs:this._state.bootTs,
launched:!!this._state.launched,
launching:!!this._state.launching,
launchCount:this._state.launchCount,
activeCartridge:this._state.activeCartridge,
activeMeta:this._state.activeMeta,
lastEvent:this._state.lastEvent,
lastError:this._state.lastError
};
},
_error(where,err){
var msg=(err&&err.message)?err.message:String(err||"error");
this._state.lastError=msg;
this._emit("EVT:LAUNCHER:ERROR",{id:this.id,ts:Date.now(),where:String(where||"unknown"),error:msg});
this._emitState("error");
return {ok:false,error:msg,where:String(where||"unknown")};
},
api:{
launch:function(p){return Engine_CARTRIDGE_LAUNCHER.launch(p);},
relaunch:function(p){return Engine_CARTRIDGE_LAUNCHER.relaunch(p);},
stop:function(p){return Engine_CARTRIDGE_LAUNCHER.stop(p);},
getState:function(){return Engine_CARTRIDGE_LAUNCHER.getState();}
}
};
window.KOG=window.KOG||{};
window.KOG[Engine_CARTRIDGE_LAUNCHER.id]=Engine_CARTRIDGE_LAUNCHER;
/-- üöÄüéÆ-(30B)-(E)-(CARTRIDGE-LAUNCHER)-(LEGION-CHESS)-(E)-(30B)-üéÆüöÄ --/
/*-- ‚úÖüéÆ-(END)-(CARTRIDGE-RUNNER)-(LEGION-CHESS)-(END)-üéÆ‚úÖ --*/
(()=>{
if(!window.LEGION_CHESS){console.error("LEGION_CHESS missing");return;}
const LC=window.LEGION_CHESS;
const start=()=>{try{LC.boot();}catch(e){console.error("LC.boot failed",e);}};
if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",start);
else start();
})();
</script>
</body>
</html>
